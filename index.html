<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>AgentSpark — Build Your AI Team</title>

<!-- PWA meta -->
<meta name="theme-color" content="#050810" id="meta-theme-color"/>
<meta name="description" content="Build your AI agent team in minutes. Choose a topic, answer questions, get production-ready agent files."/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="AgentSpark"/>

<!-- PWA manifest (inline data: URI) -->
<link rel="manifest" id="pwa-manifest"/>

<!-- PWA icons (inline SVG as data URI) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%23050810'/%3E%3Crect width='192' height='192' rx='40' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='192' y2='192' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%2300e5ff' stop-opacity='.25'/%3E%3Cstop offset='1' stop-color='%237c3aff' stop-opacity='.25'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle' fill='%2300e5ff'%3E⚡%3C/text%3E%3C/svg%3E"/>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  :root {
    --bg: #050810;
    --surface: #0b1120;
    --surface2: #111c30;
    --border: #1e3050;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --accent3: #7c3aff;
    --text: #e2eaf8;
    --muted: #5a7296;
    --success: #00ff88;
  }

  /* ── LIGHT MODE ── */
  [data-theme="light"] {
    --bg: #f0f4ff;
    --surface: #ffffff;
    --surface2: #e8edf8;
    --border: #c8d4ed;
    --accent: #0077cc;
    --accent2: #e05a1a;
    --accent3: #6020cc;
    --text: #111827;
    --muted: #6b7fa8;
    --success: #00994d;
  }
  [data-theme="light"] body::before {
    background-image:
      radial-gradient(1px 1px at 20% 30%, rgba(0,119,204,0.25) 0%, transparent 100%),
      radial-gradient(1px 1px at 80% 10%, rgba(96,32,204,0.2) 0%, transparent 100%),
      radial-gradient(1px 1px at 50% 60%, rgba(0,119,204,0.15) 0%, transparent 100%),
      radial-gradient(1px 1px at 10% 70%, rgba(224,90,26,0.2) 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 80%, rgba(0,119,204,0.15) 0%, transparent 100%),
      radial-gradient(1px 1px at 60% 20%, rgba(96,32,204,0.2) 0%, transparent 100%),
      radial-gradient(1px 1px at 30% 90%, rgba(0,153,77,0.15) 0%, transparent 100%);
  }
  [data-theme="light"] body::after {
    background-image:
      linear-gradient(rgba(0,119,204,0.06) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,119,204,0.06) 1px, transparent 1px);
  }
  [data-theme="light"] pre {
    background: #e8edf8;
  }
  [data-theme="light"] .model-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7fa8' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  }
  [data-theme="light"] .model-select option { background: #ffffff; }

  /* Theme toggle button */
  .theme-toggle {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 34px;
    height: 34px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .theme-toggle:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,119,204,0.08);
  }

  /* Smooth theme transition on the elements that matter */
  body, header, .sidebar-card, .agent-card, .topic-card, .level-card,
  .chat-main, .chat-header, .chat-input-area, .modal, .modal-overlay,
  .scoring-panel, .instructions, .results-actions, .refine-panel,
  .input-field, .model-select, pre, .notif {
    transition: background-color 0.25s ease, border-color 0.25s ease, color 0.15s ease;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(1px 1px at 20% 30%, rgba(0,229,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 80% 10%, rgba(124,58,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 50% 60%, rgba(0,229,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 10% 70%, rgba(255,107,53,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 80%, rgba(0,229,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 60% 20%, rgba(124,58,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 30% 90%, rgba(0,255,136,0.3) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  #app { position: relative; z-index: 1; }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 2.5rem;
    border-bottom: 1px solid var(--border);
    background: rgba(5,8,16,0.8);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: 'Space Mono', monospace;
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem;
    position: relative;
    overflow: hidden;
  }
  .logo-icon::after {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.15) 50%, transparent 60%);
    animation: shimmer 3s infinite;
  }
  @keyframes shimmer { 0% { transform: translateX(-100%) translateY(-100%); } 100% { transform: translateX(100%) translateY(100%); } }

  .logo span { color: var(--accent); }

  .lang-switch {
    display: flex;
    gap: 0.5rem;
  }
  .lang-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.75rem;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    transition: all 0.2s;
  }
  .lang-btn.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,229,255,0.08);
  }

  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 2rem;
  }

  .screen { display: none; }
  .screen.active { display: block; animation: fadeIn 0.4s ease; }
  @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform:translateY(0); } }

  .hero {
    text-align: center;
    padding: 4rem 0 3rem;
  }
  .hero-badge {
    display: inline-block;
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    color: var(--accent);
    border: 1px solid rgba(0,229,255,0.3);
    padding: 0.35rem 1rem;
    border-radius: 20px;
    background: rgba(0,229,255,0.05);
    margin-bottom: 1.5rem;
    animation: pulse-glow 3s ease-in-out infinite;
  }
  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 0 rgba(0,229,255,0); }
    50% { box-shadow: 0 0 20px rgba(0,229,255,0.2); }
  }

  .hero h1 {
    font-size: clamp(2.5rem, 6vw, 4.5rem);
    font-weight: 800;
    line-height: 1.05;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #fff 0%, var(--accent) 50%, var(--accent3) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .hero p {
    font-size: 1.15rem;
    color: var(--muted);
    max-width: 520px;
    margin: 0 auto 3rem;
    line-height: 1.6;
  }

  .topic-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    max-width: 900px;
    margin: 0 auto 2rem;
  }

  .topic-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .topic-card:hover {
    border-color: var(--accent);
    background: rgba(0,229,255,0.05);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,229,255,0.1);
  }
  .topic-card .icon { font-size: 1.8rem; margin-bottom: 0.5rem; }
  .topic-card .label { font-size: 0.85rem; font-weight: 600; color: var(--text); }
  .topic-card .sub { font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem; }
  .topic-card .agents-preview {
    font-size: 0.62rem;
    font-family: 'Space Mono', monospace;
    color: rgba(0,229,255,0.6);
    margin-top: 0.6rem;
    line-height: 1.4;
    border-top: 1px solid var(--border);
    padding-top: 0.5rem;
    display: none;
  }
  .topic-card:hover .agents-preview { display: block; }
  .topic-card .time-badge {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 0.55rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.1rem 0.3rem;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .topic-card:hover .time-badge { opacity: 1; }

  .template-filters {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
    max-width: 900px;
    margin: 0 auto 1.25rem;
  }
  .filter-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.85rem;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }
  .filter-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .filter-btn.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,229,255,0.08);
  }
  .topic-card.hidden { display: none; }

  .or-divider {
    text-align: center;
    color: var(--muted);
    font-size: 0.8rem;
    font-family: 'Space Mono', monospace;
    margin: 1rem 0;
  }

  .custom-topic {
    display: flex;
    gap: 0.75rem;
    max-width: 560px;
    margin: 0 auto;
  }

  .input-field {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.85rem 1.25rem;
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    font-size: 0.95rem;
    outline: none;
    transition: all 0.2s;
  }
  .input-field:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,229,255,0.1);
  }
  .input-field::placeholder { color: var(--muted); }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    color: #000;
    border: none;
    border-radius: 10px;
    padding: 0.85rem 1.5rem;
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(0,229,255,0.3);
  }
  .btn-primary:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  /* ── MY PROJECTS (#1) ── */
  .btn-projects-header {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.85rem;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex; align-items: center; gap: 0.4rem;
  }
  .btn-projects-header:hover { border-color: var(--accent); color: var(--accent); }

  .project-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    position: relative;
    overflow: hidden;
  }
  .project-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent3));
    opacity: 0;
    transition: opacity 0.2s;
  }
  .project-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
  .project-card:hover::before { opacity: 1; }
  .project-card-name { font-weight: 700; font-size: 1rem; color: var(--text); }
  .project-card-topic { font-size: 0.78rem; color: var(--muted); }
  .project-card-meta {
    display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.25rem;
  }
  .project-card-tag {
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background: rgba(0,229,255,0.08);
    border: 1px solid rgba(0,229,255,0.2);
    color: var(--accent);
  }
  .project-card-actions {
    display: flex; gap: 0.5rem; margin-top: 0.5rem;
  }
  .project-card-btn {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 7px;
    padding: 0.4rem 0.5rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }
  .project-card-btn:hover { color: var(--text); border-color: var(--accent); }
  .project-card-btn.danger:hover { color: var(--accent2); border-color: var(--accent2); }
  .project-card-date { font-size: 0.68rem; color: var(--muted); font-family: 'Space Mono', monospace; }
  .project-unsaved-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--accent2); display: inline-block; margin-left: 4px;
    vertical-align: middle;
  }
  /* Save indicator in header */
  .save-indicator {
    font-size: 0.68rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    opacity: 0;
    transition: opacity 0.4s;
    white-space: nowrap;
  }
  .save-indicator.visible { opacity: 1; }

  .chat-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.5rem;
    height: calc(100vh - 160px);
    transition: grid-template-columns 0.3s ease;
  }
  .chat-layout.sidebar-collapsed {
    grid-template-columns: 1fr 0px;
  }

  .chat-main {
    display: flex;
    flex-direction: column;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  .chat-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--surface2);
  }
  .chat-header .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--success);
    box-shadow: 0 0 8px var(--success);
    animation: blink 2s infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
  .chat-header .title { font-weight: 600; font-size: 0.95rem; }
  .chat-header .subtitle { font-size: 0.75rem; color: var(--muted); }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    scroll-behavior: smooth;
  }
  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg {
    max-width: 85%;
    animation: msgIn 0.3s ease;
  }
  @keyframes msgIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

  .msg.ai { align-self: flex-start; }
  .msg.user { align-self: flex-end; }

  .msg-bubble {
    padding: 0.9rem 1.2rem;
    border-radius: 12px;
    font-size: 0.92rem;
    line-height: 1.6;
  }
  .msg.ai .msg-bubble {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
    color: var(--text);
  }
  .msg.user .msg-bubble {
    background: linear-gradient(135deg, rgba(0,229,255,0.15), rgba(124,58,255,0.15));
    border: 1px solid rgba(0,229,255,0.3);
    border-bottom-right-radius: 4px;
    color: var(--text);
  }

  .msg-sender {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    margin-bottom: 0.3rem;
    padding: 0 0.3rem;
  }
  .msg.ai .msg-sender { color: var(--accent); }
  .msg.user .msg-sender { text-align: right; color: var(--accent3); }

  .typing-indicator {
    display: flex;
    gap: 4px;
    padding: 0.9rem 1.2rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    border-bottom-left-radius: 4px;
    width: fit-content;
  }
  .typing-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
    animation: typing 1.2s infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typing { 0%,60%,100%{transform:translateY(0);opacity:0.4} 30%{transform:translateY(-6px);opacity:1} }

  .chat-input-area {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    background: var(--surface2);
    display: flex;
    gap: 0.75rem;
  }
  .chat-input-area .input-field { font-size: 0.9rem; }

  .sidebar-toggle-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    width: 28px; height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
    margin-left: auto;
  }
  .sidebar-toggle-btn:hover { border-color: var(--accent); color: var(--accent); }

  .chat-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow: hidden;
    transition: opacity 0.2s ease, transform 0.3s ease;
    min-width: 0;
  }
  .chat-layout.sidebar-collapsed .chat-sidebar {
    opacity: 0;
    pointer-events: none;
    transform: translateX(20px);
  }

  .sidebar-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 1.25rem;
  }
  .sidebar-card h3 {
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
  }

  .progress-steps {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  .step {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.82rem;
    color: var(--muted);
    transition: color 0.3s;
  }
  .step.done { color: var(--text); }
  .step.active { color: var(--accent); }
  .step-num {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    flex-shrink: 0;
    transition: all 0.3s;
  }
  .step.done .step-num {
    background: var(--success);
    border-color: var(--success);
    color: #000;
  }
  .step.active .step-num {
    background: rgba(0,229,255,0.15);
    border-color: var(--accent);
    color: var(--accent);
  }

  .api-key-section { }
  .api-label {
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 0.5rem;
    display: block;
  }

  .results-header {
    text-align: center;
    padding: 2.5rem 0 2rem;
  }
  .results-header h2 {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    background: linear-gradient(90deg, var(--success), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .results-header p { color: var(--muted); }

  .agents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
  }

  .agent-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    transition: all 0.2s;
  }
  .agent-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(0,229,255,0.1);
  }

  .agent-card-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .agent-avatar {
    width: 48px; height: 48px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent3), var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem;
    flex-shrink: 0;
  }
  .agent-name { font-weight: 700; font-size: 1rem; }
  .agent-role { font-size: 0.75rem; color: var(--accent); font-family: 'Space Mono', monospace; }

  .agent-card-body { padding: 1.25rem; }
  .agent-desc { font-size: 0.85rem; color: var(--muted); line-height: 1.6; margin-bottom: 1rem; }

  .file-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }
  .file-chip {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
  }
  .file-chip:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* ── MARKDOWN PREVIEW MODAL ── */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 90%;
    max-width: 820px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    animation: modalIn 0.25s ease;
  }
  @keyframes modalIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }

  .modal-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .modal-title { font-family: 'Space Mono', monospace; font-size: 0.85rem; color: var(--accent); }
  .modal-close {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
    transition: color 0.2s;
  }
  .modal-close:hover { color: var(--text); }

  /* View toggle tabs */
  .modal-tabs {
    display: flex;
    gap: 0.4rem;
  }
  .modal-tab {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    transition: all 0.18s;
  }
  .modal-tab.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,229,255,0.08);
  }

  .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
  }
  .modal-body::-webkit-scrollbar { width: 4px; }
  .modal-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  pre {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    line-height: 1.7;
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* Markdown rendered styles */
  .md-preview {
    line-height: 1.75;
    color: var(--text);
  }
  .md-preview h1 {
    font-size: 1.6rem;
    font-weight: 800;
    margin: 0 0 1rem;
    background: linear-gradient(90deg, var(--accent), var(--accent3));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }
  .md-preview h2 {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent);
    margin: 1.5rem 0 0.6rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.85rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .md-preview h3 {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--text);
    margin: 1.25rem 0 0.4rem;
  }
  .md-preview p {
    margin-bottom: 0.8rem;
    font-size: 0.9rem;
    color: var(--muted);
  }
  .md-preview ul, .md-preview ol {
    margin: 0.4rem 0 0.8rem 1.5rem;
  }
  .md-preview li {
    font-size: 0.88rem;
    color: var(--muted);
    margin-bottom: 0.3rem;
    line-height: 1.6;
  }
  .md-preview strong { color: var(--text); font-weight: 700; }
  .md-preview em { color: var(--accent2); font-style: italic; }
  .md-preview code {
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    background: rgba(0,229,255,0.08);
    border: 1px solid rgba(0,229,255,0.15);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    color: var(--accent);
  }
  .md-preview pre {
    margin: 0.8rem 0;
  }
  .md-preview pre code {
    background: none;
    border: none;
    padding: 0;
    color: var(--text);
    font-size: 0.78rem;
  }
  .md-preview blockquote {
    border-left: 3px solid var(--accent3);
    padding: 0.5rem 0 0.5rem 1rem;
    margin: 0.8rem 0;
    color: var(--muted);
    font-style: italic;
    background: rgba(124,58,255,0.05);
    border-radius: 0 6px 6px 0;
  }
  .md-preview hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.25rem 0;
  }
  .md-preview table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.8rem 0;
    font-size: 0.85rem;
  }
  .md-preview th {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 0.5rem 0.8rem;
    text-align: left;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    color: var(--accent);
    letter-spacing: 0.05em;
  }
  .md-preview td {
    border: 1px solid var(--border);
    padding: 0.5rem 0.8rem;
    color: var(--muted);
  }
  .md-preview tr:hover td { background: rgba(0,229,255,0.03); }

  /* Modal footer with download button */
  .modal-footer {
    padding: 0.75rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.75rem;
  }
  .modal-download-btn {
    background: rgba(0,229,255,0.08);
    border: 1px solid rgba(0,229,255,0.3);
    color: var(--accent);
    border-radius: 8px;
    padding: 0.4rem 1rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    cursor: pointer;
    transition: all 0.18s;
  }
  .modal-download-btn:hover {
    background: rgba(0,229,255,0.15);
    box-shadow: 0 0 12px rgba(0,229,255,0.2);
  }

  .results-actions {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .results-actions h3 {
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
    letter-spacing: 0.1em;
    margin-bottom: 1.5rem;
  }

  .actions-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .btn-secondary {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 10px;
    padding: 0.85rem 1.5rem;
    font-family: 'Outfit', sans-serif;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-secondary:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .instructions {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .instructions h3 {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .instruction-steps {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  .instruction-step {
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
  }
  .instruction-step .num {
    width: 32px; height: 32px;
    border-radius: 8px;
    background: rgba(0,229,255,0.1);
    border: 1px solid rgba(0,229,255,0.3);
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .instruction-step .content { flex: 1; }
  .instruction-step .content strong { font-weight: 700; display: block; margin-bottom: 0.3rem; }
  .instruction-step .content p { font-size: 0.87rem; color: var(--muted); line-height: 1.6; }
  .instruction-step .content code {
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    background: var(--bg);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    color: var(--accent);
  }

  .api-key-area {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .api-key-status {
    font-size: 0.72rem;
    font-family: 'Space Mono', monospace;
    padding: 0.3rem 0;
  }
  .api-key-status.ok { color: var(--success); }
  .api-key-status.err { color: var(--accent2); }

  .model-select-wrap {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    margin-bottom: 0.75rem;
  }
  .model-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    padding: 0.65rem 1rem;
    cursor: pointer;
    outline: none;
    width: 100%;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235a7296' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .model-select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,229,255,0.1);
  }
  .model-select option { background: #0b1120; color: var(--text); }
  .model-hint {
    font-size: 0.67rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    margin-top: 0.1rem;
  }
  .model-provider-badge {
    display: inline-block;
    font-size: 0.58rem;
    font-family: 'Space Mono', monospace;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    letter-spacing: 0.06em;
    margin-left: 0.35rem;
    vertical-align: middle;
  }

  .notif {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--surface2);
    border: 1px solid var(--success);
    border-radius: 10px;
    padding: 0.9rem 1.25rem;
    font-size: 0.87rem;
    color: var(--success);
    z-index: 300;
    animation: notifIn 0.3s ease;
    box-shadow: 0 8px 24px rgba(0,255,136,0.15);
  }
  @keyframes notifIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  @media (max-width: 768px) {
    .chat-layout { grid-template-columns: 1fr; }
    .chat-sidebar { display: none; }
    header { padding: 1rem 1.25rem; }
    main { padding: 1rem; }
    .hero { padding: 2rem 0 1.5rem; }
  }

  .option-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 8px;
    padding: 0.6rem 1rem;
    font-family: 'Outfit', sans-serif;
    font-size: 0.87rem;
    cursor: pointer;
    transition: all 0.18s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-align: left;
    flex: 1;
    min-width: 180px;
  }
  .option-btn:hover {
    border-color: var(--accent);
    background: rgba(0,229,255,0.08);
    color: var(--accent);
    transform: translateY(-1px);
  }
  .opt-label {
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--accent);
    background: rgba(0,229,255,0.1);
    border: 1px solid rgba(0,229,255,0.2);
    border-radius: 4px;
    padding: 0.15rem 0.4rem;
    flex-shrink: 0;
  }

  .level-section {
    max-width: 760px;
    margin: 0 auto 2.5rem;
  }
  .level-section-label {
    font-size: 0.72rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    letter-spacing: 0.15em;
    margin-bottom: 0.85rem;
    display: block;
  }
  .level-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
  }
  @media(max-width:700px) { .level-grid { grid-template-columns: repeat(2,1fr); } }

  .level-card {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 14px;
    padding: 1.1rem 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .level-card::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .level-card:hover { transform: translateY(-3px); }
  .level-card.selected { transform: translateY(-3px); }
  .level-card .level-emoji { font-size: 2rem; margin-bottom: 0.4rem; display: block; }
  .level-card .level-name {
    font-weight: 800;
    font-size: 1rem;
    margin-bottom: 0.2rem;
  }
  .level-card .level-tagline {
    font-size: 0.68rem;
    color: var(--muted);
    line-height: 1.4;
  }
  .level-card .level-agents {
    font-family: 'Space Mono', monospace;
    font-size: 0.62rem;
    margin-top: 0.5rem;
    padding: 0.2rem 0.5rem;
    border-radius: 20px;
    display: inline-block;
    border: 1px solid;
  }

  .option-wrap {
    flex: 1;
    min-width: 200px;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  .option-btn {
    width: 100%;
  }
  .opt-text { flex: 1; }

  .impact-note {
    display: flex;
    align-items: flex-start;
    gap: 0.35rem;
    font-size: 0.72rem;
    color: var(--muted);
    padding: 0.3rem 0.6rem;
    border-left: 2px solid var(--border);
    line-height: 1.4;
    transition: all 0.2s;
  }
  .impact-note .impact-icon {
    font-size: 0.65rem;
    margin-top: 0.1rem;
    flex-shrink: 0;
    opacity: 0.6;
  }
  .impact-note.selected {
    border-left-color: var(--accent);
    color: var(--accent);
    opacity: 1 !important;
  }
  .impact-note.selected .impact-icon { opacity: 1; }

  .agent-type-badge {
    font-family: 'Space Mono', monospace;
    font-size: 0.58rem;
    font-weight: 700;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }
  .badge-tech {
    background: rgba(124,58,255,0.15);
    border: 1px solid rgba(124,58,255,0.4);
    color: #a78bff;
  }
  .badge-biz {
    background: rgba(255,107,53,0.12);
    border: 1px solid rgba(255,107,53,0.35);
    color: #ff9966;
  }

  .agent-section {
    margin-bottom: 2rem;
  }
  .agent-section-header {
    display: flex;
    align-items: center;
    gap: 0.65rem;
    font-size: 0.78rem;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  .section-count {
    margin-left: auto;
    background: rgba(255,255,255,0.08);
    border-radius: 20px;
    padding: 0.1rem 0.5rem;
    font-size: 0.65rem;
  }
  .section-tech {
    background: rgba(124,58,255,0.1);
    border: 1px solid rgba(124,58,255,0.25);
    color: #a78bff;
  }
  .section-biz {
    background: rgba(255,107,53,0.08);
    border: 1px solid rgba(255,107,53,0.2);
    color: #ff9966;
  }
  .section-config {
    background: rgba(30,48,80,0.4);
    border: 1px solid var(--border);
    color: var(--muted);
  }

  .agent-section .agents-grid { margin-bottom: 0; }

  .scoring-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.75rem 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }
  .scoring-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent3), var(--accent2));
  }
  .scoring-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .scoring-header h3 {
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    color: var(--accent);
  }
  .score-badge {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .score-number {
    font-size: 2.5rem;
    font-weight: 800;
    font-family: 'Space Mono', monospace;
    line-height: 1;
  }
  .score-label {
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.4;
  }
  .score-label strong { display: block; font-size: 0.9rem; color: var(--text); }

  .scoring-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .score-metric {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
  }
  .score-metric-label {
    font-size: 0.68rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin-bottom: 0.5rem;
  }
  .score-metric-bar {
    height: 5px;
    background: var(--border);
    border-radius: 3px;
    margin-bottom: 0.4rem;
    overflow: hidden;
  }
  .score-metric-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 1s ease;
  }
  .score-metric-value {
    font-size: 0.78rem;
    font-weight: 700;
    color: var(--text);
  }

  .scoring-risks {
    margin-bottom: 1rem;
  }
  .scoring-risks h4 {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent2);
    letter-spacing: 0.1em;
    margin-bottom: 0.6rem;
  }
  .risk-item {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    font-size: 0.82rem;
    color: var(--muted);
    margin-bottom: 0.35rem;
    line-height: 1.5;
  }
  .risk-item::before { content: '▸'; color: var(--accent2); flex-shrink: 0; }

  .level-suggestion {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.82rem;
    background: rgba(0,229,255,0.05);
    border: 1px solid rgba(0,229,255,0.15);
    color: var(--text);
  }
  .level-suggestion.warn {
    background: rgba(255,107,53,0.06);
    border-color: rgba(255,107,53,0.2);
  }
  .level-suggestion .ls-icon { font-size: 1.1rem; }

  .section-header-bar {
    display: flex;
    align-items: center;
    gap: 0.65rem;
    font-size: 0.78rem;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    background: rgba(0,229,255,0.06);
    border: 1px solid rgba(0,229,255,0.15);
    color: var(--accent);
  }
  .graph-section {
    margin-bottom: 2rem;
  }
  .graph-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    position: relative;
  }
  #agent-graph {
    width: 100%;
    height: auto;
    display: block;
    cursor: grab;
  }
  #agent-graph:active { cursor: grabbing; }
  .graph-legend {
    display: flex;
    gap: 1.5rem;
    padding: 0.75rem 1.25rem;
    border-top: 1px solid var(--border);
    font-size: 0.72rem;
    color: var(--muted);
  }
  .graph-legend span { display: flex; align-items: center; gap: 0.4rem; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  .refine-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.75rem 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.3s ease;
  }
  .refine-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent3), var(--accent), var(--success));
  }

  .refine-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 1.25rem;
    gap: 1rem;
  }
  .refine-header h3 {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 0.2rem;
  }
  .refine-header p {
    font-size: 0.8rem;
    color: var(--muted);
  }
  .refine-close-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 30px; height: 30px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .refine-close-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  .refine-action-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
  }
  .refine-chip {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.45rem 0.9rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--text);
  }
  .refine-chip:hover, .refine-chip.active {
    border-color: var(--accent3);
    background: rgba(124,58,255,0.1);
    color: #a78bff;
  }

  .refine-history {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
    max-height: 280px;
    overflow-y: auto;
    padding-right: 0.25rem;
  }
  .refine-history:empty { display: none; }
  .refine-history::-webkit-scrollbar { width: 3px; }
  .refine-history::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .refine-msg {
    animation: msgIn 0.25s ease;
  }
  .refine-msg.user .refine-bubble {
    background: rgba(124,58,255,0.1);
    border: 1px solid rgba(124,58,255,0.25);
    border-radius: 10px;
    border-bottom-right-radius: 3px;
    padding: 0.7rem 1rem;
    font-size: 0.87rem;
    margin-left: 20%;
    color: var(--text);
  }
  .refine-msg.ai .refine-bubble {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    border-bottom-left-radius: 3px;
    padding: 0.7rem 1rem;
    font-size: 0.87rem;
    margin-right: 20%;
    color: var(--text);
    line-height: 1.6;
  }
  .refine-msg-sender {
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    margin-bottom: 0.25rem;
    padding: 0 0.3rem;
  }
  .refine-msg.user .refine-msg-sender { text-align: right; color: #a78bff; }
  .refine-msg.ai .refine-msg-sender { color: var(--accent); }

  .refine-diff-added {
    display: inline-block;
    background: rgba(0,255,136,0.12);
    border: 1px solid rgba(0,255,136,0.25);
    color: var(--success);
    border-radius: 4px;
    padding: 0.1rem 0.4rem;
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    margin: 0.1rem;
  }
  .refine-diff-removed {
    display: inline-block;
    background: rgba(255,59,48,0.1);
    border: 1px solid rgba(255,59,48,0.2);
    color: #ff6b6b;
    border-radius: 4px;
    padding: 0.1rem 0.4rem;
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    margin: 0.1rem;
    text-decoration: line-through;
  }
  .refine-diff-changed {
    display: inline-block;
    background: rgba(255,149,0,0.1);
    border: 1px solid rgba(255,149,0,0.25);
    color: #ff9500;
    border-radius: 4px;
    padding: 0.1rem 0.4rem;
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    margin: 0.1rem;
  }

  .refine-input-row {
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
  }
  .refine-textarea {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 1rem;
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    font-size: 0.9rem;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
    line-height: 1.5;
  }
  .refine-textarea:focus { border-color: var(--accent3); box-shadow: 0 0 0 3px rgba(124,58,255,0.1); }
  .refine-textarea::placeholder { color: var(--muted); }

  .refine-submit-btn {
    background: linear-gradient(135deg, var(--accent3), var(--accent));
    padding: 0.75rem 1.25rem;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .refine-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .refine-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.75rem;
  }
  .refine-revert-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: 0.75rem;
    padding: 0.3rem 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Outfit', sans-serif;
    transition: all 0.15s;
  }
  .refine-revert-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  .refine-thinking {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.82rem;
    color: var(--muted);
    padding: 0.5rem 0;
    font-family: 'Space Mono', monospace;
  }
  .refine-thinking .thinking-dots span {
    display: inline-block;
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--accent3);
    margin: 0 2px;
    animation: typing 1.2s infinite;
  }
  .refine-thinking .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
  .refine-thinking .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes agentUpdated {
    0%   { box-shadow: 0 0 0 rgba(0,255,136,0); border-color: var(--border); }
    30%  { box-shadow: 0 0 24px rgba(0,255,136,0.3); border-color: var(--success); }
    100% { box-shadow: 0 0 0 rgba(0,255,136,0); border-color: var(--border); }
  }
  .agent-card.just-updated { animation: agentUpdated 1.5s ease forwards; }
  @keyframes agentAdded {
    0%   { opacity: 0; transform: translateY(12px) scale(0.97); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }
  /* ── PWA STYLES ── */

  /* Safe area padding for notch/home-bar devices */
  header {
    padding-top: max(1.5rem, env(safe-area-inset-top));
    padding-left: max(2.5rem, env(safe-area-inset-left));
    padding-right: max(2.5rem, env(safe-area-inset-right));
  }
  main {
    padding-left: max(2rem, env(safe-area-inset-left));
    padding-right: max(2rem, env(safe-area-inset-right));
    padding-bottom: max(2rem, env(safe-area-inset-bottom));
  }

  /* Install banner */
  .pwa-install-banner {
    position: fixed;
    bottom: max(1.5rem, env(safe-area-inset-bottom));
    left: max(1.25rem, env(safe-area-inset-left));
    right: max(1.25rem, env(safe-area-inset-right));
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 14px;
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    z-index: 500;
    box-shadow: 0 8px 32px rgba(0,229,255,0.15);
    animation: slideUp 0.4s ease;
    max-width: 480px;
    margin: 0 auto;
  }
  @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
  .pwa-install-icon { font-size: 1.8rem; flex-shrink: 0; }
  .pwa-install-text { flex: 1; }
  .pwa-install-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 0.15rem; }
  .pwa-install-sub   { font-size: 0.72rem; color: var(--muted); }
  .pwa-install-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
  .pwa-install-btn {
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    font-size: 0.82rem;
    cursor: pointer;
    white-space: nowrap;
  }
  .pwa-dismiss-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    cursor: pointer;
  }
  .pwa-dismiss-btn:hover { color: var(--text); border-color: var(--text); }

  /* Offline indicator */
  .offline-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: #ff9500;
    color: #000;
    text-align: center;
    padding: 0.4rem 1rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    font-weight: 700;
    z-index: 1000;
    display: none;
    letter-spacing: 0.05em;
  }
  .offline-bar.visible { display: block; }

  /* Standalone mode tweaks */
  @media (display-mode: standalone) {
    header {
      padding-top: max(1.25rem, env(safe-area-inset-top));
    }
    body::before { opacity: 0.6; }
  }

  /* Update toast */
  .pwa-update-toast {
    position: fixed;
    bottom: max(1.5rem, env(safe-area-inset-bottom));
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface2);
    border: 1px solid var(--accent3);
    border-radius: 10px;
    padding: 0.75rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.82rem;
    z-index: 500;
    white-space: nowrap;
    box-shadow: 0 4px 20px rgba(124,58,255,0.2);
    animation: slideUp 0.3s ease;
  }
  .pwa-update-btn {
    background: var(--accent3);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 0.3rem 0.75rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.68rem;
    cursor: pointer;
    font-weight: 700;
  }

  .trace-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 2rem;
    overflow: hidden;
  }
  .trace-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    cursor: pointer;
    user-select: none;
  }
  .trace-panel-header h3 {
    font-size: 0.72rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
    letter-spacing: 0.12em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .trace-summary-pills {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .trace-pill {
    font-size: 0.62rem;
    font-family: 'Space Mono', monospace;
    padding: 0.15rem 0.5rem;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--muted);
    background: var(--bg);
    white-space: nowrap;
  }
  .trace-pill.ok    { border-color: rgba(0,255,136,0.3); color: var(--success); background: rgba(0,255,136,0.07); }
  .trace-pill.warn  { border-color: rgba(255,213,128,0.3); color: #ffd580; background: rgba(255,213,128,0.07); }
  .trace-pill.error { border-color: rgba(255,107,53,0.3); color: var(--accent2); background: rgba(255,107,53,0.07); }

  .trace-body {
    display: none;
    padding: 1.25rem 1.5rem;
  }
  .trace-body.open { display: block; }

  /* Gantt-style bar header */
  .trace-gantt-header {
    display: grid;
    grid-template-columns: 200px 1fr 80px 70px 60px;
    gap: 0.5rem;
    padding: 0 0 0.5rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.6rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  @media(max-width:700px) {
    .trace-gantt-header { grid-template-columns: 140px 1fr 60px 0 0; }
    .trace-gantt-header .th-tokens,
    .trace-gantt-header .th-status { display: none; }
  }

  .trace-span {
    display: grid;
    grid-template-columns: 200px 1fr 80px 70px 60px;
    gap: 0.5rem;
    align-items: center;
    padding: 0.55rem 0;
    border-bottom: 1px solid rgba(30,48,80,0.5);
    font-size: 0.78rem;
  }
  .trace-span:last-child { border-bottom: none; }
  @media(max-width:700px) {
    .trace-span { grid-template-columns: 140px 1fr 60px 0 0; }
    .trace-span .span-tokens,
    .trace-span .span-status { display: none; }
  }

  .span-name {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    min-width: 0;
  }
  .span-label {
    font-weight: 600;
    color: var(--text);
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .span-model {
    font-size: 0.62rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .span-bar-col { position: relative; height: 20px; }
  .span-bar-track {
    position: absolute;
    inset: 4px 0;
    background: var(--surface2);
    border-radius: 4px;
    overflow: hidden;
  }
  .span-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.6s ease;
    position: relative;
    overflow: hidden;
  }
  .span-bar-fill::after {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 60%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    animation: barShine 2s infinite;
  }
  @keyframes barShine { 0%{left:-60%} 100%{left:160%} }

  .span-bar-fill.fill-ok      { background: linear-gradient(90deg, var(--accent), #00b8cc); }
  .span-bar-fill.fill-warn    { background: linear-gradient(90deg, #ffd580, #ffaa00); }
  .span-bar-fill.fill-fallback{ background: linear-gradient(90deg, #ff9500, #ff6b35); }
  .span-bar-fill.fill-error   { background: linear-gradient(90deg, var(--accent2), #cc4400); }
  .span-bar-fill.fill-pending { background: repeating-linear-gradient(90deg, var(--border) 0, var(--border) 6px, transparent 6px, transparent 12px); animation: none; }

  .span-duration {
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    color: var(--text);
    text-align: right;
    white-space: nowrap;
  }
  .span-tokens {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    text-align: right;
    white-space: nowrap;
  }
  .span-status {
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }
  .span-badge {
    font-size: 0.58rem;
    font-family: 'Space Mono', monospace;
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    border: 1px solid;
    white-space: nowrap;
  }
  .badge-ok       { color: var(--success); border-color: rgba(0,255,136,0.35); background: rgba(0,255,136,0.08); }
  .badge-fallback { color: #ffd580;        border-color: rgba(255,213,128,0.35); background: rgba(255,213,128,0.08); }
  .badge-error    { color: var(--accent2); border-color: rgba(255,107,53,0.35); background: rgba(255,107,53,0.08); }
  .badge-pending  { color: var(--muted);   border-color: var(--border); }

  .trace-footer {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 1.5rem;
    font-size: 0.68rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    flex-wrap: wrap;
  }
  .trace-footer strong { color: var(--text); }

  .share-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 92%;
    max-width: 560px;
    animation: modalIn 0.25s ease;
    overflow: hidden;
  }
  .share-url-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .share-url-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.6rem 0.9rem;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    outline: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: text;
  }
  .share-copy-btn {
    background: rgba(0,229,255,0.1);
    border: 1px solid rgba(0,229,255,0.3);
    color: var(--accent);
    border-radius: 8px;
    padding: 0.6rem 1rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.18s;
  }
  .share-copy-btn:hover { background: rgba(0,229,255,0.18); }
  .share-copy-btn.copied { border-color: var(--success); color: var(--success); background: rgba(0,255,136,0.1); }

  .share-options {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    margin-bottom: 1.25rem;
  }
  .share-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.18s;
    background: var(--surface2);
  }
  .share-option:hover { border-color: var(--accent); }
  .share-option.active { border-color: var(--accent); background: rgba(0,229,255,0.05); }
  .share-option input[type="radio"] { accent-color: var(--accent); flex-shrink: 0; }
  .share-option-text { flex: 1; }
  .share-option-label { font-size: 0.85rem; font-weight: 600; color: var(--text); }
  .share-option-desc  { font-size: 0.72rem; color: var(--muted); margin-top: 0.1rem; }

  .share-password-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.6rem;
    padding-left: 1.75rem;
  }
  .share-meta {
    font-size: 0.68rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    padding: 0.75rem 0 0;
    border-top: 1px solid var(--border);
  }
  .share-meta span { display: flex; align-items: center; gap: 0.3rem; }
  .share-size-warn { color: var(--accent2); }

  /* Shared view banner */
  .shared-banner {
    background: linear-gradient(90deg, rgba(0,229,255,0.08), rgba(124,58,255,0.08));
    border: 1px solid rgba(0,229,255,0.25);
    border-radius: 12px;
    padding: 0.9rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.82rem;
  }
  .shared-banner-icon { font-size: 1.4rem; flex-shrink: 0; }
  .shared-banner-text { flex: 1; }
  .shared-banner-title { font-weight: 700; margin-bottom: 0.2rem; }
  .shared-banner-sub   { color: var(--muted); font-size: 0.74rem; }
  .shared-banner-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1rem; padding: 0.2rem; }
  .shared-banner-close:hover { color: var(--text); }

  .version-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 2rem;
    overflow: hidden;
  }
  .version-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    cursor: pointer;
    user-select: none;
  }
  .version-panel-header h3 {
    font-size: 0.72rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
    letter-spacing: 0.12em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .version-count-badge {
    background: rgba(0,229,255,0.12);
    border: 1px solid rgba(0,229,255,0.25);
    border-radius: 20px;
    padding: 0.1rem 0.5rem;
    font-size: 0.62rem;
    color: var(--accent);
  }
  .version-toggle-icon {
    font-size: 0.75rem;
    color: var(--muted);
    transition: transform 0.2s;
  }
  .version-toggle-icon.open { transform: rotate(180deg); }

  .version-timeline {
    padding: 1rem 1.5rem;
    display: none;
  }
  .version-timeline.open { display: block; }

  .version-entry {
    display: flex;
    gap: 1rem;
    position: relative;
    padding-bottom: 1.25rem;
  }
  .version-entry:last-child { padding-bottom: 0; }
  .version-entry:not(:last-child)::before {
    content: '';
    position: absolute;
    left: 13px;
    top: 28px;
    bottom: 0;
    width: 1px;
    background: var(--border);
  }

  .version-dot-col { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
  .version-dot {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: 2px solid var(--border);
    background: var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .version-entry.current .version-dot {
    border-color: var(--accent);
    background: rgba(0,229,255,0.12);
    color: var(--accent);
    box-shadow: 0 0 10px rgba(0,229,255,0.2);
  }
  .version-entry.origin .version-dot {
    border-color: var(--success);
    background: rgba(0,255,136,0.1);
    color: var(--success);
  }

  .version-card {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 1rem;
    transition: all 0.18s;
    min-width: 0;
  }
  .version-entry.current .version-card {
    border-color: rgba(0,229,255,0.35);
    background: rgba(0,229,255,0.04);
  }
  .version-card-top {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
    flex-wrap: wrap;
  }
  .version-label {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .version-time {
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    white-space: nowrap;
  }
  .version-current-tag {
    font-size: 0.58rem;
    font-family: 'Space Mono', monospace;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    background: rgba(0,229,255,0.12);
    border: 1px solid rgba(0,229,255,0.3);
    color: var(--accent);
    white-space: nowrap;
  }

  .version-diff {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    margin-bottom: 0.5rem;
  }
  .diff-tag {
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    border: 1px solid;
  }
  .diff-added   { color: var(--success); border-color: rgba(0,255,136,0.3); background: rgba(0,255,136,0.08); }
  .diff-removed { color: var(--accent2); border-color: rgba(255,107,53,0.3); background: rgba(255,107,53,0.08); }
  .diff-changed { color: #ffd580;        border-color: rgba(255,213,128,0.3); background: rgba(255,213,128,0.08); }

  .version-agents {
    font-size: 0.7rem;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    margin-bottom: 0.6rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .version-actions {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
  }
  .version-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 6px;
    padding: 0.25rem 0.6rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .version-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .version-btn.restore-btn:hover {
    border-color: var(--success);
    color: var(--success);
    background: rgba(0,255,136,0.06);
  }
  .version-btn.diff-btn:hover {
    border-color: #ffd580;
    color: #ffd580;
  }

  /* diff modal */
  .diff-modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
  .diff-section { margin-bottom: 1.5rem; }
  .diff-section-title {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.1em;
    margin-bottom: 0.75rem;
    padding-bottom: 0.4rem;
    border-bottom: 1px solid var(--border);
  }
  .diff-agent-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.4rem;
    font-size: 0.82rem;
  }
  .diff-agent-row.row-added   { background: rgba(0,255,136,0.06); border: 1px solid rgba(0,255,136,0.15); }
  .diff-agent-row.row-removed { background: rgba(255,107,53,0.06); border: 1px solid rgba(255,107,53,0.15); }
  .diff-agent-row.row-changed { background: rgba(255,213,128,0.05); border: 1px solid rgba(255,213,128,0.15); }
  .diff-agent-row .row-icon { font-size: 1rem; }
  .diff-agent-name { font-weight: 600; flex: 1; }
  .diff-agent-role { font-size: 0.7rem; color: var(--muted); font-family: 'Space Mono', monospace; }

  .fw-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 92%;
    max-width: 900px;
    max-height: 88vh;
    display: flex;
    flex-direction: column;
    animation: modalIn 0.25s ease;
  }
  .fw-tabs {
    display: flex;
    gap: 0.5rem;
    padding: 1rem 1.5rem 0;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    flex-shrink: 0;
  }
  .fw-tab {
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    padding: 0.5rem 1.1rem 0.7rem;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    white-space: nowrap;
    transition: all 0.18s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .fw-tab:hover { color: var(--text); }
  .fw-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .fw-tab .fw-badge {
    font-size: 0.58rem;
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    background: rgba(0,229,255,0.1);
    border: 1px solid rgba(0,229,255,0.25);
    color: var(--accent);
  }

  /* Prompt export tab buttons (#7) */
  .prompt-tab-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.4rem 0.9rem;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    transition: all 0.18s;
  }
  .prompt-tab-btn:hover { color: var(--text); border-color: var(--accent); }
  .prompt-tab-btn.active {
    background: rgba(0,229,255,0.1);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* ── IMPORT MODAL (#4) ── */
  .import-dropzone {
    border: 2px dashed var(--border);
    border-radius: 14px;
    padding: 2rem 1.5rem;
    text-align: center;
    transition: all 0.2s;
    background: var(--surface2);
    cursor: default;
  }
  .import-dropzone.drag-over {
    border-color: var(--accent);
    background: rgba(0,229,255,0.05);
    transform: scale(1.01);
  }
  .fw-body {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .fw-pane {
    display: none;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
  }
  .fw-pane.active {
    display: flex;
  }
  .fw-info {
    padding: 1rem 1.5rem 0.75rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;
  }
  .fw-info-text { flex: 1; }
  .fw-info-title {
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 0.2rem;
  }
  .fw-info-desc {
    font-size: 0.78rem;
    color: var(--muted);
    line-height: 1.5;
  }
  .fw-info-logo {
    font-size: 2rem;
    flex-shrink: 0;
  }
  .fw-code-wrap {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem 1.5rem;
    background: var(--bg);
  }
  .fw-code-wrap pre {
    margin: 0;
    border: none;
    background: none;
    padding: 0;
    font-size: 0.78rem;
    line-height: 1.7;
    color: var(--text);
    white-space: pre;
    overflow-x: auto;
  }
  /* Syntax-lite: keywords */
  .fw-code-wrap .kw  { color: #7c9eff; }
  .fw-code-wrap .str { color: #a8d8a8; }
  .fw-code-wrap .cmt { color: var(--muted); font-style: italic; }
  .fw-code-wrap .fn  { color: #ffd580; }
  .fw-code-wrap .cls { color: #ff9dd0; }
  .fw-footer-row {
    padding: 0.75rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-shrink: 0;
  }
  .fw-pip {
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.3rem 0.75rem;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
</style>
</head>
<body>
<div class="offline-bar" id="offline-bar">📡 You're offline — AgentSpark loaded from cache</div>
<div id="app">

  <header>
    <div class="logo">
      <div class="logo-icon">⚡</div>
      Agent<span>Spark</span>
    </div>
    <div style="display:flex;align-items:center;gap:1rem;">
      <button class="btn-projects-header" onclick="openProjectsScreen()" id="btn-my-projects" title="My Projects">
        📁 <span id="projects-count-badge" style="display:none;"></span>My Projects
      </button>
      <span class="save-indicator" id="save-indicator">✓ saved</span>
      <div id="apiKeyHeader" style="display:none;align-items:center;gap:0.5rem;">
        <span id="headerModelBadge" style="font-family:'Space Mono',monospace;font-size:0.62rem;padding:0.2rem 0.55rem;border-radius:4px;background:rgba(0,229,255,0.1);border:1px solid rgba(0,229,255,0.25);color:var(--accent);white-space:nowrap;"></span>
        <input type="password" class="input-field" id="apiKeyInput" placeholder="API Key" style="width:190px;padding:0.5rem 1rem;font-size:0.82rem;" oninput="checkApiKey()"/>
        <span class="api-key-status" id="apiKeyStatus"></span>
      </div>
      <div class="lang-switch">
        <button class="lang-btn active" onclick="setLang('en')" id="btn-en">EN</button>
        <button class="lang-btn" onclick="setLang('pl')" id="btn-pl">PL</button>
      </div>
      <button class="theme-toggle" id="theme-toggle-btn"
        onmousedown="_themeHoldStart()" ontouchstart="_themeHoldStart()"
        onmouseup="toggleTheme()" ontouchend="toggleTheme()"
        onmouseleave="if(_themeHoldTimer){clearTimeout(_themeHoldTimer);_themeHoldTimer=null;}"
        title="Click: toggle theme | Hold: follow OS">🌙</button>
    </div>
  </header>

  <main>

    <!-- SCREEN 0: MY PROJECTS -->
    <div class="screen" id="screen-projects">
      <div class="hero" style="padding-bottom:1rem;">
        <div class="hero-badge">MY PROJECTS</div>
        <h2 id="projects-title" style="font-size:2rem;margin-bottom:0.5rem;">Saved Projects</h2>
        <p style="color:var(--muted);font-size:0.9rem;">Pick up where you left off or start something new.</p>
      </div>
      <div style="max-width:900px;margin:0 auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;gap:1rem;flex-wrap:wrap;">
          <input id="projects-search" type="text" class="input-field" placeholder="🔍 Search projects…"
            style="max-width:280px;padding:0.55rem 1rem;font-size:0.85rem;" oninput="renderProjectsList()"/>
          <button class="btn-primary" onclick="showScreen('topic')" style="flex-shrink:0;">+ New Project</button>
        </div>
        <div id="projects-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1.25rem;"></div>
        <div id="projects-empty" style="display:none;text-align:center;padding:4rem 2rem;color:var(--muted);">
          <div style="font-size:3rem;margin-bottom:1rem;">📂</div>
          <div style="font-size:1rem;font-weight:600;margin-bottom:0.5rem;">No projects yet</div>
          <div style="font-size:0.85rem;">Start your first AI team and it will appear here.</div>
        </div>
      </div>
    </div>

    <!-- SCREEN 1: TOPIC SELECTION -->
    <div class="screen active" id="screen-topic">
      <div class="hero">
        <div class="hero-badge" id="badge-text">AI AGENT TEAM GENERATOR</div>
        <h1 id="hero-title">Build Your<br/>AI Dream Team</h1>
        <p id="hero-sub">Choose a topic. Answer a few questions. Get a complete AI agent team — ready to build your app with Google Antigravity.</p>

        <div id="apiKeySetup" style="max-width:480px;margin:0 auto 2.5rem;">
          <div class="model-select-wrap">
            <label class="api-label">AI Model</label>
            <select class="model-select" id="modelSelect" onchange="onModelChange()">
              <optgroup label="── Google Gemini ──">
                <option value="gemini|gemini-3.1-pro|https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}|gemini">Gemini 3.1 Pro</option>
                <option value="gemini|gemini-3-flash|https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}|gemini">Gemini 3 Flash</option>
                <option value="gemini|gemini-2.5-pro|https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}|gemini">Gemini 2.5 Pro</option>
                <option value="gemini|gemini-3-flash-preview|https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}|gemini" selected>Gemini 3 Flash Preview</option>
              </optgroup>
              <optgroup label="── OpenAI GPT ──">
                <option value="openai|gpt-5.2|https://api.openai.com/v1/chat/completions|openai">GPT-5.2</option>
                <option value="openai|gpt-5.1|https://api.openai.com/v1/chat/completions|openai">GPT-5.1</option>
                <option value="openai|gpt-5|https://api.openai.com/v1/chat/completions|openai">GPT-5</option>
                <option value="openai|gpt-5-mini|https://api.openai.com/v1/chat/completions|openai">GPT-5 mini</option>
                <option value="openai|gpt-5-nano|https://api.openai.com/v1/chat/completions|openai">GPT-5 nano</option>
              </optgroup>
              <optgroup label="── Anthropic Claude ──">
                <option value="anthropic|claude-opus-4-6|https://api.anthropic.com/v1/messages|anthropic">Claude Opus 4.6</option>
                <option value="anthropic|claude-opus-4-5|https://api.anthropic.com/v1/messages|anthropic">Claude Opus 4.5</option>
                <option value="anthropic|claude-sonnet-4-5|https://api.anthropic.com/v1/messages|anthropic">Claude Sonnet 4.5</option>
                <option value="anthropic|claude-haiku-4-5-20251001|https://api.anthropic.com/v1/messages|anthropic">Claude Haiku 4.5</option>
              </optgroup>
              <optgroup label="── Mistral ──">
                <option value="openai|mistral-large-latest|https://api.mistral.ai/v1/chat/completions|mistral">Mistral Large 3</option>
                <option value="openai|ministral-14b-latest|https://api.mistral.ai/v1/chat/completions|mistral">Ministral 14B</option>
                <option value="openai|ministral-8b-latest|https://api.mistral.ai/v1/chat/completions|mistral">Ministral 8B</option>
                <option value="openai|ministral-3b-latest|https://api.mistral.ai/v1/chat/completions|mistral">Ministral 3B</option>
              </optgroup>
              <optgroup label="── Groq ──">
                <option value="openai|llama-3.3-70b-versatile|https://api.groq.com/openai/v1/chat/completions|groq">Llama 3.3 70B</option>
                <option value="openai|llama-3.1-8b-instant|https://api.groq.com/openai/v1/chat/completions|groq">Llama 3.1 8B</option>
              </optgroup>
</select>
            <div class="model-hint" id="modelHint">Key: Google AI Studio → <strong>makersuite.google.com</strong></div>
          </div>
          <label class="api-label"><span id="apiKeyLabel">Gemini API Key</span> <span style="color:var(--muted);font-size:0.7rem;">(required)</span></label>
          <div class="api-key-area">
            <input type="password" class="input-field" id="apiKeySetupInput" placeholder="AIza..." oninput="syncApiKey(this.value)"/>
          </div>
          <div class="api-key-status" id="apiKeySetupStatus"></div>
        </div>

        <div class="level-section">
          <span class="level-section-label" id="level-section-label">COMPLEXITY LEVEL</span>
          <div class="level-grid" id="level-grid"></div>
        </div>

        <div class="template-filters" id="template-filters"></div>
        <div class="topic-grid" id="topic-grid"></div>

        <div class="or-divider" id="or-text">— or describe your own —</div>
        <div class="custom-topic">
          <input type="text" class="input-field" id="customTopic" placeholder="e.g. AI-powered recipe recommender..."/>
          <button class="btn-primary" onclick="startWithTopic()" id="start-btn">Start →</button>
        </div>
        <div style="text-align:center;margin-top:1.25rem;">
          <button class="btn-secondary" onclick="openImportModal()" style="font-size:0.82rem;padding:0.55rem 1.25rem;">
            📥 Import existing project (.json / .zip)
          </button>
        </div>
      </div>
    </div>

    <!-- SCREEN 2: CHAT INTERVIEW -->
    <div class="screen" id="screen-chat">
      <div class="chat-layout">
        <div class="chat-main">
          <div class="chat-header">
            <div class="status-dot"></div>
            <div>
              <div class="title" id="chat-title">AI Interview</div>
              <div class="subtitle" id="chat-subtitle">Building your agent profile...</div>
            </div>
            <button class="sidebar-toggle-btn" onclick="toggleChatSidebar()" id="sidebar-toggle-btn" title="Toggle sidebar">▶</button>
          </div>
          <div class="chat-messages" id="chat-messages"></div>
          <div class="chat-input-area" id="chat-input-area" style="flex-direction:column;padding:1rem 1.5rem;">
            <div id="options-container" style="display:flex;flex-wrap:wrap;gap:0.5rem;"></div>
          </div>
        </div>
        <div class="chat-sidebar">
          <div class="sidebar-card">
            <h3>PROGRESS</h3>
            <div class="progress-steps" id="progress-steps"></div>
          </div>
          <div class="sidebar-card">
            <h3>TOPIC</h3>
            <div id="sidebar-topic" style="font-size:0.9rem;font-weight:600;"></div>
            <div id="sidebar-topic-sub" style="font-size:0.75rem;color:var(--muted);margin-top:0.25rem;"></div>
          </div>
          <div class="sidebar-card">
            <h3>LEVEL</h3>
            <div id="sidebar-level" style="font-size:1.3rem;"></div>
            <div id="sidebar-level-name" style="font-size:0.9rem;font-weight:700;margin-top:0.2rem;"></div>
            <div id="sidebar-level-desc" style="font-size:0.72rem;color:var(--muted);margin-top:0.2rem;line-height:1.4;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SCREEN 3: RESULTS -->
    <div class="screen" id="screen-results">
      <!-- Shared view banner (shown when loaded via shared URL) -->
      <div id="shared-banner" class="shared-banner" style="display:none;">
        <div class="shared-banner-icon">🔗</div>
        <div class="shared-banner-text">
          <div class="shared-banner-title" id="shared-banner-title">Shared team</div>
          <div class="shared-banner-sub" id="shared-banner-sub">This is a read-only shared view. Start Over to create your own.</div>
        </div>
        <button class="shared-banner-close" onclick="document.getElementById('shared-banner').style.display='none'">✕</button>
      </div>

      <div class="results-header">
        <div class="hero-badge" id="result-badge">MISSION COMPLETE</div>
        <h2 id="result-title">Your AI Team is Ready</h2>
        <p id="result-sub" style="color:var(--muted);">Download your files and deploy to Google Antigravity</p>
      </div>

      <div class="results-actions">
        <h3>ACTIONS</h3>
        <div class="actions-row">
          <button class="btn-primary" onclick="downloadZip()" id="download-btn">⬇ Download ZIP</button>
          <button class="btn-secondary" onclick="openImportModal()" id="import-btn">📥 Import</button>
          <button class="btn-secondary" onclick="openShareModal()" id="share-btn">🔗 Share</button>
          <button class="btn-secondary" onclick="openFrameworkExport()" id="fw-export-btn">🚀 Export Framework</button>
          <button class="btn-secondary" onclick="openMarkdownPreview()" id="md-preview-btn">📄 Preview Docs</button>
          <button class="btn-secondary" onclick="openRefine()" id="refine-btn">✏ Refine Team</button>
          <button class="btn-secondary" onclick="showInstructions()" id="instr-btn">📋 Instructions</button>
          <button class="btn-secondary" onclick="saveCurrentProject()">💾 Save Project</button>
          <button class="btn-secondary" onclick="openPromptExport()">📋 System Prompts</button>
          <button class="btn-secondary" onclick="restart()">↩ Start Over</button>
        </div>
      </div>

      <!-- REFINE PANEL -->
      <div id="refine-panel" class="refine-panel" style="display:none;">
        <div class="refine-header">
          <div>
            <h3 id="refine-title">Refine Your Team</h3>
            <p id="refine-sub">Tell the AI what you want to change.</p>
          </div>
          <button class="refine-close-btn" onclick="closeRefine()">✕</button>
        </div>
        <div class="refine-action-chips" id="refine-action-chips"></div>
        <div class="refine-history" id="refine-history"></div>
        <div class="refine-input-row">
          <textarea class="refine-textarea" id="refine-input"
            placeholder="e.g. Add a Security Agent..."
            rows="2"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitRefine();}"></textarea>
          <button class="btn-primary refine-submit-btn" id="refine-submit-btn" onclick="submitRefine()">
            <span id="refine-submit-label">Apply →</span>
          </button>
        </div>
        <div class="refine-footer">
          <span id="refine-counter" style="font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;"></span>
          <button class="refine-revert-btn" id="refine-revert-btn" onclick="revertLastRefine()" style="display:none;">
            ↩ Revert last change
          </button>
        </div>
      </div>

      <!-- SCORING PANEL -->
      <div id="scoring-panel" class="scoring-panel" style="display:none;"></div>

      <!-- TRACE VIEWER PANEL -->
      <div id="trace-panel" class="trace-panel" style="display:none;">
        <div class="trace-panel-header" onclick="toggleTracePanel()">
          <h3>⚡ EXECUTION TRACE <span id="trace-span-count" class="version-count-badge">0</span></h3>
          <div style="display:flex;align-items:center;gap:0.75rem;">
            <div class="trace-summary-pills" id="trace-summary-pills"></div>
            <span class="version-toggle-icon" id="trace-toggle-icon">▼</span>
          </div>
        </div>
        <div class="trace-body" id="trace-body">
          <div class="trace-gantt-header">
            <div>STEP</div>
            <div>TIMELINE</div>
            <div style="text-align:right">DURATION</div>
            <div class="th-tokens" style="text-align:right">TOKENS</div>
            <div class="th-status" style="text-align:right">STATUS</div>
          </div>
          <div id="trace-spans"></div>
          <div class="trace-footer" id="trace-footer"></div>
        </div>
      </div>

      <!-- VERSION HISTORY PANEL -->
      <div id="version-panel" class="version-panel" style="display:none;">
        <div class="version-panel-header" onclick="toggleVersionPanel()">
          <h3>🕓 VERSION HISTORY <span class="version-count-badge" id="version-count-badge">0</span></h3>
          <span class="version-toggle-icon" id="version-toggle-icon">▼</span>
        </div>
        <div class="version-timeline" id="version-timeline"></div>
      </div>

      <!-- DEPENDENCY GRAPH -->
      <div id="graph-section" class="graph-section" style="display:none;">
        <div class="section-header-bar">
          <span>🕸</span>
          <span id="graph-title">Agent Dependency Graph</span>
        </div>
        <div class="graph-container">
          <canvas id="agent-graph" width="800" height="400"></canvas>
        </div>
      </div>

      <div id="agents-grid" class="agents-grid"></div>

      <div id="instructions-section" class="instructions" style="display:none;">
        <h3 id="instr-title">How to upload to Google Antigravity</h3>
        <div class="instruction-steps" id="instr-steps"></div>
      </div>
    </div>

  </main>
</div>

<!-- ── FILE PREVIEW MODAL ── -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title"></div>
      <div class="modal-tabs">
        <button class="modal-tab active" id="tab-preview" onclick="switchModalTab('preview')">
          👁 Preview
        </button>
        <button class="modal-tab" id="tab-raw" onclick="switchModalTab('raw')">
          &lt;/&gt; Raw
        </button>
      </div>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div class="modal-body" id="modal-body">
      <div id="modal-preview-pane" class="md-preview"></div>
      <pre id="modal-raw-pane" style="display:none;"></pre>
    </div>
    <div class="modal-footer">
      <span style="font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;" id="modal-filesize"></span>
      <button class="modal-download-btn" onclick="downloadCurrentFile()">⬇ Download file</button>
    </div>
  </div>
</div>

<!-- ── MARKDOWN PREVIEW BROWSER MODAL ── -->
<div class="modal-overlay" id="md-browser-modal">
  <div class="modal" style="max-width:960px;">
    <div class="modal-header">
      <div class="modal-title" id="md-browser-title">📄 Documentation Preview</div>
      <button class="modal-close" onclick="closeMdBrowser()">✕</button>
    </div>
    <div style="display:flex;height:calc(85vh - 120px);">
      <!-- Sidebar file list -->
      <div id="md-browser-sidebar" style="
        width:220px;
        flex-shrink:0;
        border-right:1px solid var(--border);
        overflow-y:auto;
        padding:0.75rem 0;
        background:var(--surface2);
      "></div>
      <!-- Content pane -->
      <div style="flex:1;overflow-y:auto;padding:1.5rem;" id="md-browser-content">
        <div class="md-preview" id="md-browser-rendered"></div>
      </div>
    </div>
    <div class="modal-footer">
      <span style="font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;" id="md-browser-active-file"></span>
      <button class="modal-download-btn" onclick="downloadAllMd()">⬇ Download all .md</button>
    </div>
  </div>
</div>

<!-- ── SHARE MODAL ── -->
<div class="modal-overlay" id="share-modal">
  <div class="share-modal">
    <div class="modal-header">
      <div class="modal-title">🔗 Share Your Team</div>
      <button class="modal-close" onclick="closeShareModal()">✕</button>
    </div>
    <div style="padding:1.5rem;">
      <div class="share-options" id="share-options">
        <label class="share-option active" id="share-opt-open">
          <input type="radio" name="share-mode" value="open" checked onchange="onShareModeChange()">
          <div class="share-option-text">
            <div class="share-option-label">🌍 Public link</div>
            <div class="share-option-desc">Anyone with the link can view this team</div>
          </div>
        </label>
        <label class="share-option" id="share-opt-password">
          <input type="radio" name="share-mode" value="password" onchange="onShareModeChange()">
          <div class="share-option-text">
            <div class="share-option-label">🔒 Password protected <span style="font-size:0.65rem;font-family:'Space Mono',monospace;padding:0.1rem 0.4rem;border-radius:3px;background:rgba(0,229,255,0.1);border:1px solid rgba(0,229,255,0.2);color:var(--accent);vertical-align:middle;margin-left:0.3rem;">AES-256-GCM</span></div>
            <div class="share-option-desc">End-to-end encrypted — only someone with the password can read this team</div>
          </div>
          <div class="share-password-row" id="share-password-row" style="display:none;width:100%;">
            <input type="text" class="input-field" id="share-password-input" placeholder="Set a password…" oninput="generateShareUrl()" style="font-size:0.82rem;padding:0.5rem 0.8rem;">
          </div>
        </label>
      </div>

      <div class="share-url-row">
        <input type="text" class="share-url-input" id="share-url-display" readonly placeholder="Generating link…">
        <button class="share-copy-btn" id="share-copy-btn" onclick="copyShareUrl()">📋 Copy</button>
      </div>

      <div class="share-meta" id="share-meta">
        <span>📦 <span id="share-size-label">–</span></span>
        <span>⚡ <span id="share-agent-count">–</span></span>
        <span>🕓 <span id="share-version-label">–</span></span>
      </div>
    </div>
  </div>
</div>

<!-- ── FRAMEWORK EXPORT MODAL ── -->
<div class="modal-overlay" id="fw-modal">
  <div class="fw-modal">
    <div class="modal-header">
      <div class="modal-title">🚀 Export to Framework</div>
      <button class="modal-close" onclick="closeFwModal()">✕</button>
    </div>
    <div class="fw-tabs" id="fw-tabs"></div>
    <div class="fw-body" id="fw-body"></div>
  </div>
</div>

<!-- ── PROMPT EXPORT MODAL (#7) ── -->
<div class="modal-overlay" id="prompt-export-modal">
  <div class="modal" style="max-width:720px;max-height:85vh;display:flex;flex-direction:column;">
    <div class="modal-header">
      <div class="modal-title">📋 System Prompts</div>
      <button class="modal-close" onclick="closePromptExport()">✕</button>
    </div>
    <div style="display:flex;gap:0.5rem;padding:1rem 1.5rem 0;flex-shrink:0;">
      <button class="prompt-tab-btn active" id="ptab-interview" onclick="switchPromptTab('interview')">🎤 Interview</button>
      <button class="prompt-tab-btn" id="ptab-generate" onclick="switchPromptTab('generate')">⚡ Generate</button>
      <button class="prompt-tab-btn" id="ptab-refine" onclick="switchPromptTab('refine')">✏ Refine</button>
    </div>
    <div style="padding:1rem 1.5rem;flex:1;overflow:hidden;display:flex;flex-direction:column;gap:0.75rem;">
      <div style="font-size:0.72rem;color:var(--muted);font-family:'Space Mono',monospace;" id="prompt-tab-desc"></div>
      <textarea id="prompt-export-textarea" readonly
        style="flex:1;min-height:320px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;
               color:var(--text);font-family:'Space Mono',monospace;font-size:0.72rem;padding:1rem;
               resize:none;line-height:1.6;outline:none;"></textarea>
      <div style="display:flex;gap:0.75rem;flex-shrink:0;">
        <button class="btn-primary" onclick="copyPromptToClipboard()" id="copy-prompt-btn">📋 Copy to clipboard</button>
        <button class="btn-secondary" onclick="downloadPromptTxt()">⬇ Download .txt</button>
        <span id="copy-prompt-feedback" style="font-size:0.78rem;color:var(--success);align-self:center;opacity:0;transition:opacity 0.3s;"></span>
      </div>
    </div>
  </div>
</div>

<!-- ── PASSWORD UNLOCK MODAL (#3) ── -->
<div class="modal-overlay" id="unlock-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">🔒 Password Protected</div>
      <button class="modal-close" onclick="_unlockReject()">✕</button>
    </div>
    <div style="padding:1.5rem;display:flex;flex-direction:column;gap:1rem;">
      <p style="font-size:0.88rem;color:var(--muted);" id="unlock-modal-desc">This team is password protected. Enter the password to unlock it.</p>
      <input type="password" class="input-field" id="unlock-password-input"
        placeholder="Enter password…"
        style="font-size:0.9rem;"
        onkeydown="if(event.key==='Enter') _unlockConfirm()"
        autocomplete="current-password"/>
      <div id="unlock-error" style="display:none;font-size:0.8rem;color:var(--accent2);">⚠ Wrong password. Please try again.</div>
      <div style="display:flex;gap:0.75rem;">
        <button class="btn-primary" onclick="_unlockConfirm()" style="flex:1;">Unlock</button>
        <button class="btn-secondary" onclick="_unlockReject()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ── IMPORT MODAL (#4) ── -->
<div class="modal-overlay" id="import-modal">
  <div class="modal" style="max-width:620px;">
    <div class="modal-header">
      <div class="modal-title">📥 Import Project</div>
      <button class="modal-close" onclick="closeImportModal()">✕</button>
    </div>
    <div style="padding:1.5rem;">

      <!-- Drop zone -->
      <div id="import-dropzone" class="import-dropzone"
           ondragover="event.preventDefault();this.classList.add('drag-over')"
           ondragleave="this.classList.remove('drag-over')"
           ondrop="handleImportDrop(event)">
        <div style="font-size:2.5rem;margin-bottom:0.75rem;">📂</div>
        <div style="font-weight:700;font-size:1rem;margin-bottom:0.35rem;" id="import-dz-title">Drop your file here</div>
        <div style="font-size:0.78rem;color:var(--muted);margin-bottom:1.25rem;">Supports <code style="font-family:'Space Mono',monospace;font-size:0.72rem;">.json</code> and <code style="font-family:'Space Mono',monospace;font-size:0.72rem;">.zip</code> from AgentSpark</div>
        <label class="btn-secondary" style="cursor:pointer;display:inline-flex;align-items:center;gap:0.5rem;padding:0.6rem 1.25rem;font-size:0.85rem;">
          📁 Browse file
          <input type="file" id="import-file-input" accept=".json,.zip" style="display:none" onchange="handleImportFileSelect(this)"/>
        </label>
      </div>

      <!-- Preview panel (hidden until file parsed) -->
      <div id="import-preview" style="display:none;margin-top:1.25rem;">
        <div style="font-size:0.72rem;font-family:'Space Mono',monospace;color:var(--accent);letter-spacing:0.08em;margin-bottom:0.75rem;">PREVIEW</div>
        <div id="import-preview-content" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:1rem;font-size:0.82rem;line-height:1.7;"></div>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;">
          <button class="btn-primary" onclick="confirmImport()">✓ Import</button>
          <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.8rem;color:var(--muted);cursor:pointer;">
            <input type="checkbox" id="import-save-checkbox" checked style="accent-color:var(--accent);"/>
            Save as project
          </label>
          <button class="btn-secondary" style="margin-left:auto;" onclick="resetImportModal()">✕ Clear</button>
        </div>
      </div>

      <!-- Error display -->
      <div id="import-error" style="display:none;margin-top:1rem;padding:0.75rem 1rem;background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.3);border-radius:8px;font-size:0.82rem;color:var(--accent2);"></div>
    </div>
  </div>
</div>

<!-- ── VERSION DIFF MODAL ── -->
<div class="modal-overlay" id="diff-modal">
  <div class="modal" style="max-width:680px;">
    <div class="modal-header">
      <div class="modal-title" id="diff-modal-title">🔍 Compare Versions</div>
      <button class="modal-close" onclick="closeDiffModal()">✕</button>
    </div>
    <div class="diff-modal-body" id="diff-modal-body"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════
// ─── PERSISTENT PROJECTS (#1) ────────────────────────────
// ═══════════════════════════════════════════════════════════

const DB_NAME    = 'agentspark-db';
const DB_VERSION = 1;
const STORE_NAME = 'projects';
let _db = null;
let _currentProjectId = null;  // null = unsaved/new session

// ── IndexedDB init ────────────────────────────────────────
function dbOpen() {
  return new Promise((resolve, reject) => {
    if (_db) { resolve(_db); return; }
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        store.createIndex('updatedAt', 'updatedAt', { unique: false });
      }
    };
    req.onsuccess = e => { _db = e.target.result; resolve(_db); };
    req.onerror   = e => reject(e.target.error);
  });
}

async function dbGetAll() {
  const db = await dbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const req = tx.objectStore(STORE_NAME).index('updatedAt').getAll();
    req.onsuccess = e => resolve(e.target.result.reverse()); // newest first
    req.onerror   = e => reject(e.target.error);
  });
}

async function dbGet(id) {
  const db = await dbOpen();
  return new Promise((resolve, reject) => {
    const req = db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).get(id);
    req.onsuccess = e => resolve(e.target.result);
    req.onerror   = e => reject(e.target.error);
  });
}

async function dbPut(project) {
  const db = await dbOpen();
  return new Promise((resolve, reject) => {
    const req = db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).put(project);
    req.onsuccess = e => resolve(e.target.result);
    req.onerror   = e => reject(e.target.error);
  });
}

async function dbDelete(id) {
  const db = await dbOpen();
  return new Promise((resolve, reject) => {
    const req = db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(id);
    req.onsuccess = e => resolve();
    req.onerror   = e => reject(e.target.error);
  });
}

// ── Project helpers ───────────────────────────────────────
function _projectSnapshot() {
  return {
    topic:          currentTopic,
    level:          currentLevel,
    lang:           lang,
    modelProvider:  selectedModel.provider,
    modelId:        selectedModel.model,
    agents:         JSON.parse(JSON.stringify(generatedAgents)),
    files:          JSON.parse(JSON.stringify(generatedFiles)),
    versionHistory: JSON.parse(JSON.stringify(versionHistory)),
    chatHistory:    JSON.parse(JSON.stringify(chatHistory)),
  };
}

function _projectName(topic) {
  return topic || 'Untitled Project';
}

// ── Save / Auto-save ──────────────────────────────────────
let _autoSaveTimer = null;
function scheduleAutoSave() {
  if (!generatedAgents.length) return; // nothing to save yet
  clearTimeout(_autoSaveTimer);
  _autoSaveTimer = setTimeout(() => saveCurrentProject(true), 2000);
}

async function saveCurrentProject(silent = false) {
  if (!generatedAgents.length) {
    if (!silent) showNotif(lang === 'en' ? '⚠ Generate a team first before saving' : '⚠ Najpierw wygeneruj zespół', true);
    return;
  }
  try {
    const now = Date.now();
    const snap = _projectSnapshot();
    if (_currentProjectId) {
      // Update existing
      const existing = await dbGet(_currentProjectId);
      if (existing) {
        await dbPut({ ...existing, ...snap, updatedAt: now });
      } else {
        _currentProjectId = null; // was deleted externally — create new
      }
    }
    if (!_currentProjectId) {
      // Create new
      _currentProjectId = 'proj_' + now + '_' + Math.random().toString(36).slice(2,7);
      await dbPut({
        id:        _currentProjectId,
        name:      _projectName(currentTopic),
        createdAt: now,
        updatedAt: now,
        ...snap
      });
    } else {
      // Just update name in case topic changed
      const existing = await dbGet(_currentProjectId);
      if (existing) await dbPut({ ...existing, name: _projectName(currentTopic), updatedAt: now, ...snap });
    }
    _showSaveIndicator();
    await _updateProjectsBadge();
    if (!silent) showNotif(lang === 'en' ? '✓ Project saved!' : '✓ Projekt zapisany!');
  } catch(e) {
    console.error('[AgentSpark] Save failed:', e);
    if (!silent) showNotif(lang === 'en' ? '⚠ Save failed: ' + e.message : '⚠ Błąd zapisu: ' + e.message, true);
  }
}

function _showSaveIndicator() {
  const el = document.getElementById('save-indicator');
  if (!el) return;
  el.textContent = '✓ saved';
  el.classList.add('visible');
  clearTimeout(_showSaveIndicator._t);
  _showSaveIndicator._t = setTimeout(() => el.classList.remove('visible'), 2500);
}

// ── Load project ──────────────────────────────────────────
async function loadProject(id) {
  try {
    const proj = await dbGet(id);
    if (!proj) { showNotif('⚠ Project not found', true); return; }

    // Restore all state
    currentTopic      = proj.topic      || '';
    currentLevel      = proj.level      || 'iskra';
    lang              = proj.lang       || 'en';
    generatedAgents   = proj.agents     || [];
    generatedFiles    = proj.files      || {};
    versionHistory    = proj.versionHistory || [];
    chatHistory       = proj.chatHistory    || [];
    _currentProjectId = proj.id;

    // Restore model if stored
    if (proj.modelId) {
      const opt = document.querySelector(`#modelSelect option[value*="${proj.modelId}"]`);
      if (opt) { opt.selected = true; onModelChange(); }
    }
    // Restore lang
    setLang(lang);

    // Show results screen
    showScreen('results');
    document.getElementById('apiKeyHeader').style.display = 'flex';
    renderResults();
    _showSaveIndicator();
    showNotif(lang === 'en' ? `📂 "${proj.name}" loaded` : `📂 Załadowano "${proj.name}"`);
  } catch(e) {
    console.error('[AgentSpark] Load failed:', e);
    showNotif('⚠ Failed to load project: ' + e.message, true);
  }
}

// ── Delete project ────────────────────────────────────────
async function deleteProject(id, name) {
  const confirmed = window.confirm(
    lang === 'en'
      ? `Delete project "${name}"? This cannot be undone.`
      : `Usunąć projekt "${name}"? Tej operacji nie można cofnąć.`
  );
  if (!confirmed) return;
  try {
    await dbDelete(id);
    if (_currentProjectId === id) _currentProjectId = null;
    await renderProjectsList();
    await _updateProjectsBadge();
    showNotif(lang === 'en' ? '🗑 Project deleted' : '🗑 Projekt usunięty');
  } catch(e) {
    showNotif('⚠ Delete failed: ' + e.message, true);
  }
}

// ── Duplicate / Fork project ──────────────────────────────
async function forkProject(id) {
  try {
    const proj = await dbGet(id);
    if (!proj) return;
    const now = Date.now();
    const newId = 'proj_' + now + '_' + Math.random().toString(36).slice(2,7);
    await dbPut({
      ...proj,
      id:        newId,
      name:      proj.name + ' (copy)',
      createdAt: now,
      updatedAt: now,
    });
    await renderProjectsList();
    await _updateProjectsBadge();
    showNotif(lang === 'en' ? '✓ Project duplicated' : '✓ Projekt zduplikowany');
  } catch(e) {
    showNotif('⚠ Fork failed: ' + e.message, true);
  }
}

// ── Projects screen ───────────────────────────────────────
async function openProjectsScreen() {
  showScreen('projects');
  await renderProjectsList();
}

async function renderProjectsList() {
  const list    = document.getElementById('projects-list');
  const empty   = document.getElementById('projects-empty');
  const search  = (document.getElementById('projects-search')?.value || '').toLowerCase();
  if (!list) return;

  let projects = [];
  try { projects = await dbGetAll(); } catch(e) { console.error(e); }

  const filtered = search
    ? projects.filter(p => p.name.toLowerCase().includes(search) || (p.topic||'').toLowerCase().includes(search))
    : projects;

  if (!filtered.length) {
    list.innerHTML  = '';
    list.style.display  = 'none';
    empty.style.display = 'block';
    return;
  }
  list.style.display  = 'grid';
  empty.style.display = 'none';

  list.innerHTML = filtered.map(p => {
    const updated = _formatDate(p.updatedAt);
    const agentCount = (p.agents||[]).length;
    const isCurrent = p.id === _currentProjectId;
    return `
    <div class="project-card" onclick="loadProject('${p.id}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;">
        <div class="project-card-name">${_escHtml(p.name)}${isCurrent ? '<span class="project-unsaved-dot" title="Current project"></span>' : ''}</div>
      </div>
      <div class="project-card-topic">📌 ${_escHtml(p.topic||'No topic')}</div>
      <div class="project-card-meta">
        ${agentCount ? `<span class="project-card-tag">👥 ${agentCount} agents</span>` : ''}
        ${p.level ? `<span class="project-card-tag">${p.level}</span>` : ''}
        ${p.lang  ? `<span class="project-card-tag">${p.lang.toUpperCase()}</span>` : ''}
      </div>
      <div class="project-card-date">Updated ${updated}</div>
      <div class="project-card-actions" onclick="event.stopPropagation()">
        <button class="project-card-btn" onclick="loadProject('${p.id}')">▶ Open</button>
        <button class="project-card-btn" onclick="forkProject('${p.id}')">⎘ Fork</button>
        <button class="project-card-btn danger" onclick="deleteProject('${p.id}', '${_escHtml(p.name).replace(/'/g,'\\\'') }')">🗑</button>
      </div>
    </div>`;
  }).join('');
}

async function _updateProjectsBadge() {
  try {
    const all = await dbGetAll();
    const badge = document.getElementById('projects-count-badge');
    if (!badge) return;
    if (all.length > 0) {
      badge.textContent = all.length + ' ';
      badge.style.display = 'inline';
    } else {
      badge.style.display = 'none';
    }
  } catch(e) {}
}

function _formatDate(ts) {
  if (!ts) return '—';
  const d   = new Date(ts);
  const now = Date.now();
  const diff = now - ts;
  if (diff < 60000)    return 'just now';
  if (diff < 3600000)  return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  if (diff < 604800000) return Math.floor(diff/86400000) + 'd ago';
  return d.toLocaleDateString();
}

function _escHtml(str) {
  return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── Wire auto-save into agent generation ─────────────────
// Called after generatedAgents is populated (patched into renderResults)
function _onAgentsReady() {
  scheduleAutoSave();
  _updateProjectsBadge();
}

// ── Init on load ──────────────────────────────────────────
window.addEventListener('DOMContentLoaded', async () => {
  try {
    await dbOpen();
    await _updateProjectsBadge();
  } catch(e) {
    console.warn('[AgentSpark] IndexedDB init failed:', e);
  }
});

// ─── STATE ───────────────────────────────────────────────
let lang = 'en';
let apiKey = '';
let selectedModel = {
  provider: 'gemini',
  model: 'gemini-3-flash-preview',
  endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}',
  tag: 'gemini'
};
let currentTopic = '';
let currentLevel = 'iskra';
let chatHistory = [];
let conversationState = 'interview';
let questionCount = 0;
let MAX_QUESTIONS = 6;
let generatedAgents = [];
let generatedFiles = {};
let refineHistory = [];
let isRefining = false;

// Modal state
let currentModalFile = '';
let currentModalTab = 'preview';
let mdBrowserActiveFile = '';

// ─── I18N ─────────────────────────────────────────────────
const T = {
  en: {
    badge: 'AI AGENT TEAM GENERATOR',
    heroTitle: 'Build Your<br/>AI Dream Team',
    heroSub: 'Choose a topic. Answer a few questions. Get a complete AI agent team — ready to build your app with Google Antigravity.',
    orText: '— or describe your own —',
    startBtn: 'Start →',
    chatTitle: 'AI Interview',
    chatSub: 'Building your agent profile...',
    sendBtn: 'Send',
    resultBadge: 'MISSION COMPLETE',
    resultTitle: 'Your AI Team is Ready',
    resultSub: 'Download your files and deploy to Google Antigravity',
    downloadBtn: '⬇ Download ZIP',
    instrBtn: '📋 Instructions',
    restartBtn: '↩ Start Over',
    refineBtn: '✏ Refine Team',
    refineTitle: 'Refine Your Team',
    refineSub: 'Tell the AI what you want to change. Be specific.',
    refineActions: [
      { id: 'improve', emoji: '⚡', label: 'Improve team', desc: 'General improvements to all agents' },
      { id: 'add', emoji: '➕', label: 'Add an agent', desc: 'Add a new specialist to the team' },
      { id: 'remove', emoji: '🗑', label: 'Remove an agent', desc: 'Remove or merge an existing agent' },
      { id: 'connections', emoji: '🔗', label: 'Change connections', desc: 'Reroute how agents communicate' },
    ],
    refinePlaceholder: 'e.g. Add a Security Agent, or make the Backend Agent focus more on GraphQL...',
    refineApply: 'Apply Changes',
    refineCancel: 'Cancel',
    refineThinking: 'Refining your team...',
    instrTitle: 'How to upload to Google Antigravity',
    progressSteps: ['Topic chosen','Interview done','Team generated','Files ready'],

    levels: [
      {
        id: 'iskra', emoji: '✨', name: 'Iskra', tagline: 'Spark — just getting started',
        desc: 'Simple MVP, 2-3 agents, no-code friendly. Perfect for beginners.',
        color: '#00e5ff', questions: 4, agentCount: '2-3',
        focus: 'core features, simplicity, ease of use'
      },
      {
        id: 'plomien', emoji: '🔥', name: 'Płomień', tagline: 'Flame — ready to build',
        desc: 'Full-featured app, 3-4 agents, some technical knowledge assumed.',
        color: '#ff9500', questions: 5, agentCount: '3-4',
        focus: 'features, integrations, user flows, basic tech stack'
      },
      {
        id: 'pozar', emoji: '🌋', name: 'Pożar', tagline: 'Fire — serious project',
        desc: 'Complex system, 4-5 agents, APIs, auth, data pipelines.',
        color: '#ff3b30', questions: 6, agentCount: '4-5',
        focus: 'architecture, scalability, security, APIs, data models'
      },
      {
        id: 'inferno', emoji: '💀', name: 'Inferno', tagline: 'Inferno — enterprise grade',
        desc: 'Full enterprise system, 5-6 agents, microservices, CI/CD, full stack.',
        color: '#7c3aff', questions: 7, agentCount: '5-6',
        focus: 'microservices, DevOps, security, compliance, scalability, multi-tenant architecture'
      }
    ],
    topics: [
      { icon:'🛒', label:'E-Commerce App', sub:'Store, payments, catalog', cat:'business', agents:'Product, Cart, Payments, Recommendations', time:'~45s' },
      { icon:'📊', label:'Analytics Dashboard', sub:'Data, charts, reports', cat:'business', agents:'Data Ingest, Aggregator, Visualizer, Alerts', time:'~40s' },
      { icon:'💼', label:'SaaS Dev Team', sub:'Multi-tenant SaaS product', cat:'business', agents:'Auth, Billing, API, Infra, Onboarding', time:'~50s' },
      { icon:'📈', label:'Marketing Crew', sub:'Campaigns, copy, SEO', cat:'business', agents:'Strategist, Copywriter, SEO, Analytics', time:'~40s' },
      { icon:'🎓', label:'EdTech Platform', sub:'Courses, quizzes, users', cat:'education', agents:'Curriculum, Assessment, Progress, Content', time:'~45s' },
      { icon:'🏥', label:'Healthcare Tool', sub:'Patients, records, booking', cat:'health', agents:'Records, Scheduler, Alerts, Compliance', time:'~50s' },
      { icon:'💬', label:'Chat Application', sub:'Messaging, rooms, media', cat:'social', agents:'Messaging, Presence, Media, Moderation', time:'~40s' },
      { icon:'🎮', label:'Game / Gamification', sub:'Points, levels, rewards', cat:'social', agents:'Game Loop, Rewards, Leaderboard, Events', time:'~40s' },
      { icon:'🤖', label:'AI Automation Bot', sub:'Tasks, scheduling, workflows', cat:'ai', agents:'Orchestrator, Task Runner, Notifier, Logger', time:'~45s' },
      { icon:'🔍', label:'Research Assistant', sub:'Web search, summaries, reports', cat:'ai', agents:'Searcher, Synthesizer, Fact-checker, Writer', time:'~40s' },
      { icon:'🏗', label:'DevOps Pipeline', sub:'CI/CD, infra, monitoring', cat:'dev', agents:'Builder, Deployer, Monitor, Incident', time:'~50s' },
      { icon:'💰', label:'FinTech App', sub:'Payments, wallets, compliance', cat:'business', agents:'Payments, Risk, KYC, Ledger, Reporting', time:'~50s' },
    ],
    topicCats: [
      { id:'all', label:'All' },
      { id:'business', label:'Business' },
      { id:'ai', label:'AI / Automation' },
      { id:'dev', label:'Dev Tools' },
      { id:'education', label:'Education' },
      { id:'health', label:'Health' },
      { id:'social', label:'Social' },
    ],
    apiPlaceholder: 'Type your answer...',
    instrSteps: [
      { title: 'Open Google Antigravity', body: 'Go to <code>antigravity.google</code> and sign in with your Google account.' },
      { title: 'Create a new Workspace', body: 'Click "New Workspace" and give it the name of your project.' },
      { title: 'Upload agent files', body: 'For each agent, create a new Agent. Upload the corresponding <code>agent-[name].md</code> as the Agent\'s knowledge base.' },
      { title: 'Upload skill files', body: 'Within each agent, attach the <code>skill-[name].md</code> file to define how the agent behaves.' },
      { title: 'Connect the team', body: 'In the Manager View, connect your agents using the wiring provided in <code>team-config.md</code>.' },
      { title: 'Choose orchestration mode', body: 'Set the team to <strong>Agent-driven</strong> (fully automatic) or <strong>Agent-assisted</strong> (user orchestrated) depending on your preference.' },
      { title: 'Launch!', body: 'Hit "Deploy" and start interacting with your AI team. They are ready to help you build your app.' },
    ]
  },
  pl: {
    badge: 'GENERATOR ZESPOŁU AGENTÓW AI',
    heroTitle: 'Zbuduj Swój<br/>Zespół AI',
    heroSub: 'Wybierz temat. Odpowiedz na kilka pytań. Otrzymaj kompletny zespół agentów AI — gotowy do budowania aplikacji w Google Antigravity.',
    orText: '— lub opisz własny temat —',
    startBtn: 'Zacznij →',
    chatTitle: 'Wywiad AI',
    chatSub: 'Budujemy Twój profil agentów...',
    sendBtn: 'Wyślij',
    resultBadge: 'MISJA WYKONANA',
    resultTitle: 'Twój Zespół AI jest Gotowy',
    resultSub: 'Pobierz pliki i wdróż do Google Antigravity',
    downloadBtn: '⬇ Pobierz ZIP',
    instrBtn: '📋 Instrukcja',
    restartBtn: '↩ Od Początku',
    refineBtn: '✏ Popraw Zespół',
    refineTitle: 'Popraw Swój Zespół',
    refineSub: 'Powiedz AI co chcesz zmienić. Im konkretniej, tym lepiej.',
    refineActions: [
      { id: 'improve', emoji: '⚡', label: 'Ulepsz zespół', desc: 'Ogólne ulepszenia wszystkich agentów' },
      { id: 'add', emoji: '➕', label: 'Dodaj agenta', desc: 'Dodaj nowego specjalistę do zespołu' },
      { id: 'remove', emoji: '🗑', label: 'Usuń agenta', desc: 'Usuń lub połącz istniejącego agenta' },
      { id: 'connections', emoji: '🔗', label: 'Zmień połączenia', desc: 'Przepnij sposób komunikacji agentów' },
    ],
    refinePlaceholder: 'np. Dodaj agenta ds. bezpieczeństwa, albo zmień Backend Agenta na GraphQL...',
    refineApply: 'Zastosuj Zmiany',
    refineCancel: 'Anuluj',
    refineThinking: 'Poprawiam Twój zespół...',
    instrTitle: 'Jak wgrać do Google Antigravity',
    progressSteps: ['Temat wybrany','Wywiad gotowy','Zespół wygenerowany','Pliki gotowe'],

    levels: [
      {
        id: 'iskra', emoji: '✨', name: 'Iskra', tagline: 'Dopiero zaczynam',
        desc: 'Proste MVP, 2-3 agenty, przyjazne dla początkujących. Zero kodowania.',
        color: '#00e5ff', questions: 4, agentCount: '2-3',
        focus: 'podstawowe funkcje, prostota, łatwość użycia'
      },
      {
        id: 'plomien', emoji: '🔥', name: 'Płomień', tagline: 'Gotowy do budowania',
        desc: 'Pełna aplikacja, 3-4 agenty, podstawowa wiedza techniczna wymagana.',
        color: '#ff9500', questions: 5, agentCount: '3-4',
        focus: 'funkcje, integracje, przepływy użytkownika, podstawowy stack techniczny'
      },
      {
        id: 'pozar', emoji: '🌋', name: 'Pożar', tagline: 'Poważny projekt',
        desc: 'Złożony system, 4-5 agentów, API, autoryzacja, pipeline danych.',
        color: '#ff3b30', questions: 6, agentCount: '4-5',
        focus: 'architektura, skalowalność, bezpieczeństwo, API, modele danych'
      },
      {
        id: 'inferno', emoji: '💀', name: 'Inferno', tagline: 'Poziom enterprise',
        desc: 'Pełny system enterprise, 5-6 agentów, mikroserwisy, CI/CD, full stack.',
        color: '#7c3aff', questions: 7, agentCount: '5-6',
        focus: 'mikroserwisy, DevOps, bezpieczeństwo, compliance, skalowalność, architektura multi-tenant'
      }
    ],
    topics: [
      { icon:'🛒', label:'Aplikacja E-Commerce', sub:'Sklep, płatności, katalog', cat:'business', agents:'Produkty, Koszyk, Płatności, Rekomendacje', time:'~45s' },
      { icon:'📊', label:'Dashboard Analityczny', sub:'Dane, wykresy, raporty', cat:'business', agents:'Dane, Agregator, Wizualizator, Alerty', time:'~40s' },
      { icon:'💼', label:'Zespół SaaS', sub:'Multi-tenant produkt SaaS', cat:'business', agents:'Auth, Billing, API, Infra, Onboarding', time:'~50s' },
      { icon:'📈', label:'Marketing Crew', sub:'Kampanie, teksty, SEO', cat:'business', agents:'Strateg, Copywriter, SEO, Analityk', time:'~40s' },
      { icon:'🎓', label:'Platforma EdTech', sub:'Kursy, quizy, użytkownicy', cat:'education', agents:'Curriculum, Ocenianie, Postępy, Treści', time:'~45s' },
      { icon:'🏥', label:'Narzędzie Medyczne', sub:'Pacjenci, dokumentacja, wizyty', cat:'health', agents:'Dokumentacja, Scheduler, Alerty, Compliance', time:'~50s' },
      { icon:'💬', label:'Aplikacja Czat', sub:'Wiadomości, pokoje, media', cat:'social', agents:'Wiadomości, Obecność, Media, Moderacja', time:'~40s' },
      { icon:'🎮', label:'Gra / Gamifikacja', sub:'Punkty, poziomy, nagrody', cat:'social', agents:'Pętla gry, Nagrody, Ranking, Eventy', time:'~40s' },
      { icon:'🤖', label:'Bot Automatyzacji AI', sub:'Zadania, harmonogram, workflow', cat:'ai', agents:'Orkiestrator, Executor, Notifier, Logger', time:'~45s' },
      { icon:'🔍', label:'Asystent Badań', sub:'Wyszukiwanie, podsumowania, raporty', cat:'ai', agents:'Wyszukiwarka, Synthesizer, Fact-checker, Pisarz', time:'~40s' },
      { icon:'🏗', label:'Pipeline DevOps', sub:'CI/CD, infra, monitoring', cat:'dev', agents:'Builder, Deployer, Monitor, Incident', time:'~50s' },
      { icon:'💰', label:'Aplikacja FinTech', sub:'Płatności, portfele, compliance', cat:'business', agents:'Płatności, Ryzyko, KYC, Księga, Raporty', time:'~50s' },
    ],
    topicCats: [
      { id:'all', label:'Wszystkie' },
      { id:'business', label:'Biznes' },
      { id:'ai', label:'AI / Automatyzacja' },
      { id:'dev', label:'Dev Tools' },
      { id:'education', label:'Edukacja' },
      { id:'health', label:'Zdrowie' },
      { id:'social', label:'Social' },
    ],
    apiPlaceholder: 'Wpisz odpowiedź...',
    instrSteps: [
      { title: 'Otwórz Google Antigravity', body: 'Przejdź na <code>antigravity.google</code> i zaloguj się kontem Google.' },
      { title: 'Utwórz nowy Workspace', body: 'Kliknij "New Workspace" i nadaj mu nazwę projektu.' },
      { title: 'Wgraj pliki agentów', body: 'Dla każdego agenta utwórz nowego Agenta. Wgraj <code>agent-[nazwa].md</code> jako bazę wiedzy.' },
      { title: 'Wgraj pliki umiejętności', body: 'W każdym agencie dołącz plik <code>skill-[nazwa].md</code> — definiuje on zachowanie agenta.' },
      { title: 'Połącz zespół', body: 'W Manager View połącz agentów zgodnie z konfiguracją z pliku <code>team-config.md</code>.' },
      { title: 'Wybierz tryb orkiestracji', body: 'Ustaw <strong>Agent-driven</strong> (w pełni automatyczny) lub <strong>Agent-assisted</strong> (sterowany przez użytkownika).' },
      { title: 'Uruchom!', body: 'Kliknij "Deploy" i zacznij pracę z zespołem AI gotowym do budowania Twojej aplikacji.' },
    ]
  }
};

function t(key) { return T[lang][key]; }

// ─── LANGUAGE ─────────────────────────────────────────────
function setLang(l) {
  lang = l;
  document.getElementById('btn-en').classList.toggle('active', l==='en');
  document.getElementById('btn-pl').classList.toggle('active', l==='pl');
  renderTopicScreen();
}

// ─── MODEL SELECTION ──────────────────────────────────────
const MODEL_KEY_HINTS = {
  gemini:    { label: 'Gemini API Key',    hint: 'Key: Google AI Studio → makersuite.google.com',   placeholder: 'AIza...' },
  openai:    { label: 'OpenAI API Key',    hint: 'Key: platform.openai.com/api-keys',                placeholder: 'sk-...' },
  anthropic: { label: 'Anthropic API Key', hint: 'Key: console.anthropic.com/settings/keys',         placeholder: 'sk-ant-...' },
  mistral:   { label: 'Mistral API Key',   hint: 'Key: console.mistral.ai/api-keys',                 placeholder: 'your-mistral-key' },
  groq:      { label: 'Groq API Key',      hint: 'Key: console.groq.com/keys',                       placeholder: 'gsk_...' },
};

function onModelChange() {
  const sel = document.getElementById('modelSelect');
  if(!sel) return;
  const parts = sel.value.split('|');
  const label = sel.options[sel.selectedIndex]?.text || parts[1];
  selectedModel = { provider: parts[0], model: parts[1], endpoint: parts[2], tag: parts[3], label };

  const info = MODEL_KEY_HINTS[selectedModel.tag] || MODEL_KEY_HINTS.gemini;
  const labelEl = document.getElementById('apiKeyLabel');
  const hintEl  = document.getElementById('modelHint');
  const inputEl = document.getElementById('apiKeySetupInput');
  const headerInputEl = document.getElementById('apiKeyInput');

  if(labelEl)  labelEl.textContent = info.label;
  if(hintEl)   hintEl.innerHTML = info.hint;
  if(inputEl)  inputEl.placeholder = info.placeholder;
  if(headerInputEl) headerInputEl.placeholder = info.label;

  // Reset key when switching provider
  apiKey = '';
  if(inputEl) inputEl.value = '';
  const status = document.getElementById('apiKeySetupStatus');
  if(status) { status.textContent = ''; status.className = 'api-key-status'; }
}

// ─── API KEY ──────────────────────────────────────────────
function syncApiKey(val) {
  apiKey = val.trim();
  const headerInput = document.getElementById('apiKeyInput');
  if(headerInput) headerInput.value = apiKey;
  checkApiKey();
}
function checkApiKey() {
  const val = apiKey || document.getElementById('apiKeySetupInput')?.value?.trim() || '';
  apiKey = val;
  const status = document.getElementById('apiKeySetupStatus');
  if(val.length > 10) {
    if(status) { status.textContent = '✓ Key set'; status.className = 'api-key-status ok'; }
  } else {
    if(status) { status.textContent = ''; status.className = 'api-key-status'; }
  }
}

// ─── TOPIC SCREEN ─────────────────────────────────────────
function renderLevelGrid() {
  const grid = document.getElementById('level-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const label = document.getElementById('level-section-label');
  if(label) label.textContent = lang === 'en' ? 'COMPLEXITY LEVEL' : 'POZIOM ZŁOŻONOŚCI';

  t('levels').forEach(level => {
    const div = document.createElement('div');
    div.className = 'level-card' + (currentLevel === level.id ? ' selected' : '');
    div.style.borderColor = currentLevel === level.id ? level.color : '';
    div.style.boxShadow = currentLevel === level.id ? `0 0 20px ${level.color}33` : '';
    div.innerHTML = `
      <span class="level-emoji">${level.emoji}</span>
      <div class="level-name" style="color:${level.color}">${level.name}</div>
      <div class="level-tagline">${level.tagline}</div>
      <div class="level-agents" style="color:${level.color};border-color:${level.color}33;background:${level.color}11">
        ${level.agentCount} ${lang==='en'?'agents':'agentów'}
      </div>
    `;
    div.title = level.desc;
    div.onclick = () => {
      currentLevel = level.id;
      MAX_QUESTIONS = level.questions;
      renderLevelGrid();
    };
    grid.appendChild(div);
  });
}

let activeTopicCat = 'all';

function renderTopicScreen() {
  renderLevelGrid();
  document.getElementById('badge-text').textContent = t('badge');
  document.getElementById('hero-title').innerHTML = t('heroTitle');
  document.getElementById('hero-sub').textContent = t('heroSub');
  document.getElementById('or-text').textContent = t('orText');
  document.getElementById('start-btn').textContent = t('startBtn');

  // Render category filters
  const filtersEl = document.getElementById('template-filters');
  filtersEl.innerHTML = '';
  t('topicCats').forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn' + (activeTopicCat === cat.id ? ' active' : '');
    btn.textContent = cat.label;
    btn.onclick = () => {
      activeTopicCat = cat.id;
      renderTopicScreen();
    };
    filtersEl.appendChild(btn);
  });

  // Render topic cards
  const grid = document.getElementById('topic-grid');
  grid.innerHTML = '';
  t('topics').forEach(topic => {
    const div = document.createElement('div');
    div.className = 'topic-card' + (activeTopicCat !== 'all' && topic.cat !== activeTopicCat ? ' hidden' : '');
    div.innerHTML = `
      <div class="time-badge">${topic.time}</div>
      <div class="icon">${topic.icon}</div>
      <div class="label">${topic.label}</div>
      <div class="sub">${topic.sub}</div>
      <div class="agents-preview">⚡ ${topic.agents}</div>
    `;
    div.onclick = () => { document.getElementById('customTopic').value = topic.label; startWithTopic(); };
    grid.appendChild(div);
  });
}

function startWithTopic() {
  const val = document.getElementById('apiKeySetupInput').value.trim();
  apiKey = val;
  if(!apiKey || apiKey.length < 10) {
    showNotif(lang==='en' ? `⚠ Please enter a valid ${MODEL_KEY_HINTS[selectedModel.tag]?.label || 'API key'}` : `⚠ Podaj prawidłowy klucz ${MODEL_KEY_HINTS[selectedModel.tag]?.label || 'API'}`, true);
    return;
  }
  const topic = document.getElementById('customTopic').value.trim();
  if(!topic) {
    showNotif(lang==='en' ? '⚠ Please select or enter a topic' : '⚠ Wybierz lub wpisz temat', true);
    return;
  }
  currentTopic = topic;
  startChat();
}

// ─── CHAT SCREEN ──────────────────────────────────────────
function startChat() {
  showScreen('chat');
  // Reset trace for new session
  traceSpans = [];
  tracePanelOpen = false;
  traceSessionStart = null;
  document.getElementById('apiKeyHeader').style.display = 'flex';
  document.getElementById('apiKeyInput').value = apiKey;
  // Show model badge in header
  const badgeEl = document.getElementById('headerModelBadge');
  if(badgeEl) badgeEl.textContent = selectedModel.model;
  document.getElementById('sidebar-topic').textContent = currentTopic;
  const lvl = t('levels').find(l => l.id === currentLevel);
  if(lvl) {
    document.getElementById('sidebar-level').textContent = lvl.emoji;
    document.getElementById('sidebar-level-name').textContent = lvl.name;
    document.getElementById('sidebar-level-name').style.color = lvl.color;
    document.getElementById('sidebar-level-desc').textContent = lvl.tagline;
  }
  document.getElementById('chat-title').textContent = t('chatTitle');
  document.getElementById('chat-subtitle').textContent = t('chatSub');

  renderProgressSteps(0);
  chatHistory = [];
  questionCount = 0;
  conversationState = 'interview';

  const systemPrompt = getSystemPrompt();
  addTypingIndicator();
  callGemini(systemPrompt, `The user wants to build: "${currentTopic}". Start the interview with a warm greeting and your FIRST question. Be concise. Ask only one question at a time.`, 'Interview: Start')
    .then(reply => {
      removeTypingIndicator();
      addMessage('ai', reply);
      renderOptions(reply);
    })
    .catch(err => {
      removeTypingIndicator();
      addMessage('ai', `Error: ${err.message}. Please check your API key.`);
    });
}

function getSystemPrompt() {
  const levelData = t('levels').find(l => l.id === currentLevel) || t('levels')[0];
  return `You are AgentSpark, an expert AI system designer. Your job is to interview the user about their app idea using CLOSED questions with multiple choice answers.

Language: ${lang === 'en' ? 'English' : 'Polish'}
App topic: ${currentTopic}
Complexity level: ${levelData.name} — ${levelData.tagline}
Agent count to generate: ${levelData.agentCount}
Focus areas for this level: ${levelData.focus}

INTERVIEW PHASE (exactly ${MAX_QUESTIONS} questions, calibrated for ${levelData.name} level):
- Ask ONE question at a time
- Every question MUST be closed — provide exactly 4 answer options
- Cover topics appropriate for ${levelData.name} level, focusing on: ${levelData.focus}
- For Iskra: simple, friendly questions — avoid jargon, focus on purpose and users
- For Płomień: balanced questions — features, integrations, basic tech choices
- For Pożar: technical questions — architecture, APIs, data, security considerations
- For Inferno: deep technical questions — microservices, DevOps, compliance, scalability, multi-tenancy
- Calibrate vocabulary and depth to the chosen level
- Be brief and direct
- Format each question EXACTLY like this (no deviation):

QUESTION: [Your question here?]
A) [Option A]
B) [Option B]
C) [Option C]
D) [Option D]

- After exactly ${MAX_QUESTIONS} questions, write a brief confirmation of what you understood, then end with: [INTERVIEW_COMPLETE]

IMPORTANT: Never ask open-ended questions. Always provide exactly 4 options labeled A) B) C) D).

QUESTION FORMAT — for every question you must also add an impact note for each option:
QUESTION: [Your question here?]
A) [Option A] | IMPACT: [1 sentence: what consequence does choosing A have on the app]
B) [Option B] | IMPACT: [1 sentence: what consequence does choosing B have on the app]
C) [Option C] | IMPACT: [1 sentence: what consequence does choosing C have on the app]
D) [Option D] | IMPACT: [1 sentence: what consequence does choosing D have on the app]

The IMPACT must be specific and directly relevant to the app being built. Keep it under 15 words.

GENERATION PHASE (when you receive [GENERATE]):
Respond with a JSON object ONLY, no markdown, no explanation. Format:
{
  "agents": [
    {
      "id": "slug-name",
      "name": "Agent Name",
      "emoji": "🤖",
      "type": "technical",
      "role": "ROLE_LABEL",
      "description": "What this agent does",
      "agentMd": "# Agent: Name\\n\\n## Identity\\n...\\n\\n## Goal\\n...\\n\\n## Personality\\n...\\n\\n## Context\\n...",
      "skillMd": "# Skill: Name\\n\\n## Capabilities\\n...\\n\\n## Instructions\\n...\\n\\n## Tools\\n...\\n\\n## Output Format\\n..."
    }
  ],
  "teamConfig": "# Team Configuration\\n\\n## Architecture\\n...\\n\\n## Agent Connections\\n...\\n\\n## Orchestration Mode\\n...\\n\\n## Workflow\\n..."
}

AGENT TYPES — you MUST generate both types:
- "technical" agents: builders who directly help code and implement the app
- "business" agents: strategists who provide context, validation and guidance

Distribute agent types based on level:
- Iskra: 2 technical, 1 business
- Płomień: 2 technical, 2 business
- Pożar: 3 technical, 2 business
- Inferno: 4 technical, 2 business

Make agent files detailed and professional. Each agent should be genuinely useful for the specific app described.`;
}

function selectOption(label, text) {
  document.querySelectorAll('.option-btn').forEach(b => {
    b.disabled = true;
    if(b.dataset.label === label) {
      b.style.borderColor = 'var(--accent)';
      b.style.background = 'rgba(0,229,255,0.15)';
      b.style.color = 'var(--accent)';
    } else {
      b.style.opacity = '0.3';
    }
  });
  document.querySelectorAll('.option-wrap').forEach(w => {
    const btn = w.querySelector('.option-btn');
    const note = w.querySelector('.impact-note');
    if(note) {
      if(btn && btn.dataset.label === label) {
        note.classList.add('selected');
      } else {
        note.style.opacity = '0.3';
      }
    }
  });
  setTimeout(() => submitAnswer(label + ') ' + text), 400);
}

async function submitAnswer(answer) {
  clearOptions();
  addMessage('user', answer);
  chatHistory.push({ role:'user', text: answer });
  questionCount++;

  if(conversationState === 'interview') {
    addTypingIndicator();
    try {
      const history = chatHistory.map(m => `${m.role === 'user' ? 'User' : 'AgentSpark'}: ${m.text}`).join('\n');
      const prompt = `${history}\n\nThis was answer ${questionCount} of ${MAX_QUESTIONS}. Ask next closed question with 4 options, or wrap up if done.`;
      const reply = await callGemini(getSystemPrompt(), prompt, `Interview: Q${questionCount}`);
      removeTypingIndicator();
      addMessage('ai', reply);
      chatHistory.push({ role:'ai', text: reply });

      if(reply.includes('[INTERVIEW_COMPLETE]') || questionCount >= MAX_QUESTIONS) {
        conversationState = 'generating';
        renderProgressSteps(1);
        clearOptions();
        setTimeout(generateAgents, 1200);
      } else {
        renderOptions(reply);
      }
    } catch(err) {
      removeTypingIndicator();
      addMessage('ai', `Error: ${err.message}`);
    }
  }
}

function renderOptions(text) {
  const container = document.getElementById('options-container');
  if(!container) return;
  container.innerHTML = '';

  const matches = [...text.matchAll(/([A-D])\)\s*(.+?)(?=\n[A-D]\)|$)/gs)];
  if(matches.length === 0) return;

  matches.forEach(m => {
    const label = m[1];
    const full = m[2].trim().replace(/\n/g, ' ');
    const impactSplit = full.split(/\s*\|\s*IMPACT:\s*/i);
    const optText = impactSplit[0].trim();
    const impact = impactSplit[1] ? impactSplit[1].trim() : null;

    const wrap = document.createElement('div');
    wrap.className = 'option-wrap';

    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.dataset.label = label;
    btn.dataset.opttext = optText;
    btn.innerHTML = `<span class="opt-label">${label}</span><span class="opt-text">${optText}</span>`;
    btn.onclick = () => selectOption(label, optText);
    wrap.appendChild(btn);

    if(impact) {
      const note = document.createElement('div');
      note.className = 'impact-note';
      note.innerHTML = `<span class="impact-icon">⚡</span><span>${impact}</span>`;
      wrap.appendChild(note);
    }

    container.appendChild(wrap);
  });
}

function clearOptions() {
  const c = document.getElementById('options-container');
  if(c) c.innerHTML = '';
}

async function generateScoring(history) {
  const lvl = t('levels').find(l => l.id === currentLevel);
  const scoringPrompt = `You are a project complexity analyst. Based on this interview about the app "${currentTopic}", generate a project scoring report.

Interview:
${history}

Chosen level: ${lvl ? lvl.name : currentLevel}

Respond ONLY with a JSON object, no markdown:
{
  "overallScore": 72,
  "overallLabel": "Medium-High Complexity",
  "metrics": [
    { "label": "Technical Complexity", "value": 80, "color": "#7c3aff" },
    { "label": "Business Complexity", "value": 60, "color": "#ff6b35" },
    { "label": "Integration Needs", "value": 70, "color": "#00e5ff" },
    { "label": "Scalability Demand", "value": 55, "color": "#00ff88" }
  ],
  "risks": ["Risk 1 in 10 words max", "Risk 2", "Risk 3"],
  "levelMatch": "ok",
  "levelSuggestion": "Your chosen level matches the project complexity well.",
  "suggestedLevel": "${currentLevel}"
}

levelMatch must be: "ok", "upgrade", or "downgrade".
suggestedLevel must be one of: iskra, plomien, pozar, inferno.
Keep risks under 12 words each. Be specific to this project.
Language: ${lang === 'en' ? 'English' : 'Polish'}`;

  try {
    const raw = await callGemini('You are a project analyst. Return only JSON.', scoringPrompt, 'Scoring');
    const match = raw.match(/\{[\s\S]*\}/);
    if (!match) return null;
    return JSON.parse(match[0]);
  } catch(e) {
    console.warn('Scoring failed:', e);
    return null;
  }
}

function renderScoring(data) {
  if(!data) return;
  const panel = document.getElementById('scoring-panel');
  panel.style.display = 'block';

  const scoreColor = data.overallScore >= 75 ? 'var(--accent2)' : data.overallScore >= 50 ? '#ff9500' : 'var(--success)';
  const isWarn = data.levelMatch !== 'ok';
  const suggestedLvl = t('levels').find(l => l.id === data.suggestedLevel);

  const metricsHTML = (data.metrics || []).map(m => `
    <div class="score-metric">
      <div class="score-metric-label">${m.label}</div>
      <div class="score-metric-bar"><div class="score-metric-fill" style="width:0%;background:${m.color}" data-target="${m.value}"></div></div>
      <div class="score-metric-value">${m.value}/100</div>
    </div>`).join('');

  const risksHTML = (data.risks || []).map(r => `<div class="risk-item">${r}</div>`).join('');
  const suggestionIcon = data.levelMatch === 'upgrade' ? '⬆' : data.levelMatch === 'downgrade' ? '⬇' : '✓';

  panel.innerHTML = `
    <div class="scoring-header">
      <h3>${lang==='en' ? 'PROJECT SCORING' : 'OCENA PROJEKTU'}</h3>
      <div class="score-badge">
        <div class="score-number" style="color:${scoreColor}">${data.overallScore}</div>
        <div class="score-label"><strong>${data.overallLabel}</strong>${lang==='en'?'out of 100':'na 100'}</div>
      </div>
    </div>
    <div class="scoring-grid">${metricsHTML}</div>
    ${risksHTML ? `<div class="scoring-risks"><h4>${lang==='en'?'⚠ POTENTIAL RISKS':'⚠ POTENCJALNE RYZYKA'}</h4>${risksHTML}</div>` : ''}
    <div class="level-suggestion ${isWarn ? 'warn' : ''}">
      <span class="ls-icon">${suggestionIcon}</span>
      <span>${data.levelSuggestion}${suggestedLvl && isWarn ? ' <strong>→ ' + suggestedLvl.name + '</strong>' : ''}</span>
    </div>
  `;

  // Single-frame rAF to trigger CSS transition after DOM paint
  requestAnimationFrame(() => {
    if(!document.getElementById('screen-results').classList.contains('active')) return;
    panel.querySelectorAll('.score-metric-fill').forEach(bar => {
      setTimeout(() => { bar.style.width = (bar.dataset.target || 0) + '%'; }, 100);
    });
  });
}

async function generateAgents() {
  addTypingIndicator();
  const history = chatHistory.map(m => `${m.role === 'user' ? 'User' : 'AgentSpark'}: ${m.text}`).join('\n');
  const prompt = `Here is the complete interview:\n${history}\n\n[GENERATE]\nGenerate the agent team JSON now based on the interview.`;

  try {
    const raw = await callGemini(getSystemPrompt(), prompt, 'Generate Team');
    removeTypingIndicator();

    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if(!jsonMatch) throw new Error('Could not parse agent data');
    const data = JSON.parse(jsonMatch[0]);

    generatedAgents = data.agents || [];
    generatedFiles = {};

    generatedAgents.forEach(a => {
      generatedFiles[`agent-${a.id}.md`] = a.agentMd || `# Agent: ${a.name}\n\n**Role:** ${a.role || ''}\n\n${a.description || ''}`;
      generatedFiles[`skill-${a.id}.md`] = a.skillMd || `# Skill: ${a.name}\n\n## Capabilities\n\n${a.description || ''}`;
    });
    generatedFiles['team-config.md'] = data.teamConfig || `# Team Configuration\n\n**Project:** ${currentTopic}\n\n## Agents\n\n${generatedAgents.map(a => `- **${a.name}** (${a.role || a.id})`).join('\n')}`;
    generatedFiles['README.md'] = generateReadme();

    window._scoringData = undefined;
    const historyForScoring = chatHistory.map(m => `${m.role === 'user' ? 'User' : 'AgentSpark'}: ${m.text}`).join('\n');
    generateScoring(historyForScoring).then(scoreData => {
      window._scoringData = scoreData;
    });

    renderProgressSteps(3);
    addMessage('ai', lang==='en'
      ? `✅ Done! I've designed ${generatedAgents.length} specialized agents for your "${currentTopic}" app. Your files are ready — switching to results view now!`
      : `✅ Gotowe! Zaprojektowałem ${generatedAgents.length} wyspecjalizowanych agentów dla Twojej aplikacji "${currentTopic}". Pliki są gotowe — przechodzę do widoku wyników!`
    );

    setTimeout(() => {
      // Seed v1 "Origin" snapshot
      versionHistory = [];
      versionHistory.push({
        id: Date.now(),
        label: lang === 'en' ? `Original team — ${currentTopic}` : `Oryginalny zespół — ${currentTopic}`,
        ts: new Date(),
        agents: JSON.parse(JSON.stringify(generatedAgents)),
        files: JSON.parse(JSON.stringify(generatedFiles)),
        diff: { added: [], removed: [], changed: [] },
        removedNames: {},
        agentNames: Object.fromEntries(generatedAgents.map(a => [a.id, a.name])),
        vNum: 1,
        isOrigin: true,
      });
      showResults();
    }, 1800);
  } catch(err) {
    removeTypingIndicator();
    addMessage('ai', `Generation error: ${err.message}. Please try again.`);
  }
}

function generateReadme() {
  const technical = generatedAgents.filter(a => a.type === 'technical');
  const business  = generatedAgents.filter(a => a.type !== 'technical');
  const techList = technical.map(a => `- **${a.name}** [TECHNICAL] (${a.role}): ${a.description}`).join('\n');
  const bizList  = business.map(a  => `- **${a.name}** [BUSINESS] (${a.role}): ${a.description}`).join('\n');
  const lvl = t('levels').find(l => l.id === currentLevel);
  return `# AgentSpark — Generated Team\n\n**Project:** ${currentTopic}\n**Level:** ${lvl ? lvl.name : currentLevel}\n**Generated:** ${new Date().toLocaleString()}\n**Language:** ${lang.toUpperCase()}\n\n## ⚙️ Technical Agents\n\n${techList || 'none'}\n\n## 💼 Business Agents\n\n${bizList || 'none'}\n\n## Files\n\n${Object.keys(generatedFiles).filter(f=>f!=='README.md').map(f=>`- \`${f}\``).join('\n')}\n\n## How to use\n\nSee instructions inside the app or visit antigravity.google\n`;
}


// ─── DEPENDENCY GRAPH ────────────────────────────────────
let graphNodes = [];
let graphEdges = [];
let graphAnimFrame = null;

function buildGraphFromAgents() {
  const agents = generatedAgents;
  if(!agents.length) return;

  const canvas = document.getElementById('agent-graph');
  if(!canvas) return;

  // Cancel any running animation before rebuilding
  if(graphAnimFrame) {
    cancelAnimationFrame(graphAnimFrame);
    graphAnimFrame = null;
  }
  const W = canvas.offsetWidth || 800;
  const H = 400;
  canvas.width = W;
  canvas.height = H;

  const cx = W / 2, cy = H / 2;
  const radius = Math.min(W, H) * 0.33;

  const tech = agents.filter(a => a.type === 'technical');
  const biz  = agents.filter(a => a.type !== 'technical');

  graphNodes = [];

  tech.forEach((a, i) => {
    const angle = (Math.PI * 0.8) + (i / Math.max(tech.length - 1, 1)) * Math.PI * 0.8 - Math.PI * 0.4;
    graphNodes.push({
      id: a.id, label: a.name, emoji: a.emoji || '⚙',
      type: 'technical',
      x: cx - radius * 0.6 + Math.cos(angle) * radius * 0.5,
      y: cy + Math.sin(angle) * radius * 0.7,
      vx: 0, vy: 0, r: 28
    });
  });

  biz.forEach((a, i) => {
    const angle = (Math.PI * 0.1) + (i / Math.max(biz.length - 1, 1)) * Math.PI * 0.8 - Math.PI * 0.4;
    graphNodes.push({
      id: a.id, label: a.name, emoji: a.emoji || '💼',
      type: 'business',
      x: cx + radius * 0.6 + Math.cos(angle) * radius * 0.5,
      y: cy + Math.sin(angle) * radius * 0.7,
      vx: 0, vy: 0, r: 28
    });
  });

  graphEdges = [];
  for(let i = 0; i < tech.length - 1; i++) {
    graphEdges.push({ from: tech[i].id, to: tech[i+1].id, label: 'pipeline', style: 'tech' });
  }
  biz.forEach(b => {
    tech.forEach(tn => {
      graphEdges.push({ from: b.id, to: tn.id, label: 'context', style: 'biz' });
    });
  });

  drawGraph();
}

function drawGraph() {
  const canvas = document.getElementById('agent-graph');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  ctx.clearRect(0, 0, W, H);

  ctx.strokeStyle = 'rgba(0,229,255,0.04)';
  ctx.lineWidth = 1;
  for(let x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for(let y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

  graphEdges.forEach(edge => {
    const from = graphNodes.find(n => n.id === edge.from);
    const to   = graphNodes.find(n => n.id === edge.to);
    if(!from || !to) return;

    const isBiz = edge.style === 'biz';
    const color = isBiz ? 'rgba(255,107,53,0.35)' : 'rgba(0,229,255,0.4)';

    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = isBiz ? 1.5 : 2;
    if(isBiz) ctx.setLineDash([4, 4]);
    else ctx.setLineDash([]);

    const mx = (from.x + to.x) / 2;
    const my = (from.y + to.y) / 2 - 30;
    ctx.moveTo(from.x, from.y);
    ctx.quadraticCurveTo(mx, my, to.x, to.y);
    ctx.stroke();
    ctx.setLineDash([]);

    const angle = Math.atan2(to.y - my, to.x - mx);
    const arrowLen = 8;
    ctx.beginPath();
    ctx.fillStyle = color.replace('0.35','0.7').replace('0.4','0.8');
    ctx.moveTo(to.x, to.y);
    ctx.lineTo(to.x - arrowLen * Math.cos(angle - 0.4), to.y - arrowLen * Math.sin(angle - 0.4));
    ctx.lineTo(to.x - arrowLen * Math.cos(angle + 0.4), to.y - arrowLen * Math.sin(angle + 0.4));
    ctx.closePath();
    ctx.fill();
  });

  graphNodes.forEach(node => {
    const isTech = node.type === 'technical';
    const color  = isTech ? '#7c3aff' : '#ff6b35';
    const glow   = isTech ? 'rgba(124,58,255,0.3)' : 'rgba(255,107,53,0.25)';

    ctx.beginPath();
    ctx.arc(node.x, node.y, node.r + 8, 0, Math.PI * 2);
    ctx.fillStyle = glow;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(node.x, node.y, node.r, 0, Math.PI * 2);
    ctx.fillStyle = isTech ? 'rgba(124,58,255,0.2)' : 'rgba(255,107,53,0.15)';
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.font = '16px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(node.emoji, node.x, node.y - 2);

    const maxW = 90;
    const words = node.label.split(' ');
    let line = '', lines = [];
    words.forEach(w => {
      const test = line + (line ? ' ' : '') + w;
      ctx.font = 'bold 10px Outfit, sans-serif';
      if(ctx.measureText(test).width > maxW && line) {
        lines.push(line); line = w;
      } else { line = test; }
    });
    lines.push(line);

    ctx.fillStyle = '#e2eaf8';
    ctx.font = 'bold 10px Outfit, sans-serif';
    lines.forEach((l, i) => {
      ctx.fillText(l, node.x, node.y + node.r + 12 + i * 13);
    });
  });

  graphAnimFrame = requestAnimationFrame(drawGraphPulse);
}

let pulseT = 0;
function drawGraphPulse() {
  pulseT += 0.02;
  const canvas = document.getElementById('agent-graph');
  if(!canvas || !document.getElementById('screen-results').classList.contains('active')) return;

  // Full redraw each frame so glows don't accumulate
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  // Background grid
  ctx.strokeStyle = 'rgba(0,229,255,0.04)';
  ctx.lineWidth = 1;
  for(let x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for(let y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

  // Edges
  graphEdges.forEach(edge => {
    const from = graphNodes.find(n => n.id === edge.from);
    const to   = graphNodes.find(n => n.id === edge.to);
    if(!from || !to) return;
    const isBiz = edge.style === 'biz';
    const color = isBiz ? 'rgba(255,107,53,0.35)' : 'rgba(0,229,255,0.4)';
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = isBiz ? 1.5 : 2;
    if(isBiz) ctx.setLineDash([4, 4]);
    else ctx.setLineDash([]);
    const mx = (from.x + to.x) / 2;
    const my = (from.y + to.y) / 2 - 30;
    ctx.moveTo(from.x, from.y);
    ctx.quadraticCurveTo(mx, my, to.x, to.y);
    ctx.stroke();
    ctx.setLineDash([]);
    const angle = Math.atan2(to.y - my, to.x - mx);
    const arrowLen = 8;
    ctx.beginPath();
    ctx.fillStyle = color.replace('0.35','0.7').replace('0.4','0.8');
    ctx.moveTo(to.x, to.y);
    ctx.lineTo(to.x - arrowLen * Math.cos(angle - 0.4), to.y - arrowLen * Math.sin(angle - 0.4));
    ctx.lineTo(to.x - arrowLen * Math.cos(angle + 0.4), to.y - arrowLen * Math.sin(angle + 0.4));
    ctx.closePath();
    ctx.fill();
  });

  // Nodes with pulse
  graphNodes.forEach(node => {
    const isTech = node.type === 'technical';
    const color  = isTech ? '#7c3aff' : '#ff6b35';
    const phase  = pulseT + (isTech ? 0 : Math.PI);
    const pulse  = Math.sin(phase) * 3;
    const glowA  = 0.15 + Math.abs(Math.sin(phase)) * 0.12;
    const glow   = isTech ? `rgba(124,58,255,${glowA})` : `rgba(255,107,53,${glowA * 0.85})`;

    ctx.beginPath();
    ctx.arc(node.x, node.y, node.r + 8 + pulse, 0, Math.PI * 2);
    ctx.fillStyle = glow;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(node.x, node.y, node.r, 0, Math.PI * 2);
    ctx.fillStyle = isTech ? 'rgba(124,58,255,0.2)' : 'rgba(255,107,53,0.15)';
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.font = '16px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(node.emoji, node.x, node.y - 2);

    const maxW = 90;
    const words = node.label.split(' ');
    let line = '', lines = [];
    words.forEach(w => {
      ctx.font = 'bold 10px Outfit, sans-serif';
      const test = line + (line ? ' ' : '') + w;
      if(ctx.measureText(test).width > maxW && line) { lines.push(line); line = w; }
      else { line = test; }
    });
    lines.push(line);
    ctx.fillStyle = '#e2eaf8';
    ctx.font = 'bold 10px Outfit, sans-serif';
    lines.forEach((l, i) => ctx.fillText(l, node.x, node.y + node.r + 12 + i * 13));
  });

  graphAnimFrame = requestAnimationFrame(drawGraphPulse);
}


// ─── REFINE MODE ─────────────────────────────────────────────
let refineSnapshots = [];      // legacy — kept for revertLastRefine compat
let versionHistory  = [];      // rich version objects: { id, label, ts, agents, files, diff }
let selectedRefineAction = null;
let versionPanelOpen = false;

// ─── TRACE STATE ──────────────────────────────────────────
let traceSpans = [];           // all recorded API spans
let tracePanelOpen = false;
let traceSessionStart = null;  // epoch ms of first span in current session

function openRefine() {
  const panel = document.getElementById('refine-panel');
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

  document.getElementById('refine-title').textContent = t('refineTitle');
  document.getElementById('refine-sub').textContent = t('refineSub');
  document.getElementById('refine-input').placeholder = t('refinePlaceholder');
  document.getElementById('refine-submit-label').textContent = t('refineApply');

  const chips = document.getElementById('refine-action-chips');
  chips.innerHTML = '';
  t('refineActions').forEach(action => {
    const chip = document.createElement('button');
    chip.className = 'refine-chip' + (selectedRefineAction === action.id ? ' active' : '');
    chip.dataset.id = action.id;
    chip.innerHTML = `<span>${action.emoji}</span><span>${action.label}</span>`;
    chip.title = action.desc;
    chip.onclick = () => {
      selectedRefineAction = action.id;
      chips.querySelectorAll('.refine-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      const ta = document.getElementById('refine-input');
      if(!ta.value.trim()) {
        const hints = {
          improve: lang === 'en' ? 'Improve overall agent descriptions and add more specific skills...' : 'Ulepsz opisy agentów i dodaj bardziej szczegółowe umiejętności...',
          add: lang === 'en' ? 'Add a [type] agent that handles [responsibility]...' : 'Dodaj agenta [typ] który zajmuje się [odpowiedzialność]...',
          remove: lang === 'en' ? 'Remove the [agent name] agent and redistribute its responsibilities...' : 'Usuń agenta [nazwa] i redystrybuuj jego obowiązki...',
          connections: lang === 'en' ? 'Change the connection so that [agent A] sends results directly to [agent B]...' : 'Zmień połączenie tak żeby [agent A] wysyłał wyniki bezpośrednio do [agent B]...',
        };
        ta.value = '';
        ta.placeholder = hints[action.id] || t('refinePlaceholder');
      }
      ta.focus();
    };
    chips.appendChild(chip);
  });

  updateRefineCounter();
}

function closeRefine() {
  document.getElementById('refine-panel').style.display = 'none';
  selectedRefineAction = null;
  // If panel is closed mid-request, unlock state so user can refine again later
  if(isRefining) {
    isRefining = false;
    document.getElementById('refine-submit-btn').disabled = false;
    removeRefineThinking();
  }
}

function updateRefineCounter() {
  const count = refineSnapshots.length;
  const counter = document.getElementById('refine-counter');
  const revertBtn = document.getElementById('refine-revert-btn');
  // ── FIX: was missing quotes around 'ę' causing SyntaxError ──
  if(lang === 'pl') {
    const suffix = count === 1 ? 'ę' : count > 1 && count < 5 ? 'e' : 'i';
    counter.textContent = count > 0 ? `Wykonano ${count} rewizj${suffix}` : '';
  } else {
    counter.textContent = count > 0 ? `${count} revision${count > 1 ? 's' : ''} made` : '';
  }
  revertBtn.style.display = count > 0 ? 'block' : 'none';
}

function addRefineMessage(role, html) {
  const history = document.getElementById('refine-history');
  const div = document.createElement('div');
  div.className = `refine-msg ${role}`;
  div.innerHTML = `
    <div class="refine-msg-sender">${role === 'ai' ? '⚡ AgentSpark' : (lang === 'en' ? 'You' : 'Ty')}</div>
    <div class="refine-bubble">${html}</div>
  `;
  history.appendChild(div);
  history.scrollTop = history.scrollHeight;
}

function addRefineThinking() {
  const history = document.getElementById('refine-history');
  const div = document.createElement('div');
  div.className = 'refine-msg ai';
  div.id = 'refine-thinking-indicator';
  div.innerHTML = `
    <div class="refine-msg-sender">⚡ AgentSpark</div>
    <div class="refine-bubble">
      <div class="refine-thinking">
        <span>${t('refineThinking')}</span>
        <span class="thinking-dots"><span></span><span></span><span></span></span>
      </div>
    </div>
  `;
  history.appendChild(div);
  history.scrollTop = history.scrollHeight;
}

function removeRefineThinking() {
  const el = document.getElementById('refine-thinking-indicator');
  if(el) el.remove();
}

function getRefineSystemPrompt() {
  const lvl = t('levels').find(l => l.id === currentLevel);
  const currentTeamJSON = JSON.stringify(generatedAgents.map(a => ({
    id: a.id, name: a.name, type: a.type, role: a.role, description: a.description
  })), null, 2);

  return `You are AgentSpark, an expert AI system designer in REFINE mode.
Language: ${lang === 'en' ? 'English' : 'Polish'}
App topic: ${currentTopic}
Complexity level: ${lvl ? lvl.name : currentLevel}

CURRENT TEAM:
${currentTeamJSON}

The user wants to modify their agent team. Apply their requested changes and return the complete updated team as JSON.

RESPONSE FORMAT — two parts:
1. A brief human-readable summary of what changed (1-3 sentences), using these tags for changes:
   - New agent: <span class="refine-diff-added">+AgentName</span>
   - Removed: <span class="refine-diff-removed">-AgentName</span>  
   - Modified: <span class="refine-diff-changed">~AgentName</span>

2. Then the full updated JSON (same format as original generation):
[UPDATED_TEAM]
{
  "agents": [...complete updated agents array with all fields: id, name, emoji, type, role, description, agentMd, skillMd...],
  "teamConfig": "...updated team config md..."
}

RULES:
- Always return the COMPLETE agents array, not just changed agents
- Keep unchanged agents exactly as they are
- New agents must follow same structure (id, name, emoji, type, role, description, agentMd, skillMd)
- type must be "technical" or "business"
- agentMd and skillMd must be full detailed markdown, not placeholders
- The [UPDATED_TEAM] marker must appear on its own line`;
}

async function submitRefine() {
  const input = document.getElementById('refine-input');
  const text = input.value.trim();
  if(!text || isRefining) return;

  const actionCtx = selectedRefineAction ? `[Action: ${selectedRefineAction}] ` : '';
  const fullRequest = actionCtx + text;

  input.value = '';
  isRefining = true;
  document.getElementById('refine-submit-btn').disabled = true;

  addRefineMessage('user', text);
  addRefineThinking();

  refineSnapshots.push(JSON.parse(JSON.stringify({ agents: generatedAgents, files: generatedFiles })));

  // Save rich version BEFORE we mutate state
  const preSnap = JSON.parse(JSON.stringify({ agents: generatedAgents, files: generatedFiles }));

  try {
    const history = refineHistory.map(m => `${m.role === 'user' ? 'User' : 'AI'}: ${m.text}`).join('\n');
    const prompt = history
      ? `Previous context:\n${history}\n\nNew request: ${fullRequest}`
      : `Request: ${fullRequest}`;

    const raw = await callGemini(getRefineSystemPrompt(), prompt, `Refine #${versionHistory.length}`);
    removeRefineThinking();

    const markerIdx = raw.indexOf('[UPDATED_TEAM]');
    let summary = '', jsonPart = '';

    if(markerIdx !== -1) {
      summary = raw.slice(0, markerIdx).trim();
      jsonPart = raw.slice(markerIdx + '[UPDATED_TEAM]'.length).trim();
    } else {
      const jsonMatch = raw.match(/\{[\s\S]*"agents"[\s\S]*\}/);
      if(jsonMatch) {
        jsonPart = jsonMatch[0];
        summary = raw.slice(0, raw.indexOf(jsonMatch[0])).trim() || (lang === 'en' ? 'Team updated.' : 'Zespół zaktualizowany.');
      } else {
        throw new Error(lang === 'en' ? 'Could not parse updated team.' : 'Nie udało się przetworzyć zaktualizowanego zespołu.');
      }
    }

    const jsonMatch = jsonPart.match(/\{[\s\S]*\}/);
    if(!jsonMatch) throw new Error('No JSON in response');
    const data = JSON.parse(jsonMatch[0]);

    if(!data.agents || !Array.isArray(data.agents)) throw new Error('Invalid agents data');

    const prevIds = new Set(generatedAgents.map(a => a.id));
    const newIds  = new Set(data.agents.map(a => a.id));
    const addedIds   = [...newIds].filter(id => !prevIds.has(id));
    const removedIds = [...prevIds].filter(id => !newIds.has(id));
    const changedIds = [...newIds].filter(id => prevIds.has(id) && JSON.stringify(data.agents.find(a=>a.id===id)) !== JSON.stringify(generatedAgents.find(a=>a.id===id)));

    // Capture removed agent names BEFORE overwriting generatedAgents
    const removedNames = Object.fromEntries(
      removedIds.map(id => [id, generatedAgents.find(a => a.id === id)?.name || id])
    );

    generatedAgents = data.agents;

    data.agents.forEach(a => {
      generatedFiles[`agent-${a.id}.md`] = a.agentMd || `# Agent: ${a.name}\n\n**Role:** ${a.role || ''}\n\n${a.description || ''}`;
      generatedFiles[`skill-${a.id}.md`] = a.skillMd || `# Skill: ${a.name}\n\n## Capabilities\n\n${a.description || ''}`;
    });
    removedIds.forEach(id => {
      delete generatedFiles[`agent-${id}.md`];
      delete generatedFiles[`skill-${id}.md`];
    });
    if(data.teamConfig) generatedFiles['team-config.md'] = data.teamConfig;
    generatedFiles['README.md'] = generateReadme();

    refineHistory.push({ role: 'user', text: fullRequest });
    refineHistory.push({ role: 'ai', text: summary });

    // ── Save version snapshot ──────────────────────────────
    const vNum = versionHistory.length + 2; // v1 = origin, v2+ = refines
    versionHistory.push({
      id: Date.now(),
      label: text.length > 60 ? text.slice(0, 57) + '…' : text,
      ts: new Date(),
      agents: JSON.parse(JSON.stringify(generatedAgents)),
      files: JSON.parse(JSON.stringify(generatedFiles)),
      diff: { added: addedIds, removed: removedIds, changed: changedIds },
      removedNames,
      agentNames: Object.fromEntries(data.agents.map(a => [a.id, a.name])),
      vNum,
    });
    renderVersionPanel();

    const diffBadges = [
      ...addedIds.map(id => `<span class="refine-diff-added">+${data.agents.find(a=>a.id===id)?.name || id}</span>`),
      ...removedIds.map(id => `<span class="refine-diff-removed">-${removedNames[id]}</span>`),
      ...changedIds.map(id => `<span class="refine-diff-changed">~${data.agents.find(a=>a.id===id)?.name || id}</span>`),
    ].join(' ');

    addRefineMessage('ai', (summary || '') + (diffBadges ? '<br/><br/>' + diffBadges : ''));

    updateRefineCounter();

    showResults(true);
    scheduleAutoSave(); // auto-save after refine (#1)

    setTimeout(() => {
      addedIds.forEach(id => {
        const card = document.querySelector(`[data-agent-id="${id}"]`);
        if(card) card.classList.add('just-added');
      });
      changedIds.forEach(id => {
        const card = document.querySelector(`[data-agent-id="${id}"]`);
        if(card) card.classList.add('just-updated');
      });
    }, 150);

    setTimeout(() => buildGraphFromAgents(), 300);

    showNotif(lang === 'en' ? '✓ Team updated!' : '✓ Zespół zaktualizowany!');

  } catch(err) {
    removeRefineThinking();
    const snap = refineSnapshots.pop();
    if(snap) { generatedAgents = snap.agents; generatedFiles = snap.files; }
    addRefineMessage('ai', `<span style="color:var(--accent2)">⚠ ${err.message}</span>`);
    showNotif(lang === 'en' ? '⚠ Refine failed, reverted.' : '⚠ Błąd, przywrócono poprzedni stan.', true);
  }

  isRefining = false;
  document.getElementById('refine-submit-btn').disabled = false;
}

function revertLastRefine() {
  if(!refineSnapshots.length) return;
  const snap = refineSnapshots.pop();
  generatedAgents = snap.agents;
  generatedFiles = snap.files;
  refineHistory = refineHistory.slice(0, -2);
  updateRefineCounter();
  showResults(true);
  buildGraphFromAgents();
  addRefineMessage('ai', lang === 'en' ? '↩ Reverted to previous version.' : '↩ Przywrócono poprzednią wersję.');
  showNotif(lang === 'en' ? '↩ Reverted.' : '↩ Przywrócono.');
}

// ─── RESULTS SCREEN ───────────────────────────────────────
function showResults(skipReset = false) {
  showScreen('results');

  document.getElementById('result-badge').textContent = t('resultBadge');
  document.getElementById('result-title').textContent = t('resultTitle');
  document.getElementById('result-sub').textContent = t('resultSub');
  document.getElementById('download-btn').textContent = t('downloadBtn');
  document.getElementById('instr-btn').textContent = t('instrBtn');
  document.getElementById('refine-btn').textContent = t('refineBtn');
  document.getElementById('md-preview-btn').textContent = lang === 'en' ? '📄 Preview Docs' : '📄 Podgląd Docs';
  document.getElementById('fw-export-btn').textContent = lang === 'en' ? '🚀 Export Framework' : '🚀 Eksport Framework';

  renderVersionPanel();
  renderTraceLive();

  if(!skipReset) {
    refineHistory = [];
    isRefining = false;
    refineSnapshots = [];
    selectedRefineAction = null;
    document.getElementById('refine-panel').style.display = 'none';
    document.getElementById('refine-history').innerHTML = '';
  }

  const lvl = t('levels').find(l => l.id === currentLevel);
  if(lvl) {
    document.getElementById('result-badge').textContent = lvl.emoji + ' ' + lvl.name.toUpperCase() + ' — ' + t('resultBadge');
    document.getElementById('result-badge').style.borderColor = lvl.color + '66';
    document.getElementById('result-badge').style.color = lvl.color;
  }

  if(!skipReset) {
    let scoringAttempts = 0;
    const tryRenderScoring = () => {
      scoringAttempts++;
      if(window._scoringData !== undefined) {
        renderScoring(window._scoringData);
      } else if(scoringAttempts < 30) {
        setTimeout(tryRenderScoring, 400);
      }
      // silently give up after 12s — scoring is non-critical
    };
    setTimeout(tryRenderScoring, 300);
  }

  // Always ensure graph section is visible when results are shown
  document.getElementById('graph-title').textContent = lang==='en' ? 'Agent Dependency Graph' : 'Graf Zależności Agentów';
  document.getElementById('graph-section').style.display = 'block';

  // Auto-save hook (#1)
  _onAgentsReady();

  const grid = document.getElementById('agents-grid');
  grid.innerHTML = '';

  const technical = generatedAgents.filter(a => a.type === 'technical');
  const business  = generatedAgents.filter(a => a.type !== 'technical');

  function makeAgentCard(agent) {
    const isTech = agent.type === 'technical';
    const card = document.createElement('div');
    card.className = 'agent-card';
    card.dataset.type = agent.type || 'technical';
    card.dataset.agentId = agent.id;
    card.innerHTML = `
      <div class="agent-card-header">
        <div class="agent-avatar" style="background:${isTech ? 'linear-gradient(135deg,#7c3aff,#00e5ff)' : 'linear-gradient(135deg,#ff6b35,#ff9500)'}">${agent.emoji || '🤖'}</div>
        <div style="flex:1">
          <div class="agent-name">${agent.name}</div>
          <div class="agent-role">${agent.role}</div>
        </div>
        <div class="agent-type-badge ${isTech ? 'badge-tech' : 'badge-biz'}">${isTech ? (lang==='en'?'TECHNICAL':'TECHNICZNY') : (lang==='en'?'BUSINESS':'BIZNESOWY')}</div>
      </div>
      <div class="agent-card-body">
        <div class="agent-desc">${agent.description}</div>
        <div class="file-chips">
          <div class="file-chip" onclick="previewFile('agent-${agent.id}.md')">agent-${agent.id}.md</div>
          <div class="file-chip" onclick="previewFile('skill-${agent.id}.md')">skill-${agent.id}.md</div>
        </div>
      </div>
    `;
    return card;
  }

  function makeSection(title, icon, agents, colorClass) {
    if(agents.length === 0) return;
    const section = document.createElement('div');
    section.className = 'agent-section';
    section.innerHTML = `<div class="agent-section-header ${colorClass}"><span>${icon}</span><span>${title}</span><span class="section-count">${agents.length}</span></div>`;
    const sg = document.createElement('div');
    sg.className = 'agents-grid';
    agents.forEach(a => sg.appendChild(makeAgentCard(a)));
    section.appendChild(sg);
    grid.appendChild(section);
  }

  makeSection(
    lang==='en' ? 'Technical Agents — Build your app' : 'Agenci Techniczni — Budują aplikację',
    '⚙️', technical, 'section-tech'
  );
  makeSection(
    lang==='en' ? 'Business Agents — Shape your vision' : 'Agenci Biznesowi — Nadają kontekst',
    '💼', business, 'section-biz'
  );

  const configWrap = document.createElement('div');
  configWrap.className = 'agent-section';
  configWrap.innerHTML = `<div class="agent-section-header section-config"><span>🔗</span><span>${lang==='en'?'Team Configuration':'Konfiguracja Zespołu'}</span></div>`;
  const configGrid = document.createElement('div');
  configGrid.className = 'agents-grid';
  const configCard = document.createElement('div');
  configCard.className = 'agent-card';
  configCard.innerHTML = `
    <div class="agent-card-header">
      <div class="agent-avatar" style="background:linear-gradient(135deg,#1e3050,#0b1120)">🔗</div>
      <div>
        <div class="agent-name">${lang==='en' ? 'Team Configuration' : 'Konfiguracja Zespołu'}</div>
        <div class="agent-role">ORCHESTRATION</div>
      </div>
    </div>
    <div class="agent-card-body">
      <div class="agent-desc">${lang==='en' ? 'Defines how all agents connect and collaborate.' : 'Definiuje jak agenci się łączą i współpracują.'}</div>
      <div class="file-chips">
        <div class="file-chip" onclick="previewFile('team-config.md')">team-config.md</div>
        <div class="file-chip" onclick="previewFile('README.md')">README.md</div>
      </div>
    </div>
  `;
  configGrid.appendChild(configCard);
  configWrap.appendChild(configGrid);
  grid.appendChild(configWrap);

  setTimeout(() => {
    buildGraphFromAgents();
    const gc = document.querySelector('.graph-container');
    if(gc && !gc.querySelector('.graph-legend')) {
      const leg = document.createElement('div');
      leg.className = 'graph-legend';
      leg.innerHTML = `
        <span><div class="legend-dot" style="background:#7c3aff"></div>${lang==='en'?'Technical agent':'Agent techniczny'}</span>
        <span><div class="legend-dot" style="background:#ff6b35"></div>${lang==='en'?'Business agent':'Agent biznesowy'}</span>
        <span style="font-size:0.65rem;margin-left:auto;color:var(--muted)">— — ${lang==='en'?'context flow':'przepływ kontekstu'} &nbsp;&nbsp;—— ${lang==='en'?'pipeline':'pipeline'}</span>
      `;
      gc.appendChild(leg);
    }
  }, 100);
}

function showInstructions() {
  const section = document.getElementById('instructions-section');
  const isHidden = getComputedStyle(section).display === 'none';
  section.style.display = isHidden ? 'block' : 'none';
  if(isHidden) {
    document.getElementById('instr-title').textContent = t('instrTitle');
    const steps = document.getElementById('instr-steps');
    steps.innerHTML = '';
    t('instrSteps').forEach((step, i) => {
      const div = document.createElement('div');
      div.className = 'instruction-step';
      div.innerHTML = `<div class="num">0${i+1}</div><div class="content"><strong>${step.title}</strong><p>${step.body}</p></div>`;
      steps.appendChild(div);
    });
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

async function downloadZip() {
  if(typeof JSZip === 'undefined') {
    showNotif('JSZip not loaded', true); return;
  }
  const zip = new JSZip();
  Object.entries(generatedFiles).forEach(([name, content]) => {
    zip.file(name, content);
  });
  // Embed project manifest for lossless re-import (#4)
  const manifest = {
    v: 2,
    source: 'agentspark',
    topic: currentTopic,
    level: currentLevel,
    lang,
    agents: generatedAgents,
    files: generatedFiles,
    ts: Date.now(),
  };
  zip.file('agentspark.json', JSON.stringify(manifest, null, 2));
  const blob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `agentspark-${currentTopic.toLowerCase().replace(/\s+/g,'-')}.zip`;
  a.click();
  showNotif(lang==='en' ? '✓ ZIP downloaded successfully!' : '✓ ZIP pobrany pomyślnie!');
}

// ─── MARKDOWN RENDERER ───────────────────────────────────
function renderMarkdown(md) {
  if(!md) return '';

  // Step 1: Extract fenced code blocks and inline code before ANY other processing
  // so that their content is never HTML-escaped or regex-mangled
  const codeBlocks = [];
  const inlineCodes = [];

  let text = md
    // Fenced code blocks: save content raw, replace with placeholder
    .replace(/```([\w]*)\n?([\s\S]*?)```/g, (_, lang, code) => {
      const escaped = code.trim()
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const idx = codeBlocks.length;
      codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
      return `\x02CODE_BLOCK_${idx}\x03`;
    })
    // Inline code: save raw, replace with placeholder
    .replace(/`([^`\n]+)`/g, (_, code) => {
      const escaped = code
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const idx = inlineCodes.length;
      inlineCodes.push(`<code>${escaped}</code>`);
      return `\x02INLINE_CODE_${idx}\x03`;
    });

  // Step 2: Escape remaining HTML in normal text
  text = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Step 3: Apply markdown transformations
  text = text
    // Headings
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    // Horizontal rule
    .replace(/^---$/gm, '<hr>')
    // Bold + italic
    .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
    // Bold
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    // Italic (skip lone asterisks used as list bullets)
    .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
    // Unordered lists
    .replace(/^\s*[-+] (.+)$/gm, '<li>$1</li>')
    // Ordered lists
    .replace(/^\s*\d+\. (.+)$/gm, '<li>$1</li>')
    // Blockquotes
    .replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

  // Step 4: Line-by-line block wrapping — prevents paragraph text from being
  // swallowed into <ul> when it appears in the same \n\n block as list items
  const outLines = [];
  let inList = false;
  let paraAcc = [];

  const flushPara = () => {
    if (paraAcc.length) {
      outLines.push('<p>' + paraAcc.join('<br>') + '</p>');
      paraAcc = [];
    }
  };
  const flushList = () => {
    if (inList) { outLines.push('</ul>'); inList = false; }
  };

  text.split('\n').forEach(rawLine => {
    const line = rawLine.trim();

    if (!line) {
      flushPara();
      flushList();
      return;
    }

    // Block-level tags / placeholders — emit as-is
    if (line.startsWith('<h')      || line.startsWith('<pre')       ||
        line.startsWith('<hr')     || line.startsWith('<blockquote') ||
        line.startsWith('\x02CODE_BLOCK_')) {
      flushPara();
      flushList();
      outLines.push(line);
      return;
    }

    // List item
    if (line.startsWith('<li>')) {
      flushPara();
      if (!inList) { outLines.push('<ul>'); inList = true; }
      outLines.push(line);
      return;
    }

    // Regular text
    flushList();
    paraAcc.push(line);
  });

  flushPara();
  flushList();

  text = outLines.join('\n');

  // Step 5: Restore code placeholders
  codeBlocks.forEach((html, i) => {
    text = text.replace(`\x02CODE_BLOCK_${i}\x03`, html);
  });
  inlineCodes.forEach((html, i) => {
    text = text.replace(`\x02INLINE_CODE_${i}\x03`, html);
  });

  return text;
}

// ─── FILE PREVIEW MODAL ───────────────────────────────────
function previewFile(filename) {
  const content = generatedFiles[filename];
  if(!content) return;

  currentModalFile = filename;
  currentModalTab = 'preview';

  document.getElementById('modal-title').textContent = filename;
  document.getElementById('modal-filesize').textContent =
    `${(new Blob([content]).size / 1024).toFixed(1)} KB`;

  // Render both panes
  document.getElementById('modal-preview-pane').innerHTML = renderMarkdown(content);
  document.getElementById('modal-raw-pane').textContent = content;

  // Show preview by default
  switchModalTab('preview');

  document.getElementById('modal').classList.add('open');
}

function switchModalTab(tab) {
  currentModalTab = tab;
  const previewPane = document.getElementById('modal-preview-pane');
  const rawPane = document.getElementById('modal-raw-pane');
  const tabPreview = document.getElementById('tab-preview');
  const tabRaw = document.getElementById('tab-raw');

  if(tab === 'preview') {
    previewPane.style.display = 'block';
    rawPane.style.display = 'none';
    tabPreview.classList.add('active');
    tabRaw.classList.remove('active');
  } else {
    previewPane.style.display = 'none';
    rawPane.style.display = 'block';
    tabPreview.classList.remove('active');
    tabRaw.classList.add('active');
  }
}

function downloadCurrentFile() {
  if(!currentModalFile || !generatedFiles[currentModalFile]) return;
  const blob = new Blob([generatedFiles[currentModalFile]], { type: 'text/markdown' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = currentModalFile;
  a.click();
  showNotif(`✓ ${currentModalFile} downloaded`);
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

// ─── MARKDOWN BROWSER (all files) ─────────────────────────
function openMarkdownPreview() {
  if(!Object.keys(generatedFiles).length) {
    showNotif(lang==='en' ? '⚠ No files yet — generate a team first' : '⚠ Brak plików — najpierw wygeneruj zespół', true);
    return;
  }
  const modal = document.getElementById('md-browser-modal');
  modal.classList.add('open');

  const mdFiles = Object.keys(generatedFiles).filter(f => f.endsWith('.md'));
  const sidebar = document.getElementById('md-browser-sidebar');
  sidebar.innerHTML = '';

  // File groups
  const groups = [
    { label: lang==='en' ? '📋 Config' : '📋 Konfiguracja', files: mdFiles.filter(f => f === 'README.md' || f === 'team-config.md') },
    { label: lang==='en' ? '⚙️ Agents' : '⚙️ Agenci', files: mdFiles.filter(f => f.startsWith('agent-')) },
    { label: lang==='en' ? '🎯 Skills' : '🎯 Umiejętności', files: mdFiles.filter(f => f.startsWith('skill-')) },
  ];

  groups.forEach(group => {
    if(!group.files.length) return;

    const groupLabel = document.createElement('div');
    groupLabel.style.cssText = 'font-size:0.6rem;font-family:"Space Mono",monospace;color:var(--muted);padding:0.6rem 1rem 0.3rem;letter-spacing:0.1em;text-transform:uppercase;';
    groupLabel.textContent = group.label;
    sidebar.appendChild(groupLabel);

    group.files.forEach(f => {
      const item = document.createElement('button');
      item.style.cssText = `
        display:block;width:100%;text-align:left;
        background:none;border:none;border-left:2px solid transparent;
        color:var(--muted);padding:0.5rem 1rem;
        font-family:'Space Mono',monospace;font-size:0.68rem;
        cursor:pointer;transition:all 0.15s;line-height:1.4;
        word-break:break-all;
      `;
      item.textContent = f;
      item.dataset.file = f;
      item.onmouseenter = () => { if(f !== mdBrowserActiveFile) item.style.color = 'var(--text)'; };
      item.onmouseleave = () => { if(f !== mdBrowserActiveFile) item.style.color = 'var(--muted)'; };
      item.onclick = () => selectMdBrowserFile(f);
      sidebar.appendChild(item);
    });
  });

  // Select first file
  if(mdFiles.length > 0) {
    selectMdBrowserFile('README.md' in generatedFiles ? 'README.md' : mdFiles[0]);
  }
}

function selectMdBrowserFile(filename) {
  mdBrowserActiveFile = filename;
  const content = generatedFiles[filename] || '';

  // Update sidebar active state
  document.querySelectorAll('#md-browser-sidebar button').forEach(btn => {
    const isActive = btn.dataset.file === filename;
    btn.style.borderLeftColor = isActive ? 'var(--accent)' : 'transparent';
    btn.style.color = isActive ? 'var(--accent)' : 'var(--muted)';
    btn.style.background = isActive ? 'rgba(0,229,255,0.06)' : 'none';
  });

  document.getElementById('md-browser-rendered').innerHTML = renderMarkdown(content);
  document.getElementById('md-browser-active-file').textContent =
    `${filename} · ${(new Blob([content]).size / 1024).toFixed(1)} KB`;

  // Scroll content pane to top
  const contentPane = document.getElementById('md-browser-content');
  contentPane.scrollTop = 0;
}

function closeMdBrowser() {
  document.getElementById('md-browser-modal').classList.remove('open');
}

async function downloadAllMd() {
  if(typeof JSZip === 'undefined') {
    showNotif('JSZip not loaded', true); return;
  }
  const zip = new JSZip();
  Object.entries(generatedFiles)
    .filter(([name]) => name.endsWith('.md'))
    .forEach(([name, content]) => zip.file(name, content));

  const blob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `agentspark-docs-${currentTopic.toLowerCase().replace(/\s+/g,'-')}.zip`;
  a.click();
  showNotif(lang === 'en' ? '✓ Docs ZIP downloaded!' : '✓ Docs ZIP pobrany!');
}

// ─── CHAT HELPERS ─────────────────────────────────────────
function addMessage(role, text) {
  const container = document.getElementById('chat-messages');
  const cleanText = text.replace('[INTERVIEW_COMPLETE]', '').trim();
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  const sender = document.createElement('div');
  sender.className = 'msg-sender';
  sender.textContent = role === 'ai' ? '⚡ AgentSpark' : (lang==='en'?'You':'Ty');
  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  // AI messages may have formatting intent — use innerHTML but only with escaped special chars
  // User messages are always plain text
  if(role === 'user') {
    bubble.textContent = cleanText;
  } else {
    // Sanitise AI output: remove dangerous tags and all event handler attributes
    const sanitized = cleanText
      .replace(/<script[\s\S]*?<\/script>/gi, '')
      .replace(/<iframe[\s\S]*?<\/iframe>/gi, '')
      .replace(/<object[\s\S]*?<\/object>/gi, '')
      .replace(/<embed[^>]*>/gi, '')
      .replace(/\s+on\w+\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]*)/gi, '')  // strip onX= attributes
      .replace(/\s+href\s*=\s*(?:"javascript:[^"]*"|'javascript:[^']*')/gi, ''); // strip javascript: hrefs
    bubble.innerHTML = sanitized;
  }
  div.appendChild(sender);
  div.appendChild(bubble);
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function addTypingIndicator() {
  removeTypingIndicator();
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'msg ai';
  div.id = 'typing-indicator';
  div.innerHTML = `
    <div class="msg-sender">⚡ AgentSpark</div>
    <div class="typing-indicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function removeTypingIndicator() {
  const el = document.getElementById('typing-indicator');
  if(el) el.remove();
}

// ─── PROGRESS ─────────────────────────────────────────────
function renderProgressSteps(activeIndex) {
  const container = document.getElementById('progress-steps');
  container.innerHTML = '';
  t('progressSteps').forEach((label, i) => {
    const div = document.createElement('div');
    div.className = `step ${i < activeIndex ? 'done' : i === activeIndex ? 'active' : ''}`;
    div.innerHTML = `<div class="step-num">${i < activeIndex ? '✓' : i+1}</div><span>${label}</span>`;
    container.appendChild(div);
  });
}

// ─── AI API (multi-provider + automatic fallback) ─────────

// Fallback chains per provider tag — ordered best→fastest
const FALLBACK_CHAINS = {
  gemini: [
    { provider:'gemini', model:'gemini-3-flash-preview', endpoint:'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}', tag:'gemini', label:'Gemini 3 Flash Preview' },
    { provider:'gemini', model:'gemini-2.0-flash',               endpoint:'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}', tag:'gemini', label:'Gemini 2.0 Flash' },
    { provider:'gemini', model:'gemini-1.5-flash',               endpoint:'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}', tag:'gemini', label:'Gemini 1.5 Flash' },
  ],
  openai: [
    { provider:'openai', model:'gpt-4o',      endpoint:'https://api.openai.com/v1/chat/completions', tag:'openai', label:'GPT-4o' },
    { provider:'openai', model:'gpt-4o-mini', endpoint:'https://api.openai.com/v1/chat/completions', tag:'openai', label:'GPT-4o mini' },
    { provider:'openai', model:'gpt-3.5-turbo', endpoint:'https://api.openai.com/v1/chat/completions', tag:'openai', label:'GPT-3.5 Turbo' },
  ],
  anthropic: [
    { provider:'anthropic', model:'claude-sonnet-4-6', endpoint:'https://api.anthropic.com/v1/messages', tag:'anthropic', label:'Claude Sonnet 4.6' },
    { provider:'anthropic', model:'claude-haiku-4-5-20251001', endpoint:'https://api.anthropic.com/v1/messages', tag:'anthropic', label:'Claude Haiku 4.5' },
  ],
  mistral: [
    { provider:'openai', model:'mistral-large-latest',  endpoint:'https://api.mistral.ai/v1/chat/completions', tag:'mistral', label:'Mistral Large' },
    { provider:'openai', model:'mistral-small-latest',  endpoint:'https://api.mistral.ai/v1/chat/completions', tag:'mistral', label:'Mistral Small' },
    { provider:'openai', model:'open-mistral-nemo',     endpoint:'https://api.mistral.ai/v1/chat/completions', tag:'mistral', label:'Mistral Nemo' },
  ],
  groq: [
    { provider:'openai', model:'llama-3.3-70b-versatile', endpoint:'https://api.groq.com/openai/v1/chat/completions', tag:'groq', label:'Llama 3.3 70B' },
    { provider:'openai', model:'llama-3.1-8b-instant',    endpoint:'https://api.groq.com/openai/v1/chat/completions', tag:'groq', label:'Llama 3.1 8B' },
    { provider:'openai', model:'gemma2-9b-it',            endpoint:'https://api.groq.com/openai/v1/chat/completions', tag:'groq', label:'Gemma2 9B' },
  ],
};

// Errors that justify trying a fallback (rate limit, overload, server error)
function isFallbackable(status, message) {
  if([429, 500, 502, 503, 504, 529].includes(status)) return true;
  const msg = (message || '').toLowerCase();
  return msg.includes('rate limit') || msg.includes('overloaded') ||
         msg.includes('capacity') || msg.includes('timeout') ||
         msg.includes('quota') || msg.includes('unavailable');
}

// Update typing indicator text without replacing the dots
function setTypingStatus(text) {
  const el = document.getElementById('typing-indicator');
  if(!el) return;
  let label = el.querySelector('.typing-status-label');
  if(!label) {
    label = document.createElement('div');
    label.className = 'typing-status-label';
    label.style.cssText = 'font-size:0.68rem;font-family:"Space Mono",monospace;color:var(--muted);margin-top:0.4rem;';
    el.appendChild(label);
  }
  label.textContent = text;
}

// Single model call — throws with {status, message} on failure
async function callSingleModel(m, key, systemInstruction, userMessage, _traceLabel) {
  const { provider, model, endpoint } = m;
  const t0 = Date.now();

  // Register span as pending
  const span = {
    id: traceSpans.length,
    label: _traceLabel || 'API Call',
    model: m.label || model,
    provider,
    startMs: t0,
    endMs: null,
    durationMs: null,
    status: 'pending',   // pending | ok | fallback | error
    isFallback: false,
    tokens: null,
    error: null,
  };
  if(!traceSessionStart) traceSessionStart = t0;
  traceSpans.push(span);
  renderTraceLive();  // show pending bar immediately

  const finalize = (status, tokens, error) => {
    span.endMs = Date.now();
    span.durationMs = span.endMs - span.startMs;
    span.status = status;
    span.tokens = tokens || null;
    span.error = error || null;
    renderTraceLive();
  };

  try {
    let result, tokens = null;

    if(provider === 'gemini') {
      const url = endpoint.replace('{model}', model).replace('{key}', key);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          systemInstruction: { parts: [{ text: systemInstruction }] },
          contents: [{ role: 'user', parts: [{ text: userMessage }] }],
          generationConfig: { temperature: 0.8, maxOutputTokens: 4096 }
        })
      });
      if(!res.ok) {
        const err = await res.json().catch(() => ({}));
        const e = new Error(err.error?.message || `Gemini error ${res.status}`);
        e.status = res.status;
        finalize('error', null, e.message);
        throw e;
      }
      const data = await res.json();
      tokens = data.usageMetadata
        ? (data.usageMetadata.totalTokenCount || null)
        : null;
      result = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    }

    else if(provider === 'openai') {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
        body: JSON.stringify({
          model,
          messages: [{ role:'system', content: systemInstruction }, { role:'user', content: userMessage }],
          temperature: 0.8, max_tokens: 4096
        })
      });
      if(!res.ok) {
        const err = await res.json().catch(() => ({}));
        const e = new Error(err.error?.message || `API error ${res.status}`);
        e.status = res.status;
        finalize('error', null, e.message);
        throw e;
      }
      const data = await res.json();
      tokens = data.usage?.total_tokens || null;
      result = data.choices?.[0]?.message?.content || '';
    }

    else if(provider === 'anthropic') {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': key,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model,
          system: systemInstruction,
          messages: [{ role: 'user', content: userMessage }],
          max_tokens: 4096
        })
      });
      if(!res.ok) {
        const err = await res.json().catch(() => ({}));
        const e = new Error(err.error?.message || `Anthropic error ${res.status}`);
        e.status = res.status;
        finalize('error', null, e.message);
        throw e;
      }
      const data = await res.json();
      tokens = data.usage ? (data.usage.input_tokens + data.usage.output_tokens) : null;
      result = data.content?.[0]?.text || '';
    }

    else {
      const e = new Error(`Unknown provider: ${provider}`);
      finalize('error', null, e.message);
      throw e;
    }

    finalize('ok', tokens, null);
    return result;

  } catch(err) {
    // Only finalize if not already done inside branches
    if(span.status === 'pending') finalize('error', null, err.message);
    throw err;
  }
}

// Main entry — tries selected model, then falls back through chain
async function callGemini(systemInstruction, userMessage, traceLabel) {
  const key = apiKey || document.getElementById('apiKeyInput')?.value?.trim();
  if(!key) throw new Error('No API key — please enter your key');

  // Build attempt list: selected model first, then rest of its chain
  const chain = FALLBACK_CHAINS[selectedModel.tag] || [];
  // Put selected model at front, deduplicate by model name
  const primary = { ...selectedModel };
  const rest = chain.filter(m => m.model !== primary.model);
  const attempts = [primary, ...rest];

  let lastError = null;
  for(let i = 0; i < attempts.length; i++) {
    const m = attempts[i];
    const spanLabel = traceLabel
      ? (i > 0 ? `${traceLabel} (fallback)` : traceLabel)
      : (i > 0 ? `Fallback #${i}` : 'API Call');

    if(i > 0) {
      setTypingStatus(`⚠ ${attempts[i-1].label || attempts[i-1].model} failed — trying ${m.label || m.model}…`);
      await new Promise(r => setTimeout(r, 600)); // brief pause before retry
    }
    try {
      const result = await callSingleModel(m, key, systemInstruction, userMessage, spanLabel);

      // If we used a fallback, mark the span and notify user
      if(i > 0) {
        const span = traceSpans[traceSpans.length - 1];
        if(span) { span.status = 'fallback'; span.isFallback = true; }
        renderTraceLive();
        const modelName = m.label || m.model;
        setTimeout(() => showNotif(
          lang === 'en'
            ? `↩ Fell back to ${modelName}`
            : `↩ Przełączono na ${modelName}`
        ), 300);
        // Update header badge to reflect actual model used
        const badgeEl = document.getElementById('headerModelBadge');
        if(badgeEl) badgeEl.textContent = m.model + ' (fallback)';
      }
      setTypingStatus('');
      return result;
    } catch(err) {
      lastError = err;
      const fallbackable = isFallbackable(err.status, err.message);
      // If not a fallbackable error (e.g. 401 auth), fail immediately
      if(!fallbackable) {
        console.warn(`[AgentSpark] Non-fallbackable error on ${m.model}:`, err.message);
        break;
      }
      console.warn(`[AgentSpark] Fallback triggered (${m.model}): ${err.message}`);
    }
  }

  setTypingStatus('');
  throw lastError || new Error('All models failed');
}

// ─── UTILS ────────────────────────────────────────────────
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
}

// ─── SIDEBAR TOGGLE (#5) ──────────────────────────────────
let _sidebarCollapsed = false;
function toggleChatSidebar() {
  _sidebarCollapsed = !_sidebarCollapsed;
  const layout = document.querySelector('.chat-layout');
  const btn = document.getElementById('sidebar-toggle-btn');
  if (layout) layout.classList.toggle('sidebar-collapsed', _sidebarCollapsed);
  if (btn) btn.textContent = _sidebarCollapsed ? '◀' : '▶';
  localStorage.setItem('agentspark-sidebar-collapsed', _sidebarCollapsed ? '1' : '0');
}
// Restore sidebar state on load
(function() {
  window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('agentspark-sidebar-collapsed') === '1') {
      _sidebarCollapsed = true;
      const layout = document.querySelector('.chat-layout');
      const btn = document.getElementById('sidebar-toggle-btn');
      if (layout) layout.classList.add('sidebar-collapsed');
      if (btn) btn.textContent = '◀';
    }
  });
})();

function renderResults() {
  // Alias used when loading a project — renders the results screen UI
  showResults(false);
}

function restart() {
  // If there's unsaved work and a project in progress, offer to save
  if (generatedAgents.length && _currentProjectId === null) {
    const save = window.confirm(
      lang === 'en'
        ? 'Save current project before starting over?'
        : 'Zapisać bieżący projekt przed rozpoczęciem od nowa?'
    );
    if (save) { saveCurrentProject(false); }
  }
  _currentProjectId = null;
  chatHistory = [];
  generatedAgents = [];
  generatedFiles = {};
  refineHistory = [];
  refineSnapshots = [];
  versionHistory = [];
  versionPanelOpen = false;
  traceSpans = [];
  tracePanelOpen = false;
  traceSessionStart = null;
  isRefining = false;
  selectedRefineAction = null;
  questionCount = 0;
  conversationState = 'interview';
  currentModalFile = '';
  mdBrowserActiveFile = '';
  document.getElementById('chat-messages').innerHTML = '';
  if(document.getElementById('refine-history')) document.getElementById('refine-history').innerHTML = '';
  document.getElementById('refine-panel').style.display = 'none';
  document.getElementById('version-panel').style.display = 'none';
  currentLevel = 'iskra';
  MAX_QUESTIONS = 4;
  if(graphAnimFrame) { cancelAnimationFrame(graphAnimFrame); graphAnimFrame = null; }
  graphNodes = []; graphEdges = [];
  document.getElementById('scoring-panel').style.display = 'none';
  document.getElementById('trace-panel').style.display = 'none';
  document.getElementById('graph-section').style.display = 'none';
  const gc = document.querySelector('.graph-container');
  if(gc) { const leg = gc.querySelector('.graph-legend'); if(leg) leg.remove(); }
  document.getElementById('instructions-section').style.display = 'none';
  document.getElementById('apiKeyHeader').style.display = 'none';
  showScreen('topic');
}

let notifTimeout;
function showNotif(msg, isError=false) {
  const old = document.querySelector('.notif');
  if(old) old.remove();
  const div = document.createElement('div');
  div.className = 'notif';
  div.style.borderColor = isError ? 'var(--accent2)' : 'var(--success)';
  div.style.color = isError ? 'var(--accent2)' : 'var(--success)';
  div.textContent = msg;
  document.body.appendChild(div);
  clearTimeout(notifTimeout);
  notifTimeout = setTimeout(() => div.remove(), 3500);
}

// ─── TRACE VIEWER ─────────────────────────────────────────

function toggleTracePanel() {
  tracePanelOpen = !tracePanelOpen;
  document.getElementById('trace-body').classList.toggle('open', tracePanelOpen);
  document.getElementById('trace-toggle-icon').classList.toggle('open', tracePanelOpen);
}

function renderTraceLive() {
  const panel = document.getElementById('trace-panel');
  if(!panel) return;

  if(!traceSpans.length) { panel.style.display = 'none'; return; }
  panel.style.display = 'block';

  // Count badge
  const doneCount = traceSpans.filter(s => s.status !== 'pending').length;
  document.getElementById('trace-span-count').textContent = traceSpans.length;

  // Summary pills
  const pills = document.getElementById('trace-summary-pills');
  const totalMs = traceSpans.reduce((n, s) => n + (s.durationMs || 0), 0);
  const totalTok = traceSpans.reduce((n, s) => n + (s.tokens || 0), 0);
  const hasFallback = traceSpans.some(s => s.isFallback);
  const hasError    = traceSpans.some(s => s.status === 'error');
  const hasPending  = traceSpans.some(s => s.status === 'pending');
  pills.innerHTML = `
    <span class="trace-pill ${hasError ? 'error' : hasFallback ? 'warn' : 'ok'}">
      ${hasError ? '⚠ error' : hasFallback ? '↩ fallback' : '✓ ok'}
    </span>
    <span class="trace-pill">${(totalMs/1000).toFixed(1)}s total</span>
    ${totalTok ? `<span class="trace-pill">${totalTok.toLocaleString()} tokens</span>` : ''}
    ${hasPending ? `<span class="trace-pill">⏳ running…</span>` : ''}
  `;

  // Span rows
  const spansEl = document.getElementById('trace-spans');

  // Calculate timeline scale
  const sessionStart = traceSessionStart || (traceSpans[0]?.startMs || Date.now());
  const sessionEnd   = Math.max(...traceSpans.map(s => s.endMs || Date.now()));
  const sessionRange = Math.max(sessionEnd - sessionStart, 1);

  spansEl.innerHTML = '';
  traceSpans.forEach(s => {
    const left  = ((s.startMs - sessionStart) / sessionRange) * 100;
    const width = s.durationMs
      ? Math.max((s.durationMs / sessionRange) * 100, 1.5)
      : Math.max(((Date.now() - s.startMs) / sessionRange) * 100, 3);

    const fillClass = s.status === 'ok' ? 'fill-ok'
      : s.status === 'fallback' ? 'fill-fallback'
      : s.status === 'error'   ? 'fill-error'
      : 'fill-pending';

    const badgeClass = s.status === 'ok' ? 'badge-ok'
      : s.status === 'fallback' ? 'badge-fallback'
      : s.status === 'error'   ? 'badge-error'
      : 'badge-pending';

    const badgeText = s.status === 'ok' ? 'OK'
      : s.status === 'fallback' ? 'FALLBACK'
      : s.status === 'error'   ? 'ERROR'
      : '…';

    const durText = s.durationMs
      ? s.durationMs >= 1000 ? `${(s.durationMs/1000).toFixed(1)}s` : `${s.durationMs}ms`
      : '…';

    const tokenText = s.tokens ? s.tokens.toLocaleString() : '–';

    const row = document.createElement('div');
    row.className = 'trace-span';
    row.innerHTML = `
      <div class="span-name">
        <div class="span-label" title="${s.label}">${s.label}</div>
        <div class="span-model" title="${s.model}">${s.model}</div>
      </div>
      <div class="span-bar-col">
        <div class="span-bar-track">
          <div class="span-bar-fill ${fillClass}" style="margin-left:${left.toFixed(1)}%;width:${width.toFixed(1)}%"></div>
        </div>
      </div>
      <div class="span-duration">${durText}</div>
      <div class="span-tokens">${tokenText}</div>
      <div class="span-status"><span class="span-badge ${badgeClass}">${badgeText}</span></div>
    `;
    spansEl.appendChild(row);
  });

  // Footer stats
  const footerEl = document.getElementById('trace-footer');
  const calls = traceSpans.length;
  const errors = traceSpans.filter(s => s.status === 'error').length;
  const fallbacks = traceSpans.filter(s => s.isFallback).length;
  footerEl.innerHTML = `
    <span><strong>${calls}</strong> ${lang==='en'?'API calls':'wywołań API'}</span>
    <span><strong>${(totalMs/1000).toFixed(1)}s</strong> ${lang==='en'?'total time':'łączny czas'}</span>
    ${totalTok ? `<span><strong>${totalTok.toLocaleString()}</strong> ${lang==='en'?'tokens':'tokenów'}</span>` : ''}
    ${fallbacks ? `<span><strong>${fallbacks}</strong> ${lang==='en'?'fallbacks':'fallbacków'}</span>` : ''}
    ${errors ? `<span style="color:var(--accent2)"><strong>${errors}</strong> ${lang==='en'?'errors':'błędów'}</span>` : ''}
    <span style="margin-left:auto;color:var(--muted)">${lang==='en'?'Session':'Sesja'}: ${new Date(sessionStart).toLocaleTimeString()}</span>
  `;
}

// ─── VERSION HISTORY ──────────────────────────────────────

function renderVersionPanel() {
  const panel = document.getElementById('version-panel');
  const timeline = document.getElementById('version-timeline');
  const badge = document.getElementById('version-count-badge');
  const icon = document.getElementById('version-toggle-icon');

  const total = versionHistory.length;
  if(total === 0) { panel.style.display = 'none'; return; }

  panel.style.display = 'block';
  badge.textContent = total;
  icon.className = 'version-toggle-icon' + (versionPanelOpen ? ' open' : '');
  timeline.className = 'version-timeline' + (versionPanelOpen ? ' open' : '');

  timeline.innerHTML = '';

  // Show newest first
  const reversed = [...versionHistory].reverse();

  reversed.forEach((v, ri) => {
    const isCurrentIdx = ri === 0;
    const origIdx = versionHistory.indexOf(v);           // index in versionHistory array

    const entry = document.createElement('div');
    entry.className = 'version-entry' + (isCurrentIdx ? ' current' : '') + (v.isOrigin ? ' origin' : '');

    // Diff tags
    const diffHtml = [
      ...v.diff.added.map(id =>
        `<span class="diff-tag diff-added">+${v.agentNames?.[id] || id}</span>`),
      ...v.diff.removed.map(id =>
        `<span class="diff-tag diff-removed">−${v.removedNames?.[id] || id}</span>`),
      ...v.diff.changed.map(id =>
        `<span class="diff-tag diff-changed">~${v.agentNames?.[id] || id}</span>`),
    ].join('');

    // Agent list preview
    const agentPreview = v.agents.map(a => a.name).join(', ');

    // Time label
    const timeLabel = formatVersionTime(v.ts);

    // Actions: can't restore current, can't diff origin
    const restoreBtn = !isCurrentIdx
      ? `<button class="version-btn restore-btn" onclick="restoreVersion(${origIdx})">↩ ${lang==='en'?'Restore':'Przywróć'}</button>`
      : `<span class="version-current-tag">CURRENT</span>`;

    const diffBtn = origIdx > 0
      ? `<button class="version-btn diff-btn" onclick="showDiffModal(${origIdx})">🔍 ${lang==='en'?'Diff':'Porównaj'}</button>`
      : '';

    const downloadBtn = `<button class="version-btn" onclick="downloadVersionZip(${origIdx})">⬇ ZIP</button>`;

    entry.innerHTML = `
      <div class="version-dot-col">
        <div class="version-dot">${v.isOrigin ? '●' : 'v' + v.vNum}</div>
      </div>
      <div class="version-card">
        <div class="version-card-top">
          <div class="version-label">${escapeHtml(v.label)}</div>
          <div class="version-time">${timeLabel}</div>
        </div>
        ${diffHtml ? `<div class="version-diff">${diffHtml}</div>` : ''}
        <div class="version-agents">⚡ ${agentPreview}</div>
        <div class="version-actions">
          ${restoreBtn}
          ${diffBtn}
          ${downloadBtn}
        </div>
      </div>
    `;
    timeline.appendChild(entry);
  });
}

function toggleVersionPanel() {
  versionPanelOpen = !versionPanelOpen;
  renderVersionPanel();
}

function formatVersionTime(ts) {
  if(!ts) return '';
  const d = ts instanceof Date ? ts : new Date(ts);
  const now = new Date();
  const diffMs = now - d;
  const diffM = Math.floor(diffMs / 60000);
  if(diffM < 1)  return lang==='en' ? 'just now' : 'przed chwilą';
  if(diffM < 60) return `${diffM}m ${lang==='en'?'ago':'temu'}`;
  const diffH = Math.floor(diffM / 60);
  if(diffH < 24) return `${diffH}h ${lang==='en'?'ago':'temu'}`;
  return d.toLocaleDateString();
}

function restoreVersion(idx) {
  if(idx < 0 || idx >= versionHistory.length) return;
  const v = versionHistory[idx];

  // Save current state as new version before restoring
  const alreadySaved = versionHistory[versionHistory.length - 1];
  // Don't double-save if idx is already last
  if(idx !== versionHistory.length - 1) {
    versionHistory.push({
      id: Date.now(),
      label: lang==='en' ? `Restored v${v.vNum}` : `Przywrócono v${v.vNum}`,
      ts: new Date(),
      agents: JSON.parse(JSON.stringify(v.agents)),
      files: JSON.parse(JSON.stringify(v.files)),
      diff: { added: [], removed: [], changed: [] },
      removedNames: {},
      agentNames: Object.fromEntries(v.agents.map(a => [a.id, a.name])),
      vNum: versionHistory.length + 1,
    });
  }

  generatedAgents = JSON.parse(JSON.stringify(v.agents));
  generatedFiles  = JSON.parse(JSON.stringify(v.files));

  showResults(true);
  buildGraphFromAgents();
  renderVersionPanel();

  showNotif(lang==='en'
    ? `↩ Restored to v${v.vNum}: "${v.label}"`
    : `↩ Przywrócono v${v.vNum}: "${v.label}"`);
}

async function downloadVersionZip(idx) {
  if(typeof JSZip === 'undefined') { showNotif('JSZip not loaded', true); return; }
  const v = versionHistory[idx];
  if(!v) return;
  const zip = new JSZip();
  Object.entries(v.files).forEach(([name, content]) => zip.file(name, content));
  const blob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `agentspark-v${v.vNum}-${currentTopic.toLowerCase().replace(/\s+/g,'-')}.zip`;
  a.click();
  showNotif(`✓ v${v.vNum} ZIP downloaded`);
}

function showDiffModal(idx) {
  if(idx < 1 || idx >= versionHistory.length) return;
  const vNew = versionHistory[idx];
  const vOld = versionHistory[idx - 1];

  const modal = document.getElementById('diff-modal');
  const title = document.getElementById('diff-modal-title');
  const body  = document.getElementById('diff-modal-body');

  title.textContent = lang==='en'
    ? `🔍 v${vOld.vNum} → v${vNew.vNum}: "${vNew.label}"`
    : `🔍 v${vOld.vNum} → v${vNew.vNum}: "${vNew.label}"`;

  const { added, removed, changed } = vNew.diff;

  let html = '';

  if(added.length) {
    html += `<div class="diff-section">
      <div class="diff-section-title" style="color:var(--success)">➕ ${lang==='en'?'Added Agents':'Dodani Agenci'} (${added.length})</div>
      ${added.map(id => {
        const a = vNew.agents.find(ag => ag.id === id);
        if(!a) return '';
        return `<div class="diff-agent-row row-added">
          <span class="row-icon">${a.emoji||'🤖'}</span>
          <div><div class="diff-agent-name">${a.name}</div><div class="diff-agent-role">${a.role||''}</div></div>
        </div>`;
      }).join('')}
    </div>`;
  }

  if(removed.length) {
    html += `<div class="diff-section">
      <div class="diff-section-title" style="color:var(--accent2)">🗑 ${lang==='en'?'Removed Agents':'Usunięci Agenci'} (${removed.length})</div>
      ${removed.map(id => {
        const a = vOld.agents.find(ag => ag.id === id);
        if(!a) return '';
        return `<div class="diff-agent-row row-removed">
          <span class="row-icon">${a.emoji||'🤖'}</span>
          <div><div class="diff-agent-name">${a.name}</div><div class="diff-agent-role">${a.role||''}</div></div>
        </div>`;
      }).join('')}
    </div>`;
  }

  if(changed.length) {
    html += `<div class="diff-section">
      <div class="diff-section-title" style="color:#ffd580">✏ ${lang==='en'?'Modified Agents':'Zmodyfikowani Agenci'} (${changed.length})</div>
      ${changed.map(id => {
        const aNew = vNew.agents.find(ag => ag.id === id);
        const aOld = vOld.agents.find(ag => ag.id === id);
        if(!aNew) return '';
        const descChanged = aOld && aOld.description !== aNew.description;
        const roleChanged = aOld && aOld.role !== aNew.role;
        return `<div class="diff-agent-row row-changed">
          <span class="row-icon">${aNew.emoji||'🤖'}</span>
          <div style="flex:1">
            <div class="diff-agent-name">${aNew.name}</div>
            ${roleChanged ? `<div class="diff-agent-role" style="color:#ffd580">Role: ${aOld.role} → ${aNew.role}</div>` : ''}
            ${descChanged ? `<div style="font-size:0.7rem;color:var(--muted);margin-top:0.25rem;line-height:1.4;">${aNew.description.slice(0,120)}${aNew.description.length>120?'…':''}</div>` : ''}
          </div>
        </div>`;
      }).join('')}
    </div>`;
  }

  if(!added.length && !removed.length && !changed.length) {
    html = `<div style="padding:2rem;text-align:center;color:var(--muted);font-family:'Space Mono',monospace;font-size:0.82rem;">
      ${lang==='en'?'No structural changes — metadata or descriptions updated.':'Brak zmian strukturalnych — zaktualizowano metadane lub opisy.'}
    </div>`;
  }

  // Agent count summary
  html = `<div style="display:flex;gap:1.5rem;padding:0 0 1.25rem;font-family:'Space Mono',monospace;font-size:0.72rem;color:var(--muted);border-bottom:1px solid var(--border);margin-bottom:1.25rem;">
    <span>${lang==='en'?'Before':'Przed'}: <strong style="color:var(--text)">${vOld.agents.length} ${lang==='en'?'agents':'agentów'}</strong></span>
    <span>→</span>
    <span>${lang==='en'?'After':'Po'}: <strong style="color:var(--text)">${vNew.agents.length} ${lang==='en'?'agents':'agentów'}</strong></span>
    <span style="margin-left:auto;">${lang==='en'?'Change':'Zmiana'}: ${vNew.agents.length - vOld.agents.length > 0 ? '+' : ''}${vNew.agents.length - vOld.agents.length}</span>
  </div>` + html;

  body.innerHTML = html;
  modal.classList.add('open');
}

function closeDiffModal() {
  document.getElementById('diff-modal').classList.remove('open');
}

// ─── FRAMEWORK EXPORT ─────────────────────────────────────

const FRAMEWORKS = [
  { id: 'crewai',   label: 'CrewAI',    badge: 'Python',   logo: '🤝', pip: 'pip install crewai crewai-tools',
    desc: 'Role-based agents with tasks and tools. Best for sequential and hierarchical workflows.',
    url: 'https://docs.crewai.com' },
  { id: 'langgraph', label: 'LangGraph', badge: 'Python',  logo: '🔗', pip: 'pip install langgraph langchain-openai',
    desc: 'Stateful multi-agent graphs with cycles and branching. Best for complex conditional flows.',
    url: 'https://langchain-ai.github.io/langgraph' },
  { id: 'autogen',  label: 'AutoGen',   badge: 'Python',   logo: '🔄', pip: 'pip install pyautogen',
    desc: 'Conversational multi-agent framework with human-in-the-loop support. Best for agentic chat.',
    url: 'https://microsoft.github.io/autogen' },
  { id: 'swarm',    label: 'Swarm',     badge: 'Python',   logo: '🐝', pip: 'pip install git+https://github.com/openai/swarm.git',
    desc: 'Lightweight OpenAI Swarm with handoffs between agents. Best for simple agent routing.',
    url: 'https://github.com/openai/swarm' },
];

let activeFwTab = 'crewai';

// ═══════════════════════════════════════════════════════════
// ─── IMPORT PROJECT (#4) ─────────────────────────────────
// ═══════════════════════════════════════════════════════════

let _importParsed = null; // holds parsed payload ready to confirm

// ── Open / close ──────────────────────────────────────────
function openImportModal() {
  resetImportModal();
  document.getElementById('import-modal').classList.add('open');
}
function closeImportModal() {
  document.getElementById('import-modal').classList.remove('open');
  _importParsed = null;
}

// ── Drag & drop ───────────────────────────────────────────
function handleImportDrop(e) {
  e.preventDefault();
  document.getElementById('import-dropzone').classList.remove('drag-over');
  const file = e.dataTransfer?.files?.[0];
  if (file) _processImportFile(file);
}
function handleImportFileSelect(input) {
  const file = input.files?.[0];
  if (file) _processImportFile(file);
  input.value = ''; // reset so same file can be re-selected
}

// ── Core parser ───────────────────────────────────────────
async function _processImportFile(file) {
  _clearImportError();
  const ext = file.name.split('.').pop().toLowerCase();

  try {
    if (ext === 'json') {
      const text = await file.text();
      await _parseImportJson(text, file.name);
    } else if (ext === 'zip') {
      await _parseImportZip(file);
    } else {
      _showImportError(`Unsupported file type ".${ext}". Please use .json or .zip`);
    }
  } catch(e) {
    _showImportError('Failed to read file: ' + e.message);
  }
}

async function _parseImportJson(text, filename) {
  let data;
  try { data = JSON.parse(text); }
  catch(e) { _showImportError('Invalid JSON: ' + e.message); return; }

  // Support multiple JSON shapes:
  // 1) AgentSpark share payload  { v, agents, files, topic, level, lang }
  // 2) AgentSpark project record { id, name, agents, files, topic, ... }
  // 3) Raw agents array           [ { id, name, ... }, ... ]
  let payload;
  if (Array.isArray(data) && data[0]?.id && data[0]?.name) {
    // Raw agents array
    payload = { agents: data, topic: 'Imported', level: 'iskra', files: {} };
  } else if (data.agents?.length) {
    payload = data;
  } else {
    _showImportError('No agents found in this JSON file. Make sure it\'s an AgentSpark export.');
    return;
  }
  _importParsed = { ...payload, _sourceFile: filename };
  _showImportPreview(payload, filename);
}

async function _parseImportZip(file) {
  if (typeof JSZip === 'undefined') {
    _showImportError('JSZip library not loaded — cannot read ZIP files.'); return;
  }
  let zip;
  try {
    zip = await JSZip.loadAsync(file);
  } catch(e) {
    _showImportError('Cannot open ZIP: ' + e.message); return;
  }

  // Strategy 1: look for agentspark.json manifest (lossless)
  const manifestFile = zip.file('agentspark.json');
  if (manifestFile) {
    const text = await manifestFile.async('text');
    await _parseImportJson(text, file.name + ' → agentspark.json');
    return;
  }

  // Strategy 2: look for any .json in the zip
  const jsonFiles = Object.keys(zip.files).filter(n => n.endsWith('.json') && !zip.files[n].dir);
  for (const jf of jsonFiles) {
    const text = await zip.file(jf).async('text');
    try {
      const data = JSON.parse(text);
      if (data.agents?.length) {
        _importParsed = { ...data, _sourceFile: file.name };
        _showImportPreview(data, file.name);
        return;
      }
    } catch(e) { /* try next */ }
  }

  // Strategy 3: reconstruct from .md files (generic zip without manifest)
  const mdFiles = {};
  const mdNames = Object.keys(zip.files).filter(n => n.endsWith('.md') && !zip.files[n].dir);
  for (const mf of mdNames) {
    mdFiles[mf] = await zip.file(mf).async('text');
  }
  if (!mdNames.length) {
    _showImportError('No recognizable AgentSpark files found in this ZIP.'); return;
  }
  const reconstructed = _reconstructFromMdFiles(mdFiles, file.name);
  if (!reconstructed.agents.length) {
    _showImportError('Could not reconstruct agents from .md files in this ZIP.'); return;
  }
  _importParsed = { ...reconstructed, _sourceFile: file.name };
  _showImportPreview(reconstructed, file.name);
}

// Reconstruct minimal agent list from agent-*.md files
function _reconstructFromMdFiles(mdFiles, zipName) {
  const agents = [];
  const files  = { ...mdFiles };
  let topic = 'Imported from ZIP';

  // Try to get topic from README.md
  if (mdFiles['README.md']) {
    const m = mdFiles['README.md'].match(/\*\*Project:\*\*\s*(.+)/);
    if (m) topic = m[1].trim();
  }

  // Parse agent-*.md files
  Object.entries(mdFiles).forEach(([name, content]) => {
    if (!name.startsWith('agent-') || !name.endsWith('.md')) return;
    const idSlug = name.replace(/^agent-/, '').replace(/\.md$/, '');
    const nameMatch    = content.match(/^#\s+Agent:\s+(.+)/m);
    const roleMatch    = content.match(/\*\*Role:\*\*\s*(.+)/m);
    const emojiMatch   = content.match(/^##\s+Identity[\s\S]*?([^\w\s])/m);
    const descMatch    = content.match(/^##\s+Goal\s*\n+([\s\S]+?)(?:\n##|$)/m);
    agents.push({
      id:          idSlug,
      name:        nameMatch?.[1]?.trim()  || idSlug,
      emoji:       emojiMatch?.[1]         || '🤖',
      type:        'technical',
      role:        roleMatch?.[1]?.trim()  || 'Agent',
      description: descMatch?.[1]?.trim().slice(0, 200) || '',
      agentMd:     content,
      skillMd:     mdFiles[`skill-${idSlug}.md`] || '',
    });
  });

  return { agents, files, topic, level: 'iskra', lang: 'en' };
}

// ── Preview ───────────────────────────────────────────────
function _showImportPreview(payload, filename) {
  const agents = payload.agents || [];
  const tech   = agents.filter(a => a.type === 'technical');
  const biz    = agents.filter(a => a.type !== 'technical');
  const fileCount = Object.keys(payload.files || {}).length;

  const preview = document.getElementById('import-preview');
  const content = document.getElementById('import-preview-content');
  const dropzone = document.getElementById('import-dropzone');

  content.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 1.5rem;margin-bottom:0.75rem;">
      <div><span style="color:var(--muted);font-size:0.72rem;">FILE</span><br/><strong style="font-size:0.85rem;">${_escHtml(filename)}</strong></div>
      <div><span style="color:var(--muted);font-size:0.72rem;">TOPIC</span><br/><strong style="font-size:0.85rem;">${_escHtml(payload.topic || '—')}</strong></div>
      <div><span style="color:var(--muted);font-size:0.72rem;">LEVEL</span><br/><strong style="font-size:0.85rem;">${payload.level || '—'}</strong></div>
      <div><span style="color:var(--muted);font-size:0.72rem;">FILES</span><br/><strong style="font-size:0.85rem;">${fileCount} .md files</strong></div>
    </div>
    <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.4rem;">AGENTS (${agents.length})</div>
    <div style="display:flex;flex-wrap:wrap;gap:0.4rem;">
      ${agents.map(a => `<span style="font-size:0.75rem;padding:0.2rem 0.55rem;border-radius:5px;
        background:${a.type==='technical'?'rgba(124,58,255,0.12)':'rgba(255,107,53,0.12)'};
        border:1px solid ${a.type==='technical'?'rgba(124,58,255,0.3)':'rgba(255,107,53,0.3)'};
        color:${a.type==='technical'?'var(--accent3)':'var(--accent2)'}">${a.emoji||'🤖'} ${_escHtml(a.name)}</span>`).join('')}
    </div>
    ${!agents.length ? '<div style="color:var(--accent2);">⚠ No agents detected</div>' : ''}
  `;

  preview.style.display = 'block';
  dropzone.style.opacity = '0.5';
  dropzone.style.pointerEvents = 'none';
}

// ── Confirm import ────────────────────────────────────────
async function confirmImport() {
  if (!_importParsed) return;
  const p = _importParsed;
  const saveToDb = document.getElementById('import-save-checkbox')?.checked !== false;

  // Restore state — same pattern as loadProject / share restore
  currentTopic    = p.topic   || 'Imported Project';
  currentLevel    = p.level   || 'iskra';
  if (p.lang) { lang = p.lang; setLang(lang); }
  generatedAgents = JSON.parse(JSON.stringify(p.agents || []));
  generatedFiles  = JSON.parse(JSON.stringify(p.files  || {}));

  // Regenerate missing files
  if (!generatedFiles['README.md'] && generatedAgents.length) {
    generatedFiles['README.md'] = generateReadme();
  }
  generatedAgents.forEach(a => {
    if (!generatedFiles[`agent-${a.id}.md`] && a.agentMd)
      generatedFiles[`agent-${a.id}.md`] = a.agentMd;
    if (!generatedFiles[`skill-${a.id}.md`] && a.skillMd)
      generatedFiles[`skill-${a.id}.md`] = a.skillMd;
  });

  // Bootstrap version history
  versionHistory = [{
    id: Date.now(),
    label: lang==='en' ? `Imported: ${currentTopic}` : `Zaimportowany: ${currentTopic}`,
    ts: new Date(),
    agents: JSON.parse(JSON.stringify(generatedAgents)),
    files:  JSON.parse(JSON.stringify(generatedFiles)),
    diff: { added: [], removed: [], changed: [] },
    removedNames: {},
    agentNames: Object.fromEntries(generatedAgents.map(a => [a.id, a.name])),
    vNum: 1,
    isOrigin: true,
  }];

  // Reset project ID — will be assigned fresh by save
  _currentProjectId = null;

  closeImportModal();
  showScreen('results');
  document.getElementById('apiKeyHeader').style.display = 'flex';
  showResults(false);

  // Save to IndexedDB if requested
  if (saveToDb) {
    await saveCurrentProject(true);
  }

  showNotif(lang==='en'
    ? `✓ Imported "${currentTopic}" — ${generatedAgents.length} agents`
    : `✓ Zaimportowano "${currentTopic}" — ${generatedAgents.length} agentów`
  );
}

// ── Reset modal ───────────────────────────────────────────
function resetImportModal() {
  _importParsed = null;
  const preview  = document.getElementById('import-preview');
  const error    = document.getElementById('import-error');
  const dropzone = document.getElementById('import-dropzone');
  if (preview)  preview.style.display  = 'none';
  if (error)    error.style.display    = 'none';
  if (dropzone) { dropzone.style.opacity = ''; dropzone.style.pointerEvents = ''; }
}

function _showImportError(msg) {
  const el = document.getElementById('import-error');
  if (!el) return;
  el.textContent = '⚠ ' + msg;
  el.style.display = 'block';
}
function _clearImportError() {
  const el = document.getElementById('import-error');
  if (el) el.style.display = 'none';
}

// ─── PROMPT EXPORT (#7) ──────────────────────────────────
let _activePromptTab = 'interview';

const PROMPT_TAB_DESCS = {
  interview: 'System prompt used during the AI interview phase — guides question format, depth calibration, and IMPACT notes.',
  generate:  'System prompt used to generate your agent team JSON from interview answers.',
  refine:    'System prompt used when refining / editing an existing team.'
};

function openPromptExport() {
  _activePromptTab = 'interview';
  _renderPromptTab('interview');
  document.getElementById('prompt-export-modal').classList.add('open');
}

function closePromptExport() {
  document.getElementById('prompt-export-modal').classList.remove('open');
}

function switchPromptTab(tab) {
  _activePromptTab = tab;
  document.querySelectorAll('.prompt-tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('ptab-' + tab).classList.add('active');
  _renderPromptTab(tab);
}

function _getPromptForTab(tab) {
  if (tab === 'interview') return getSystemPrompt();
  if (tab === 'generate')  return getSystemPrompt() + '\n\n--- GENERATION PHASE TRIGGER ---\nWhen user sends [GENERATE], respond with the JSON agent team.';
  if (tab === 'refine')    return getRefineSystemPrompt();
  return '';
}

function _renderPromptTab(tab) {
  const ta = document.getElementById('prompt-export-textarea');
  const desc = document.getElementById('prompt-tab-desc');
  if (ta) ta.value = _getPromptForTab(tab);
  if (desc) desc.textContent = PROMPT_TAB_DESCS[tab] || '';
  // reset copy feedback
  const fb = document.getElementById('copy-prompt-feedback');
  if (fb) { fb.textContent = ''; fb.style.opacity = '0'; }
}

async function copyPromptToClipboard() {
  const ta = document.getElementById('prompt-export-textarea');
  const fb = document.getElementById('copy-prompt-feedback');
  const btn = document.getElementById('copy-prompt-btn');
  if (!ta) return;
  try {
    await navigator.clipboard.writeText(ta.value);
    if (fb) { fb.textContent = '✓ Copied!'; fb.style.opacity = '1'; setTimeout(() => { fb.style.opacity = '0'; }, 2000); }
    if (btn) { const orig = btn.textContent; btn.textContent = '✓ Copied!'; setTimeout(() => { btn.textContent = orig; }, 1500); }
  } catch(e) {
    ta.select();
    document.execCommand('copy');
    if (fb) { fb.textContent = '✓ Copied!'; fb.style.opacity = '1'; setTimeout(() => { fb.style.opacity = '0'; }, 2000); }
  }
}

function downloadPromptTxt() {
  const content = _getPromptForTab(_activePromptTab);
  const topicSlug = (currentTopic || 'agentspark').toLowerCase().replace(/\s+/g, '-');
  const filename = `prompt-${_activePromptTab}-${topicSlug}.txt`;
  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function openFrameworkExport() {
  if(!generatedAgents.length) {
    showNotif(lang==='en' ? '⚠ Generate a team first' : '⚠ Najpierw wygeneruj zespół', true);
    return;
  }
  renderFwModal();
  document.getElementById('fw-modal').classList.add('open');
}

function closeFwModal() {
  document.getElementById('fw-modal').classList.remove('open');
}

function renderFwModal() {
  const tabsEl = document.getElementById('fw-tabs');
  const bodyEl = document.getElementById('fw-body');
  tabsEl.innerHTML = '';
  bodyEl.innerHTML = '';

  FRAMEWORKS.forEach(fw => {
    // Tab
    const tab = document.createElement('button');
    tab.className = 'fw-tab' + (activeFwTab === fw.id ? ' active' : '');
    tab.innerHTML = `${fw.logo} ${fw.label} <span class="fw-badge">${fw.badge}</span>`;
    tab.onclick = () => { activeFwTab = fw.id; renderFwModal(); };
    tabsEl.appendChild(tab);

    // Pane
    const pane = document.createElement('div');
    pane.className = 'fw-pane' + (activeFwTab === fw.id ? ' active' : '');

    const code = generateFrameworkCode(fw.id);
    pane.innerHTML = `
      <div class="fw-info">
        <div class="fw-info-text">
          <div class="fw-info-title">${fw.logo} ${fw.label}</div>
          <div class="fw-info-desc">${fw.desc} <a href="${fw.url}" target="_blank" style="color:var(--accent);text-decoration:none;">Docs ↗</a></div>
        </div>
      </div>
      <div class="fw-code-wrap">
        <pre id="fw-code-${fw.id}">${escapeHtml(code)}</pre>
      </div>
      <div class="fw-footer-row">
        <div class="fw-pip">$ ${fw.pip}</div>
        <button class="modal-download-btn" onclick="copyFwCode('${fw.id}')">📋 ${lang==='en'?'Copy':'Kopiuj'}</button>
        <button class="modal-download-btn" onclick="downloadFwCode('${fw.id}')">⬇ ${lang==='en'?'Download .py':'Pobierz .py'}</button>
      </div>
    `;
    bodyEl.appendChild(pane);
  });
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function copyFwCode(fwId) {
  const code = generateFrameworkCode(fwId);
  navigator.clipboard.writeText(code).then(() => {
    showNotif(lang==='en' ? '✓ Code copied to clipboard!' : '✓ Kod skopiowany!');
  }).catch(() => {
    showNotif(lang==='en' ? '⚠ Copy failed — select manually' : '⚠ Kopiowanie nieudane', true);
  });
}

function downloadFwCode(fwId) {
  const code = generateFrameworkCode(fwId);
  const slug = currentTopic.toLowerCase().replace(/\s+/g, '_');
  const filename = `${fwId}_${slug}.py`;
  const blob = new Blob([code], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  showNotif(`✓ ${filename} downloaded`);
}

// ── Code generators ────────────────────────────────────────

function generateFrameworkCode(fwId) {
  switch(fwId) {
    case 'crewai':   return genCrewAI();
    case 'langgraph': return genLangGraph();
    case 'autogen':  return genAutoGen();
    case 'swarm':    return genSwarm();
    default:         return '# Unknown framework';
  }
}

function agentVarName(agent) {
  return agent.id.replace(/-/g, '_') + '_agent';
}
function taskVarName(agent) {
  return agent.id.replace(/-/g, '_') + '_task';
}

function genCrewAI() {
  const topic = currentTopic;
  const agents = generatedAgents;
  const agentDefs = agents.map(a => `
${agentVarName(a)} = Agent(
    role="${a.role || a.name}",
    goal="${a.description.split('.')[0]}.",
    backstory="""${a.description}""",
    verbose=True,
    allow_delegation=${a.type === 'technical' ? 'False' : 'True'},
    tools=[],  # Add your tools here
)`).join('\n');

  const taskDefs = agents.map((a, i) => {
    const next = agents[i + 1];
    return `
${taskVarName(a)} = Task(
    description="""
    Topic: ${topic}
    Agent: ${a.name} — ${a.role || ''}
    ${a.description}
    """,
    expected_output="Detailed output from ${a.name} covering its responsibilities.",
    agent=${agentVarName(a)},${next ? `\n    context=[],  # Will receive output from previous tasks` : ''}
)`;
  }).join('\n');

  const agentList = agents.map(a => `    ${agentVarName(a)},`).join('\n');
  const taskList  = agents.map(a => `    ${taskVarName(a)},`).join('\n');

  return `"""
AgentSpark → CrewAI Export
Topic: ${topic}
Generated: ${new Date().toISOString().slice(0,10)}
Docs: https://docs.crewai.com
"""

from crewai import Agent, Task, Crew, Process
# from crewai_tools import SerperDevTool, FileReadTool  # uncomment to add tools

# ── Agents ────────────────────────────────────────────────
${agentDefs}

# ── Tasks ─────────────────────────────────────────────────
${taskDefs}

# ── Crew ──────────────────────────────────────────────────
crew = Crew(
    agents=[
${agentList}
    ],
    tasks=[
${taskList}
    ],
    process=Process.sequential,  # or Process.hierarchical
    verbose=True,
)

# ── Run ───────────────────────────────────────────────────
if __name__ == "__main__":
    result = crew.kickoff()
    print("\\n=== CREW RESULT ===")
    print(result)
`;
}

function genLangGraph() {
  const topic = currentTopic;
  const agents = generatedAgents;

  const stateFields = agents.map(a =>
    `    ${a.id.replace(/-/g,'_')}_output: str`
  ).join('\n');

  const nodeDefs = agents.map(a => {
    const varName = a.id.replace(/-/g,'_');
    return `
def ${varName}_node(state: AgentState) -> AgentState:
    """${a.name}: ${a.description.split('.')[0]}."""
    response = llm.invoke([
        SystemMessage(content="""You are ${a.name}, ${a.role || a.description.split('.')[0]}.
Topic: ${topic}
Task: ${a.description}"""),
        HumanMessage(content=state.get("user_input", "Start the workflow.")),
    ])
    state["${varName}_output"] = response.content
    state["messages"].append(AIMessage(content=f"[${a.name}] " + response.content))
    return state`;
  }).join('\n');

  const addNodes = agents.map(a =>
    `workflow.add_node("${a.id}", ${a.id.replace(/-/g,'_')}_node)`
  ).join('\n');

  const addEdges = agents.map((a, i) => {
    if(i === 0) return `workflow.set_entry_point("${a.id}")`;
    return `workflow.add_edge("${agents[i-1].id}", "${a.id}")`;
  }).join('\n');

  const lastId = agents[agents.length-1]?.id || 'end';

  return `"""
AgentSpark → LangGraph Export
Topic: ${topic}
Generated: ${new Date().toISOString().slice(0,10)}
Docs: https://langchain-ai.github.io/langgraph
"""

from typing import TypedDict, Annotated
from langgraph.graph import StateGraph, END
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage
import operator

# ── State ─────────────────────────────────────────────────
class AgentState(TypedDict):
    messages: Annotated[list, operator.add]
    user_input: str
${stateFields}

# ── LLM ───────────────────────────────────────────────────
llm = ChatOpenAI(model="gpt-4o", temperature=0.7)

# ── Agent Nodes ───────────────────────────────────────────
${nodeDefs}

# ── Graph ─────────────────────────────────────────────────
workflow = StateGraph(AgentState)

${addNodes}

${addEdges}
workflow.add_edge("${lastId}", END)

app = workflow.compile()

# ── Run ───────────────────────────────────────────────────
if __name__ == "__main__":
    result = app.invoke({
        "messages": [],
        "user_input": "Build the ${topic} application.",
${agents.map(a => `        "${a.id.replace(/-/g,'_')}_output": ""`).join(',\n')}
    })
    print("\\n=== FINAL STATE ===")
    for key, val in result.items():
        if val and key != "messages":
            print(f"\\n[{key}]\\n{val}")
`;
}

function genAutoGen() {
  const topic = currentTopic;
  const agents = generatedAgents;

  const agentDefs = agents.map(a => `
${a.id.replace(/-/g,'_')} = AssistantAgent(
    name="${a.name.replace(/\s+/g,'_')}",
    system_message="""You are ${a.name}.
Role: ${a.role || a.name}
Responsibilities: ${a.description}
Topic: ${topic}

When you complete your part, summarize your output clearly and pass to the next agent.""",
    llm_config=llm_config,
)`).join('\n');

  const groupChatAgents = agents.map(a => `    ${a.id.replace(/-/g,'_')},`).join('\n');

  return `"""
AgentSpark → AutoGen Export
Topic: ${topic}
Generated: ${new Date().toISOString().slice(0,10)}
Docs: https://microsoft.github.io/autogen
"""

import autogen

# ── LLM Config ────────────────────────────────────────────
llm_config = {
    "config_list": [{"model": "gpt-4o", "api_key": "YOUR_OPENAI_API_KEY"}],
    "temperature": 0.7,
    "timeout": 120,
}

# ── Human Proxy ───────────────────────────────────────────
user_proxy = autogen.UserProxyAgent(
    name="UserProxy",
    human_input_mode="NEVER",  # Set to "ALWAYS" for interactive mode
    max_consecutive_auto_reply=10,
    is_termination_msg=lambda x: "TASK_COMPLETE" in x.get("content", ""),
    code_execution_config={"work_dir": "workspace", "use_docker": False},
)

# ── Agents ────────────────────────────────────────────────
${agentDefs}

# ── Group Chat ────────────────────────────────────────────
groupchat = autogen.GroupChat(
    agents=[
        user_proxy,
${groupChatAgents}
    ],
    messages=[],
    max_round=20,
    speaker_selection_method="round_robin",  # or "auto"
)

manager = autogen.GroupChatManager(
    groupchat=groupchat,
    llm_config=llm_config,
)

# ── Run ───────────────────────────────────────────────────
if __name__ == "__main__":
    user_proxy.initiate_chat(
        manager,
        message=f"""
        Build the ${topic} application.
        Each agent should complete their responsibilities and hand off to the next.
        Finish with TASK_COMPLETE when all work is done.
        """,
    )
`;
}

function genSwarm() {
  const topic = currentTopic;
  const agents = generatedAgents;

  const agentDefs = agents.map((a, i) => {
    const nextAgent = agents[i + 1];
    const handoff = nextAgent
      ? `\n    handoff_to_${nextAgent.id.replace(/-/g,'_')} = transfer_to_${nextAgent.id.replace(/-/g,'_')}()`
      : '';
    return `
def ${a.id.replace(/-/g,'_')}_instructions(context_variables):
    return f"""You are ${a.name}.
Role: ${a.role || a.name}
Topic: ${topic}
Task: ${a.description}
${nextAgent ? `When done, call transfer_to_${nextAgent.id.replace(/-/g,'_')} to pass to the next agent.` : 'This is the final step. Summarize all work done.'}"""

${a.id.replace(/-/g,'_')} = Agent(
    name="${a.name}",
    instructions=${a.id.replace(/-/g,'_')}_instructions,
    functions=[${nextAgent ? `transfer_to_${nextAgent.id.replace(/-/g,'_')}` : ''}],
)`;
  }).join('\n');

  const transferFns = agents.slice(0, -1).map((a, i) => {
    const next = agents[i + 1];
    return `
def transfer_to_${next.id.replace(/-/g,'_')}():
    """Transfer to ${next.name} — ${next.description.split('.')[0]}."""
    return ${next.id.replace(/-/g,'_')}`;
  }).join('\n');

  const firstAgent = agents[0]?.id.replace(/-/g,'_') || 'agent';

  return `"""
AgentSpark → OpenAI Swarm Export
Topic: ${topic}
Generated: ${new Date().toISOString().slice(0,10)}
Docs: https://github.com/openai/swarm
Install: pip install git+https://github.com/openai/swarm.git
"""

from swarm import Swarm, Agent

client = Swarm()

# ── Transfer Functions (forward declarations) ──────────────
${agents.slice(1).map(a => `${a.id.replace(/-/g,'_')} = None  # defined below`).join('\n')}

# ── Agents ────────────────────────────────────────────────
${agentDefs}

# ── Handoff Functions ─────────────────────────────────────
${transferFns}

# ── Fix forward references ────────────────────────────────
${agents.slice(0,-1).map((a,i) => {
    const next = agents[i+1];
    return `${a.id.replace(/-/g,'_')}.functions = [transfer_to_${next.id.replace(/-/g,'_')}]`;
  }).join('\n')}

# ── Run ───────────────────────────────────────────────────
if __name__ == "__main__":
    response = client.run(
        agent=${firstAgent},
        messages=[{"role": "user", "content": "Build the ${topic} application. Complete all steps."}],
        context_variables={"topic": "${topic}"},
        debug=False,
    )
    print("\\n=== SWARM RESULT ===")
    print(response.messages[-1]["content"])
`;
}

document.getElementById('fw-modal').addEventListener('click', function(e) {
  if(e.target === this) closeFwModal();
});
document.getElementById('diff-modal').addEventListener('click', function(e) {
  if(e.target === this) closeDiffModal();
});
document.getElementById('prompt-export-modal').addEventListener('click', function(e) {
  if(e.target === this) closePromptExport();
});
document.getElementById('import-modal').addEventListener('click', function(e) {
  if(e.target === this) closeImportModal();
});

// ─── SHARING VIA URL ──────────────────────────────────────

// Compress string → Uint8Array (gzip via CompressionStream)
async function compress(str) {
  const stream = new CompressionStream('gzip');
  const writer = stream.writable.getWriter();
  const enc = new TextEncoder();
  writer.write(enc.encode(str));
  writer.close();
  const chunks = [];
  const reader = stream.readable.getReader();
  while(true) {
    const { done, value } = await reader.read();
    if(done) break;
    chunks.push(value);
  }
  const total = chunks.reduce((n, c) => n + c.length, 0);
  const out = new Uint8Array(total);
  let offset = 0;
  for(const c of chunks) { out.set(c, offset); offset += c.length; }
  return out;
}

// Decompress Uint8Array → string
async function decompress(bytes) {
  const stream = new DecompressionStream('gzip');
  const writer = stream.writable.getWriter();
  writer.write(bytes);
  writer.close();
  const chunks = [];
  const reader = stream.readable.getReader();
  while(true) {
    const { done, value } = await reader.read();
    if(done) break;
    chunks.push(value);
  }
  const total = chunks.reduce((n, c) => n + c.length, 0);
  const out = new Uint8Array(total);
  let offset = 0;
  for(const c of chunks) { out.set(c, offset); offset += c.length; }
  return new TextDecoder().decode(out);
}

// Uint8Array → URL-safe base64
function uint8ToBase64url(bytes) {
  let bin = '';
  for(let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

// URL-safe base64 → Uint8Array
function base64urlToUint8(str) {
  const b64 = str.replace(/-/g, '+').replace(/_/g, '/');
  const bin = atob(b64);
  const out = new Uint8Array(bin.length);
  for(let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
  return out;
}

// Simple XOR kept ONLY for backward-compat reading of v:2 links
function xorObfuscate(str, password) {
  const key = password.split('').map(c => c.charCodeAt(0));
  return str.split('').map((c, i) =>
    String.fromCharCode(c.charCodeAt(0) ^ key[i % key.length])
  ).join('');
}

// ── AES-256-GCM helpers (#3) ──────────────────────────────
// Derive a 256-bit key from a password using PBKDF2 + a fixed app salt
async function _aesKeyFromPassword(password, saltBytes) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']
  );
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: saltBytes, iterations: 200_000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function aesGcmEncrypt(plaintext, password) {
  const enc      = new TextEncoder();
  const iv       = crypto.getRandomValues(new Uint8Array(12));  // 96-bit IV
  const salt     = crypto.getRandomValues(new Uint8Array(16));  // 128-bit PBKDF2 salt
  const key      = await _aesKeyFromPassword(password, salt);
  const ctBuf    = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv },
    key,
    enc.encode(plaintext)
  );
  // Pack: [salt 16B][iv 12B][ciphertext …]
  const ct = new Uint8Array(ctBuf);
  const packed = new Uint8Array(salt.length + iv.length + ct.length);
  packed.set(salt, 0);
  packed.set(iv,   salt.length);
  packed.set(ct,   salt.length + iv.length);
  return packed;
}

async function aesGcmDecrypt(packedBytes, password) {
  const salt = packedBytes.slice(0, 16);
  const iv   = packedBytes.slice(16, 28);
  const ct   = packedBytes.slice(28);
  const key  = await _aesKeyFromPassword(password, salt);
  const ptBuf = await crypto.subtle.decrypt(
    { name: 'AES-GCM', iv },
    key,
    ct
  );
  return new TextDecoder().decode(ptBuf);
}

// ── Password unlock modal promise ─────────────────────────
let _unlockResolve = null;
let _unlockRejectCb = null;

function _unlockReject() {
  document.getElementById('unlock-modal').classList.remove('open');
  if (_unlockRejectCb) { _unlockRejectCb(new Error('cancelled')); _unlockRejectCb = null; }
}

function _promptPassword(descText) {
  return new Promise((resolve, reject) => {
    _unlockResolve  = resolve;
    _unlockRejectCb = reject;
    const descEl = document.getElementById('unlock-modal-desc');
    if (descEl && descText) descEl.textContent = descText;
    const input = document.getElementById('unlock-password-input');
    if (input) input.value = '';
    const errEl = document.getElementById('unlock-error');
    if (errEl) errEl.style.display = 'none';
    document.getElementById('unlock-modal').classList.add('open');
    setTimeout(() => input?.focus(), 80);
  });
}

function _unlockConfirm() {
  const pw = document.getElementById('unlock-password-input')?.value || '';
  if (!pw) return;
  document.getElementById('unlock-modal').classList.remove('open');
  if (_unlockResolve) { _unlockResolve(pw); _unlockResolve = null; }
}

function _unlockShowError() {
  const errEl = document.getElementById('unlock-error');
  if (errEl) errEl.style.display = 'block';
  const input = document.getElementById('unlock-password-input');
  if (input) { input.value = ''; input.focus(); }
  document.getElementById('unlock-modal').classList.add('open');
}

let _shareUrl  = '';
let _shareMode = 'open';

async function generateShareUrl() {
  const password    = document.getElementById('share-password-input')?.value?.trim() || '';
  const usePassword = _shareMode === 'password' && password.length > 0;

  // Build state payload
  const payload = {
    v:      3,             // v3 = AES-GCM encrypted (v2 = legacy XOR)
    topic:  currentTopic,
    level:  currentLevel,
    lang,
    agents: generatedAgents,
    files:  generatedFiles,
    ts:     Date.now(),
    pw:     usePassword,
  };

  try {
    const jsonStr = JSON.stringify(payload);
    let dataToCompress;

    if (usePassword) {
      // Encrypt with AES-256-GCM, then compress the packed binary
      const encrypted = await aesGcmEncrypt(jsonStr, password);
      dataToCompress  = encrypted;                       // Uint8Array
      const compressed = await _compressBytes(dataToCompress);
      const encoded    = uint8ToBase64url(compressed);
      const base       = window.location.href.split('#')[0];
      _shareUrl        = `${base}#share=${encoded}`;
    } else {
      const compressed = await compress(jsonStr);
      const encoded    = uint8ToBase64url(compressed);
      const base       = window.location.href.split('#')[0];
      _shareUrl        = `${base}#share=${encoded}`;
    }

    const displayEl = document.getElementById('share-url-display');
    if (displayEl) displayEl.value = _shareUrl;

    const kb     = (_shareUrl.length / 1024).toFixed(1);
    const sizeEl = document.getElementById('share-size-label');
    if (sizeEl) {
      sizeEl.textContent = `${kb} KB`;
      sizeEl.className   = parseFloat(kb) > 100 ? 'share-size-warn' : '';
    }
    const agentEl = document.getElementById('share-agent-count');
    if (agentEl) agentEl.textContent = `${generatedAgents.length} agents`;
    const verEl   = document.getElementById('share-version-label');
    if (verEl)    verEl.textContent = `v${versionHistory.length || 1} (latest)`;

  } catch(e) {
    const displayEl = document.getElementById('share-url-display');
    if (displayEl) displayEl.value = 'Error generating link: ' + e.message;
  }
}

// Compress raw Uint8Array (for encrypted binary blobs)
async function _compressBytes(bytes) {
  const stream = new CompressionStream('gzip');
  const writer = stream.writable.getWriter();
  writer.write(bytes);
  writer.close();
  const chunks = [];
  const reader = stream.readable.getReader();
  while(true) {
    const { done, value } = await reader.read();
    if(done) break;
    chunks.push(value);
  }
  const total = chunks.reduce((n,c) => n + c.length, 0);
  const out   = new Uint8Array(total);
  let offset  = 0;
  for(const c of chunks) { out.set(c, offset); offset += c.length; }
  return out;
}

async function _decompressBytes(bytes) {
  const stream = new DecompressionStream('gzip');
  const writer = stream.writable.getWriter();
  writer.write(bytes);
  writer.close();
  const chunks = [];
  const reader = stream.readable.getReader();
  while(true) {
    const { done, value } = await reader.read();
    if(done) break;
    chunks.push(value);
  }
  const total = chunks.reduce((n,c) => n + c.length, 0);
  const out   = new Uint8Array(total);
  let offset  = 0;
  for(const c of chunks) { out.set(c, offset); offset += c.length; }
  return out;
}

function onShareModeChange() {
  const val = document.querySelector('input[name="share-mode"]:checked')?.value || 'open';
  _shareMode = val;

  document.getElementById('share-opt-open').classList.toggle('active', val === 'open');
  document.getElementById('share-opt-password').classList.toggle('active', val === 'password');

  const pwRow = document.getElementById('share-password-row');
  if(pwRow) pwRow.style.display = val === 'password' ? 'flex' : 'none';

  generateShareUrl();
}

function openShareModal() {
  if(!generatedAgents.length) {
    showNotif(lang==='en' ? '⚠ Generate a team first' : '⚠ Najpierw wygeneruj zespół', true);
    return;
  }
  _shareMode = 'open';
  // Reset UI
  const openOpt = document.querySelector('input[name="share-mode"][value="open"]');
  if(openOpt) openOpt.checked = true;
  document.getElementById('share-opt-open').classList.add('active');
  document.getElementById('share-opt-password').classList.remove('active');
  document.getElementById('share-password-row').style.display = 'none';
  const pwInput = document.getElementById('share-password-input');
  if(pwInput) pwInput.value = '';

  const copyBtn = document.getElementById('share-copy-btn');
  if(copyBtn) { copyBtn.textContent = '📋 Copy'; copyBtn.classList.remove('copied'); }

  document.getElementById('share-modal').classList.add('open');
  generateShareUrl();
}

function closeShareModal() {
  document.getElementById('share-modal').classList.remove('open');
}

async function copyShareUrl() {
  if(!_shareUrl) return;
  try {
    await navigator.clipboard.writeText(_shareUrl);
    const btn = document.getElementById('share-copy-btn');
    btn.textContent = '✓ Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = '📋 Copy'; btn.classList.remove('copied'); }, 2500);
    showNotif(lang==='en' ? '✓ Share link copied!' : '✓ Link skopiowany!');
  } catch(e) {
    showNotif(lang==='en' ? '⚠ Copy failed' : '⚠ Kopiowanie nieudane', true);
  }
}

// ── Load from URL hash on startup ──────────────────────────
async function loadFromHash() {
  const hash = window.location.hash;
  if(!hash.startsWith('#share=')) return false;

  const encoded = hash.slice('#share='.length);
  if(!encoded) return false;

  try {
    const bytes = base64urlToUint8(encoded);

    // Try 1: decompress as plain text (unencrypted, v1 or v2 open link)
    let payload = null;
    let jsonStr = null;
    try {
      jsonStr = await decompress(bytes);
      payload = JSON.parse(jsonStr);
    } catch(e) {
      // Not valid plain JSON after decompress — could be:
      // (a) v3 AES-GCM encrypted binary, or
      // (b) v2 XOR-obfuscated (legacy)
      // In both cases, decompress gave us bytes or garbled text.
      // We'll re-decompress the raw bytes and attempt AES-GCM first.
    }

    // If payload has pw:true it was flagged as password-protected
    if (payload && payload.pw) {
      // v2 legacy XOR path
      let pw;
      try {
        pw = await _promptPassword(
          lang === 'en'
            ? '🔒 This team is password protected. Enter the password to unlock it.'
            : '🔒 Ten zespół jest chroniony hasłem. Podaj hasło, aby go odblokować.'
        );
      } catch(e) { return false; } // user cancelled

      while (true) {
        const decrypted = xorObfuscate(jsonStr, pw);
        try {
          payload = JSON.parse(decrypted);
          break; // success
        } catch(e2) {
          _unlockShowError();
          try {
            pw = await _promptPassword();
          } catch(e3) { return false; }
        }
      }
    }

    // If no valid plain payload yet → treat as v3 AES-GCM encrypted binary
    if (!payload) {
      let decompressedBytes;
      try {
        decompressedBytes = await _decompressBytes(bytes);
      } catch(e) {
        decompressedBytes = bytes; // maybe not compressed
      }

      let pw;
      try {
        pw = await _promptPassword(
          lang === 'en'
            ? '🔒 This team is password protected (AES-256-GCM). Enter the password to unlock it.'
            : '🔒 Ten zespół jest zaszyfrowany (AES-256-GCM). Podaj hasło, aby go odblokować.'
        );
      } catch(e) { return false; }

      while (true) {
        try {
          const decrypted = await aesGcmDecrypt(decompressedBytes, pw);
          payload = JSON.parse(decrypted);
          break; // success
        } catch(e) {
          _unlockShowError();
          try {
            pw = await _promptPassword();
          } catch(e2) { return false; }
        }
      }
    }

    if(!payload?.agents?.length) return false;

    // Restore state
    currentTopic = payload.topic || 'Shared Team';
    currentLevel = payload.level || 'iskra';
    if(payload.lang) lang = payload.lang;
    generatedAgents = payload.agents;
    generatedFiles  = payload.files || {};
    versionHistory  = [{
      id: Date.now(),
      label: lang==='en' ? `Shared: ${currentTopic}` : `Udostępniony: ${currentTopic}`,
      ts: new Date(payload.ts || Date.now()),
      agents: JSON.parse(JSON.stringify(generatedAgents)),
      files:  JSON.parse(JSON.stringify(generatedFiles)),
      diff: { added: [], removed: [], changed: [] },
      removedNames: {},
      agentNames: Object.fromEntries(generatedAgents.map(a => [a.id, a.name])),
      vNum: 1,
      isOrigin: true,
    }];

    // Show results
    showResults();

    // Show shared banner
    const banner = document.getElementById('shared-banner');
    const bannerTitle = document.getElementById('shared-banner-title');
    const bannerSub   = document.getElementById('shared-banner-sub');
    if(banner) {
      bannerTitle.textContent = lang==='en'
        ? `🔗 Shared team: "${currentTopic}"`
        : `🔗 Udostępniony zespół: "${currentTopic}"`;
      bannerSub.textContent = lang==='en'
        ? `${generatedAgents.length} agents · Read-only view · Start Over to create your own`
        : `${generatedAgents.length} agentów · Widok tylko do odczytu · Zacznij od nowa, by stworzyć własny`;
      banner.style.display = 'flex';
    }

    // Clean hash from URL (so refresh doesn't re-load)
    history.replaceState(null, '', window.location.pathname + window.location.search);

    return true;
  } catch(e) {
    console.warn('[AgentSpark] Failed to load shared URL:', e);
    return false;
  }
}

document.getElementById('share-modal').addEventListener('click', function(e) {
  if(e.target === this) closeShareModal();
});
document.getElementById('unlock-modal').addEventListener('click', function(e) {
  if(e.target === this) _unlockReject();
});

// ─── THEME ────────────────────────────────────────────────
function _toggleThemeCore() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') !== 'light';
  const next = isDark ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('agentspark-theme', next);
  document.getElementById('theme-toggle-btn').textContent = next === 'light' ? '☀️' : '🌙';
  // Sync PWA theme-color meta
  const metaTC = document.getElementById('meta-theme-color');
  if(metaTC) metaTC.content = next === 'light' ? '#f0f4ff' : '#050810';
}

// Global wrapper called by onclick="toggleTheme()"
// Short click = toggle + save manual preference
// Long press (600ms) = reset to OS auto-detect
let _themeHoldTimer = null;
function toggleTheme() {
  if (_themeHoldTimer === null) return; // longpress already fired
  clearTimeout(_themeHoldTimer);
  _themeHoldTimer = null;
  _toggleThemeCore();
}
function _themeHoldStart() {
  _themeHoldTimer = setTimeout(() => {
    _themeHoldTimer = null;
    localStorage.removeItem('agentspark-theme');
    const next = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    const btn = document.getElementById('theme-toggle-btn');
    if (btn) btn.textContent = next === 'light' ? '☀️' : '🌙';
    const metaTC = document.getElementById('meta-theme-color');
    if (metaTC) metaTC.content = next === 'light' ? '#f0f4ff' : '#050810';
    showNotif(lang === 'en' ? '🎨 Theme: following OS preference' : '🎨 Motyw: podąża za ustawieniami systemu');
  }, 600);
}

// Init theme from localStorage or auto-detect from OS
(function() {
  const saved = localStorage.getItem('agentspark-theme');
  // If user never manually picked → follow OS preference
  const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = saved || (systemPrefersDark ? 'dark' : 'light');
  document.documentElement.setAttribute('data-theme', theme);
  // Set correct icon after DOM ready
  window.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('theme-toggle-btn');
    if (btn) btn.textContent = theme === 'light' ? '☀️' : '🌙';
  });
  // Listen for OS-level theme changes — only apply if user hasn't manually overridden
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    if (localStorage.getItem('agentspark-theme')) return; // user has manual pref — respect it
    const next = e.matches ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    const btn = document.getElementById('theme-toggle-btn');
    if (btn) btn.textContent = next === 'light' ? '☀️' : '🌙';
    const metaTC = document.getElementById('meta-theme-color');
    if (metaTC) metaTC.content = next === 'light' ? '#f0f4ff' : '#050810';
  });
})();

// ─── INIT ─────────────────────────────────────────────────
(async () => {
  const loaded = await loadFromHash();
  if(!loaded) renderTopicScreen();
})();

// ─── PWA ──────────────────────────────────────────────────

(function initPWA() {

  // ── 1. Inline Manifest ────────────────────────────────
  const manifest = {
    name: 'AgentSpark',
    short_name: 'AgentSpark',
    description: 'Build your AI agent team in minutes',
    start_url: './',
    display: 'standalone',
    background_color: '#050810',
    theme_color: '#050810',
    orientation: 'any',
    categories: ['productivity', 'developer', 'utilities'],
    icons: [
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%23050810'/%3E%3Crect width='192' height='192' rx='40' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='192' y2='192' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%2300e5ff' stop-opacity='.3'/%3E%3Cstop offset='1' stop-color='%237c3aff' stop-opacity='.3'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='96' y='128' font-size='96' text-anchor='middle' fill='%2300e5ff'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E",
        sizes: '192x192', type: 'image/svg+xml', purpose: 'any maskable'
      },
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%23050810'/%3E%3Crect width='512' height='512' rx='100' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='512' y2='512' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%2300e5ff' stop-opacity='.3'/%3E%3Cstop offset='1' stop-color='%237c3aff' stop-opacity='.3'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='256' y='340' font-size='256' text-anchor='middle' fill='%2300e5ff'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E",
        sizes: '512x512', type: 'image/svg+xml', purpose: 'any maskable'
      }
    ],
    screenshots: [],
    shortcuts: [
      {
        name: 'New Team',
        short_name: 'New',
        description: 'Start building a new AI agent team',
        url: './',
        icons: [{ src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 96 96'%3E%3Ctext y='80' font-size='80'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E", sizes: '96x96' }]
      }
    ]
  };

  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
  const manifestURL  = URL.createObjectURL(manifestBlob);
  const manifestLink = document.getElementById('pwa-manifest');
  if(manifestLink) manifestLink.href = manifestURL;

  // ── 2. Service Worker (inline as Blob) ────────────────
  const CACHE_NAME = 'agentspark-v1';

  const swCode = `
const CACHE = '${CACHE_NAME}';
const FONTS = [
  'https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap',
  'https://fonts.gstatic.com'
];

self.addEventListener('install', e => {
  self.skipWaiting();
  e.waitUntil(
    caches.open(CACHE).then(c => {
      // Cache the app shell itself (the HTML)
      return c.addAll(['./']).catch(() => {});
    })
  );
});

self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys().then(keys =>
      Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
    ).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', e => {
  const url = new URL(e.request.url);

  // Network-first for API calls (never cache)
  if(url.hostname.includes('googleapis.com') && url.pathname.includes('generateContent')) {
    e.respondWith(fetch(e.request));
    return;
  }
  if(url.hostname.includes('openai.com') ||
     url.hostname.includes('anthropic.com') ||
     url.hostname.includes('mistral.ai') ||
     url.hostname.includes('groq.com')) {
    e.respondWith(fetch(e.request));
    return;
  }

  // Cache-first for fonts and static assets
  if(url.hostname.includes('fonts.g') || e.request.destination === 'font') {
    e.respondWith(
      caches.match(e.request).then(cached => cached || fetch(e.request).then(res => {
        const clone = res.clone();
        caches.open(CACHE).then(c => c.put(e.request, clone));
        return res;
      }))
    );
    return;
  }

  // Stale-while-revalidate for the app shell
  e.respondWith(
    caches.open(CACHE).then(cache =>
      cache.match(e.request).then(cached => {
        const fetchPromise = fetch(e.request).then(res => {
          if(res.ok) cache.put(e.request, res.clone());
          return res;
        }).catch(() => cached);
        return cached || fetchPromise;
      })
    )
  );
});

// Listen for skip-waiting message from update toast
self.addEventListener('message', e => {
  if(e.data === 'skipWaiting') self.skipWaiting();
});
`;

  let swRegistration = null;
  let newWorker = null;

  if('serviceWorker' in navigator) {
    const swBlob = new Blob([swCode], { type: 'text/javascript' });
    const swURL  = URL.createObjectURL(swBlob);

    navigator.serviceWorker.register(swURL)
      .then(reg => {
        swRegistration = reg;

        // Detect update (new SW waiting)
        reg.addEventListener('updatefound', () => {
          newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if(newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdateToast();
            }
          });
        });

        // Check for update on focus
        window.addEventListener('focus', () => reg.update());
      })
      .catch(err => console.warn('[AgentSpark SW]', err));

    // Reload page when new SW takes control
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }

  // ── 3. Offline / Online detection ────────────────────
  const offlineBar = document.getElementById('offline-bar');

  function updateOnlineStatus() {
    if(!offlineBar) return;
    offlineBar.classList.toggle('visible', !navigator.onLine);
  }

  window.addEventListener('online',  updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus(); // initial check

  // ── 4. Install prompt (A2HS) ─────────────────────────
  let deferredPrompt = null;
  const DISMISSED_KEY = 'agentspark-pwa-dismissed';

  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;

    // Don't show if previously dismissed (within 7 days)
    const dismissed = localStorage.getItem(DISMISSED_KEY);
    if(dismissed && Date.now() - Number(dismissed) < 7 * 86400000) return;

    // Show install banner after a brief delay
    setTimeout(showInstallBanner, 3000);
  });

  window.addEventListener('appinstalled', () => {
    hideInstallBanner();
    if(typeof showNotif === 'function') {
      showNotif('✓ AgentSpark installed!');
    }
    deferredPrompt = null;
  });

  function showInstallBanner() {
    if(document.getElementById('pwa-install-banner')) return;

    const banner = document.createElement('div');
    banner.id = 'pwa-install-banner';
    banner.className = 'pwa-install-banner';
    banner.innerHTML = `
      <div class="pwa-install-icon">⚡</div>
      <div class="pwa-install-text">
        <div class="pwa-install-title">Install AgentSpark</div>
        <div class="pwa-install-sub">Add to home screen — works offline</div>
      </div>
      <div class="pwa-install-actions">
        <button class="pwa-install-btn" onclick="window._pwaInstall()">Install</button>
        <button class="pwa-dismiss-btn" onclick="window._pwaDismiss()">✕</button>
      </div>
    `;
    document.body.appendChild(banner);
  }

  function hideInstallBanner() {
    const b = document.getElementById('pwa-install-banner');
    if(b) {
      b.style.animation = 'none';
      b.style.opacity = '0';
      b.style.transform = 'translateY(20px)';
      b.style.transition = 'all 0.3s ease';
      setTimeout(() => b.remove(), 300);
    }
  }

  window._pwaInstall = async () => {
    if(!deferredPrompt) return;
    hideInstallBanner();
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    if(outcome === 'dismissed') {
      localStorage.setItem(DISMISSED_KEY, Date.now());
    }
  };

  window._pwaDismiss = () => {
    hideInstallBanner();
    localStorage.setItem(DISMISSED_KEY, Date.now());
  };

  // ── 5. Update toast ───────────────────────────────────
  function showUpdateToast() {
    if(document.getElementById('pwa-update-toast')) return;
    const toast = document.createElement('div');
    toast.id = 'pwa-update-toast';
    toast.className = 'pwa-update-toast';
    toast.innerHTML = `
      <span>🔄 New version available</span>
      <button class="pwa-update-btn" onclick="window._pwaUpdate()">Update</button>
      <button class="pwa-dismiss-btn" onclick="this.parentElement.remove()" style="font-size:0.7rem;padding:0.25rem 0.5rem;">✕</button>
    `;
    document.body.appendChild(toast);
    // Auto-hide after 15s
    setTimeout(() => toast.remove(), 15000);
  }

  window._pwaUpdate = () => {
    document.getElementById('pwa-update-toast')?.remove();
    if(newWorker) newWorker.postMessage('skipWaiting');
    else if(swRegistration?.waiting) swRegistration.waiting.postMessage('skipWaiting');
  };

  // ── 6. Theme-color sync with dark/light toggle ────────
  // Handled directly inside toggleTheme() / _toggleThemeCore()

  // Initial sync of meta theme-color on PWA startup
  (function() {
    const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
    const metaTC = document.getElementById('meta-theme-color');
    if(metaTC) metaTC.content = isDark ? '#050810' : '#f0f4ff';
  })();

})();

document.getElementById('modal').addEventListener('click', function(e) {
  if(e.target === this) closeModal();
});
document.getElementById('md-browser-modal').addEventListener('click', function(e) {
  if(e.target === this) closeMdBrowser();
});
</script>
</body>
</html>
