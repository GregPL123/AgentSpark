<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>AgentSpark — Build Your AI Team</title>

<!-- PWA meta -->
<meta name="theme-color" content="#1a170d" id="meta-theme-color"/>
<meta name="description" content="Build your AI agent team in minutes. Choose a topic, answer questions, get production-ready agent files."/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="AgentSpark"/>

<!-- PWA manifest (inline data: URI) -->
<link rel="manifest" id="pwa-manifest"/>

<!-- PWA icons (inline SVG as data URI) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%231a170d'/%3E%3Crect width='192' height='192' rx='40' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='192' y2='192' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23f2b90d' stop-opacity='.25'/%3E%3Cstop offset='1' stop-color='%23f2b90d' stop-opacity='.05'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle' fill='%23f2b90d'%3E⚡%3C/text%3E%3C/svg%3E"/>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@400,0..1&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  :root {
    --bg: #1a170d;
    --surface: #221e10;
    --surface2: #2a2510;
    --border: #3a3218;
    --accent: #f2b90d;
    --accent2: #e05a1a;
    --accent3: #c4930a;
    --text: #f0ead8;
    --muted: #8a7e60;
    --success: #7cc42a;
  }

  /* ── LIGHT MODE ── */
  [data-theme="light"] {
    --bg: #faf7ee;
    --surface: #ffffff;
    --surface2: #f5f0de;
    --border: #e0d5b0;
    --accent: #c49a0a;
    --accent2: #c44a10;
    --accent3: #a07808;
    --text: #1a1508;
    --muted: #7a6e48;
    --success: #4a8a10;
  }
  [data-theme="light"] body::before {
    background-image:
      radial-gradient(1px 1px at 20% 30%, rgba(196,154,10,0.2) 0%, transparent 100%),
      radial-gradient(1px 1px at 80% 10%, rgba(196,154,10,0.15) 0%, transparent 100%),
      radial-gradient(1px 1px at 50% 60%, rgba(196,154,10,0.1) 0%, transparent 100%),
      radial-gradient(1px 1px at 10% 70%, rgba(196,96,10,0.15) 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 80%, rgba(196,154,10,0.1) 0%, transparent 100%),
      radial-gradient(1px 1px at 60% 20%, rgba(196,154,10,0.15) 0%, transparent 100%),
      radial-gradient(1px 1px at 30% 90%, rgba(100,160,20,0.12) 0%, transparent 100%);
  }
  [data-theme="light"] body::after {
    background-image:
      linear-gradient(rgba(196,154,10,0.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(196,154,10,0.05) 1px, transparent 1px);
  }
  [data-theme="light"] pre {
    background: #f5f0de;
  }
  [data-theme="light"] .model-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a6e48' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  }
  [data-theme="light"] .model-select option { background: #ffffff; }

  /* Theme toggle button */
  .theme-toggle {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 34px;
    height: 34px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .theme-toggle:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(242,185,13,0.08);
  }

  /* Smooth theme transition on the elements that matter */
  body, header, .sidebar-card, .agent-card, .topic-card, .level-card,
  .chat-main, .chat-header, .chat-input-area, .modal, .modal-overlay,
  .scoring-panel, .instructions, .results-actions, .refine-panel,
  .input-field, .model-select, pre, .notif {
    transition: background-color 0.25s ease, border-color 0.25s ease, color 0.15s ease;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Manrope', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(ellipse 80% 50% at 50% -10%, rgba(242,185,13,0.18) 0%, transparent 70%),
      radial-gradient(1px 1px at 20% 30%, rgba(242,185,13,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 80% 10%, rgba(242,185,13,0.35) 0%, transparent 100%),
      radial-gradient(1px 1px at 50% 60%, rgba(242,185,13,0.25) 0%, transparent 100%),
      radial-gradient(1px 1px at 10% 70%, rgba(224,90,26,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 80%, rgba(242,185,13,0.2) 0%, transparent 100%),
      radial-gradient(1px 1px at 60% 20%, rgba(242,185,13,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 30% 90%, rgba(200,160,10,0.25) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(242,185,13,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(242,185,13,0.025) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  #app { position: relative; z-index: 1; }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 2.5rem;
    border-bottom: 1px solid var(--border);
    background: rgba(26,23,13,0.85);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: 'Manrope', sans-serif;
    font-size: 1.25rem;
    font-weight: 800;
    letter-spacing: -0.02em;
  }

  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, #f2b90d, #c49a0a);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 16px rgba(242,185,13,0.4);
  }
  .logo-icon::after {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%);
    animation: shimmer 3s infinite;
  }
  @keyframes shimmer { 0% { transform: translateX(-100%) translateY(-100%); } 100% { transform: translateX(100%) translateY(100%); } }

  .logo span { color: var(--accent); }

  .lang-switch {
    display: flex;
    gap: 0.5rem;
  }
  .lang-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.75rem;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Manrope', sans-serif;
    font-size: 0.75rem;
    font-weight: 600;
    transition: all 0.2s;
  }
  .lang-btn.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(242,185,13,0.1);
  }

  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 2rem;
  }

  .screen { display: none; }
  .screen.active { display: block; animation: fadeIn 0.4s ease; }
  @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform:translateY(0); } }

  .hero {
    text-align: center;
    padding: 4rem 0 3rem;
  }
  .hero-badge {
    display: inline-block;
    font-family: 'Manrope', sans-serif;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    color: var(--accent);
    border: 1px solid rgba(242,185,13,0.35);
    padding: 0.35rem 1rem;
    border-radius: 20px;
    background: rgba(242,185,13,0.07);
    margin-bottom: 1.5rem;
    animation: pulse-glow 3s ease-in-out infinite;
  }
  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 0 rgba(242,185,13,0); }
    50% { box-shadow: 0 0 20px rgba(242,185,13,0.25); }
  }

  .hero h1 {
    font-size: clamp(2.5rem, 6vw, 4.5rem);
    font-weight: 800;
    line-height: 1.05;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #fff 0%, #f2b90d 50%, #c49a0a 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .hero p {
    font-size: 1.15rem;
    color: var(--muted);
    max-width: 520px;
    margin: 0 auto 3rem;
    line-height: 1.6;
  }

  .topic-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    max-width: 900px;
    margin: 0 auto 2rem;
  }

  .topic-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .topic-card:hover {
    border-color: var(--accent);
    background: rgba(242,185,13,0.06);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(242,185,13,0.12);
  }
  .topic-card .icon { font-size: 1.8rem; margin-bottom: 0.5rem; }
  .topic-card .label { font-size: 0.85rem; font-weight: 700; color: var(--text); }
  .topic-card .sub { font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem; }
  .topic-card .agents-preview {
    font-size: 0.62rem;
    font-family: 'Space Mono', monospace;
    color: rgba(242,185,13,0.7);
    margin-top: 0.6rem;
    line-height: 1.4;
    border-top: 1px solid var(--border);
    padding-top: 0.5rem;
    display: none;
  }
  .topic-card:hover .agents-preview { display: block; }
  .topic-card .time-badge {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 0.55rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.1rem 0.3rem;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .topic-card:hover .time-badge { opacity: 1; }

  .template-filters {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
    max-width: 900px;
    margin: 0 auto 1.25rem;
  }
  .template-filters .ios-segmented {
    width: 100%;
    max-width: 540px;
  }
  .filter-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.85rem;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }
  .filter-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .filter-btn.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(242,185,13,0.1);
  }
  .topic-card.hidden { display: none; }

  .or-divider {
    text-align: center;
    color: var(--muted);
    font-size: 0.8rem;
    font-family: 'Space Mono', monospace;
    margin: 1rem 0;
  }

  .custom-topic {
    display: flex;
    gap: 0.75rem;
    max-width: 560px;
    margin: 0 auto;
  }

  .input-field {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.85rem 1.25rem;
    color: var(--text);
    font-family: 'Manrope', sans-serif;
    font-size: 0.95rem;
    outline: none;
    transition: all 0.2s;
  }
  .input-field:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(242,185,13,0.12);
  }
  .input-field::placeholder { color: var(--muted); }

  .btn-primary {
    background: #f2b90d;
    color: #1a170d;
    border: none;
    border-radius: 12px;
    padding: 0.85rem 1.5rem;
    font-family: 'Manrope', sans-serif;
    font-weight: 800;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    box-shadow: 0 4px 20px rgba(242,185,13,0.35);
  }
  .btn-primary:hover {
    background: #f5c830;
    transform: translateY(-1px);
    box-shadow: 0 8px 28px rgba(242,185,13,0.45);
  }
  .btn-primary:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  /* ── MY PROJECTS (#1) ── */
  .btn-projects-header {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.85rem;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex; align-items: center; gap: 0.4rem;
  }
  .btn-projects-header:hover { border-color: var(--accent); color: var(--accent); }

  .project-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    position: relative;
    overflow: hidden;
  }
  .project-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, #f2b90d, #c49a0a);
    opacity: 0;
    transition: opacity 0.2s;
  }
  .project-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .project-card:hover::before { opacity: 1; }
  .project-card-name { font-weight: 800; font-size: 1rem; color: var(--text); }
  .project-card-topic { font-size: 0.78rem; color: var(--muted); }
  .project-card-meta {
    display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.25rem;
  }
  .project-card-tag {
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background: rgba(242,185,13,0.1);
    border: 1px solid rgba(242,185,13,0.25);
    color: var(--accent);
  }
  .project-card-actions {
    display: flex; gap: 0.5rem; margin-top: 0.5rem;
  }
  .project-card-btn {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 10px;
    padding: 0.6rem 0.5rem;
    min-height: 44px;
    font-size: 0.78rem;
    font-family: 'Manrope', sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.34,1.56,0.64,1);
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.3rem;
    -webkit-tap-highlight-color: transparent;
  }
  .project-card-btn:hover { color: var(--text); border-color: var(--accent); background: rgba(242,185,13,0.06); }
  .project-card-btn:active { transform: scale(0.93); }
  .project-card-btn.danger:hover { color: var(--accent2); border-color: var(--accent2); background: rgba(224,90,26,0.06); }
  .project-card-date { font-size: 0.72rem; color: var(--muted); font-family: 'Manrope', sans-serif; }
  .project-unsaved-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--accent2); display: inline-block; margin-left: 4px;
    vertical-align: middle;
  }
  /* Save indicator in header */
  .save-indicator {
    font-size: 0.68rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    opacity: 0;
    transition: opacity 0.4s;
    white-space: nowrap;
  }
  .save-indicator.visible { opacity: 1; }

  .chat-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.5rem;
    height: calc(100svh - 160px);
    transition: grid-template-columns 0.3s ease;
  }
  .chat-layout.sidebar-collapsed {
    grid-template-columns: 1fr 0px;
  }

  .chat-main {
    display: flex;
    flex-direction: column;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  .chat-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--surface2);
  }
  .chat-header .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--success);
    box-shadow: 0 0 8px var(--success);
    animation: blink 2s infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
  .chat-header .title { font-weight: 600; font-size: 0.95rem; }
  .chat-header .subtitle { font-size: 0.75rem; color: var(--muted); }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    scroll-behavior: smooth;
  }
  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg {
    max-width: 85%;
    animation: msgIn 0.3s ease;
  }
  @keyframes msgIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

  .msg.ai { align-self: flex-start; }
  .msg.user { align-self: flex-end; }

  .msg-bubble {
    padding: 0.9rem 1.2rem;
    border-radius: 12px;
    font-size: 0.92rem;
    line-height: 1.6;
  }
  .msg.ai .msg-bubble {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
    color: var(--text);
  }
  .msg.user .msg-bubble {
    background: linear-gradient(135deg, rgba(242,185,13,0.15), rgba(196,147,10,0.12));
    border: 1px solid rgba(242,185,13,0.35);
    border-bottom-right-radius: 4px;
    color: var(--text);
  }

  .msg-sender {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    margin-bottom: 0.3rem;
    padding: 0 0.3rem;
  }
  .msg.ai .msg-sender { color: var(--accent); }
  .msg.user .msg-sender { text-align: right; color: var(--accent3); }

  .typing-indicator {
    display: flex;
    gap: 4px;
    padding: 0.9rem 1.2rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    border-bottom-left-radius: 4px;
    width: fit-content;
  }
  .typing-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
    animation: typing 1.2s infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typing { 0%,60%,100%{transform:translateY(0);opacity:0.4} 30%{transform:translateY(-6px);opacity:1} }

  .chat-input-area {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    background: var(--surface2);
    display: flex;
    gap: 0.75rem;
  }
  .chat-input-area .input-field { font-size: 0.9rem; }

  /* ── Fixed question panel ── */
  .question-panel {
    border-top: 1px solid var(--border);
    background: var(--surface2);
    padding: 1rem 1.25rem 1.1rem;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    flex-shrink: 0;
  }
  .question-section-badge {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    color: var(--accent);
    background: rgba(242,185,13,0.1);
    border: 1px solid rgba(242,185,13,0.25);
    border-radius: 6px;
    padding: 0.2rem 0.6rem;
    align-self: flex-start;
    margin-bottom: 0.1rem;
  }
  .question-panel-text {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.45;
    font-family: 'Manrope', sans-serif;
    padding-bottom: 0.25rem;
  }
  .question-panel-choices {
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
  }

  .sidebar-toggle-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    width: 28px; height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
    margin-left: auto;
  }
  .sidebar-toggle-btn:hover { border-color: var(--accent); color: var(--accent); }

  .chat-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow: hidden;
    transition: opacity 0.2s ease, transform 0.3s ease;
    min-width: 0;
  }
  .chat-layout.sidebar-collapsed .chat-sidebar {
    opacity: 0;
    pointer-events: none;
    transform: translateX(20px);
  }

  .sidebar-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 1.25rem;
  }
  .sidebar-card h3 {
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
  }

  .progress-steps {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  .step {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.82rem;
    color: var(--muted);
    transition: color 0.3s;
  }
  .step.done { color: var(--text); }
  .step.active { color: var(--accent); }
  .step-num {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    flex-shrink: 0;
    transition: all 0.3s;
  }
  .step.done .step-num {
    background: var(--success);
    border-color: var(--success);
    color: #000;
  }
  .step.active .step-num {
    background: rgba(242,185,13,0.15);
    border-color: var(--accent);
    color: var(--accent);
  }

  .api-key-section { }
  .api-label {
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 0.5rem;
    display: block;
  }

  .results-header {
    text-align: center;
    padding: 2.5rem 0 2rem;
  }
  .results-header h2 {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    background: linear-gradient(90deg, #f2b90d, #f5c830);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .results-header p { color: var(--muted); }

  .agents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
  }

  .agent-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    overflow: hidden;
    transition: all 0.22s cubic-bezier(0.34,1.56,0.64,1);
    position: relative;
  }
  .agent-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, rgba(242,185,13,0.5), transparent);
    opacity: 0;
    transition: opacity 0.25s;
  }
  .agent-card:hover::after { opacity: 1; }
  .agent-card:hover {
    border-color: rgba(242,185,13,0.3);
    transform: translateY(-4px);
    box-shadow: 0 20px 48px rgba(0,0,0,0.28), 0 0 0 1px rgba(242,185,13,0.08);
  }

  .agent-card-header {
    padding: 1.4rem 1.4rem 0;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }
  .agent-avatar {
    width: 62px; height: 62px;
    border-radius: 17px;
    background: linear-gradient(145deg, #c49a0a, #f2b90d);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem;
    flex-shrink: 0;
    transition: box-shadow 0.25s, transform 0.25s;
  }
  .agent-card:hover .agent-avatar {
    box-shadow: 0 8px 24px rgba(242,185,13,0.4);
    transform: scale(1.04) rotate(-2deg);
  }
  .agent-card-meta { flex: 1; min-width: 0; padding-top: 0.1rem; }
  .agent-name { font-weight: 800; font-size: 1.08rem; letter-spacing: -0.02em; margin-bottom: 0.2rem; color: var(--text); }
  .agent-role { font-size: 0.7rem; color: var(--accent); font-family: 'Manrope', sans-serif; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; }
  .agent-type-badge { margin-top: 0.5rem; }

  .agent-card-divider {
    height: 1px; background: var(--border); margin: 1.1rem 1.4rem 0; opacity: 0.5;
  }
  .agent-card-body { padding: 1rem 1.4rem 1.4rem; }
  .agent-desc { font-size: 0.88rem; color: var(--muted); line-height: 1.7; margin-bottom: 1.1rem; }

  .file-chips-group { margin-bottom: 0; }
  .file-chips-label {
    font-size: 0.62rem; font-weight: 700; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--muted); margin-bottom: 0.45rem; display: block; opacity: 0.6;
  }
  .file-chips { display: flex; flex-wrap: wrap; gap: 0.4rem; }
  .file-chip {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    padding: 0.28rem 0.65rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    background: var(--surface2);
    transition: all 0.15s;
  }
  .file-chip:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(242,185,13,0.07);
  }

  /* ── MARKDOWN PREVIEW MODAL ── */
  /* ── iOS SHEET SYSTEM — replaces all modals ── */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 200;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
  .modal-overlay.open {
    display: flex;
    animation: sheet-backdrop-in 0.28s ease forwards;
  }
  @keyframes sheet-backdrop-in {
    from { background: rgba(0,0,0,0); backdrop-filter: blur(0px); }
    to   { background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); }
  }

  /* The sheet container — slides up from bottom */
  .modal {
    background: var(--surface);
    border: 0.5px solid rgba(255,255,255,0.08);
    border-radius: 22px 22px 0 0;
    width: 100%;
    max-width: 720px;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    animation: sheet-slide-up 0.4s cubic-bezier(0.32, 0.72, 0, 1) forwards;
    /* subtle inner gradient top edge */
    box-shadow: 0 -4px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.06);
    position: relative;
  }
  /* Sheet handle */
  .modal::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 38px; height: 5px;
    background: rgba(255,255,255,0.18);
    border-radius: 3px;
    flex-shrink: 0;
  }
  [data-theme="light"] .modal::before { background: rgba(0,0,0,0.12); }
  [data-theme="light"] .modal {
    border: 0.5px solid rgba(0,0,0,0.08);
    box-shadow: 0 -4px 40px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
  }
  @keyframes sheet-slide-up {
    from { transform: translateY(100%); opacity: 0.4; }
    to   { transform: translateY(0);   opacity: 1; }
  }

  /* On desktop show centered instead of bottom-sheet */
  @media (min-width: 769px) {
    .modal-overlay { align-items: center; }
    .modal {
      border-radius: 20px;
      max-height: 85vh;
      animation: sheet-scale-in 0.3s cubic-bezier(0.34, 1.3, 0.64, 1) forwards;
      box-shadow: 0 20px 80px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .modal::before { display: none; }
    @keyframes sheet-scale-in {
      from { opacity: 0; transform: scale(0.93) translateY(10px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }
  }

  .modal-header {
    padding: 1.4rem 1.5rem 1rem;
    border-bottom: 0.5px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 8px; /* space for handle */
  }
  .modal-title {
    font-family: 'Manrope', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.01em;
  }
  .modal-close {
    width: 30px; height: 30px;
    background: var(--surface2);
    border: none;
    border-radius: 50%;
    color: var(--muted);
    cursor: pointer;
    font-size: 0.85rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .modal-close:hover { background: var(--border); color: var(--text); }
  .modal-close:active { transform: scale(0.88); }

  /* View toggle tabs */
  .modal-tabs {
    display: flex;
    gap: 0.4rem;
  }
  .modal-tab {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    transition: all 0.18s;
  }
  .modal-tab.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(242,185,13,0.1);
  }

  .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
  }
  .modal-body::-webkit-scrollbar { width: 4px; }
  .modal-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  pre {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    line-height: 1.7;
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* Markdown rendered styles */
  .md-preview {
    line-height: 1.75;
    color: var(--text);
  }
  .md-preview h1 {
    font-size: 1.6rem;
    font-weight: 800;
    margin: 0 0 1rem;
    background: linear-gradient(90deg, var(--accent), var(--accent3));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }
  .md-preview h2 {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent);
    margin: 1.5rem 0 0.6rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.85rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .md-preview h3 {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--text);
    margin: 1.25rem 0 0.4rem;
  }
  .md-preview p {
    margin-bottom: 0.8rem;
    font-size: 0.9rem;
    color: var(--muted);
  }
  .md-preview ul, .md-preview ol {
    margin: 0.4rem 0 0.8rem 1.5rem;
  }
  .md-preview li {
    font-size: 0.88rem;
    color: var(--muted);
    margin-bottom: 0.3rem;
    line-height: 1.6;
  }
  .md-preview strong { color: var(--text); font-weight: 700; }
  .md-preview em { color: var(--accent2); font-style: italic; }
  .md-preview code {
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    background: rgba(242,185,13,0.08);
    border: 1px solid rgba(242,185,13,0.18);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    color: var(--accent);
  }
  .md-preview pre {
    margin: 0.8rem 0;
  }
  .md-preview pre code {
    background: none;
    border: none;
    padding: 0;
    color: var(--text);
    font-size: 0.78rem;
  }
  .md-preview blockquote {
    border-left: 3px solid var(--accent3);
    padding: 0.5rem 0 0.5rem 1rem;
    margin: 0.8rem 0;
    color: var(--muted);
    font-style: italic;
    background: rgba(196,147,10,0.06);
    border-radius: 0 6px 6px 0;
  }
  .md-preview hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.25rem 0;
  }
  .md-preview table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.8rem 0;
    font-size: 0.85rem;
  }
  .md-preview th {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 0.5rem 0.8rem;
    text-align: left;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    color: var(--accent);
    letter-spacing: 0.05em;
  }
  .md-preview td {
    border: 1px solid var(--border);
    padding: 0.5rem 0.8rem;
    color: var(--muted);
  }
  .md-preview tr:hover td { background: rgba(242,185,13,0.03); }

  /* Modal footer with download button */
  .modal-footer {
    padding: 0.75rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.75rem;
  }
  .modal-download-btn {
    background: rgba(242,185,13,0.1);
    border: 1px solid rgba(242,185,13,0.35);
    color: var(--accent);
    border-radius: 8px;
    padding: 0.4rem 1rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    cursor: pointer;
    transition: all 0.18s;
  }
  .modal-download-btn:hover {
    background: rgba(242,185,13,0.18);
    box-shadow: 0 0 12px rgba(242,185,13,0.25);
  }

  .results-actions {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .results-actions h3 {
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
    letter-spacing: 0.1em;
    margin-bottom: 1.5rem;
  }

  .actions-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .btn-secondary {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 12px;
    padding: 0.85rem 1.5rem;
    font-family: 'Manrope', sans-serif;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-secondary:hover {
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 12px rgba(242,185,13,0.15);
  }

  .instructions {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .instructions h3 {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .instruction-steps {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  .instruction-step {
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
  }
  .instruction-step .num {
    width: 32px; height: 32px;
    border-radius: 8px;
    background: rgba(242,185,13,0.12);
    border: 1px solid rgba(242,185,13,0.35);
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .instruction-step .content { flex: 1; }
  .instruction-step .content strong { font-weight: 700; display: block; margin-bottom: 0.3rem; }
  .instruction-step .content p { font-size: 0.87rem; color: var(--muted); line-height: 1.6; }
  .instruction-step .content code {
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    background: var(--bg);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    color: var(--accent);
  }

  .api-key-area {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .api-key-status {
    font-size: 0.72rem;
    font-family: 'Space Mono', monospace;
    padding: 0.3rem 0;
  }
  .api-key-status.ok { color: var(--success); }
  .api-key-status.err { color: var(--accent2); }

  .model-select-wrap {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    margin-bottom: 0.75rem;
  }
  .model-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    padding: 0.65rem 1rem;
    cursor: pointer;
    outline: none;
    width: 100%;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235a7296' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .model-select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(242,185,13,0.1);
  }
  .model-select option { background: #221e10; color: var(--text); }
  .model-hint {
    font-size: 0.67rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    margin-top: 0.1rem;
  }
  .model-provider-badge {
    display: inline-block;
    font-size: 0.58rem;
    font-family: 'Space Mono', monospace;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    letter-spacing: 0.06em;
    margin-left: 0.35rem;
    vertical-align: middle;
  }

  .notif {
    position: fixed;
    bottom: calc(64px + env(safe-area-inset-bottom, 0px) + 16px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(20, 17, 8, 0.97);
    border: 0.5px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    padding: 0.85rem 1.4rem;
    font-size: 0.9rem;
    font-family: 'Manrope', sans-serif;
    font-weight: 700;
    color: var(--text);
    z-index: 215;
    white-space: nowrap;
    pointer-events: none;
    animation: notif-spring-in 0.42s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    backdrop-filter: blur(28px) saturate(2.2);
    -webkit-backdrop-filter: blur(28px) saturate(2.2);
    box-shadow: 0 12px 40px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.05);
    letter-spacing: -0.01em;
  }
  .notif.error {
    border-color: rgba(224, 90, 26, 0.4);
    background: rgba(40, 20, 10, 0.92);
  }
  .notif.hiding {
    animation: notif-out 0.24s ease forwards !important;
  }
  /* Mobile: centered from bottom */
  @keyframes notif-spring-in {
    0%   { opacity: 0; transform: translateX(-50%) translateY(24px) scale(0.86); }
    60%  { opacity: 1; transform: translateX(-50%) translateY(-5px) scale(1.03); }
    100% { opacity: 1; transform: translateX(-50%) translateY(0)    scale(1); }
  }
  @keyframes notif-out {
    0%   { opacity: 1; transform: translateX(-50%) translateY(0)    scale(1); }
    100% { opacity: 0; transform: translateX(-50%) translateY(14px) scale(0.9); }
  }
  /* Desktop: bottom-right, no translateX */
  @keyframes notif-spring-in-desktop {
    0%   { opacity: 0; transform: translateY(20px) scale(0.88); }
    60%  { opacity: 1; transform: translateY(-4px) scale(1.02); }
    100% { opacity: 1; transform: translateY(0)    scale(1); }
  }
  @keyframes notif-out-desktop {
    0%   { opacity: 1; transform: translateY(0)    scale(1); }
    100% { opacity: 0; transform: translateY(12px) scale(0.9); }
  }
  .notif.hiding {
    animation: notif-out 0.24s ease forwards !important;
  }
  @media (min-width: 769px) {
    .notif {
      left: auto;
      right: 2rem;
      bottom: 2rem;
      transform: none;
      animation: notif-spring-in-desktop 0.42s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    .notif.hiding {
      animation: notif-out-desktop 0.24s ease forwards !important;
    }
  }

  @media (max-width: 768px) {
    .chat-layout {
      grid-template-columns: 1fr !important;
      height: calc(100svh - 128px);
    }
    .chat-sidebar {
      display: none !important;
    }
    header { padding: 1rem 1.25rem; }
    main { padding: 1rem; }
    .hero { padding: 2rem 0 1.5rem; }
  }

  .option-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 8px;
    padding: 0.6rem 1rem;
    font-family: 'Manrope', sans-serif;
    font-size: 0.87rem;
    cursor: pointer;
    transition: all 0.18s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-align: left;
    flex: 1;
    min-width: 180px;
  }
  .option-btn:hover {
    border-color: var(--accent);
    background: rgba(242,185,13,0.08);
    color: var(--accent);
    transform: translateY(-1px);
  }
  .opt-label {
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--accent);
    background: rgba(242,185,13,0.1);
    border: 1px solid rgba(242,185,13,0.25);
    border-radius: 4px;
    padding: 0.15rem 0.4rem;
    flex-shrink: 0;
  }

  .level-section {
    max-width: 760px;
    margin: 0 auto 2.5rem;
  }
  .level-section-label {
    font-size: 0.72rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    letter-spacing: 0.15em;
    margin-bottom: 0.85rem;
    display: block;
  }
  .level-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
  }
  @media(max-width:700px) { .level-grid { grid-template-columns: repeat(2,1fr); } }

  .level-card {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 14px;
    padding: 1.1rem 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .level-card::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .level-card:hover { transform: translateY(-3px); }
  .level-card.selected { transform: translateY(-3px); }
  .level-card .level-emoji { font-size: 2rem; margin-bottom: 0.4rem; display: block; }
  .level-card .level-name {
    font-weight: 800;
    font-size: 1rem;
    margin-bottom: 0.2rem;
  }
  .level-card .level-tagline {
    font-size: 0.68rem;
    color: var(--muted);
    line-height: 1.4;
  }
  .level-card .level-agents {
    font-family: 'Space Mono', monospace;
    font-size: 0.62rem;
    margin-top: 0.5rem;
    padding: 0.2rem 0.5rem;
    border-radius: 20px;
    display: inline-block;
    border: 1px solid;
  }

  /* ── Inline choice cards ── */
  .choices-msg {
    align-self: stretch;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    animation: msgIn 0.3s ease;
  }
  .choice-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.18s;
    text-align: left;
    width: 100%;
    box-sizing: border-box;
  }
  .choice-card:active,
  .choice-card:hover {
    border-color: var(--accent);
    background: rgba(242,185,13,0.07);
  }
  .choice-card.selected {
    border-color: var(--accent);
    background: rgba(242,185,13,0.13);
    pointer-events: none;
  }
  .choice-card.disabled {
    opacity: 0.42;
    pointer-events: none;
  }
  .choice-label {
    font-family: 'Space Mono', monospace;
    font-size: 0.68rem;
    font-weight: 700;
    color: var(--accent);
    background: rgba(242,185,13,0.12);
    border: 1px solid rgba(242,185,13,0.3);
    border-radius: 5px;
    padding: 0.18rem 0.42rem;
    flex-shrink: 0;
  }
  .choice-text {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text);
    line-height: 1.4;
    font-family: 'Manrope', sans-serif;
  }
  .choice-info-btn {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 1rem;
    cursor: pointer;
    padding: 0.15rem 0.3rem;
    flex-shrink: 0;
    line-height: 1;
    transition: color 0.15s;
    border-radius: 50%;
  }
  .choice-info-btn:hover { color: var(--accent); }
  .choice-impact {
    display: none;
    font-size: 0.75rem;
    color: var(--muted);
    background: rgba(242,185,13,0.04);
    border-top: 1px solid rgba(242,185,13,0.15);
    padding: 0.5rem 1rem 0.6rem 1rem;
    border-radius: 0 0 12px 12px;
    line-height: 1.5;
  }
  .choice-impact.visible { display: block; }
  .choice-wrap {
    display: flex;
    flex-direction: column;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid var(--border);
    transition: border-color 0.18s;
  }
  .choice-wrap:hover { border-color: var(--accent); }
  .choice-wrap .choice-card {
    border: none;
    border-radius: 0;
    padding: 0.6rem 0.9rem;
  }
  .choice-wrap.selected { border-color: var(--accent); }

  .option-wrap {
    flex: 1;
    min-width: 200px;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  .option-btn { width: 100%; }
  .opt-text { flex: 1; }
  .impact-note { display: none; }

  .agent-type-badge {
    font-family: 'Space Mono', monospace;
    font-size: 0.58rem;
    font-weight: 700;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }
  .badge-tech {
    background: rgba(196,147,10,0.15);
    border: 1px solid rgba(196,147,10,0.4);
    color: #f2b90d;
  }
  .badge-biz {
    background: rgba(224,90,26,0.12);
    border: 1px solid rgba(224,90,26,0.35);
    color: #e88a50;
  }

  .agent-section {
    margin-bottom: 2rem;
  }
  .agent-section-header {
    display: flex;
    align-items: center;
    gap: 0.65rem;
    font-size: 0.78rem;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  .section-count {
    margin-left: auto;
    background: rgba(255,255,255,0.08);
    border-radius: 20px;
    padding: 0.1rem 0.5rem;
    font-size: 0.65rem;
  }
  .section-tech {
    background: rgba(196,147,10,0.1);
    border: 1px solid rgba(196,147,10,0.25);
    color: #f2b90d;
  }
  .section-biz {
    background: rgba(224,90,26,0.08);
    border: 1px solid rgba(224,90,26,0.2);
    color: #e88a50;
  }
  .section-config {
    background: rgba(42,37,16,0.6);
    border: 1px solid var(--border);
    color: var(--muted);
  }

  .agent-section .agents-grid { margin-bottom: 0; }

  .scoring-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.75rem 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }
  .scoring-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, #f2b90d, #c49a0a, #e05a1a);
  }
  .scoring-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .scoring-header h3 {
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    color: var(--accent);
  }
  .score-badge {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .score-number {
    font-size: 2.5rem;
    font-weight: 800;
    font-family: 'Space Mono', monospace;
    line-height: 1;
  }
  .score-label {
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.4;
  }
  .score-label strong { display: block; font-size: 0.9rem; color: var(--text); }

  .scoring-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .score-metric {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
  }
  .metric-info-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.85rem;
    padding: 0 0.2rem;
    vertical-align: middle;
    opacity: 0.7;
    transition: opacity 0.15s;
    line-height: 1;
  }
  .metric-info-btn:hover { opacity: 1; }
  .metric-tip {
    display: none;
    font-size: 0.75rem;
    color: var(--muted);
    background: rgba(242,185,13,0.06);
    border-left: 2px solid rgba(242,185,13,0.3);
    border-radius: 0 6px 6px 0;
    padding: 0.4rem 0.7rem;
    margin: 0.2rem 0 0.4rem 0;
    line-height: 1.5;
    animation: msgIn 0.2s ease;
  }
  .metric-tip.visible { display: block; }

  .score-metric-label {
    font-size: 0.68rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin-bottom: 0.5rem;
  }
  .score-metric-bar {
    height: 5px;
    background: var(--border);
    border-radius: 3px;
    margin-bottom: 0.4rem;
    overflow: hidden;
  }
  .score-metric-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 1s ease;
  }
  .score-metric-value {
    font-size: 0.78rem;
    font-weight: 700;
    color: var(--text);
  }

  .scoring-risks {
    margin-bottom: 1rem;
  }
  .scoring-risks h4 {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent2);
    letter-spacing: 0.1em;
    margin-bottom: 0.6rem;
  }
  .risk-item {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    font-size: 0.82rem;
    color: var(--muted);
    margin-bottom: 0.35rem;
    line-height: 1.5;
  }
  .risk-item::before { content: '▸'; color: var(--accent2); flex-shrink: 0; }

  .level-suggestion {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.82rem;
    background: rgba(242,185,13,0.06);
    border: 1px solid rgba(242,185,13,0.18);
    color: var(--text);
  }
  .level-suggestion.warn {
    background: rgba(224,90,26,0.06);
    border-color: rgba(224,90,26,0.2);
  }
  .level-suggestion .ls-icon { font-size: 1.1rem; }

  .section-header-bar {
    display: flex;
    align-items: center;
    gap: 0.65rem;
    font-size: 0.78rem;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    background: rgba(242,185,13,0.07);
    border: 1px solid rgba(242,185,13,0.18);
    color: var(--accent);
  }
  .graph-section {
    margin-bottom: 2rem;
  }
  .graph-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    overflow: hidden;
    position: relative;
  }
  #agent-graph {
    width: 100%;
    height: auto;
    display: block;
    cursor: grab;
    will-change: transform;
  }
  #agent-graph:active { cursor: grabbing; }
  .graph-legend {
    display: flex;
    gap: 1.5rem;
    padding: 0.75rem 1.25rem;
    border-top: 1px solid var(--border);
    font-size: 0.72rem;
    color: var(--muted);
  }
  .graph-legend span { display: flex; align-items: center; gap: 0.4rem; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  .refine-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.75rem 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.3s ease;
  }
  .refine-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, #f2b90d, #c49a0a, #7cc42a);
  }

  .refine-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 1.25rem;
    gap: 1rem;
  }
  .refine-header h3 {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 0.2rem;
  }
  .refine-header p {
    font-size: 0.8rem;
    color: var(--muted);
  }
  .refine-close-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 30px; height: 30px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .refine-close-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  .refine-action-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
  }
  .refine-chip {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.45rem 0.9rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--text);
  }
  .refine-chip:hover, .refine-chip.active {
    border-color: var(--accent);
    background: rgba(242,185,13,0.1);
    color: var(--accent);
  }

  .refine-history {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
    max-height: 280px;
    overflow-y: auto;
    padding-right: 0.25rem;
  }
  .refine-history:empty { display: none; }
  .refine-history::-webkit-scrollbar { width: 3px; }
  .refine-history::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .refine-msg {
    animation: msgIn 0.25s ease;
  }
  .refine-msg.user .refine-bubble {
    background: rgba(242,185,13,0.1);
    border: 1px solid rgba(242,185,13,0.25);
    border-radius: 10px;
    border-bottom-right-radius: 3px;
    padding: 0.7rem 1rem;
    font-size: 0.87rem;
    margin-left: 20%;
    color: var(--text);
  }
  .refine-msg.ai .refine-bubble {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    border-bottom-left-radius: 3px;
    padding: 0.7rem 1rem;
    font-size: 0.87rem;
    margin-right: 20%;
    color: var(--text);
    line-height: 1.6;
  }
  .refine-msg-sender {
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    margin-bottom: 0.25rem;
    padding: 0 0.3rem;
  }
  .refine-msg.user .refine-msg-sender { text-align: right; color: var(--accent3); }
  .refine-msg.ai .refine-msg-sender { color: var(--accent); }

  .refine-diff-added {
    display: inline-block;
    background: rgba(124,196,42,0.12);
    border: 1px solid rgba(124,196,42,0.25);
    color: var(--success);
    border-radius: 4px;
    padding: 0.1rem 0.4rem;
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    margin: 0.1rem;
  }
  .refine-diff-removed {
    display: inline-block;
    background: rgba(255,59,48,0.1);
    border: 1px solid rgba(255,59,48,0.2);
    color: #ff6b6b;
    border-radius: 4px;
    padding: 0.1rem 0.4rem;
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    margin: 0.1rem;
    text-decoration: line-through;
  }
  .refine-diff-changed {
    display: inline-block;
    background: rgba(255,149,0,0.1);
    border: 1px solid rgba(255,149,0,0.25);
    color: #ff9500;
    border-radius: 4px;
    padding: 0.1rem 0.4rem;
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    margin: 0.1rem;
  }

  .refine-input-row {
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
  }
  .refine-textarea {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 1rem;
    color: var(--text);
    font-family: 'Manrope', sans-serif;
    font-size: 0.9rem;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
    line-height: 1.5;
  }
  .refine-textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(242,185,13,0.1); }
  .refine-textarea::placeholder { color: var(--muted); }

  .refine-submit-btn {
    background: #f2b90d;
    color: #1a170d;
    padding: 0.75rem 1.25rem;
    white-space: nowrap;
    flex-shrink: 0;
    font-weight: 800;
    box-shadow: 0 2px 12px rgba(242,185,13,0.3);
  }
  .refine-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .refine-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.75rem;
  }
  .refine-revert-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: 0.75rem;
    padding: 0.3rem 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Manrope', sans-serif;
    transition: all 0.15s;
  }
  .refine-revert-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  .refine-thinking {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.82rem;
    color: var(--muted);
    padding: 0.5rem 0;
    font-family: 'Space Mono', monospace;
  }
  .refine-thinking .thinking-dots span {
    display: inline-block;
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--accent);
    margin: 0 2px;
    animation: typing 1.2s infinite;
  }
  .refine-thinking .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
  .refine-thinking .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes agentUpdated {
    0%   { box-shadow: 0 0 0 rgba(124,196,42,0); border-color: var(--border); }
    30%  { box-shadow: 0 0 24px rgba(124,196,42,0.3); border-color: var(--success); }
    100% { box-shadow: 0 0 0 rgba(124,196,42,0); border-color: var(--border); }
  }
  .agent-card.just-updated { animation: agentUpdated 1.5s ease forwards; }
  @keyframes agentAdded {
    0%   { opacity: 0; transform: translateY(12px) scale(0.97); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }
  /* ── PWA STYLES ── */

  /* Safe area padding for notch/home-bar devices */
  header {
    padding-top: max(1.5rem, env(safe-area-inset-top));
    padding-left: max(2.5rem, env(safe-area-inset-left));
    padding-right: max(2.5rem, env(safe-area-inset-right));
  }
  main {
    padding-left: max(2rem, env(safe-area-inset-left));
    padding-right: max(2rem, env(safe-area-inset-right));
    padding-bottom: max(2rem, env(safe-area-inset-bottom));
  }

  /* Install banner */
  .pwa-install-banner {
    position: fixed;
    bottom: max(1.5rem, env(safe-area-inset-bottom));
    left: max(1.25rem, env(safe-area-inset-left));
    right: max(1.25rem, env(safe-area-inset-right));
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 14px;
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    z-index: 500;
    box-shadow: 0 8px 32px rgba(242,185,13,0.2);
    animation: slideUp 0.4s ease;
    max-width: 480px;
    margin: 0 auto;
  }
  @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
  .pwa-install-icon { font-size: 1.8rem; flex-shrink: 0; }
  .pwa-install-text { flex: 1; }
  .pwa-install-title { font-weight: 800; font-size: 0.9rem; margin-bottom: 0.15rem; }
  .pwa-install-sub   { font-size: 0.72rem; color: var(--muted); }
  .pwa-install-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
  .pwa-install-btn {
    background: #f2b90d;
    color: #1a170d;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-family: 'Manrope', sans-serif;
    font-weight: 800;
    font-size: 0.82rem;
    cursor: pointer;
    white-space: nowrap;
    box-shadow: 0 2px 10px rgba(242,185,13,0.3);
  }
  .pwa-dismiss-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    cursor: pointer;
  }
  .pwa-dismiss-btn:hover { color: var(--text); border-color: var(--text); }

  /* Offline indicator */
  .offline-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: #e05a1a;
    color: #fff;
    text-align: center;
    padding: 0.4rem 1rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    font-weight: 700;
    z-index: 1010;
    display: none;
    letter-spacing: 0.05em;
  }
  .offline-bar.visible { display: block; }

  /* Standalone mode tweaks */
  @media (display-mode: standalone) {
    header {
      padding-top: max(1.25rem, env(safe-area-inset-top));
    }
    body::before { opacity: 0.6; }
  }

  /* Update toast */
  .pwa-update-toast {
    position: fixed;
    bottom: calc(64px + env(safe-area-inset-bottom, 0px) + 12px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(26,23,13,0.96);
    backdrop-filter: blur(20px) saturate(1.8);
    -webkit-backdrop-filter: blur(20px) saturate(1.8);
    border: 1px solid rgba(242,185,13,0.4);
    border-radius: 14px;
    padding: 0.85rem 1.3rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.88rem;
    font-family: 'Manrope', sans-serif;
    font-weight: 600;
    z-index: 220;
    white-space: nowrap;
    box-shadow: 0 8px 32px rgba(0,0,0,0.45), 0 0 0 0.5px rgba(255,255,255,0.06);
    animation: notif-spring-in 0.42s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }
  .pwa-update-btn {
    background: #f2b90d;
    color: #1a170d;
    border: none;
    border-radius: 6px;
    padding: 0.3rem 0.75rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.68rem;
    cursor: pointer;
    font-weight: 700;
  }

  .trace-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 2rem;
    overflow: hidden;
  }
  .trace-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    cursor: pointer;
    user-select: none;
  }
  .trace-panel-header h3 {
    font-size: 0.72rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
    letter-spacing: 0.12em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .trace-summary-pills {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .trace-pill {
    font-size: 0.62rem;
    font-family: 'Space Mono', monospace;
    padding: 0.15rem 0.5rem;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--muted);
    background: var(--bg);
    white-space: nowrap;
  }
  .trace-pill.ok    { border-color: rgba(124,196,42,0.3); color: var(--success); background: rgba(124,196,42,0.07); }
  .trace-pill.warn  { border-color: rgba(255,213,128,0.3); color: #ffd580; background: rgba(255,213,128,0.07); }
  .trace-pill.error { border-color: rgba(255,107,53,0.3); color: var(--accent2); background: rgba(255,107,53,0.07); }

  .trace-body {
    display: none;
    padding: 1.25rem 1.5rem;
  }
  .trace-body.open { display: block; }

  /* Gantt-style bar header */
  .trace-gantt-header {
    display: grid;
    grid-template-columns: 200px 1fr 80px 70px 60px;
    gap: 0.5rem;
    padding: 0 0 0.5rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.6rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  @media(max-width:700px) {
    .trace-gantt-header { grid-template-columns: 140px 1fr 60px 0 0; }
    .trace-gantt-header .th-tokens,
    .trace-gantt-header .th-status { display: none; }
  }

  .trace-span {
    display: grid;
    grid-template-columns: 200px 1fr 80px 70px 60px;
    gap: 0.5rem;
    align-items: center;
    padding: 0.55rem 0;
    border-bottom: 1px solid rgba(30,48,80,0.5);
    font-size: 0.78rem;
  }
  .trace-span:last-child { border-bottom: none; }
  @media(max-width:700px) {
    .trace-span { grid-template-columns: 140px 1fr 60px 0 0; }
    .trace-span .span-tokens,
    .trace-span .span-status { display: none; }
  }

  .span-name {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    min-width: 0;
  }
  .span-label {
    font-weight: 600;
    color: var(--text);
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .span-model {
    font-size: 0.62rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .span-detail {
    font-size: 0.65rem;
    color: var(--accent);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    opacity: 0.85;
  }

  .span-bar-col { position: relative; height: 20px; }
  .span-bar-track {
    position: absolute;
    inset: 4px 0;
    background: var(--surface2);
    border-radius: 4px;
    overflow: hidden;
  }
  .span-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.6s ease;
    position: relative;
    overflow: hidden;
  }
  .span-bar-fill::after {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 60%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    animation: barShine 2s infinite;
  }
  @keyframes barShine { 0%{left:-60%} 100%{left:160%} }

  .span-bar-fill.fill-ok      { background: linear-gradient(90deg, var(--accent), #00b8cc); }
  .span-bar-fill.fill-warn    { background: linear-gradient(90deg, #ffd580, #ffaa00); }
  .span-bar-fill.fill-fallback{ background: linear-gradient(90deg, #ff9500, #e05a1a); }
  .span-bar-fill.fill-error   { background: linear-gradient(90deg, var(--accent2), #cc4400); }
  .span-bar-fill.fill-pending { background: repeating-linear-gradient(90deg, var(--border) 0, var(--border) 6px, transparent 6px, transparent 12px); animation: none; }

  .span-duration {
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    color: var(--text);
    text-align: right;
    white-space: nowrap;
  }
  .span-tokens {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    text-align: right;
    white-space: nowrap;
  }
  .span-status {
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }
  .span-badge {
    font-size: 0.58rem;
    font-family: 'Space Mono', monospace;
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    border: 1px solid;
    white-space: nowrap;
  }
  .badge-ok       { color: var(--success); border-color: rgba(0,255,136,0.35); background: rgba(124,196,42,0.08); }
  .badge-fallback { color: #ffd580;        border-color: rgba(255,213,128,0.35); background: rgba(255,213,128,0.08); }
  .badge-error    { color: var(--accent2); border-color: rgba(255,107,53,0.35); background: rgba(255,107,53,0.08); }
  .badge-pending  { color: var(--muted);   border-color: var(--border); }

  .trace-footer {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 1.5rem;
    font-size: 0.68rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    flex-wrap: wrap;
  }
  .trace-footer strong { color: var(--text); }

  /* share-modal and fw-modal inherit .modal sheet style */
  .share-modal {
    background: var(--surface);
    border-radius: 22px 22px 0 0;
    width: 100%;
    max-width: 560px;
    animation: sheet-slide-up 0.4s cubic-bezier(0.32, 0.72, 0, 1) forwards;
    overflow: hidden;
    position: relative;
    box-shadow: 0 -4px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.06);
  }
  .share-modal::before {
    content: '';
    position: absolute;
    top: 10px; left: 50%; transform: translateX(-50%);
    width: 38px; height: 5px;
    background: rgba(255,255,255,0.18); border-radius: 3px;
  }
  [data-theme="light"] .share-modal::before { background: rgba(0,0,0,0.12); }
  @media (min-width: 769px) {
    .share-modal { border-radius: 20px; animation: sheet-scale-in 0.3s cubic-bezier(0.34,1.3,0.64,1) forwards; }
    .share-modal::before { display: none; }
  }
  .share-url-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .share-url-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.6rem 0.9rem;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    outline: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: text;
  }
  .share-copy-btn {
    background: rgba(242,185,13,0.1);
    border: 1px solid rgba(242,185,13,0.3);
    color: var(--accent);
    border-radius: 8px;
    padding: 0.6rem 1rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.18s;
  }
  .share-copy-btn:hover { background: rgba(242,185,13,0.18); }
  .share-copy-btn.copied { border-color: var(--success); color: var(--success); background: rgba(124,196,42,0.1); }

  .share-options {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    margin-bottom: 1.25rem;
  }
  .share-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.18s;
    background: var(--surface2);
  }
  .share-option:hover { border-color: var(--accent); }
  .share-option.active { border-color: var(--accent); background: rgba(242,185,13,0.05); }
  .share-option input[type="radio"] { accent-color: var(--accent); flex-shrink: 0; }
  .share-option-text { flex: 1; }
  .share-option-label { font-size: 0.85rem; font-weight: 600; color: var(--text); }
  .share-option-desc  { font-size: 0.72rem; color: var(--muted); margin-top: 0.1rem; }

  .share-password-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.6rem;
    padding-left: 1.75rem;
  }
  .share-meta {
    font-size: 0.68rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    padding: 0.75rem 0 0;
    border-top: 1px solid var(--border);
  }
  .share-meta span { display: flex; align-items: center; gap: 0.3rem; }
  .share-size-warn { color: var(--accent2); }

  /* Shared view banner */
  .shared-banner {
    background: linear-gradient(90deg, rgba(242,185,13,0.08), rgba(196,147,10,0.08));
    border: 1px solid rgba(242,185,13,0.25);
    border-radius: 12px;
    padding: 0.9rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.82rem;
  }
  .shared-banner-icon { font-size: 1.4rem; flex-shrink: 0; }
  .shared-banner-text { flex: 1; }
  .shared-banner-title { font-weight: 700; margin-bottom: 0.2rem; }
  .shared-banner-sub   { color: var(--muted); font-size: 0.74rem; }
  .shared-banner-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1rem; padding: 0.2rem; }
  .shared-banner-close:hover { color: var(--text); }

  .version-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 2rem;
    overflow: hidden;
  }
  .version-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    cursor: pointer;
    user-select: none;
  }
  .version-panel-header h3 {
    font-size: 0.72rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
    letter-spacing: 0.12em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .version-count-badge {
    background: rgba(242,185,13,0.12);
    border: 1px solid rgba(242,185,13,0.25);
    border-radius: 20px;
    padding: 0.1rem 0.5rem;
    font-size: 0.62rem;
    color: var(--accent);
  }
  .version-toggle-icon {
    font-size: 0.75rem;
    color: var(--muted);
    transition: transform 0.2s;
  }
  .version-toggle-icon.open { transform: rotate(180deg); }

  .version-timeline {
    padding: 1rem 1.5rem;
    display: none;
  }
  .version-timeline.open { display: block; }

  .version-entry {
    display: flex;
    gap: 1rem;
    position: relative;
    padding-bottom: 1.25rem;
  }
  .version-entry:last-child { padding-bottom: 0; }
  .version-entry:not(:last-child)::before {
    content: '';
    position: absolute;
    left: 13px;
    top: 28px;
    bottom: 0;
    width: 1px;
    background: var(--border);
  }

  .version-dot-col { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
  .version-dot {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: 2px solid var(--border);
    background: var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .version-entry.current .version-dot {
    border-color: var(--accent);
    background: rgba(242,185,13,0.12);
    color: var(--accent);
    box-shadow: 0 0 10px rgba(242,185,13,0.2);
  }
  .version-entry.origin .version-dot {
    border-color: var(--success);
    background: rgba(124,196,42,0.1);
    color: var(--success);
  }

  .version-card {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 1rem;
    transition: all 0.18s;
    min-width: 0;
  }
  .version-entry.current .version-card {
    border-color: rgba(242,185,13,0.35);
    background: rgba(242,185,13,0.04);
  }
  .version-card-top {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
    flex-wrap: wrap;
  }
  .version-label {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .version-time {
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    white-space: nowrap;
  }
  .version-current-tag {
    font-size: 0.58rem;
    font-family: 'Space Mono', monospace;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    background: rgba(242,185,13,0.12);
    border: 1px solid rgba(242,185,13,0.3);
    color: var(--accent);
    white-space: nowrap;
  }

  .version-diff {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    margin-bottom: 0.5rem;
  }
  .diff-tag {
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    border: 1px solid;
  }
  .diff-added   { color: var(--success); border-color: rgba(124,196,42,0.3); background: rgba(124,196,42,0.08); }
  .diff-removed { color: var(--accent2); border-color: rgba(255,107,53,0.3); background: rgba(255,107,53,0.08); }
  .diff-changed { color: #ffd580;        border-color: rgba(255,213,128,0.3); background: rgba(255,213,128,0.08); }

  .version-agents {
    font-size: 0.7rem;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    margin-bottom: 0.6rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .version-actions {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
  }
  .version-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 6px;
    padding: 0.25rem 0.6rem;
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .version-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .version-btn.restore-btn:hover {
    border-color: var(--success);
    color: var(--success);
    background: rgba(124,196,42,0.06);
  }
  .version-btn.diff-btn:hover {
    border-color: #ffd580;
    color: #ffd580;
  }

  /* diff modal */
  .diff-modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
  .diff-section { margin-bottom: 1.5rem; }
  .diff-section-title {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.1em;
    margin-bottom: 0.75rem;
    padding-bottom: 0.4rem;
    border-bottom: 1px solid var(--border);
  }
  .diff-agent-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.4rem;
    font-size: 0.82rem;
  }
  .diff-agent-row.row-added   { background: rgba(124,196,42,0.06); border: 1px solid rgba(124,196,42,0.15); }
  .diff-agent-row.row-removed { background: rgba(255,107,53,0.06); border: 1px solid rgba(255,107,53,0.15); }
  .diff-agent-row.row-changed { background: rgba(255,213,128,0.05); border: 1px solid rgba(255,213,128,0.15); }
  .diff-agent-row .row-icon { font-size: 1rem; }
  .diff-agent-name { font-weight: 600; flex: 1; }
  .diff-agent-role { font-size: 0.7rem; color: var(--muted); font-family: 'Space Mono', monospace; }

  .fw-modal {
    background: var(--surface);
    border-radius: 22px 22px 0 0;
    width: 100%;
    max-width: 900px;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    animation: sheet-slide-up 0.4s cubic-bezier(0.32, 0.72, 0, 1) forwards;
    position: relative;
    box-shadow: 0 -4px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.06);
  }
  .fw-modal::before {
    content: '';
    position: absolute;
    top: 10px; left: 50%; transform: translateX(-50%);
    width: 38px; height: 5px;
    background: rgba(255,255,255,0.18); border-radius: 3px;
  }
  [data-theme="light"] .fw-modal::before { background: rgba(0,0,0,0.12); }
  @media (min-width: 769px) {
    .fw-modal { border-radius: 20px; animation: sheet-scale-in 0.3s cubic-bezier(0.34,1.3,0.64,1) forwards; max-height: 88vh; }
    .fw-modal::before { display: none; }
  }
  .fw-tabs {
    display: flex;
    gap: 0.5rem;
    padding: 1rem 1.5rem 0;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    flex-shrink: 0;
  }
  .fw-tab {
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    padding: 0.5rem 1.1rem 0.7rem;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    white-space: nowrap;
    transition: all 0.18s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .fw-tab:hover { color: var(--text); }
  .fw-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .fw-tab .fw-badge {
    font-size: 0.58rem;
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    background: rgba(242,185,13,0.1);
    border: 1px solid rgba(242,185,13,0.25);
    color: var(--accent);
  }

  /* Prompt export tab buttons (#7) */
  .prompt-tab-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.4rem 0.9rem;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    transition: all 0.18s;
  }
  .prompt-tab-btn:hover { color: var(--text); border-color: var(--accent); }
  .prompt-tab-btn.active {
    background: rgba(242,185,13,0.1);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* ── IMPORT MODAL (#4) ── */
  .import-dropzone {
    border: 2px dashed var(--border);
    border-radius: 14px;
    padding: 2rem 1.5rem;
    text-align: center;
    transition: all 0.2s;
    background: var(--surface2);
    cursor: default;
  }
  .import-dropzone.drag-over {
    border-color: var(--accent);
    background: rgba(242,185,13,0.05);
    transform: scale(1.01);
  }
  .fw-body {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .fw-pane {
    display: none;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
  }
  .fw-pane.active {
    display: flex;
  }
  .fw-info {
    padding: 1rem 1.5rem 0.75rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;
  }
  .fw-info-text { flex: 1; }
  .fw-info-title {
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 0.2rem;
  }
  .fw-info-desc {
    font-size: 0.78rem;
    color: var(--muted);
    line-height: 1.5;
  }
  .fw-info-logo {
    font-size: 2rem;
    flex-shrink: 0;
  }
  .fw-code-wrap {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem 1.5rem;
    background: var(--bg);
  }
  .fw-code-wrap pre {
    margin: 0;
    border: none;
    background: none;
    padding: 0;
    font-size: 0.78rem;
    line-height: 1.7;
    color: var(--text);
    white-space: pre;
    overflow-x: auto;
  }
  /* Syntax-lite: keywords */
  .fw-code-wrap .kw  { color: #7c9eff; }
  .fw-code-wrap .str { color: #a8d8a8; }
  .fw-code-wrap .cmt { color: var(--muted); font-style: italic; }
  .fw-code-wrap .fn  { color: #ffd580; }
  .fw-code-wrap .cls { color: #ff9dd0; }
  .fw-footer-row {
    padding: 0.75rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-shrink: 0;
  }
  .fw-pip {
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.3rem 0.75rem;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* ═══════════════════════════════════════════════════════
     iOS UX SYSTEM — Spring · Haptic · Sheets · Tab Bar
     ═══════════════════════════════════════════════════════ */

  /* ── PRIORITY 1: SPRING / HAPTIC FEEL ── */

  /* Screen enter animation */
  @keyframes ios-spring-in {
    0%   { transform: scale(0.93) translateY(10px); opacity: 0; }
    55%  { transform: scale(1.02) translateY(-2px);  opacity: 1; }
    100% { transform: scale(1)    translateY(0);     opacity: 1; }
  }
  .screen.active {
    animation: ios-spring-in 0.42s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  /* Universal spring base transition for interactive elements */
  .btn-primary,
  .btn-secondary,
  .topic-card,
  .level-card,
  .project-card,
  .agent-card,
  .file-chip,
  .filter-btn,
  .lang-btn,
  .modal-tab,
  .ios-tab-btn,
  .share-option,
  .ios-action-btn,
  .ios-list-item,
  .ios-seg-btn {
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition:
      transform   0.22s cubic-bezier(0.34, 1.56, 0.64, 1),
      box-shadow  0.18s ease,
      background  0.15s ease,
      border-color 0.15s ease,
      opacity     0.15s ease !important;
  }

  /* Press-down (scale shrink) */
  .btn-primary:active,
  .btn-secondary:active { transform: scale(0.94) !important; }

  .topic-card:active,
  .level-card:active,
  .project-card:active,
  .agent-card:active    { transform: scale(0.96) !important; }

  .file-chip:active,
  .filter-btn:active,
  .lang-btn:active,
  .modal-tab:active,
  .share-option:active,
  .ios-seg-btn:active   { transform: scale(0.93) !important; }

  .ios-tab-btn:active   { transform: scale(0.88) !important; }
  .ios-action-btn:active { transform: scale(0.965) !important; }
  .ios-list-item:active { opacity: 0.6; }

  /* Release spring-back: when :active ends, spring back */
  .btn-primary:not(:active),
  .btn-secondary:not(:active),
  .topic-card:not(:active),
  .level-card:not(:active),
  .project-card:not(:active),
  .agent-card:not(:active),
  .ios-action-btn:not(:active) {
    transform: scale(1);
  }

  /* Hover lift (desktop only) */
  @media (hover: hover) {
    .btn-primary:hover    { transform: scale(1.03) translateY(-1px); }
    .btn-secondary:hover  { transform: scale(1.02); }
    .topic-card:hover     { transform: scale(1.03) translateY(-2px); }
    .level-card:hover     { transform: scale(1.04); }
    .project-card:hover   { transform: scale(1.02) translateY(-3px); }
    .agent-card:hover     { transform: scale(1.015) translateY(-2px); }
    .ios-action-btn:hover { transform: scale(1.02); }
  }

  /* ── PRIORITY 2: BOTTOM SHEETS (all modal-overlay) ── */

  /* All modals → align bottom on mobile */
  .modal-overlay {
    align-items: flex-end !important;
  }

  /* Swipe handle on ALL sheet containers */
  .modal::before,
  .share-modal::before,
  .fw-modal::before {
    content: '';
    display: block;
    width: 38px; height: 5px;
    background: rgba(255,255,255,0.18);
    border-radius: 3px;
    margin: 10px auto 0;
    flex-shrink: 0;
  }
  [data-theme="light"] .modal::before,
  [data-theme="light"] .share-modal::before,
  [data-theme="light"] .fw-modal::before {
    background: rgba(0,0,0,0.1);
  }

  /* Adjust header padding to accommodate handle */
  .modal .modal-header,
  .share-modal .modal-header,
  .fw-modal .modal-header {
    padding-top: 0.85rem;
  }

  /* Scrollable body — hide scrollbar iOS style */
  .modal-body,
  .ios-sheet-body {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .modal-body::-webkit-scrollbar,
  .ios-sheet-body::-webkit-scrollbar { display: none; }

  /* On desktop: center-modal, no handle needed */
  @media (min-width: 769px) {
    .modal-overlay { align-items: center !important; }
    .modal::before, .share-modal::before, .fw-modal::before { display: none; }
    .modal .modal-header,
    .share-modal .modal-header,
    .fw-modal .modal-header { padding-top: 1rem; }
  }

  /* ── PRIORITY 3: RESPONSIVE TAB BAR ── */

  /* Mobile: fixed bottom bar */
  #ios-tab-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: calc(64px + env(safe-area-inset-bottom, 0px));
    padding-bottom: env(safe-area-inset-bottom, 0px);
    background: rgba(18,15,7,0.97);
    backdrop-filter: blur(32px) saturate(2);
    -webkit-backdrop-filter: blur(32px) saturate(2);
    border-top: 1px solid rgba(255,255,255,0.11);
    box-shadow: 0 -8px 32px rgba(0,0,0,0.45), 0 -1px 0 rgba(255,255,255,0.06);
    display: flex;
    align-items: stretch;
    z-index: 200;
  }
  [data-theme="light"] #ios-tab-bar {
    background: rgba(248,244,232,0.98);
    border-top-color: rgba(0,0,0,0.12);
    box-shadow: 0 -6px 24px rgba(0,0,0,0.12), 0 -1px 0 rgba(0,0,0,0.06);
  }

  .ios-tab-btn {
    flex: 1;
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    padding: 6px 4px 2px;
    color: rgba(255,255,255,0.35);
    font-family: 'Manrope', sans-serif;
    font-size: 0.6rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    position: relative;
    -webkit-tap-highlight-color: transparent;
    /* spring base */
    transition:
      transform   0.22s cubic-bezier(0.34, 1.56, 0.64, 1),
      color       0.18s ease;
  }
  [data-theme="light"] .ios-tab-btn { color: rgba(0,0,0,0.3); }
  .ios-tab-btn.active { color: #f2b90d; }
  [data-theme="light"] .ios-tab-btn.active { color: #c49a0a; }

  .ios-tab-btn .tab-icon {
    font-size: 1.5rem;
    line-height: 1;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    will-change: transform;
  }
  .ios-tab-btn.active .tab-icon {
    transform: scale(1.15) translateY(-1px);
  }
  .ios-tab-btn:active .tab-icon {
    transform: scale(0.85);
  }

  .ios-tab-badge {
    position: absolute;
    top: 5px;
    right: calc(50% - 18px);
    background: #e05a1a;
    color: #fff;
    font-size: 0.55rem;
    font-weight: 800;
    min-width: 15px; height: 15px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    padding: 0 3px;
    border: 1.5px solid var(--bg);
    animation: ios-spring-in 0.3s cubic-bezier(0.34,1.56,0.64,1);
  }

  /* Tab bar spacer — content doesn't go under it */
  main {
    padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px)) !important;
  }

  /* Mobile: hide desktop header, show iOS nav bars */
  @media (max-width: 768px) {
    header { display: none !important; }
    #ios-tab-bar { display: flex; }
    .ios-screen-header { display: flex; }
    main { padding-left: 0 !important; padding-right: 0 !important; }
    .hero { padding: 1.25rem 0 0.75rem !important; }
    .hero h1 { font-size: clamp(1.9rem, 7vw, 2.8rem) !important; }
    .hero p { font-size: 0.95rem !important; }
    .chat-layout { height: calc(100svh - 110px); }
    .actions-row { flex-direction: column; }
    .custom-topic { flex-direction: column; }
    .custom-topic .btn-primary { width: 100%; }
  }
  /* Desktop: show header, hide tab bar */
  @media (min-width: 769px) {
    header { display: flex !important; }
    #ios-tab-bar { display: none !important; }
    .ios-screen-header { display: none !important; }
    main { padding-bottom: 2rem !important; }
  }

  /* ── Per-screen iOS navigation bars (mobile only) ── */
  .ios-screen-header {
    display: none; /* shown via media query */
    flex-direction: column;
    position: sticky;
    top: 0;
    z-index: 50;
  }
  .ios-nav-bar {
    display: flex;
    align-items: center;
    padding: 0.6rem 1.1rem 0.2rem;
    gap: 0.75rem;
    backdrop-filter: blur(20px) saturate(1.8);
    -webkit-backdrop-filter: blur(20px) saturate(1.8);
    background: rgba(26,23,13,0.82);
    border-bottom: 0.5px solid rgba(255,255,255,0.06);
  }
  [data-theme="light"] .ios-nav-bar {
    background: rgba(250,247,238,0.88);
    border-bottom-color: rgba(0,0,0,0.07);
  }
  .ios-nav-title {
    flex: 1;
    text-align: center;
    font-size: 0.95rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    color: var(--text);
  }
  .ios-nav-back {
    background: none; border: none;
    color: var(--accent);
    font-size: 0.95rem; font-weight: 600;
    font-family: 'Manrope', sans-serif;
    cursor: pointer;
    display: flex; align-items: center; gap: 0.2rem;
    min-width: 64px;
    padding: 0.3rem 0;
    transition: opacity 0.15s;
  }
  .ios-nav-back::before { content: '‹'; font-size: 1.5rem; line-height: 1; }
  .ios-nav-back:active { opacity: 0.5; }
  .ios-nav-action {
    background: none; border: none;
    color: var(--accent);
    font-size: 0.95rem; font-weight: 600;
    font-family: 'Manrope', sans-serif;
    cursor: pointer;
    min-width: 64px; text-align: right;
    transition: opacity 0.15s;
  }
  .ios-nav-action:active { opacity: 0.5; }

  /* ── iOS Progress bar (chat screen) ── */
  .ios-progress-bar-wrap {
    display: flex;
    gap: 4px;
    padding: 0 1.25rem 0.6rem;
    background: rgba(26,23,13,0.82);
    backdrop-filter: blur(20px) saturate(1.8);
  }
  [data-theme="light"] .ios-progress-bar-wrap {
    background: rgba(250,247,238,0.88);
  }
  .ios-progress-segment {
    flex: 1;
    height: 3px;
    border-radius: 2px;
    background: rgba(255,255,255,0.1);
    transition: background 0.35s ease;
  }
  [data-theme="light"] .ios-progress-segment { background: rgba(0,0,0,0.1); }
  .ios-progress-segment.done   { background: #7cc42a; }
  .ios-progress-segment.active { background: #f2b90d; }

  /* ── iOS Segmented Control (category filters) ── */
  .template-filters {
    display: flex;
    justify-content: center;
    max-width: 900px;
    margin: 0 auto 1.25rem;
  }
  .ios-segmented {
    display: flex;
    background: rgba(255,255,255,0.06);
    border-radius: 10px;
    padding: 3px;
    border: 1px solid var(--border);
    width: 100%;
    max-width: 540px;
  }
  [data-theme="light"] .ios-segmented { background: rgba(0,0,0,0.05); }
  .ios-seg-btn {
    flex: 1;
    background: none; border: none;
    border-radius: 8px;
    padding: 0.44rem 0.5rem;
    font-family: 'Manrope', sans-serif;
    font-size: 0.78rem; font-weight: 600;
    color: var(--muted);
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
  }
  .ios-seg-btn.active {
    background: #f2b90d;
    color: #1a170d;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
  }
  [data-theme="light"] .ios-seg-btn.active { box-shadow: 0 1px 4px rgba(0,0,0,0.15); }

  /* ── iOS Search bar ── */
  .ios-search {
    display: flex;
    align-items: center;
    background: rgba(255,255,255,0.07);
    border-radius: 12px;
    padding: 0.65rem 1rem;
    gap: 0.5rem;
    border: 1px solid var(--border);
    transition: border-color 0.18s, background 0.18s;
  }
  [data-theme="light"] .ios-search { background: rgba(0,0,0,0.04); }
  .ios-search:focus-within {
    border-color: var(--accent);
    background: rgba(242,185,13,0.05);
  }
  .ios-search-icon { font-size: 0.9rem; opacity: 0.45; }
  .ios-search input {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text);
    font-family: 'Manrope', sans-serif; font-size: 0.95rem;
  }
  .ios-search input::placeholder { color: var(--muted); }

  /* ── iOS Action buttons (results screen) ── */
  .ios-action-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.75rem; }
  .ios-action-btn {
    display: flex;
    align-items: center;
    gap: 0.85rem;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 0.95rem 1.15rem;
    font-family: 'Manrope', sans-serif;
    font-size: 0.95rem; font-weight: 600;
    color: var(--text);
    text-align: left;
    width: 100%;
    -webkit-tap-highlight-color: transparent;
  }
  [data-theme="light"] .ios-action-btn { background: rgba(0,0,0,0.025); }
  .ios-action-btn .ios-action-icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
    background: rgba(242,185,13,0.1);
    transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1);
  }
  .ios-action-btn.primary-action {
    background: #f2b90d;
    color: #1a170d;
    border-color: transparent;
    box-shadow: 0 4px 20px rgba(242,185,13,0.35);
  }
  .ios-action-btn.primary-action .ios-action-icon { background: rgba(26,23,13,0.12); }
  .ios-action-cancel {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 0.9rem;
    width: 100%;
    font-family: 'Manrope', sans-serif;
    font-size: 0.95rem; font-weight: 700;
    color: #e05a1a;
    cursor: pointer;
    margin-top: 0.25rem;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1), opacity 0.15s;
  }
  [data-theme="light"] .ios-action-cancel { background: rgba(0,0,0,0.025); }
  .ios-action-cancel:active { transform: scale(0.96); opacity: 0.7; }

  /* ── iOS Settings sheet (launched from tab bar) ── */
  .ios-sheet-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 300;
    align-items: flex-end;
    justify-content: center;
  }
  .ios-sheet-overlay.open {
    display: flex;
    animation: sheet-backdrop-in 0.25s ease forwards;
  }
  .ios-sheet {
    background: var(--surface);
    border-radius: 22px 22px 0 0;
    width: 100%;
    max-width: 640px;
    max-height: 88vh;
    display: flex; flex-direction: column;
    animation: sheet-slide-up 0.4s cubic-bezier(0.32,0.72,0,1);
    overflow: hidden;
    box-shadow: 0 -4px 40px rgba(0,0,0,0.4);
  }
  @media (min-width: 769px) {
    .ios-sheet-overlay { align-items: center; }
    .ios-sheet { border-radius: 20px; animation: sheet-scale-in 0.3s cubic-bezier(0.34,1.3,0.64,1); }
  }
  .ios-sheet-handle {
    width: 38px; height: 5px;
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
    margin: 10px auto 0;
    flex-shrink: 0;
  }
  [data-theme="light"] .ios-sheet-handle { background: rgba(0,0,0,0.1); }
  .ios-sheet-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.85rem 1.4rem 0.75rem;
    border-bottom: 0.5px solid var(--border);
  }
  .ios-sheet-title { font-size: 1rem; font-weight: 700; color: var(--text); letter-spacing: -0.01em; }
  .ios-sheet-close {
    width: 30px; height: 30px;
    background: rgba(255,255,255,0.08);
    border: none; border-radius: 50%;
    cursor: pointer; color: var(--muted); font-size: 0.85rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  [data-theme="light"] .ios-sheet-close { background: rgba(0,0,0,0.06); }
  .ios-sheet-close:hover { background: var(--border); color: var(--text); }
  .ios-sheet-close:active { transform: scale(0.88); }
  .ios-sheet-body { flex: 1; overflow-y: auto; padding: 1.1rem 1.25rem; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .ios-sheet-body::-webkit-scrollbar { display: none; }

  /* ── iOS List (settings) ── */
  .ios-section-label {
    font-size: 0.7rem; font-weight: 700; letter-spacing: 0.08em;
    color: var(--muted); text-transform: uppercase;
    padding: 0 0.4rem 0.45rem;
  }
  .ios-list-group {
    background: var(--surface2);
    border-radius: 14px; overflow: hidden;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border);
  }
  .ios-list-item {
    display: flex; align-items: center; gap: 1rem;
    padding: 0.85rem 1.1rem;
    border-bottom: 0.5px solid var(--border);
    -webkit-tap-highlight-color: transparent;
    transition: background 0.12s;
  }
  .ios-list-item:last-child { border-bottom: none; }
  .ios-list-item:active { background: var(--border); }
  .ios-list-icon {
    width: 32px; height: 32px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; flex-shrink: 0;
  }
  .ios-list-label { flex: 1; font-weight: 600; font-size: 0.93rem; }
  .ios-list-sub { font-size: 0.75rem; color: var(--muted); margin-top: 0.08rem; }
  .ios-list-chevron { color: var(--muted); font-size: 1rem; opacity: 0.4; }

  /* ── Misc refinements ── */
  /* Round inputs more */
  .input-field  { border-radius: 12px !important; }
  .model-select { border-radius: 12px !important; }

  /* Model/API key setup card */
  #apiKeySetup {
    background: var(--surface);
    border-radius: 16px;
    padding: 1.25rem;
    border: 1px solid var(--border);
    margin-bottom: 2rem !important;
  }
  .api-label {
    font-size: 0.7rem !important; font-weight: 700;
    letter-spacing: 0.06em; text-transform: uppercase;
  }

  /* Agent / topic card border radius */
  .topic-card  { border-radius: 16px !important; }
  .level-card  { border-radius: 16px !important; }
  /* agent-card is already 20px, avatar 17px — no override needed */

  /* ── SKELETON LOADING ── */
  @keyframes skeleton-shimmer {
    0%   { background-position: -500px 0; }
    100% { background-position: 500px 0; }
  }
  .skeleton {
    background: linear-gradient(90deg, var(--surface2) 25%, rgba(255,255,255,0.07) 50%, var(--surface2) 75%);
    background-size: 1000px 100%;
    animation: skeleton-shimmer 1.5s infinite linear;
    border-radius: 8px; display: block;
  }
  [data-theme="light"] .skeleton {
    background: linear-gradient(90deg, #e8e0c8 25%, #f5f0de 50%, #e8e0c8 75%);
    background-size: 1000px 100%;
    animation: skeleton-shimmer 1.5s infinite linear;
  }
  .skeleton-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 1.4rem;
  }
  .skeleton-avatar { width: 62px; height: 62px; border-radius: 17px; margin-bottom: 1rem; }
  .skeleton-line { height: 13px; margin-bottom: 9px; }
  .skeleton-line.w40 { width: 40%; }
  .skeleton-line.w65 { width: 65%; }
  .skeleton-line.w90 { width: 90%; }
  .skeleton-line.w100 { width: 100%; }
  .skeleton-chips { display: flex; gap: 0.4rem; margin-top: 0.75rem; }
  .skeleton-chip { height: 26px; width: 90px; border-radius: 8px; }

  /* ── GENERATING STATE ── */
  .generating-overlay {
    display: flex; flex-direction: column; align-items: center;
    padding: 3rem 2rem; gap: 1.25rem;
  }
  .generating-spinner {
    width: 52px; height: 52px; border-radius: 50%;
    border: 3px solid var(--border); border-top-color: var(--accent);
    animation: spin 0.85s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .generating-label { font-size: 1.05rem; font-weight: 800; color: var(--text); letter-spacing: -0.02em; }
  .generating-steps {
    display: flex; flex-direction: column; gap: 0.5rem;
    width: 100%; max-width: 300px; margin-top: 0.25rem;
  }
  .gen-step {
    display: flex; align-items: center; gap: 0.75rem;
    font-size: 0.82rem; color: var(--muted); transition: color 0.3s;
  }
  .gen-step.active { color: var(--accent); font-weight: 700; }
  .gen-step.done { color: var(--success); }
  .gen-step-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--border); flex-shrink: 0; transition: background 0.3s, box-shadow 0.3s;
  }
  .gen-step.active .gen-step-dot { background: var(--accent); animation: gen-pulse 1.2s ease-in-out infinite; }
  .gen-step.done .gen-step-dot { background: var(--success); }
  @keyframes gen-pulse {
    0%,100% { box-shadow: 0 0 4px rgba(242,185,13,0.4); }
    50%      { box-shadow: 0 0 14px rgba(242,185,13,0.85); }
  }

  /* ── EMPTY STATE ── */
  .empty-state {
    display: flex; flex-direction: column; align-items: center;
    padding: 5rem 2rem; text-align: center; gap: 0.75rem;
  }
  .empty-state-icon { font-size: 3.5rem; opacity: 0.5; animation: float 3s ease-in-out infinite; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
  .empty-state-title { font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em; }
  .empty-state-sub { font-size: 0.875rem; color: var(--muted); line-height: 1.6; max-width: 260px; }

  /* ── FLOATING ACTION BUTTON ── */
  .results-fab {
    position: fixed;
    bottom: calc(80px + env(safe-area-inset-bottom, 0px) + 16px);
    right: 20px;
    z-index: 100;
    display: none !important;
    opacity: 0;
    pointer-events: none;
    transform: scale(0.7);
    transition: opacity 0.28s cubic-bezier(0.34,1.56,0.64,1),
                transform 0.28s cubic-bezier(0.34,1.56,0.64,1);
  }
  .results-fab.fab-visible {
    display: flex !important;
    opacity: 1;
    pointer-events: all;
    transform: scale(1);
  }
  @media (min-width: 769px) {
    .results-fab { display: none !important; }
  }
  .results-fab-btn {
    width: 58px; height: 58px; border-radius: 50%;
    background: #f2b90d; border: none; color: #1a170d;
    font-size: 1.5rem; cursor: pointer;
    box-shadow: 0 6px 28px rgba(242,185,13,0.5), 0 2px 8px rgba(0,0,0,0.35);
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.22s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .results-fab-btn:active { transform: scale(0.88); }

  /* ── COLLAPSIBLE API SETUP ── */
  .api-setup-toggle {
    display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; padding: 0.9rem 1.1rem; border-radius: 14px;
    background: var(--surface); border: 1px solid var(--border);
    max-width: 480px; margin: 0 auto 0.75rem;
    transition: border-color 0.2s, background 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .api-setup-toggle:hover { border-color: rgba(242,185,13,0.4); background: rgba(242,185,13,0.03); }
  .api-setup-toggle:active { transform: scale(0.98); }
  .api-setup-toggle-left { display: flex; align-items: center; gap: 0.75rem; font-weight: 700; font-size: 0.9rem; }
  .api-key-dot {
    width: 9px; height: 9px; border-radius: 50%; background: var(--border);
    transition: background 0.3s, box-shadow 0.3s; flex-shrink: 0;
  }
  .api-key-dot.ready { background: var(--success); box-shadow: 0 0 8px rgba(124,196,42,0.6); }
  .api-key-dot.error { background: var(--accent2); }
  .api-setup-chevron { font-size: 0.8rem; color: var(--muted); transition: transform 0.28s cubic-bezier(0.34,1.56,0.64,1); }
  .api-setup-chevron.open { transform: rotate(180deg); }
  .api-setup-body {
    max-width: 480px; margin: 0 auto;
    overflow: hidden; max-height: 0;
    transition: max-height 0.38s cubic-bezier(0.4,0,0.2,1), opacity 0.3s;
    opacity: 0;
  }
  .api-setup-body.open { max-height: 700px; opacity: 1; }
  .api-setup-body-inner { padding-bottom: 1.5rem; }

  /* ── RESULTS: agents first, actions secondary ── */
  .results-actions-secondary {
    margin-top: 2.5rem; padding-top: 2rem; border-top: 1px solid var(--border);
  }

  /* Chat messages scroll */
  .chat-messages { -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .chat-messages::-webkit-scrollbar { display: none; }

  /* Chat header flush */
  .chat-header {
    border-radius: 0 !important;
    border-left: none !important;
    border-right: none !important;
    border-top: none !important;
  }

  /* Refine panel */
  .refine-history { scrollbar-width: none; }
  .refine-history::-webkit-scrollbar { display: none; }


  /* ═══════════════════════════════════════════════════════
     POLISH v4 — Typography · Chat Bubbles · Spacing · 
     Focus · Toast · Micro-transitions
     ═══════════════════════════════════════════════════════ */

  /* ── 1. TYPOGRAPHY: Space Mono only for code/data ── */
  .or-divider          { font-family: 'Manrope', sans-serif !important; font-weight: 600; opacity: 0.6; }
  .filter-btn          { font-family: 'Manrope', sans-serif !important; font-size: 0.8rem !important; font-weight: 600; }
  .btn-projects-header { font-family: 'Manrope', sans-serif !important; font-size: 0.8rem !important; font-weight: 600; }
  .level-section-label { font-family: 'Manrope', sans-serif !important; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.1em; }
  .level-card .level-agents {
    font-family: 'Manrope', sans-serif !important;
    font-size: 0.73rem !important;
    font-weight: 700;
    letter-spacing: 0;
  }
  .level-card .level-tagline { font-size: 0.73rem !important; }
  .opt-label           { font-family: 'Manrope', sans-serif !important; font-weight: 700; }
  .agent-type-badge    { font-family: 'Manrope', sans-serif !important; font-weight: 700; font-size: 0.7rem !important; }
  .sidebar-card h3     { font-family: 'Manrope', sans-serif !important; font-weight: 700; font-size: 0.72rem; letter-spacing: 0.1em; }
  .project-card-date   { font-family: 'Manrope', sans-serif !important; font-size: 0.73rem !important; }
  .project-card-tag    { font-family: 'Manrope', sans-serif !important; font-weight: 700; }
  .save-indicator      { font-family: 'Manrope', sans-serif !important; }
  .modal-title         { font-family: 'Manrope', sans-serif !important; font-weight: 700; font-size: 1rem !important; letter-spacing: -0.01em; color: var(--text) !important; }
  .version-panel-header h3,
  .trace-panel-header h3  { font-family: 'Manrope', sans-serif !important; font-size: 0.73rem; font-weight: 700; letter-spacing: 0.08em; }
  .section-header-bar  { font-family: 'Manrope', sans-serif !important; font-weight: 700; }
  .scoring-header h3   { font-family: 'Manrope', sans-serif !important; font-weight: 700; }
  .agent-section-header { font-family: 'Manrope', sans-serif !important; font-weight: 800; font-size: 0.8rem !important; letter-spacing: 0.06em; }
  .topic-card .agents-preview { font-family: 'Manrope', sans-serif !important; font-size: 0.73rem !important; font-weight: 600; }
  .topic-card .time-badge     { font-family: 'Manrope', sans-serif !important; font-size: 0.65rem !important; font-weight: 700; border-radius: 6px; }
  #headerModelBadge    { font-family: 'Manrope', sans-serif !important; font-weight: 700 !important; font-size: 0.7rem !important; }
  .share-meta          { font-family: 'Manrope', sans-serif !important; }
  /* Actions section label */
  .results-actions-secondary h3 { font-family: 'Manrope', sans-serif !important; font-weight: 700 !important; font-size: 0.73rem !important; letter-spacing: 0.1em !important; }
  /* Minimum accessible font sizes — nothing under ~11px */
  .version-count-badge,
  .ios-tab-badge        { font-size: 0.69rem !important; }

  /* ── 2. CHAT BUBBLES: iMessage organic style ── */
  .msg { gap: 0; }
  .msg-sender { display: none !important; }
  .msg-bubble {
    padding: 0.72rem 1.05rem !important;
    line-height: 1.55 !important;
    font-size: 0.94rem !important;
    max-width: 80%;
  }
  .msg.ai .msg-bubble {
    border-radius: 18px 18px 18px 4px !important;
    border: none !important;
    background: var(--surface2) !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
  }
  .msg.user .msg-bubble {
    border-radius: 18px 18px 4px 18px !important;
    border: none !important;
    background: linear-gradient(145deg, #f5c830, #f2b90d) !important;
    color: #1a170d !important;
    box-shadow: 0 2px 8px rgba(242,185,13,0.3);
  }
  [data-theme="light"] .msg.ai .msg-bubble {
    background: #eee8d0 !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  /* Typing indicator matches AI bubble */
  .typing-indicator {
    border-radius: 18px 18px 18px 4px !important;
    border: none !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    padding: 0.85rem 1.1rem !important;
  }
  /* Chat option buttons — pill style */
  .option-btn {
    border-radius: 22px !important;
    padding: 0.6rem 1.15rem !important;
    font-size: 0.88rem !important;
    font-weight: 600 !important;
    font-family: 'Manrope', sans-serif !important;
  }
  /* Refine bubbles match chat style */
  .refine-msg.user .refine-bubble {
    border-radius: 14px 14px 4px 14px !important;
    border: none !important;
    background: linear-gradient(145deg, rgba(242,185,13,0.18), rgba(196,147,10,0.14)) !important;
    box-shadow: 0 1px 4px rgba(242,185,13,0.15);
  }
  .refine-msg.ai .refine-bubble {
    border-radius: 14px 14px 14px 4px !important;
    border: none !important;
    background: var(--surface2) !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }

  /* ── 3. SPACING: 8px grid rhythm ── */
  @media (max-width: 768px) {
    .hero { padding: 1.25rem 0 0.5rem !important; }
    .hero p { margin-bottom: 1.5rem !important; }
    .level-section { margin-bottom: 1.5rem !important; }
    .topic-grid { gap: 0.75rem !important; }
    main { padding: 0 1rem !important; }
  }
  .results-header   { padding: 1.75rem 0 1.25rem !important; }
  .results-actions-secondary { margin-top: 1.75rem !important; padding-top: 1.5rem !important; }

  /* ── 4. FOCUS-VISIBLE: keyboard accessibility ── */
  :focus { outline: none; }
  :focus-visible {
    outline: 2px solid #f2b90d !important;
    outline-offset: 3px !important;
    border-radius: 8px;
  }
  [data-theme="light"] :focus-visible { outline-color: #c49a0a !important; }
  .btn-primary:focus-visible,
  .btn-secondary:focus-visible,
  .ios-action-btn:focus-visible { outline-offset: 3px !important; border-radius: 12px; }
  .topic-card:focus-visible,
  .level-card:focus-visible,
  .agent-card:focus-visible,
  .project-card:focus-visible { outline-offset: 4px !important; border-radius: 20px; }
  .ios-tab-btn:focus-visible { border-radius: 10px; outline-offset: 2px !important; }
  .input-field:focus-visible,
  .model-select:focus-visible,
  .refine-textarea:focus-visible {
    outline: none !important;
    border-color: var(--accent) !important;
    box-shadow: 0 0 0 3px rgba(242,185,13,0.18) !important;
  }

  /* ── 5. TOAST: spring slide-in from bottom ── */
  @keyframes toast-in {
    0%   { transform: translateY(100%) scale(0.88); opacity: 0; }
    60%  { transform: translateY(-6px) scale(1.02); opacity: 1; }
    100% { transform: translateY(0) scale(1); opacity: 1; }
  }
  @keyframes toast-out {
    0%   { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(80%) scale(0.9); opacity: 0; }
  }
  /* Override existing notif style */
  #notif-container > div,
  .notif-toast {
    animation: toast-in 0.42s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important;
    border-radius: 14px !important;
    font-family: 'Manrope', sans-serif !important;
    font-weight: 700 !important;
    font-size: 0.9rem !important;
    padding: 0.85rem 1.3rem !important;
    backdrop-filter: blur(16px) saturate(1.8) !important;
    -webkit-backdrop-filter: blur(16px) saturate(1.8) !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.06) !important;
    letter-spacing: -0.01em;
  }
  #notif-container > div.hiding,
  .notif-toast.fade-out {
    animation: toast-out 0.26s ease forwards !important;
  }

  /* ── 6. MICRO-TRANSITIONS ── */
  /* API setup smooth open/close with transform */
  .api-setup-body {
    transition:
      max-height 0.38s cubic-bezier(0.4, 0, 0.2, 1),
      opacity    0.26s ease,
      transform  0.3s cubic-bezier(0.34, 1.3, 0.64, 1) !important;
    transform-origin: top center;
  }
  .api-setup-body:not(.open) { transform: scaleY(0.96) translateY(-4px); }
  .api-setup-body.open       { transform: scaleY(1) translateY(0); }

  /* Project card: consistent min height */
  .project-card { min-height: 130px; }

  /* Version panel / trace panel smooth toggle */
  .version-timeline, .trace-body {
    transition: opacity 0.2s ease;
  }

  /* Smooth color transitions for theme switch */
  body, header, .sidebar-card, .agent-card, .topic-card, .level-card,
  .project-card, .modal, .share-modal, .fw-modal, .ios-sheet,
  .ios-nav-bar, #ios-tab-bar {
    transition:
      background-color 0.22s ease,
      border-color     0.22s ease,
      color            0.22s ease !important;
  }

  /* Chat message pop-in: spring instead of simple fade */
  @keyframes msg-spring-in {
    0%   { opacity: 0; transform: scale(0.88) translateY(8px); }
    65%  { opacity: 1; transform: scale(1.02) translateY(-2px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }
  .msg { animation: msg-spring-in 0.32s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important; }
  @keyframes msgIn {
    from { opacity: 0; transform: scale(0.9) translateY(10px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }

  /* Agent card just-added / just-updated glow */
  .agent-card.just-added {
    animation: card-added 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .agent-card.just-updated {
    animation: card-updated 0.5s ease;
  }
  @keyframes card-added {
    0%   { box-shadow: 0 0 0 4px rgba(124,196,42,0); transform: scale(0.95); }
    50%  { box-shadow: 0 0 0 4px rgba(124,196,42,0.5); transform: scale(1.02); }
    100% { box-shadow: 0 0 0 0 rgba(124,196,42,0); transform: scale(1); }
  }
  @keyframes card-updated {
    0%   { box-shadow: 0 0 0 4px rgba(242,185,13,0); }
    50%  { box-shadow: 0 0 0 4px rgba(242,185,13,0.4); }
    100% { box-shadow: 0 0 0 0 rgba(242,185,13,0); }
  }

  /* ═══════════════════════════════════════════════════
     v6 POLISH — Burger drawer · Sticky bar · Swipe ·
     Back-to-top · Accordion · Segmented home nav
     ═══════════════════════════════════════════════════ */

  /* ── DESKTOP BURGER DRAWER (769px–1200px) ──────────── */
  #burger-btn {
    display: none;
    background: none;
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    width: 40px; height: 40px;
    cursor: pointer;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: border-color 0.2s, background 0.2s;
    flex-shrink: 0;
    -webkit-tap-highlight-color: transparent;
  }
  #burger-btn:hover { border-color: var(--accent); background: rgba(242,185,13,0.07); }
  #burger-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 3px; border-radius: 10px; }
  .burger-bar {
    width: 18px; height: 2px;
    background: var(--text);
    border-radius: 2px;
    transition: transform 0.28s cubic-bezier(0.34,1.56,0.64,1), opacity 0.2s;
    transform-origin: center;
  }
  #burger-btn.open .burger-bar:nth-child(1) { transform: translateY(7px) rotate(45deg); }
  #burger-btn.open .burger-bar:nth-child(2) { opacity: 0; transform: scaleX(0); }
  #burger-btn.open .burger-bar:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }
  @media (min-width: 769px) and (max-width: 1200px) {
    #burger-btn { display: flex; }
  }
  /* Also show on large desktop for convenience */
  @media (min-width: 1201px) {
    #burger-btn { display: flex; }
  }
  /* Never on mobile - iOS tab bar handles that */
  @media (max-width: 768px) {
    #burger-btn { display: none !important; }
  }

  /* Drawer overlay */
  #nav-drawer-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 299;
    opacity: 0;
    transition: opacity 0.28s ease;
  }
  #nav-drawer-overlay.open { display: block; opacity: 1; }

  /* Drawer panel */
  #nav-drawer {
    position: fixed;
    top: 0; right: 0;
    width: min(320px, 85vw);
    height: 100%;
    background: var(--surface);
    border-left: 1px solid var(--border);
    z-index: 300;
    transform: translateX(105%);
    transition: transform 0.36s cubic-bezier(0.34,1.2,0.64,1);
    display: flex;
    flex-direction: column;
    box-shadow: -20px 0 60px rgba(0,0,0,0.4);
    padding-top: env(safe-area-inset-top, 0px);
  }
  #nav-drawer.open { transform: translateX(0); }

  .drawer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.4rem 1.5rem 1rem;
    border-bottom: 1px solid var(--border);
  }
  .drawer-logo { font-weight: 800; font-size: 1.1rem; color: var(--accent); letter-spacing: -0.03em; }
  .drawer-close {
    background: none; border: 1px solid var(--border);
    color: var(--muted); width: 34px; height: 34px;
    border-radius: 8px; cursor: pointer; font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .drawer-close:hover { border-color: var(--accent); color: var(--accent); }

  .drawer-nav { flex: 1; overflow-y: auto; padding: 1rem 0.75rem; }
  .drawer-nav-item {
    display: flex; align-items: center; gap: 0.9rem;
    padding: 0.85rem 0.9rem;
    border-radius: 12px;
    cursor: pointer;
    color: var(--text);
    font-size: 0.95rem;
    font-weight: 600;
    transition: background 0.15s, color 0.15s;
    -webkit-tap-highlight-color: transparent;
    border: none; background: none; width: 100%; text-align: left;
  }
  .drawer-nav-item:hover { background: rgba(242,185,13,0.08); color: var(--accent); }
  .drawer-nav-item.active { background: rgba(242,185,13,0.12); color: var(--accent); }
  .drawer-nav-item .dnav-icon { font-size: 1.25rem; width: 28px; text-align: center; flex-shrink: 0; }
  .drawer-nav-item .dnav-label { flex: 1; }
  .drawer-nav-item .dnav-badge {
    background: var(--accent2); color: #fff;
    font-size: 0.62rem; font-weight: 800;
    padding: 0.1rem 0.45rem; border-radius: 10px;
    min-width: 18px; text-align: center;
  }

  .drawer-section-label {
    font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--muted);
    padding: 0.75rem 0.9rem 0.3rem;
    opacity: 0.6;
  }
  .drawer-divider { height: 1px; background: var(--border); margin: 0.5rem 0.75rem; opacity: 0.5; }

  .drawer-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex; gap: 0.75rem; align-items: center;
  }

  /* ── STICKY CONTEXT BAR (mobile) ─────────────────── */
  #sticky-context-bar {
    display: none;
  }
  @media (max-width: 768px) {
    #sticky-context-bar {
      display: flex;
      position: fixed;
      bottom: calc(64px + env(safe-area-inset-bottom, 0px));
      left: 0; right: 0;
      background: rgba(26,23,13,0.95);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 0.5px solid rgba(255,255,255,0.07);
      padding: 0.6rem 1rem;
      gap: 0.5rem;
      z-index: 190;
      transform: translateY(100%);
      transition: transform 0.38s cubic-bezier(0.34,1.2,0.64,1);
    }
    #sticky-context-bar.visible { transform: translateY(0); }
    [data-theme="light"] #sticky-context-bar {
      background: rgba(250,247,238,0.95);
      border-top-color: rgba(0,0,0,0.08);
    }
    .ctx-btn {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-family: 'Manrope', sans-serif;
      font-size: 0.8rem;
      font-weight: 700;
      padding: 0.65rem 0.5rem;
      min-height: 44px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      gap: 0.35rem;
      transition: all 0.18s cubic-bezier(0.34,1.56,0.64,1);
      -webkit-tap-highlight-color: transparent;
    }
    .ctx-btn:active { transform: scale(0.92); }
    .ctx-btn.primary {
      background: #f2b90d;
      color: #1a170d;
      border-color: transparent;
      box-shadow: 0 4px 16px rgba(242,185,13,0.4);
    }
    .ctx-btn.primary:hover { background: #f5c830; }
  }

  /* ── BACK TO TOP BUTTON ───────────────────────────── */
  #back-to-top {
    position: fixed;
    bottom: calc(80px + env(safe-area-inset-bottom, 0px) + 16px);
    left: 20px;
    width: 44px; height: 44px;
    border-radius: 50%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: 1.1rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    z-index: 99;
    opacity: 0;
    pointer-events: none;
    transform: translateY(8px) scale(0.88);
    transition: opacity 0.28s ease, transform 0.32s cubic-bezier(0.34,1.56,0.64,1),
                border-color 0.18s, background 0.18s;
    -webkit-tap-highlight-color: transparent;
  }
  #back-to-top.visible {
    opacity: 1;
    pointer-events: all;
    transform: translateY(0) scale(1);
  }
  #back-to-top:hover { border-color: var(--accent); color: var(--accent); background: rgba(242,185,13,0.08); }
  #back-to-top:active { transform: scale(0.88); }
  @media (min-width: 769px) {
    #back-to-top { bottom: 2rem; left: auto; right: 6rem; }
  }

  /* ── HOME SEGMENTED NAV (topic screen top) ─────────── */
  .home-seg-nav {
    display: flex;
    max-width: 480px;
    margin: 0 auto 1.75rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 4px;
    gap: 2px;
  }
  .home-seg-btn {
    flex: 1;
    background: none;
    border: none;
    border-radius: 10px;
    padding: 0.6rem 0.5rem;
    font-family: 'Manrope', sans-serif;
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--muted);
    cursor: pointer;
    transition: background 0.22s cubic-bezier(0.34,1.56,0.64,1), color 0.18s;
    -webkit-tap-highlight-color: transparent;
    white-space: nowrap;
  }
  .home-seg-btn.active {
    background: rgba(242,185,13,0.14);
    color: var(--accent);
    box-shadow: inset 0 0 0 1px rgba(242,185,13,0.3);
  }
  /* Panels behind segmented nav */
  .home-panel { display: none; }
  .home-panel.active { display: block; }

  /* ── ACCORDION INSTRUCTIONS ───────────────────────── */
  .accordion-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    margin-bottom: 0.6rem;
    transition: border-color 0.2s;
  }
  .accordion-item.open { border-color: rgba(242,185,13,0.3); }
  .accordion-header {
    display: flex; align-items: center;
    padding: 1rem 1.25rem;
    cursor: pointer;
    gap: 0.85rem;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }
  .accordion-num {
    width: 28px; height: 28px;
    border-radius: 8px;
    background: rgba(242,185,13,0.12);
    border: 1px solid rgba(242,185,13,0.25);
    color: var(--accent);
    font-size: 0.75rem;
    font-weight: 800;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .accordion-item.open .accordion-num { background: var(--accent); color: #1a170d; }
  .accordion-title { flex: 1; font-weight: 700; font-size: 0.95rem; }
  .accordion-chevron {
    color: var(--muted); font-size: 0.8rem;
    transition: transform 0.28s cubic-bezier(0.34,1.56,0.64,1);
  }
  .accordion-item.open .accordion-chevron { transform: rotate(180deg); color: var(--accent); }
  .accordion-body {
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.38s cubic-bezier(0.4,0,0.2,1),
                opacity 0.28s ease;
    opacity: 0;
  }
  .accordion-item.open .accordion-body { max-height: 400px; opacity: 1; }
  .accordion-content {
    padding: 0 1.25rem 1.1rem 3.9rem;
    font-size: 0.88rem;
    color: var(--muted);
    line-height: 1.7;
  }
  .accordion-content code { font-family: 'Space Mono', monospace; font-size: 0.82em; }

  /* ── SWIPE ACTIONS ON PROJECT CARDS ──────────────── */
  @media (max-width: 768px) {
    #projects-list {
      grid-template-columns: 1fr !important;
    }
    .project-card-wrap {
      position: relative;
      overflow: hidden;
      border-radius: 18px;
      touch-action: pan-y;
    }
    .project-card {
      transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
      position: relative;
      z-index: 1;
    }
    .project-swipe-actions {
      position: absolute;
      top: 0; right: 0; bottom: 0;
      display: flex;
      align-items: stretch;
      border-radius: 0 18px 18px 0;
      overflow: hidden;
    }
    .swipe-action-btn {
      width: 72px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 0.3rem;
      font-size: 1.2rem;
      font-family: 'Manrope', sans-serif;
      font-size: 0.65rem;
      font-weight: 700;
      cursor: pointer;
      border: none;
      color: #fff;
    }
    .swipe-action-btn.open-btn  { background: var(--accent); color: #1a170d; }
    .swipe-action-btn.fork-btn  { background: #555; }
    .swipe-action-btn.del-btn   { background: var(--accent2); }
    .swipe-action-btn .sa-icon { font-size: 1.25rem; }
  }

  /* ── SMOOTH SCROLL GLOBAL ─────────────────────────── */
  html { scroll-behavior: smooth; }
  .chat-messages { scroll-behavior: smooth !important; }


  /* ── SW / Console Messages as bottom sheet ── */
  .pwa-bottom-sheet {
    left: 0 !important;
    right: 0 !important;
    bottom: calc(56px + env(safe-area-inset-bottom, 0px)) !important;
    transform: none !important;
    border-radius: 20px 20px 0 0 !important;
    border-left: none !important;
    border-right: none !important;
    border-bottom: none !important;
    border-top: 1px solid rgba(242,185,13,0.3) !important;
    padding: 1rem 1.5rem 1.25rem !important;
    white-space: normal !important;
    flex-direction: column !important;
    gap: 0.75rem !important;
    animation: sheet-slide-up 0.44s cubic-bezier(0.34,1.2,0.64,1) forwards !important;
  }
  @keyframes sheet-slide-up {
    from { transform: translateY(100%); opacity: 0.6; }
    to   { transform: translateY(0);   opacity: 1; }
  }
  .pwa-bottom-sheet::before {
    content: '';
    display: block;
    width: 36px; height: 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 2px;
    margin: 0 auto 0.5rem;
    flex-shrink: 0;
  }
  .pwa-bottom-sheet-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    width: 100%;
  }
  @media (min-width: 769px) {
    .pwa-bottom-sheet {
      left: 50% !important;
      right: auto !important;
      max-width: 420px !important;
      transform: translateX(-50%) !important;
      border-radius: 20px !important;
      border: 1px solid rgba(242,185,13,0.4) !important;
      bottom: 2rem !important;
      animation: notif-spring-in 0.42s cubic-bezier(0.34,1.56,0.64,1) forwards !important;
    }
    .pwa-bottom-sheet::before { display: none; }
  }


  /* ── SW / Warning corner toasts ── */
  .sw-toast {
    position: fixed;
    bottom: calc(64px + env(safe-area-inset-bottom, 0px) + 12px);
    right: 1rem;
    max-width: 280px;
    background: rgba(20,17,8,0.96);
    backdrop-filter: blur(20px) saturate(1.8);
    -webkit-backdrop-filter: blur(20px) saturate(1.8);
    border: 0.5px solid rgba(224,90,26,0.4);
    border-radius: 12px;
    padding: 0.7rem 1rem;
    font-family: 'Manrope', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--accent2);
    z-index: 215;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    animation: notif-spring-in-desktop 0.38s cubic-bezier(0.34,1.56,0.64,1) forwards;
    display: flex;
    align-items: flex-start;
    gap: 0.6rem;
    line-height: 1.45;
  }
  .sw-toast .sw-toast-icon { font-size: 1rem; flex-shrink: 0; margin-top: 0.05rem; }
  .sw-toast .sw-toast-close {
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-size: 0.85rem; padding: 0;
    margin-left: auto; flex-shrink: 0; line-height: 1;
  }
  .sw-toast .sw-toast-close:hover { color: var(--text); }
  @media (max-width: 768px) {
    .sw-toast {
      right: auto;
      left: 1rem;
      max-width: calc(100vw - 2rem);
    }
  }


  /* ── Bottom nav hide on scroll down (mobile) ── */
  #ios-tab-bar {
    transition: transform 0.32s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.2s ease !important;
  }
  #ios-tab-bar.hidden-by-scroll {
    transform: translateY(100%);
    box-shadow: none !important;
  }
  /* Context bar follows tab bar */
  #sticky-context-bar {
    transition: transform 0.32s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.28s ease !important;
  }
  #sticky-context-bar.tab-hidden {
    transform: translateY(calc(64px + env(safe-area-inset-bottom, 0px)));
  }

</style>
</head>
<body>
<div class="offline-bar" id="offline-bar">📡 You're offline — AgentSpark loaded from cache</div>

<!-- ── NAV DRAWER ── -->
<div id="nav-drawer-overlay" onclick="closeDrawer()"></div>
<div id="nav-drawer" role="navigation" aria-label="Main navigation">
  <div class="drawer-header">
    <span class="drawer-logo">⚡ AgentSpark</span>
    <button class="drawer-close" onclick="closeDrawer()" aria-label="Close menu">✕</button>
  </div>
  <nav class="drawer-nav">
    <span class="drawer-section-label">Navigate</span>
    <button class="drawer-nav-item" onclick="closeDrawer();iosTabNav('home')" id="dnav-home">
      <span class="dnav-icon">🏠</span>
      <span class="dnav-label">Home / Topics</span>
    </button>
    <button class="drawer-nav-item" onclick="closeDrawer();iosTabNav('projects')" id="dnav-projects">
      <span class="dnav-icon">📁</span>
      <span class="dnav-label">My Projects</span>
      <span class="dnav-badge" id="dnav-badge" style="display:none;"></span>
    </button>
    <button class="drawer-nav-item" onclick="closeDrawer();iosTabNav('chat')" id="dnav-chat">
      <span class="dnav-icon">💬</span>
      <span class="dnav-label">Chat / Interview</span>
    </button>
    <button class="drawer-nav-item" onclick="closeDrawer();iosTabNav('results')" id="dnav-results">
      <span class="dnav-icon">⚡</span>
      <span class="dnav-label">Results / Agents</span>
    </button>
    <div class="drawer-divider"></div>
    <span class="drawer-section-label">Actions</span>
    <button class="drawer-nav-item" onclick="closeDrawer();showInstructions()">
      <span class="dnav-icon">📖</span>
      <span class="dnav-label">Instructions</span>
    </button>
    <button class="drawer-nav-item" onclick="closeDrawer();openShareModal()">
      <span class="dnav-icon">🔗</span>
      <span class="dnav-label">Share / Export</span>
    </button>
    <button class="drawer-nav-item" onclick="closeDrawer();openImportModal()">
      <span class="dnav-icon">📥</span>
      <span class="dnav-label">Import Project</span>
    </button>
    <div class="drawer-divider"></div>
    <span class="drawer-section-label">Preferences</span>
    <button class="drawer-nav-item" onclick="closeDrawer();toggleTheme()">
      <span class="dnav-icon" id="dnav-theme-icon">🌙</span>
      <span class="dnav-label">Toggle Theme</span>
    </button>
  </nav>
  <div class="drawer-footer">
    <div style="display:flex;gap:0.5rem;width:100%;">
      <button class="lang-btn" onclick="setLang('en');updateDrawerActive()" style="flex:1;padding:0.6rem;">EN</button>
      <button class="lang-btn" onclick="setLang('pl');updateDrawerActive()" style="flex:1;padding:0.6rem;">PL</button>
    </div>
  </div>
</div>


<!-- ── iOS Bottom Tab Bar ── -->
<div id="ios-tab-bar">
  <button class="ios-tab-btn active" id="tab-home" onclick="iosTabNav('home')">
    <span class="tab-icon">🏠</span>
    <span>Home</span>
  </button>
  <button class="ios-tab-btn" id="tab-projects" onclick="iosTabNav('projects')">
    <span class="tab-icon">📁</span>
    <span id="tab-projects-label">Projects</span>
    <span class="ios-tab-badge" id="tab-badge" style="display:none;"></span>
  </button>
  <button class="ios-tab-btn" id="tab-chat" onclick="iosTabNav('chat')" style="display:none;">
    <span class="tab-icon">💬</span>
    <span>Interview</span>
  </button>
  <button class="ios-tab-btn" id="tab-results" onclick="iosTabNav('results')" style="display:none;">
    <span class="tab-icon">⚡</span>
    <span>Team</span>
  </button>
  <button class="ios-tab-btn" id="tab-settings" onclick="iosTabNav('settings')">
    <span class="tab-icon">⚙️</span>
    <span>Settings</span>
  </button>
</div>

<div id="app">

  <header>
    <div class="logo">
      <div class="logo-icon">⚡</div>
      Agent<span>Spark</span>
    </div>
    <div style="display:flex;align-items:center;gap:1rem;">
      <span class="save-indicator" id="save-indicator">✓ saved</span>
      <div id="apiKeyHeader" style="display:none;align-items:center;gap:0.5rem;">
        <span id="headerModelBadge" style="font-family:'Space Mono',monospace;font-size:0.62rem;padding:0.2rem 0.55rem;border-radius:4px;background:rgba(242,185,13,0.1);border:1px solid rgba(242,185,13,0.25);color:var(--accent);white-space:nowrap;"></span>
        <input type="password" class="input-field" id="apiKeyInput" placeholder="API Key" style="width:190px;padding:0.5rem 1rem;font-size:0.82rem;" oninput="checkApiKey()"/>
        <span class="api-key-status" id="apiKeyStatus"></span>
      </div>
      <div class="lang-switch">
        <button class="lang-btn active" onclick="setLang('en')" id="btn-en">EN</button>
        <button class="lang-btn" onclick="setLang('pl')" id="btn-pl">PL</button>
      </div>
      <button id="burger-btn" onclick="toggleDrawer()" aria-label="Menu" aria-expanded="false" aria-controls="nav-drawer">
        <span class="burger-bar"></span>
        <span class="burger-bar"></span>
        <span class="burger-bar"></span>
      </button>
      <button class="theme-toggle" id="theme-toggle-btn"
        onmousedown="_themeHoldStart()" ontouchstart="_themeHoldStart()"
        onmouseup="toggleTheme()" ontouchend="toggleTheme()"
        onmouseleave="if(_themeHoldTimer){clearTimeout(_themeHoldTimer);_themeHoldTimer=null;}"
        title="Click: toggle theme | Hold: follow OS">🌙</button>
    </div>
  </header>

  <main>

    <!-- SCREEN 0: MY PROJECTS -->
    <div class="screen" id="screen-projects">
      <!-- iOS Nav Bar -->
      <div class="ios-screen-header">
        <div class="ios-nav-bar">
          <button class="ios-nav-back" onclick="iosTabNav('home')"></button>
          <span class="ios-nav-title">My Projects</span>
          <button class="ios-nav-action" onclick="showScreen('topic')">+ New</button>
        </div>
      </div>
      <!-- No hero — compact header via iOS nav bar above -->
      <div style="max-width:900px;margin:1.5rem auto 0;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;gap:1rem;flex-wrap:wrap;">
          <div class="ios-search" style="flex:1;max-width:320px;">
            <span class="ios-search-icon">🔍</span>
            <input id="projects-search" type="text" placeholder="Search projects…" oninput="renderProjectsList()"/>
          </div>
          <button class="btn-primary" onclick="showScreen('topic')" style="flex-shrink:0;">+ New Project</button>
        </div>
        <div id="projects-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1.25rem;"></div>
        <div id="projects-empty" style="display:none;">
          <div class="empty-state">
            <div class="empty-state-icon">📂</div>
            <div class="empty-state-title">No projects yet</div>
            <div class="empty-state-sub">Build your first AI team and it will appear here automatically.</div>
            <button class="btn-primary" onclick="showScreen('topic')" style="margin-top:0.5rem;">+ Start a project</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCREEN 1: TOPIC SELECTION -->
    <div class="screen active" id="screen-topic">
      <div class="hero">
        <div class="hero-badge" id="badge-text">AI AGENT TEAM GENERATOR</div>
        <h1 id="hero-title">Build Your<br/>AI Dream Team</h1>
        <p id="hero-sub">Choose a topic. Answer a few questions. Get a complete AI agent team — ready to build your app with Google Antigravity.</p>

        <div id="apiKeySetup" style="margin-bottom:2rem;">
          <!-- Collapsible toggle row -->
          <div class="api-setup-toggle" onclick="toggleApiSetup()" id="api-setup-toggle">
            <div class="api-setup-toggle-left">
              <span class="api-key-dot" id="api-key-dot"></span>
              <span id="api-setup-toggle-label">AI Model & API Key</span>
            </div>
            <span class="api-setup-chevron" id="api-setup-chevron">▾</span>
          </div>
          <!-- Collapsible body -->
          <div class="api-setup-body" id="api-setup-body">
            <div class="api-setup-body-inner" id="api-setup-inner-old">
              <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1.1rem;max-width:480px;margin:0 auto;">
          <div class="model-select-wrap">
            <label class="api-label">AI Model</label>
            <select class="model-select" id="modelSelect" onchange="onModelChange()">
              <optgroup label="── Google Gemini ──">
                <option value="gemini|gemini-3.1-pro|https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}|gemini">Gemini 3.1 Pro</option>
                <option value="gemini|gemini-3-flash|https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}|gemini">Gemini 3 Flash</option>
                <option value="gemini|gemini-2.5-pro|https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}|gemini">Gemini 2.5 Pro</option>
                <option value="gemini|gemini-3-flash-preview|https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}|gemini" selected>Gemini 3 Flash Preview</option>
              </optgroup>
              <optgroup label="── OpenAI GPT ──">
                <option value="openai|gpt-5.2|https://api.openai.com/v1/chat/completions|openai">GPT-5.2</option>
                <option value="openai|gpt-5.1|https://api.openai.com/v1/chat/completions|openai">GPT-5.1</option>
                <option value="openai|gpt-5|https://api.openai.com/v1/chat/completions|openai">GPT-5</option>
                <option value="openai|gpt-5-mini|https://api.openai.com/v1/chat/completions|openai">GPT-5 mini</option>
                <option value="openai|gpt-5-nano|https://api.openai.com/v1/chat/completions|openai">GPT-5 nano</option>
              </optgroup>
              <optgroup label="── Anthropic Claude ──">
                <option value="anthropic|claude-opus-4-6|https://api.anthropic.com/v1/messages|anthropic">Claude Opus 4.6</option>
                <option value="anthropic|claude-opus-4-5|https://api.anthropic.com/v1/messages|anthropic">Claude Opus 4.5</option>
                <option value="anthropic|claude-sonnet-4-5|https://api.anthropic.com/v1/messages|anthropic">Claude Sonnet 4.5</option>
                <option value="anthropic|claude-haiku-4-5-20251001|https://api.anthropic.com/v1/messages|anthropic">Claude Haiku 4.5</option>
              </optgroup>
              <optgroup label="── Mistral ──">
                <option value="openai|mistral-large-latest|https://api.mistral.ai/v1/chat/completions|mistral">Mistral Large 3</option>
                <option value="openai|ministral-14b-latest|https://api.mistral.ai/v1/chat/completions|mistral">Ministral 14B</option>
                <option value="openai|ministral-8b-latest|https://api.mistral.ai/v1/chat/completions|mistral">Ministral 8B</option>
                <option value="openai|ministral-3b-latest|https://api.mistral.ai/v1/chat/completions|mistral">Ministral 3B</option>
              </optgroup>
              <optgroup label="── Groq ──">
                <option value="openai|llama-3.3-70b-versatile|https://api.groq.com/openai/v1/chat/completions|groq">Llama 3.3 70B</option>
                <option value="openai|llama-3.1-8b-instant|https://api.groq.com/openai/v1/chat/completions|groq">Llama 3.1 8B</option>
              </optgroup>
</select>
            <div class="model-hint" id="modelHint">Key: Google AI Studio → <strong>makersuite.google.com</strong></div>
          </div>
          <label class="api-label"><span id="apiKeyLabel">Gemini API Key</span> <span style="color:var(--muted);font-size:0.7rem;">(required)</span></label>
          <div class="api-key-area">
            <input type="password" class="input-field" id="apiKeySetupInput" placeholder="AIza..." oninput="syncApiKey(this.value)"/>
          </div>
          <div class="api-key-status" id="apiKeySetupStatus"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Home segmented nav -->
        <div class="home-seg-nav" role="tablist" aria-label="Home sections">
          <button class="home-seg-btn active" id="hseg-topics" role="tab" aria-selected="true" onclick="switchHomePanel('topics')">🔥 Topics</button>
          <button class="home-seg-btn" id="hseg-custom" role="tab" aria-selected="false" onclick="switchHomePanel('custom')">✏️ Custom</button>
        </div>

        <!-- Panel: Topics -->
        <div class="home-panel active" id="hpanel-topics">
          <div class="level-section">
            <span class="level-section-label" id="level-section-label">COMPLEXITY LEVEL</span>
            <div class="level-grid" id="level-grid"></div>
          </div>
          <div class="template-filters" id="template-filters"></div>
          <div class="topic-grid" id="topic-grid"></div>
        </div>

        <!-- Panel: Projects (mini) -->
        <div class="home-panel" id="hpanel-projects">
          <div style="max-width:900px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;gap:1rem;flex-wrap:wrap;">
              <div class="ios-search" style="flex:1;max-width:320px;">
                <span class="ios-search-icon">🔍</span>
                <input id="home-projects-search" type="text" placeholder="Search projects…" oninput="renderHomeProjectsList()"/>
              </div>
              <button class="btn-primary" onclick="switchHomePanel('topics')">+ New →</button>
            </div>
            <div id="home-projects-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;"></div>
            <div id="home-projects-empty" style="display:none;">
              <div class="empty-state" style="padding:3rem 2rem;">
                <div class="empty-state-icon">📂</div>
                <div class="empty-state-title">No projects yet</div>
                <div class="empty-state-sub">Start a project and it will appear here.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel: Custom -->
        <div class="home-panel" id="hpanel-custom">
          <div style="max-width:560px;margin:0 auto;padding:1rem 0 2rem;">
            <div class="or-divider" id="or-text" style="margin-bottom:1.5rem;">Describe your project</div>
            <div class="custom-topic">
              <input type="text" class="input-field" id="customTopic" placeholder="e.g. AI-powered recipe recommender..."/>
              <button class="btn-primary" onclick="startWithTopic()" id="start-btn">Start →</button>
            </div>
            <div style="text-align:center;margin-top:1.5rem;">
              <button class="btn-secondary" onclick="openImportModal()" style="font-size:0.82rem;padding:0.55rem 1.25rem;">
                📥 Import existing project (.json / .zip)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SCREEN 2: CHAT INTERVIEW -->
    <div class="screen" id="screen-chat">
      <!-- iOS Nav Bar -->
      <div class="ios-screen-header">
        <div class="ios-nav-bar">
          <button class="ios-nav-back" onclick="restart()">Cancel</button>
          <span class="ios-nav-title" id="ios-chat-nav-title">AI Interview</span>
          <span class="ios-nav-action" id="ios-chat-step-label" style="color:var(--muted);font-size:0.8rem;"></span>
        </div>
        <!-- iOS Progress bar -->
        <div class="ios-progress-bar-wrap" id="ios-progress-bar" style="padding: 0 1.25rem 0.6rem;"></div>
      </div>
      <div class="chat-layout">
        <div class="chat-main">
          <div class="chat-header">
            <div class="status-dot"></div>
            <div>
              <div class="title" id="chat-title">AI Interview</div>
              <div class="subtitle" id="chat-subtitle">Building your agent profile...</div>
            </div>
            <button class="sidebar-toggle-btn" onclick="toggleChatSidebar()" id="sidebar-toggle-btn" title="Toggle sidebar">▶</button>
          </div>
          <div class="chat-messages" id="chat-messages"></div>
          <div id="options-container" style="display:none;"></div>
          <!-- Fixed question + choices panel -->
          <div class="question-panel" id="question-panel" style="display:none;">
            <div class="question-panel-text" id="question-panel-text"></div>
            <div class="question-panel-choices" id="question-panel-choices"></div>
          </div>
        </div>
        <div class="chat-sidebar">
          <div class="sidebar-card">
            <h3>PROGRESS</h3>
            <div class="progress-steps" id="progress-steps"></div>
          </div>
          <div class="sidebar-card">
            <h3>TOPIC</h3>
            <div id="sidebar-topic" style="font-size:0.9rem;font-weight:600;"></div>
            <div id="sidebar-topic-sub" style="font-size:0.75rem;color:var(--muted);margin-top:0.25rem;"></div>
          </div>
          <div class="sidebar-card">
            <h3>LEVEL</h3>
            <div id="sidebar-level" style="font-size:1.3rem;"></div>
            <div id="sidebar-level-name" style="font-size:0.9rem;font-weight:700;margin-top:0.2rem;"></div>
            <div id="sidebar-level-desc" style="font-size:0.72rem;color:var(--muted);margin-top:0.2rem;line-height:1.4;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SCREEN 3: RESULTS -->
    <div class="screen" id="screen-results">
      <!-- iOS Nav Bar -->
      <div class="ios-screen-header">
        <div class="ios-nav-bar">
          <button class="ios-nav-back" onclick="restart()">Start Over</button>
          <span class="ios-nav-title">Your Team</span>
          <button class="ios-nav-action" onclick="downloadZip()">Export</button>
        </div>
      </div>
      <!-- Shared view banner (shown when loaded via shared URL) -->
      <div id="shared-banner" class="shared-banner" style="display:none;">
        <div class="shared-banner-icon">🔗</div>
        <div class="shared-banner-text">
          <div class="shared-banner-title" id="shared-banner-title">Shared team</div>
          <div class="shared-banner-sub" id="shared-banner-sub">This is a read-only shared view. Start Over to create your own.</div>
        </div>
        <button class="shared-banner-close" onclick="document.getElementById('shared-banner').style.display='none'">✕</button>
      </div>

      <div class="results-header">
        <div class="hero-badge" id="result-badge">MISSION COMPLETE</div>
        <h2 id="result-title">Your AI Team is Ready</h2>
        <p id="result-sub" style="color:var(--muted);">Download your files and deploy to Google Antigravity</p>
      </div>

      <!-- REFINE PANEL — near top for context -->
      <div id="refine-panel" class="refine-panel" style="display:none;">
        <div class="refine-header">
          <div>
            <h3 id="refine-title">Refine Your Team</h3>
            <p id="refine-sub">Tell the AI what you want to change.</p>
          </div>
          <button class="refine-close-btn" onclick="closeRefine()">✕</button>
        </div>
        <div class="refine-action-chips" id="refine-action-chips"></div>
        <div class="refine-history" id="refine-history"></div>
        <div class="refine-input-row">
          <textarea class="refine-textarea" id="refine-input"
            placeholder="e.g. Add a Security Agent..."
            rows="2"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitRefine();}"></textarea>
          <button class="btn-primary refine-submit-btn" id="refine-submit-btn" onclick="submitRefine()">
            <span id="refine-submit-label">Apply →</span>
          </button>
        </div>
        <div class="refine-footer">
          <span id="refine-counter" style="font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;"></span>
          <button class="refine-revert-btn" id="refine-revert-btn" onclick="revertLastRefine()" style="display:none;">
            ↩ Revert last change
          </button>
        </div>
      </div>

      <!-- SCORING PANEL -->
      <div id="scoring-panel" class="scoring-panel" style="display:none;"></div>

      <!-- DEPENDENCY GRAPH -->
      <div id="graph-section" class="graph-section" style="display:none;">
        <div class="section-header-bar">
          <span>🕸</span>
          <span id="graph-title">Agent Dependency Graph</span>
        </div>
        <div class="graph-container">
          <canvas id="agent-graph" width="800" height="400" aria-label="Agent dependency graph" role="img" style="will-change:transform;"></canvas>
        </div>
      </div>

      <!-- AGENTS GRID — primary content -->
      <div id="agents-grid" class="agents-grid"></div>

      <!-- INSTRUCTIONS -->
      <div id="instructions-section" class="instructions" style="display:none;">
        <h3 id="instr-title" style="margin-bottom:1rem;">How to upload to Google Antigravity</h3>
        <div class="instruction-steps" id="instr-steps"></div>
      </div>

      <!-- TRACE VIEWER PANEL -->
      <div id="trace-panel" class="trace-panel" style="display:none;">
        <div class="trace-panel-header" onclick="toggleTracePanel()">
          <h3>⚡ API TRACE <span id="trace-span-count" class="version-count-badge">0</span></h3>
          <div style="display:flex;align-items:center;gap:0.75rem;">
            <div class="trace-summary-pills" id="trace-summary-pills"></div>
            <span class="version-toggle-icon" id="trace-toggle-icon">▼</span>
          </div>
        </div>
        <div class="trace-body" id="trace-body">
          <div class="trace-gantt-header">
            <div>OPERATION</div>
            <div>TIMELINE</div>
            <div style="text-align:right">DURATION</div>
            <div class="th-tokens" style="text-align:right">TOKENS</div>
            <div class="th-status" style="text-align:right">STATUS</div>
          </div>
          <div id="trace-spans"></div>
          <div class="trace-footer" id="trace-footer"></div>
        </div>
      </div>

      <!-- VERSION HISTORY PANEL -->
      <div id="version-panel" class="version-panel" style="display:none;">
        <div class="version-panel-header" onclick="toggleVersionPanel()">
          <h3>🕓 VERSION HISTORY <span class="version-count-badge" id="version-count-badge">0</span></h3>
          <span class="version-toggle-icon" id="version-toggle-icon">▼</span>
        </div>
        <div class="version-timeline" id="version-timeline"></div>
      </div>

      <!-- ACTIONS — secondary, below the content -->
      <div class="results-actions results-actions-secondary">
        <h3 style="font-size:0.72rem;font-family:'Space Mono',monospace;letter-spacing:0.12em;color:var(--accent);margin-bottom:1rem;">ACTIONS</h3>
        <div class="ios-action-group">
          <button class="ios-action-btn primary-action" onclick="downloadZip()" id="download-btn">
            <span class="ios-action-icon">⬇</span>
            <span id="download-btn-label">Download ZIP</span>
          </button>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
            <button class="ios-action-btn" onclick="openShareModal()" id="share-btn">
              <span class="ios-action-icon">🔗</span><span>Share</span>
            </button>
            <button class="ios-action-btn" onclick="openRefine()" id="refine-btn">
              <span class="ios-action-icon">✏️</span><span>Refine</span>
            </button>
            <button class="ios-action-btn" onclick="openMarkdownPreview()" id="md-preview-btn">
              <span class="ios-action-icon">📄</span><span>Docs</span>
            </button>
            <button class="ios-action-btn" onclick="openFrameworkExport()" id="fw-export-btn">
              <span class="ios-action-icon">🚀</span><span>Export</span>
            </button>
            <button class="ios-action-btn" onclick="openImportModal()" id="import-btn">
              <span class="ios-action-icon">📥</span><span>Import</span>
            </button>
            <button class="ios-action-btn" onclick="openPromptExport()">
              <span class="ios-action-icon">📋</span><span>Prompts</span>
            </button>
            <button class="ios-action-btn" onclick="showInstructions()" id="instr-btn">
              <span class="ios-action-icon">📖</span><span>Guide</span>
            </button>
          </div>
          <button class="ios-action-cancel" onclick="restart()">↩ Start Over</button>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- ── FLOATING ACTION BUTTON (mobile results) ── -->


<!-- ── FILE PREVIEW MODAL (iOS Sheet) ── -->
<div class="ios-sheet-overlay" id="modal">
  <div class="ios-sheet">
    <div class="ios-sheet-handle"></div>
    <div class="ios-sheet-header">
      <div class="ios-sheet-title" id="modal-title"></div>
      <div class="modal-tabs">
        <button class="modal-tab active" id="tab-preview" onclick="switchModalTab('preview')">👁 Preview</button>
        <button class="modal-tab" id="tab-raw" onclick="switchModalTab('raw')">&lt;/&gt; Raw</button>
      </div>
      <button class="ios-sheet-close" onclick="closeModal()">✕</button>
    </div>
    <div class="ios-sheet-body" id="modal-body">
      <div id="modal-preview-pane" class="md-preview"></div>
      <pre id="modal-raw-pane" style="display:none;"></pre>
    </div>
    <div class="modal-footer" style="border-radius:0;">
      <span style="font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;" id="modal-filesize"></span>
      <button class="modal-download-btn" onclick="downloadCurrentFile()">⬇ Download</button>
    </div>
  </div>
</div>

<!-- ── MARKDOWN PREVIEW BROWSER MODAL ── -->
<div class="modal-overlay" id="md-browser-modal">
  <div class="modal" style="max-width:960px;">
    <div class="modal-header">
      <div class="modal-title" id="md-browser-title">📄 Documentation Preview</div>
      <button class="modal-close" onclick="closeMdBrowser()">✕</button>
    </div>
    <div style="display:flex;height:calc(85vh - 120px);">
      <!-- Sidebar file list -->
      <div id="md-browser-sidebar" style="
        width:220px;
        flex-shrink:0;
        border-right:1px solid var(--border);
        overflow-y:auto;
        padding:0.75rem 0;
        background:var(--surface2);
      "></div>
      <!-- Content pane -->
      <div style="flex:1;overflow-y:auto;padding:1.5rem;" id="md-browser-content">
        <div class="md-preview" id="md-browser-rendered"></div>
      </div>
    </div>
    <div class="modal-footer">
      <span style="font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;" id="md-browser-active-file"></span>
      <button class="modal-download-btn" onclick="downloadAllMd()">⬇ Download all .md</button>
    </div>
  </div>
</div>

<!-- ── SHARE MODAL ── -->
<div class="modal-overlay" id="share-modal">
  <div class="share-modal">
    <div class="modal-header">
      <div class="modal-title">🔗 Share Your Team</div>
      <button class="modal-close" onclick="closeShareModal()">✕</button>
    </div>
    <div style="padding:1.5rem;">
      <div class="share-options" id="share-options">
        <label class="share-option active" id="share-opt-open">
          <input type="radio" name="share-mode" value="open" checked onchange="onShareModeChange()">
          <div class="share-option-text">
            <div class="share-option-label">🌍 Public link</div>
            <div class="share-option-desc">Anyone with the link can view this team</div>
          </div>
        </label>
        <label class="share-option" id="share-opt-password">
          <input type="radio" name="share-mode" value="password" onchange="onShareModeChange()">
          <div class="share-option-text">
            <div class="share-option-label">🔒 Password protected <span style="font-size:0.65rem;font-family:'Space Mono',monospace;padding:0.1rem 0.4rem;border-radius:3px;background:rgba(242,185,13,0.1);border:1px solid rgba(242,185,13,0.2);color:var(--accent);vertical-align:middle;margin-left:0.3rem;">AES-256-GCM</span></div>
            <div class="share-option-desc">End-to-end encrypted — only someone with the password can read this team</div>
          </div>
          <div class="share-password-row" id="share-password-row" style="display:none;width:100%;">
            <input type="text" class="input-field" id="share-password-input" placeholder="Set a password…" oninput="generateShareUrl()" style="font-size:0.82rem;padding:0.5rem 0.8rem;">
          </div>
        </label>
      </div>

      <div class="share-url-row">
        <input type="text" class="share-url-input" id="share-url-display" readonly placeholder="Generating link…">
        <button class="share-copy-btn" id="share-copy-btn" onclick="copyShareUrl()">📋 Copy</button>
      </div>

      <div class="share-meta" id="share-meta">
        <span>📦 <span id="share-size-label">–</span></span>
        <span>⚡ <span id="share-agent-count">–</span></span>
        <span>🕓 <span id="share-version-label">–</span></span>
      </div>
    </div>
  </div>
</div>

<!-- ── FRAMEWORK EXPORT MODAL ── -->
<div class="modal-overlay" id="fw-modal">
  <div class="fw-modal">
    <div class="modal-header">
      <div class="modal-title">🚀 Export to Framework</div>
      <button class="modal-close" onclick="closeFwModal()">✕</button>
    </div>
    <div class="fw-tabs" id="fw-tabs"></div>
    <div class="fw-body" id="fw-body"></div>
  </div>
</div>

<!-- ── PROMPT EXPORT MODAL (#7) ── -->
<div class="modal-overlay" id="prompt-export-modal">
  <div class="modal" style="max-width:720px;max-height:85vh;display:flex;flex-direction:column;">
    <div class="modal-header">
      <div class="modal-title">📋 System Prompts</div>
      <button class="modal-close" onclick="closePromptExport()">✕</button>
    </div>
    <div style="display:flex;gap:0.5rem;padding:1rem 1.5rem 0;flex-shrink:0;">
      <button class="prompt-tab-btn active" id="ptab-interview" onclick="switchPromptTab('interview')">🎤 Interview</button>
      <button class="prompt-tab-btn" id="ptab-generate" onclick="switchPromptTab('generate')">⚡ Generate</button>
      <button class="prompt-tab-btn" id="ptab-refine" onclick="switchPromptTab('refine')">✏ Refine</button>
    </div>
    <div style="padding:1rem 1.5rem;flex:1;overflow:hidden;display:flex;flex-direction:column;gap:0.75rem;">
      <div style="font-size:0.72rem;color:var(--muted);font-family:'Space Mono',monospace;" id="prompt-tab-desc"></div>
      <textarea id="prompt-export-textarea" readonly
        style="flex:1;min-height:320px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;
               color:var(--text);font-family:'Space Mono',monospace;font-size:0.72rem;padding:1rem;
               resize:none;line-height:1.6;outline:none;"></textarea>
      <div style="display:flex;gap:0.75rem;flex-shrink:0;">
        <button class="btn-primary" onclick="copyPromptToClipboard()" id="copy-prompt-btn">📋 Copy to clipboard</button>
        <button class="btn-secondary" onclick="downloadPromptTxt()">⬇ Download .txt</button>
        <span id="copy-prompt-feedback" style="font-size:0.78rem;color:var(--success);align-self:center;opacity:0;transition:opacity 0.3s;"></span>
      </div>
    </div>
  </div>
</div>

<!-- ── PASSWORD UNLOCK MODAL (#3) ── -->
<div class="modal-overlay" id="unlock-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">🔒 Password Protected</div>
      <button class="modal-close" onclick="_unlockReject()">✕</button>
    </div>
    <div style="padding:1.5rem;display:flex;flex-direction:column;gap:1rem;">
      <p style="font-size:0.88rem;color:var(--muted);" id="unlock-modal-desc">This team is password protected. Enter the password to unlock it.</p>
      <input type="password" class="input-field" id="unlock-password-input"
        placeholder="Enter password…"
        style="font-size:0.9rem;"
        onkeydown="if(event.key==='Enter') _unlockConfirm()"
        autocomplete="current-password"/>
      <div id="unlock-error" style="display:none;font-size:0.8rem;color:var(--accent2);">⚠ Wrong password. Please try again.</div>
      <div style="display:flex;gap:0.75rem;">
        <button class="btn-primary" onclick="_unlockConfirm()" style="flex:1;">Unlock</button>
        <button class="btn-secondary" onclick="_unlockReject()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ── IMPORT MODAL (#4) ── -->
<div class="modal-overlay" id="import-modal">
  <div class="modal" style="max-width:620px;">
    <div class="modal-header">
      <div class="modal-title">📥 Import Project</div>
      <button class="modal-close" onclick="closeImportModal()">✕</button>
    </div>
    <div style="padding:1.5rem;">

      <!-- Drop zone -->
      <div id="import-dropzone" class="import-dropzone"
           ondragover="event.preventDefault();this.classList.add('drag-over')"
           ondragleave="this.classList.remove('drag-over')"
           ondrop="handleImportDrop(event)">
        <div style="font-size:2.5rem;margin-bottom:0.75rem;">📂</div>
        <div style="font-weight:700;font-size:1rem;margin-bottom:0.35rem;" id="import-dz-title">Drop your file here</div>
        <div style="font-size:0.78rem;color:var(--muted);margin-bottom:1.25rem;">Supports <code style="font-family:'Space Mono',monospace;font-size:0.72rem;">.json</code> and <code style="font-family:'Space Mono',monospace;font-size:0.72rem;">.zip</code> from AgentSpark</div>
        <label class="btn-secondary" style="cursor:pointer;display:inline-flex;align-items:center;gap:0.5rem;padding:0.6rem 1.25rem;font-size:0.85rem;">
          📁 Browse file
          <input type="file" id="import-file-input" accept=".json,.zip" style="display:none" onchange="handleImportFileSelect(this)"/>
        </label>
      </div>

      <!-- Preview panel (hidden until file parsed) -->
      <div id="import-preview" style="display:none;margin-top:1.25rem;">
        <div style="font-size:0.72rem;font-family:'Space Mono',monospace;color:var(--accent);letter-spacing:0.08em;margin-bottom:0.75rem;">PREVIEW</div>
        <div id="import-preview-content" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:1rem;font-size:0.82rem;line-height:1.7;"></div>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;">
          <button class="btn-primary" onclick="confirmImport()">✓ Import</button>
          <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.8rem;color:var(--muted);cursor:pointer;">
            <input type="checkbox" id="import-save-checkbox" checked style="accent-color:var(--accent);"/>
            Save as project
          </label>
          <button class="btn-secondary" style="margin-left:auto;" onclick="resetImportModal()">✕ Clear</button>
        </div>
      </div>

      <!-- Error display -->
      <div id="import-error" style="display:none;margin-top:1rem;padding:0.75rem 1rem;background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.3);border-radius:8px;font-size:0.82rem;color:var(--accent2);"></div>
    </div>
  </div>
</div>

<!-- ── VERSION DIFF MODAL ── -->
<div class="modal-overlay" id="diff-modal">
  <div class="modal" style="max-width:680px;">
    <div class="modal-header">
      <div class="modal-title" id="diff-modal-title">🔍 Compare Versions</div>
      <button class="modal-close" onclick="closeDiffModal()">✕</button>
    </div>
    <div class="diff-modal-body" id="diff-modal-body"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════
// ─── PERSISTENT PROJECTS (#1) ────────────────────────────
// ═══════════════════════════════════════════════════════════

const DB_NAME    = 'agentspark-db';
const DB_VERSION = 1;
const STORE_NAME = 'projects';
let _db = null;
let _currentProjectId = null;  // null = unsaved/new session

// ── IndexedDB init ────────────────────────────────────────
function dbOpen() {
  return new Promise((resolve, reject) => {
    if (_db) { resolve(_db); return; }
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        store.createIndex('updatedAt', 'updatedAt', { unique: false });
      }
    };
    req.onsuccess = e => { _db = e.target.result; resolve(_db); };
    req.onerror   = e => reject(e.target.error);
  });
}

async function dbGetAll() {
  const db = await dbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const req = tx.objectStore(STORE_NAME).index('updatedAt').getAll();
    req.onsuccess = e => resolve(e.target.result.reverse()); // newest first
    req.onerror   = e => reject(e.target.error);
  });
}

async function dbGet(id) {
  const db = await dbOpen();
  return new Promise((resolve, reject) => {
    const req = db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).get(id);
    req.onsuccess = e => resolve(e.target.result);
    req.onerror   = e => reject(e.target.error);
  });
}

async function dbPut(project) {
  const db = await dbOpen();
  return new Promise((resolve, reject) => {
    const req = db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).put(project);
    req.onsuccess = e => resolve(e.target.result);
    req.onerror   = e => reject(e.target.error);
  });
}

async function dbDelete(id) {
  const db = await dbOpen();
  return new Promise((resolve, reject) => {
    const req = db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(id);
    req.onsuccess = e => resolve();
    req.onerror   = e => reject(e.target.error);
  });
}

// ── Project helpers ───────────────────────────────────────
function _projectSnapshot() {
  return {
    topic:          currentTopic,
    level:          currentLevel,
    lang:           lang,
    modelProvider:  selectedModel.provider,
    modelId:        selectedModel.model,
    agents:         JSON.parse(JSON.stringify(generatedAgents)),
    files:          JSON.parse(JSON.stringify(generatedFiles)),
    versionHistory: JSON.parse(JSON.stringify(versionHistory)),
    chatHistory:    JSON.parse(JSON.stringify(chatHistory)),
  };
}

function _projectName(topic) {
  return topic || 'Untitled Project';
}

// ── Save / Auto-save ──────────────────────────────────────
let _autoSaveTimer = null;
function scheduleAutoSave() {
  if (!generatedAgents.length) return; // nothing to save yet
  clearTimeout(_autoSaveTimer);
  _autoSaveTimer = setTimeout(() => saveCurrentProject(true), 2000);
}

async function saveCurrentProject(silent = false) {
  if (!generatedAgents.length) {
    if (!silent) showNotif(lang === 'en' ? '⚠ Generate a team first before saving' : '⚠ Najpierw wygeneruj zespół', true);
    return;
  }
  try {
    const now = Date.now();
    const snap = _projectSnapshot();
    if (_currentProjectId) {
      // Update existing
      const existing = await dbGet(_currentProjectId);
      if (existing) {
        await dbPut({ ...existing, ...snap, updatedAt: now });
      } else {
        _currentProjectId = null; // was deleted externally — create new
      }
    }
    if (!_currentProjectId) {
      // Create new
      _currentProjectId = 'proj_' + now + '_' + Math.random().toString(36).slice(2,7);
      await dbPut({
        id:        _currentProjectId,
        name:      _projectName(currentTopic),
        createdAt: now,
        updatedAt: now,
        ...snap
      });
    } else {
      // Just update name in case topic changed
      const existing = await dbGet(_currentProjectId);
      if (existing) await dbPut({ ...existing, name: _projectName(currentTopic), updatedAt: now, ...snap });
    }
    _showSaveIndicator();
    await _updateProjectsBadge();
    if (!silent) showNotif(lang === 'en' ? '✓ Project saved!' : '✓ Projekt zapisany!');
  } catch(e) {
    console.error('[AgentSpark] Save failed:', e);
    if (!silent) showNotif(lang === 'en' ? '⚠ Save failed: ' + e.message : '⚠ Błąd zapisu: ' + e.message, true);
  }
}

function _showSaveIndicator() {
  const el = document.getElementById('save-indicator');
  if (!el) return;
  el.textContent = '✓ saved';
  el.classList.add('visible');
  clearTimeout(_showSaveIndicator._t);
  _showSaveIndicator._t = setTimeout(() => el.classList.remove('visible'), 2500);
}

// ── Load project ──────────────────────────────────────────
async function loadProject(id) {
  try {
    const proj = await dbGet(id);
    if (!proj) { showNotif('⚠ Project not found', true); return; }

    // Restore all state
    currentTopic      = proj.topic      || '';
    currentLevel      = proj.level      || 'iskra';
    lang              = proj.lang       || 'en';
    generatedAgents   = proj.agents     || [];
    generatedFiles    = proj.files      || {};
    versionHistory    = proj.versionHistory || [];
    chatHistory       = proj.chatHistory    || [];
    _currentProjectId = proj.id;

    // Restore model if stored
    if (proj.modelId) {
      const opt = document.querySelector(`#modelSelect option[value*="${proj.modelId}"]`);
      if (opt) { opt.selected = true; onModelChange(); }
    }
    // Restore lang
    setLang(lang);

    // Show results screen
    showScreen('results');
    document.getElementById('apiKeyHeader').style.display = 'flex';
    renderResults();
    _showSaveIndicator();
    showNotif(lang === 'en' ? `📂 "${proj.name}" loaded` : `📂 Załadowano "${proj.name}"`);
  } catch(e) {
    console.error('[AgentSpark] Load failed:', e);
    showNotif('⚠ Failed to load project: ' + e.message, true);
  }
}

// ── Delete project ────────────────────────────────────────
async function deleteProject(id, name) {
  const confirmed = window.confirm(
    lang === 'en'
      ? `Delete project "${name}"? This cannot be undone.`
      : `Usunąć projekt "${name}"? Tej operacji nie można cofnąć.`
  );
  if (!confirmed) return;
  try {
    await dbDelete(id);
    if (_currentProjectId === id) _currentProjectId = null;
    await renderProjectsList();
    await _updateProjectsBadge();
    showNotif(lang === 'en' ? '🗑 Project deleted' : '🗑 Projekt usunięty');
  } catch(e) {
    showNotif('⚠ Delete failed: ' + e.message, true);
  }
}

// ── Duplicate / Fork project ──────────────────────────────
async function forkProject(id) {
  try {
    const proj = await dbGet(id);
    if (!proj) return;
    const now = Date.now();
    const newId = 'proj_' + now + '_' + Math.random().toString(36).slice(2,7);
    await dbPut({
      ...proj,
      id:        newId,
      name:      proj.name + ' (copy)',
      createdAt: now,
      updatedAt: now,
    });
    await renderProjectsList();
    await _updateProjectsBadge();
    showNotif(lang === 'en' ? '✓ Project duplicated' : '✓ Projekt zduplikowany');
  } catch(e) {
    showNotif('⚠ Fork failed: ' + e.message, true);
  }
}

// ── Projects screen ───────────────────────────────────────
async function openProjectsScreen() {
  _updateContextBar('projects');
  showScreen('projects');
  await renderProjectsList();
}

async function renderProjectsList() {
  const list    = document.getElementById('projects-list');
  const empty   = document.getElementById('projects-empty');
  const search  = (document.getElementById('projects-search')?.value || '').toLowerCase();
  if (!list) return;

  let projects = [];
  try { projects = await dbGetAll(); } catch(e) { console.error(e); }

  const filtered = search
    ? projects.filter(p => p.name.toLowerCase().includes(search) || (p.topic||'').toLowerCase().includes(search))
    : projects;

  if (!filtered.length) {
    list.innerHTML  = '';
    list.style.display  = 'none';
    empty.style.display = 'block';
    return;
  }
  list.style.display  = 'grid';
  empty.style.display = 'none';

  list.innerHTML = filtered.map(p => {
    const updated = _formatDate(p.updatedAt);
    const agentCount = (p.agents||[]).length;
    const isCurrent = p.id === _currentProjectId;
    return `
    <div class="project-card-wrap" id="wrap-${p.id}">
    <div class="project-swipe-actions" aria-hidden="true">
      <button class="swipe-action-btn open-btn" onclick="loadProject('${p.id}')"><span class="sa-icon">▶</span>Open</button>
      <button class="swipe-action-btn fork-btn" onclick="forkProject('${p.id}')"><span class="sa-icon">⎘</span>Fork</button>
      <button class="swipe-action-btn del-btn" onclick="deleteProject('${p.id}', '${_escHtml(p.name).replace(/'/g,"\\'")}')"><span class="sa-icon">🗑</span>Del</button>
    </div>
    <div class="project-card" tabindex="0" role="button" aria-label="${_escHtml(p.name)}" onclick="loadProject('${p.id}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();loadProject('${p.id}')}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;">
        <div class="project-card-name">${_escHtml(p.name)}${isCurrent ? '<span class="project-unsaved-dot" title="Current project"></span>' : ''}</div>
      </div>
      <div class="project-card-topic">📌 ${_escHtml(p.topic||'No topic')}</div>
      <div class="project-card-meta">
        ${agentCount ? `<span class="project-card-tag">👥 ${agentCount} agents</span>` : ''}
        ${p.level ? `<span class="project-card-tag">${p.level}</span>` : ''}
        ${p.lang  ? `<span class="project-card-tag">${p.lang.toUpperCase()}</span>` : ''}
      </div>
      <div class="project-card-date">Updated ${updated}</div>
      <div class="project-card-actions" onclick="event.stopPropagation()">
        <button class="project-card-btn" onclick="loadProject('${p.id}')">▶ Open</button>
        <button class="project-card-btn" onclick="forkProject('${p.id}')">⎘ Fork</button>
        <button class="project-card-btn danger" onclick="deleteProject('${p.id}', '${_escHtml(p.name).replace(/'/g,'\\\'') }')">🗑</button>
      </div>
    </div>
    </div>`;
  }).join('');
}

async function _updateProjectsBadge() {
  try {
    const all = await dbGetAll();
    const badge = document.getElementById('projects-count-badge');
    const tabBadge = document.getElementById('tab-badge');
    if (!badge) return;
    if (all.length > 0) {
      badge.textContent = all.length + ' ';
      badge.style.display = 'inline';
      if (tabBadge) { tabBadge.textContent = all.length; tabBadge.style.display = ''; }
    } else {
      badge.style.display = 'none';
      if (tabBadge) tabBadge.style.display = 'none';
    }
  } catch(e) {}
}

function _formatDate(ts) {
  if (!ts) return '—';
  const d   = new Date(ts);
  const now = Date.now();
  const diff = now - ts;
  if (diff < 60000)    return 'just now';
  if (diff < 3600000)  return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  if (diff < 604800000) return Math.floor(diff/86400000) + 'd ago';
  return d.toLocaleDateString();
}

function _escHtml(str) {
  return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── Wire auto-save into agent generation ─────────────────
// Called after generatedAgents is populated (patched into renderResults)
function _onAgentsReady() {
  scheduleAutoSave();
  _updateProjectsBadge();
}

// ── Init on load ──────────────────────────────────────────
window.addEventListener('DOMContentLoaded', async () => {
  try {
    await dbOpen();
    await _updateProjectsBadge();
  } catch(e) {
    console.warn('[AgentSpark] IndexedDB init failed:', e);
  }
  // Initialize collapsible API setup — open by default
  toggleApiSetup(true);
  // Restore saved API key if any
  const savedKey = localStorage.getItem('agentspark-api-key');
  if (savedKey) {
    apiKey = savedKey;
    const inp = document.getElementById('apiKeySetupInput');
    if (inp) inp.value = savedKey;
    checkApiKey();
  }
});

// ─── STATE ───────────────────────────────────────────────
let lang = 'en';
let apiKey = '';
let selectedModel = {
  provider: 'gemini',
  model: 'gemini-3-flash-preview',
  endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}',
  tag: 'gemini'
};
let currentTopic = '';
let currentLevel = 'iskra';
let chatHistory = [];
let conversationState = 'interview';
let questionCount = 0;
let MAX_QUESTIONS = 6;
let generatedAgents = [];
let generatedFiles = {};
let refineHistory = [];
let isRefining = false;

// Modal state
let currentModalFile = '';
let currentModalTab = 'preview';
let mdBrowserActiveFile = '';

// ─── I18N ─────────────────────────────────────────────────
const T = {
  en: {
    badge: 'AI AGENT TEAM GENERATOR',
    heroTitle: 'Build Your<br/>AI Dream Team',
    heroSub: 'Choose a topic. Answer a few questions. Get a complete AI agent team — ready to build your app with Google Antigravity.',
    orText: '— or describe your own —',
    startBtn: 'Start →',
    chatTitle: 'AI Interview',
    chatSub: 'Building your agent profile...',
    sendBtn: 'Send',
    resultBadge: 'MISSION COMPLETE',
    resultTitle: 'Your AI Team is Ready',
    resultSub: 'Download your files and deploy to Google Antigravity',
    downloadBtn: '⬇ Download ZIP',
    instrBtn: '📋 Instructions',
    restartBtn: '↩ Start Over',
    refineBtn: '✏ Refine Team',
    refineTitle: 'Refine Your Team',
    refineSub: 'Tell the AI what you want to change. Be specific.',
    refineActions: [
      { id: 'improve', emoji: '⚡', label: 'Improve team', desc: 'General improvements to all agents' },
      { id: 'add', emoji: '➕', label: 'Add an agent', desc: 'Add a new specialist to the team' },
      { id: 'remove', emoji: '🗑', label: 'Remove an agent', desc: 'Remove or merge an existing agent' },
      { id: 'connections', emoji: '🔗', label: 'Change connections', desc: 'Reroute how agents communicate' },
    ],
    refinePlaceholder: 'e.g. Add a Security Agent, or make the Backend Agent focus more on GraphQL...',
    refineApply: 'Apply Changes',
    refineCancel: 'Cancel',
    refineThinking: 'Refining your team...',
    instrTitle: 'How to upload to Google Antigravity',
    progressSteps: ['Topic chosen','Interview done','Team generated','Files ready'],

    levels: [
      {
        id: 'iskra', emoji: '✨', name: 'Spark', tagline: 'Spark — just getting started',
        desc: 'Simple MVP, 2-3 agents, no-code friendly. Perfect for beginners.',
        color: '#f2b90d', questions: 4, agentCount: '2-3',
        focus: 'core features, simplicity, ease of use'
      },
      {
        id: 'plomien', emoji: '🔥', name: 'Flame', tagline: 'Flame — ready to build',
        desc: 'Full-featured app, 3-4 agents, some technical knowledge assumed.',
        color: '#f59e0b', questions: 5, agentCount: '3-4',
        focus: 'features, integrations, user flows, basic tech stack'
      },
      {
        id: 'pozar', emoji: '🌋', name: 'Fire', tagline: 'Fire — serious project',
        desc: 'Complex system, 4-5 agents, APIs, auth, data pipelines.',
        color: '#ef4444', questions: 6, agentCount: '4-5',
        focus: 'architecture, scalability, security, APIs, data models'
      },
      {
        id: 'inferno', emoji: '💀', name: 'Inferno', tagline: 'Inferno — enterprise grade',
        desc: 'Full enterprise system, 5-6 agents, microservices, CI/CD, full stack.',
        color: '#f2b90d', questions: 7, agentCount: '5-6',
        focus: 'microservices, DevOps, security, compliance, scalability, multi-tenant architecture'
      }
    ],
    topics: [
      { icon:'🛒', label:'E-Commerce App', sub:'Store, payments, catalog', cat:'business', agents:'Product, Cart, Payments, Recommendations', time:'~45s' },
      { icon:'📊', label:'Analytics Dashboard', sub:'Data, charts, reports', cat:'business', agents:'Data Ingest, Aggregator, Visualizer, Alerts', time:'~40s' },
      { icon:'💼', label:'SaaS Dev Team', sub:'Multi-tenant SaaS product', cat:'business', agents:'Auth, Billing, API, Infra, Onboarding', time:'~50s' },
      { icon:'📈', label:'Marketing Crew', sub:'Campaigns, copy, SEO', cat:'business', agents:'Strategist, Copywriter, SEO, Analytics', time:'~40s' },
      { icon:'🎓', label:'EdTech Platform', sub:'Courses, quizzes, users', cat:'education', agents:'Curriculum, Assessment, Progress, Content', time:'~45s' },
      { icon:'🏥', label:'Healthcare Tool', sub:'Patients, records, booking', cat:'health', agents:'Records, Scheduler, Alerts, Compliance', time:'~50s' },
      { icon:'💬', label:'Chat Application', sub:'Messaging, rooms, media', cat:'social', agents:'Messaging, Presence, Media, Moderation', time:'~40s' },
      { icon:'🎮', label:'Game / Gamification', sub:'Points, levels, rewards', cat:'social', agents:'Game Loop, Rewards, Leaderboard, Events', time:'~40s' },
      { icon:'🤖', label:'AI Automation Bot', sub:'Tasks, scheduling, workflows', cat:'ai', agents:'Orchestrator, Task Runner, Notifier, Logger', time:'~45s' },
      { icon:'🔍', label:'Research Assistant', sub:'Web search, summaries, reports', cat:'ai', agents:'Searcher, Synthesizer, Fact-checker, Writer', time:'~40s' },
      { icon:'🏗', label:'DevOps Pipeline', sub:'CI/CD, infra, monitoring', cat:'dev', agents:'Builder, Deployer, Monitor, Incident', time:'~50s' },
      { icon:'💰', label:'FinTech App', sub:'Payments, wallets, compliance', cat:'business', agents:'Payments, Risk, KYC, Ledger, Reporting', time:'~50s' },
    ],
    topicCats: [
      { id:'all', label:'All' },
      { id:'business', label:'Business' },
      { id:'ai', label:'AI / Automation' },
      { id:'dev', label:'Dev Tools' },
      { id:'education', label:'Education' },
      { id:'health', label:'Health' },
      { id:'social', label:'Social' },
    ],
    apiPlaceholder: 'Type your answer...',
    instrSteps: [
      { title: 'Open Google Antigravity', body: 'Go to <code>antigravity.google</code> and sign in with your Google account.' },
      { title: 'Create a new Workspace', body: 'Click "New Workspace" and give it the name of your project.' },
      { title: 'Upload agent files', body: 'For each agent, create a new Agent. Upload the corresponding <code>agent-[name].md</code> as the Agent\'s knowledge base.' },
      { title: 'Upload skill files', body: 'Within each agent, attach the <code>skill-[name].md</code> file to define how the agent behaves.' },
      { title: 'Connect the team', body: 'In the Manager View, connect your agents using the wiring provided in <code>team-config.md</code>.' },
      { title: 'Choose orchestration mode', body: 'Set the team to <strong>Agent-driven</strong> (fully automatic) or <strong>Agent-assisted</strong> (user orchestrated) depending on your preference.' },
      { title: 'Launch!', body: 'Hit "Deploy" and start interacting with your AI team. They are ready to help you build your app.' },
    ]
  },
  pl: {
    badge: 'GENERATOR ZESPOŁU AGENTÓW AI',
    heroTitle: 'Zbuduj Swój<br/>Zespół AI',
    heroSub: 'Wybierz temat. Odpowiedz na kilka pytań. Otrzymaj kompletny zespół agentów AI — gotowy do budowania aplikacji w Google Antigravity.',
    orText: '— lub opisz własny temat —',
    startBtn: 'Zacznij →',
    chatTitle: 'Wywiad AI',
    chatSub: 'Budujemy Twój profil agentów...',
    sendBtn: 'Wyślij',
    resultBadge: 'MISJA WYKONANA',
    resultTitle: 'Twój Zespół AI jest Gotowy',
    resultSub: 'Pobierz pliki i wdróż do Google Antigravity',
    downloadBtn: '⬇ Pobierz ZIP',
    instrBtn: '📋 Instrukcja',
    restartBtn: '↩ Od Początku',
    refineBtn: '✏ Popraw Zespół',
    refineTitle: 'Popraw Swój Zespół',
    refineSub: 'Powiedz AI co chcesz zmienić. Im konkretniej, tym lepiej.',
    refineActions: [
      { id: 'improve', emoji: '⚡', label: 'Ulepsz zespół', desc: 'Ogólne ulepszenia wszystkich agentów' },
      { id: 'add', emoji: '➕', label: 'Dodaj agenta', desc: 'Dodaj nowego specjalistę do zespołu' },
      { id: 'remove', emoji: '🗑', label: 'Usuń agenta', desc: 'Usuń lub połącz istniejącego agenta' },
      { id: 'connections', emoji: '🔗', label: 'Zmień połączenia', desc: 'Przepnij sposób komunikacji agentów' },
    ],
    refinePlaceholder: 'np. Dodaj agenta ds. bezpieczeństwa, albo zmień Backend Agenta na GraphQL...',
    refineApply: 'Zastosuj Zmiany',
    refineCancel: 'Anuluj',
    refineThinking: 'Poprawiam Twój zespół...',
    instrTitle: 'Jak wgrać do Google Antigravity',
    progressSteps: ['Temat wybrany','Wywiad gotowy','Zespół wygenerowany','Pliki gotowe'],

    levels: [
      {
        id: 'iskra', emoji: '✨', name: 'Iskra', tagline: 'Dopiero zaczynam',
        desc: 'Proste MVP, 2-3 agenty, przyjazne dla początkujących. Zero kodowania.',
        color: '#f2b90d', questions: 4, agentCount: '2-3',
        focus: 'podstawowe funkcje, prostota, łatwość użycia'
      },
      {
        id: 'plomien', emoji: '🔥', name: 'Płomień', tagline: 'Gotowy do budowania',
        desc: 'Pełna aplikacja, 3-4 agenty, podstawowa wiedza techniczna wymagana.',
        color: '#f59e0b', questions: 5, agentCount: '3-4',
        focus: 'funkcje, integracje, przepływy użytkownika, podstawowy stack techniczny'
      },
      {
        id: 'pozar', emoji: '🌋', name: 'Pożar', tagline: 'Poważny projekt',
        desc: 'Złożony system, 4-5 agentów, API, autoryzacja, pipeline danych.',
        color: '#ef4444', questions: 6, agentCount: '4-5',
        focus: 'architektura, skalowalność, bezpieczeństwo, API, modele danych'
      },
      {
        id: 'inferno', emoji: '💀', name: 'Inferno', tagline: 'Poziom enterprise',
        desc: 'Pełny system enterprise, 5-6 agentów, mikroserwisy, CI/CD, full stack.',
        color: '#f2b90d', questions: 7, agentCount: '5-6',
        focus: 'mikroserwisy, DevOps, bezpieczeństwo, compliance, skalowalność, architektura multi-tenant'
      }
    ],
    topics: [
      { icon:'🛒', label:'Aplikacja E-Commerce', sub:'Sklep, płatności, katalog', cat:'business', agents:'Produkty, Koszyk, Płatności, Rekomendacje', time:'~45s' },
      { icon:'📊', label:'Dashboard Analityczny', sub:'Dane, wykresy, raporty', cat:'business', agents:'Dane, Agregator, Wizualizator, Alerty', time:'~40s' },
      { icon:'💼', label:'Zespół SaaS', sub:'Multi-tenant produkt SaaS', cat:'business', agents:'Auth, Billing, API, Infra, Onboarding', time:'~50s' },
      { icon:'📈', label:'Marketing Crew', sub:'Kampanie, teksty, SEO', cat:'business', agents:'Strateg, Copywriter, SEO, Analityk', time:'~40s' },
      { icon:'🎓', label:'Platforma EdTech', sub:'Kursy, quizy, użytkownicy', cat:'education', agents:'Curriculum, Ocenianie, Postępy, Treści', time:'~45s' },
      { icon:'🏥', label:'Narzędzie Medyczne', sub:'Pacjenci, dokumentacja, wizyty', cat:'health', agents:'Dokumentacja, Scheduler, Alerty, Compliance', time:'~50s' },
      { icon:'💬', label:'Aplikacja Czat', sub:'Wiadomości, pokoje, media', cat:'social', agents:'Wiadomości, Obecność, Media, Moderacja', time:'~40s' },
      { icon:'🎮', label:'Gra / Gamifikacja', sub:'Punkty, poziomy, nagrody', cat:'social', agents:'Pętla gry, Nagrody, Ranking, Eventy', time:'~40s' },
      { icon:'🤖', label:'Bot Automatyzacji AI', sub:'Zadania, harmonogram, workflow', cat:'ai', agents:'Orkiestrator, Executor, Notifier, Logger', time:'~45s' },
      { icon:'🔍', label:'Asystent Badań', sub:'Wyszukiwanie, podsumowania, raporty', cat:'ai', agents:'Wyszukiwarka, Synthesizer, Fact-checker, Pisarz', time:'~40s' },
      { icon:'🏗', label:'Pipeline DevOps', sub:'CI/CD, infra, monitoring', cat:'dev', agents:'Builder, Deployer, Monitor, Incident', time:'~50s' },
      { icon:'💰', label:'Aplikacja FinTech', sub:'Płatności, portfele, compliance', cat:'business', agents:'Płatności, Ryzyko, KYC, Księga, Raporty', time:'~50s' },
    ],
    topicCats: [
      { id:'all', label:'Wszystkie' },
      { id:'business', label:'Biznes' },
      { id:'ai', label:'AI / Automatyzacja' },
      { id:'dev', label:'Dev Tools' },
      { id:'education', label:'Edukacja' },
      { id:'health', label:'Zdrowie' },
      { id:'social', label:'Social' },
    ],
    apiPlaceholder: 'Wpisz odpowiedź...',
    instrSteps: [
      { title: 'Otwórz Google Antigravity', body: 'Przejdź na <code>antigravity.google</code> i zaloguj się kontem Google.' },
      { title: 'Utwórz nowy Workspace', body: 'Kliknij "New Workspace" i nadaj mu nazwę projektu.' },
      { title: 'Wgraj pliki agentów', body: 'Dla każdego agenta utwórz nowego Agenta. Wgraj <code>agent-[nazwa].md</code> jako bazę wiedzy.' },
      { title: 'Wgraj pliki umiejętności', body: 'W każdym agencie dołącz plik <code>skill-[nazwa].md</code> — definiuje on zachowanie agenta.' },
      { title: 'Połącz zespół', body: 'W Manager View połącz agentów zgodnie z konfiguracją z pliku <code>team-config.md</code>.' },
      { title: 'Wybierz tryb orkiestracji', body: 'Ustaw <strong>Agent-driven</strong> (w pełni automatyczny) lub <strong>Agent-assisted</strong> (sterowany przez użytkownika).' },
      { title: 'Uruchom!', body: 'Kliknij "Deploy" i zacznij pracę z zespołem AI gotowym do budowania Twojej aplikacji.' },
    ]
  }
};

function t(key) { return T[lang][key]; }

// ─── LANGUAGE ─────────────────────────────────────────────
function setLang(l) {
  lang = l;
  document.getElementById('btn-en').classList.toggle('active', l==='en');
  document.getElementById('btn-pl').classList.toggle('active', l==='pl');
  renderTopicScreen();
}

// ─── MODEL SELECTION ──────────────────────────────────────
const MODEL_KEY_HINTS = {
  gemini:    { label: 'Gemini API Key',    hint: 'Key: Google AI Studio → makersuite.google.com',   placeholder: 'AIza...' },
  openai:    { label: 'OpenAI API Key',    hint: 'Key: platform.openai.com/api-keys',                placeholder: 'sk-...' },
  anthropic: { label: 'Anthropic API Key', hint: 'Key: console.anthropic.com/settings/keys',         placeholder: 'sk-ant-...' },
  mistral:   { label: 'Mistral API Key',   hint: 'Key: console.mistral.ai/api-keys',                 placeholder: 'your-mistral-key' },
  groq:      { label: 'Groq API Key',      hint: 'Key: console.groq.com/keys',                       placeholder: 'gsk_...' },
};

function onModelChange() {
  const sel = document.getElementById('modelSelect');
  if(!sel) return;
  const parts = sel.value.split('|');
  const label = sel.options[sel.selectedIndex]?.text || parts[1];
  selectedModel = { provider: parts[0], model: parts[1], endpoint: parts[2], tag: parts[3], label };

  const info = MODEL_KEY_HINTS[selectedModel.tag] || MODEL_KEY_HINTS.gemini;
  const labelEl = document.getElementById('apiKeyLabel');
  const hintEl  = document.getElementById('modelHint');
  const inputEl = document.getElementById('apiKeySetupInput');
  const headerInputEl = document.getElementById('apiKeyInput');

  if(labelEl)  labelEl.textContent = info.label;
  if(hintEl)   hintEl.innerHTML = info.hint;
  if(inputEl)  inputEl.placeholder = info.placeholder;
  if(headerInputEl) headerInputEl.placeholder = info.label;

  // Reset key when switching provider
  apiKey = '';
  if(inputEl) inputEl.value = '';
  const status = document.getElementById('apiKeySetupStatus');
  if(status) { status.textContent = ''; status.className = 'api-key-status'; }
}

// ─── API KEY ──────────────────────────────────────────────
function syncApiKey(val) {
  apiKey = val.trim();
  const headerInput = document.getElementById('apiKeyInput');
  if(headerInput) headerInput.value = apiKey;
  if (apiKey.length > 10) localStorage.setItem('agentspark-api-key', apiKey);
  checkApiKey();
}
function checkApiKey() {
  const val = apiKey || document.getElementById('apiKeySetupInput')?.value?.trim() || '';
  apiKey = val;
  const status = document.getElementById('apiKeySetupStatus');
  if(val.length > 10) {
    if(status) { status.textContent = '✓ Key set'; status.className = 'api-key-status ok'; }
    _updateApiKeyDot('ready');
  } else {
    if(status) { status.textContent = ''; status.className = 'api-key-status'; }
    _updateApiKeyDot('');
  }
}

// ─── TOPIC SCREEN ─────────────────────────────────────────
function renderLevelGrid() {
  const grid = document.getElementById('level-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const label = document.getElementById('level-section-label');
  if(label) label.textContent = lang === 'en' ? 'COMPLEXITY LEVEL' : 'POZIOM ZŁOŻONOŚCI';

  t('levels').forEach(level => {
    const div = document.createElement('div');
    div.className = 'level-card' + (currentLevel === level.id ? ' selected' : '');
    div.style.borderColor = currentLevel === level.id ? level.color : '';
    div.style.boxShadow = currentLevel === level.id ? `0 0 20px ${level.color}33` : '';
    div.innerHTML = `
      <span class="level-emoji">${level.emoji}</span>
      <div class="level-name" style="color:${level.color}">${level.name}</div>
      <div class="level-tagline">${level.tagline}</div>
      <div class="level-agents" style="color:${level.color};border-color:${level.color}33;background:${level.color}11">
        ${level.agentCount} ${lang==='en'?'agents':'agentów'}
      </div>
    `;
    div.title = level.desc;
    div.tabIndex = 0;
    div.setAttribute('role', 'radio');
    div.setAttribute('aria-checked', currentLevel === level.id ? 'true' : 'false');
    div.onclick = () => {
      currentLevel = level.id;
      MAX_QUESTIONS = level.questions;
      renderLevelGrid();
    };
    div.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); div.click(); } };
    grid.appendChild(div);
  });
}

let activeTopicCat = 'all';

function renderTopicScreen() {
  renderLevelGrid();
  document.getElementById('badge-text').textContent = t('badge');
  document.getElementById('hero-title').innerHTML = t('heroTitle');
  document.getElementById('hero-sub').textContent = t('heroSub');
  document.getElementById('or-text').textContent = t('orText');
  document.getElementById('start-btn').textContent = t('startBtn');

  // Render category filters as iOS segmented control
  const filtersEl = document.getElementById('template-filters');
  filtersEl.innerHTML = '';
  const seg = document.createElement('div');
  seg.className = 'ios-segmented';
  // Limit to first 5 to fit in segmented control
  const cats = t('topicCats').slice(0, 5);
  cats.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'ios-seg-btn' + (activeTopicCat === cat.id ? ' active' : '');
    btn.textContent = cat.label;
    btn.onclick = () => {
      activeTopicCat = cat.id;
      renderTopicScreen();
    };
    seg.appendChild(btn);
  });
  filtersEl.appendChild(seg);

  // Render topic cards
  const grid = document.getElementById('topic-grid');
  grid.innerHTML = '';
  t('topics').forEach(topic => {
    const div = document.createElement('div');
    div.className = 'topic-card' + (activeTopicCat !== 'all' && topic.cat !== activeTopicCat ? ' hidden' : '');
    div.innerHTML = `
      <div class="time-badge">${topic.time}</div>
      <div class="icon">${topic.icon}</div>
      <div class="label">${topic.label}</div>
      <div class="sub">${topic.sub}</div>
      <div class="agents-preview">⚡ ${topic.agents}</div>
    `;
    div.onclick = () => { document.getElementById('customTopic').value = topic.label; startWithTopic(); };
    div.tabIndex = 0;
    div.setAttribute('role', 'button');
    div.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); div.click(); } };
    grid.appendChild(div);
  });
}

function startWithTopic() {
  const val = document.getElementById('apiKeySetupInput').value.trim();
  apiKey = val;
  if(!apiKey || apiKey.length < 10) {
    showNotif(lang==='en' ? `⚠ Please enter a valid ${MODEL_KEY_HINTS[selectedModel.tag]?.label || 'API key'}` : `⚠ Podaj prawidłowy klucz ${MODEL_KEY_HINTS[selectedModel.tag]?.label || 'API'}`, true);
    return;
  }
  const topic = document.getElementById('customTopic').value.trim();
  if(!topic) {
    showNotif(lang==='en' ? '⚠ Please select or enter a topic' : '⚠ Wybierz lub wpisz temat', true);
    return;
  }
  currentTopic = topic;
  startChat();
}

// ─── CHAT SCREEN ──────────────────────────────────────────
function startChat() {
  showScreen('chat');
  _updateContextBar('chat');
  // Reset trace for new session
  traceSpans = [];
  tracePanelOpen = false;
  traceSessionStart = null;
  document.getElementById('apiKeyHeader').style.display = 'flex';
  document.getElementById('apiKeyInput').value = apiKey;
  // Show model badge in header
  const badgeEl = document.getElementById('headerModelBadge');
  if(badgeEl) badgeEl.textContent = selectedModel.model;
  document.getElementById('sidebar-topic').textContent = currentTopic;
  const lvl = t('levels').find(l => l.id === currentLevel);
  if(lvl) {
    document.getElementById('sidebar-level').textContent = lvl.emoji;
    document.getElementById('sidebar-level-name').textContent = lvl.name;
    document.getElementById('sidebar-level-name').style.color = lvl.color;
    document.getElementById('sidebar-level-desc').textContent = lvl.tagline;
  }
  document.getElementById('chat-title').textContent = t('chatTitle');
  document.getElementById('chat-subtitle').textContent = t('chatSub');

  renderProgressSteps(0);
  chatHistory = [];
  questionCount = 0;
  conversationState = 'interview';

  const systemPrompt = getSystemPrompt();
  addTypingIndicator();
  callGemini(systemPrompt, `The user wants to build: "${currentTopic}". Start the interview with your FIRST question. Respond ONLY with the JSON object as specified — no greeting text, just the JSON.`, '🎤 Interview · Start')
    .then(reply => {
      removeTypingIndicator();
      let parsed = null;
      try {
        const m = reply.match(/\{[\s\S]*\}/);
        if(m) parsed = JSON.parse(m[0]);
      } catch(e) {}
      if(parsed && parsed.question && parsed.options) {
        addMessage('ai', parsed.question);
        renderOptions(parsed);
      } else {
        addMessage('ai', reply);
        renderOptionsLegacy(reply);
      }
    })
    .catch(err => {
      removeTypingIndicator();
      addMessage('ai', `Error: ${err.message}. Please check your API key.`);
    });
}

function getSystemPrompt() {
  const levelData = t('levels').find(l => l.id === currentLevel) || t('levels')[0];
  return `You are AgentSpark, an expert AI system designer. Your job is to interview the user about their app idea using CLOSED questions with multiple choice answers.

Language: ${lang === 'en' ? 'English' : 'Polish'}
App topic: ${currentTopic}
Complexity level: ${levelData.name} — ${levelData.tagline}
Agent count to generate: ${levelData.agentCount}
Focus areas for this level: ${levelData.focus}

INTERVIEW STRUCTURE — ${MAX_QUESTIONS} questions total, split into 3 adaptive sections:

SECTION 1 — BUSINESS (first ${Math.ceil(MAX_QUESTIONS * 0.3)} questions):
Focus: target users, monetization model, core value proposition, market.
Example topics: who uses the app, how it makes money, what problem it solves, main competitors.

SECTION 2 — FRONTEND (next ${Math.ceil(MAX_QUESTIONS * 0.35)} questions):
Focus: UI paradigm, navigation, key user flows, device targets, design priorities.
Example topics: onboarding flow, main screens, mobile vs web, key interactions.

SECTION 3 — BACKEND (remaining questions):
Focus: data storage, auth, external APIs, scalability, infrastructure.
Example topics: authentication method, data model, third-party integrations, hosting preferences.

ADAPTIVE RULES — CRITICAL:
- Each question MUST reference or build on previous answers. Never ask in a vacuum.
- If user chose "mobile-first" → ask about offline mode or push notifications next.
- If user chose "subscription model" → ask about billing provider and free tier strategy.
- If user chose "social login" → ask about user profile data needs.
- Questions must form a coherent decision tree that leads to a buildable specification.
- Calibrate depth: ${levelData.name} level — ${levelData.focus}
- For Spark: friendly, no jargon. For Flame: balanced. For Fire: technical. For Inferno: enterprise-deep.
- Always track what has been decided and reference it explicitly in the next question.

RESPONSE FORMAT — for EVERY question respond with ONLY this JSON, no extra text:
{
  "section": "Business" | "Frontend" | "Backend",
  "question": "Your question here — referencing prior choices where relevant?",
  "options": [
    { "label": "A", "text": "Option A text", "impact": "1 sentence: concrete consequence for the app under 15 words" },
    { "label": "B", "text": "Option B text", "impact": "1 sentence: concrete consequence for the app under 15 words" },
    { "label": "C", "text": "Option C text", "impact": "1 sentence: concrete consequence for the app under 15 words" },
    { "label": "D", "text": "Option D text", "impact": "1 sentence: concrete consequence for the app under 15 words" }
  ]
}

After exactly ${MAX_QUESTIONS} questions respond with ONLY:
{ "complete": true, "summary": "Coherent 3-4 sentence spec summary covering business model, frontend approach, and backend architecture based on all answers." }

IMPORTANT: Pure JSON only. No markdown. No text outside JSON. Make every question feel like the natural next step after the previous answer.

GENERATION PHASE (when you receive [GENERATE]):
Respond with a JSON object ONLY, no markdown, no explanation. Format:
{
  "agents": [
    {
      "id": "slug-name",
      "name": "Agent Name",
      "emoji": "🤖",
      "type": "technical",
      "role": "ROLE_LABEL",
      "description": "What this agent does",
      "agentMd": "# Agent: Name\\n\\n## Identity\\n...\\n\\n## Goal\\n...\\n\\n## Personality\\n...\\n\\n## Context\\n...",
      "skillMd": "# Skill: Name\\n\\n## Capabilities\\n...\\n\\n## Instructions\\n...\\n\\n## Tools\\n...\\n\\n## Output Format\\n..."
    }
  ],
  "teamConfig": "# Team Configuration\\n\\n## Architecture\\n...\\n\\n## Agent Connections\\n...\\n\\n## Orchestration Mode\\n...\\n\\n## Workflow\\n..."
}

AGENT TYPES — you MUST generate both types:
- "technical" agents: builders who directly help code and implement the app
- "business" agents: strategists who provide context, validation and guidance

Distribute agent types based on level:
- Spark: 2 technical, 1 business
- Flame: 2 technical, 2 business
- Fire: 3 technical, 2 business
- Inferno: 4 technical, 2 business

Make agent files detailed and professional. Each agent should be genuinely useful for the specific app described.`;
}

function selectOption(label, text) {
  // Mark all choice cards in the last choices-msg
  const msgs = document.querySelectorAll('.choices-msg');
  const last = msgs[msgs.length - 1];
  if(last) {
    last.querySelectorAll('.choice-wrap').forEach(w => {
      const card = w.querySelector('.choice-card');
      if(card) {
        if(card.dataset.label === label) {
          w.classList.add('selected');
          card.classList.add('selected');
        } else {
          card.classList.add('disabled');
        }
      }
    });
  }
  setTimeout(() => submitAnswer(label + ') ' + text), 400);
}

async function submitAnswer(answer) {
  clearOptions();
  addMessage('user', answer);
  chatHistory.push({ role:'user', text: answer });
  questionCount++;

  if(conversationState === 'interview') {
    addTypingIndicator();
    try {
      const history = chatHistory.map(m => `${m.role === 'user' ? 'User' : 'AgentSpark'}: ${m.text}`).join('\n');
      const prompt = `${history}\n\nThis was answer ${questionCount} of ${MAX_QUESTIONS}. Ask next question or finalize.`;
      const reply = await callGemini(getSystemPrompt(), prompt, `🎤 Interview · Q${questionCount} of ${MAX_QUESTIONS}`);
      removeTypingIndicator();

      // Parse JSON response
      let parsed = null;
      try {
        const jsonMatch = reply.match(/\{[\s\S]*\}/);
        if(jsonMatch) parsed = JSON.parse(jsonMatch[0]);
      } catch(e) { /* fallback below */ }

      if(parsed && parsed.complete) {
        // Interview complete
        if(parsed.summary) addMessage('ai', parsed.summary);
        chatHistory.push({ role:'ai', text: parsed.summary || 'Interview complete.' });
        conversationState = 'generating';
        renderProgressSteps(1);
        clearOptions();
        setTimeout(generateAgents, 1200);
      } else if(parsed && parsed.question && parsed.options) {
        // Valid question JSON — show question as AI message, options as cards
        addMessage('ai', parsed.question);
        chatHistory.push({ role:'ai', text: parsed.question });
        renderOptions(parsed);
      } else {
        // Fallback: show raw reply and try legacy parse
        addMessage('ai', reply);
        chatHistory.push({ role:'ai', text: reply });
        if(reply.includes('[INTERVIEW_COMPLETE]') || questionCount >= MAX_QUESTIONS) {
          conversationState = 'generating';
          renderProgressSteps(1);
          clearOptions();
          setTimeout(generateAgents, 1200);
        } else {
          renderOptionsLegacy(reply);
        }
      }
    } catch(err) {
      removeTypingIndicator();
      addMessage('ai', `Error: ${err.message}`);
    }
  }
}

function _buildChoiceCard(label, optText, impact) {
  const wrap = document.createElement('div');
  wrap.className = 'choice-wrap';

  const card = document.createElement('button');
  card.className = 'choice-card';
  card.dataset.label = label;

  const labelEl = document.createElement('span');
  labelEl.className = 'choice-label';
  labelEl.textContent = label;

  const textEl = document.createElement('span');
  textEl.className = 'choice-text';
  textEl.textContent = optText;

  card.appendChild(labelEl);
  card.appendChild(textEl);

  if(impact) {
    const infoBtn = document.createElement('button');
    infoBtn.className = 'choice-info-btn';
    infoBtn.title = 'Show details';
    infoBtn.textContent = 'ℹ️';
    const impactEl = document.createElement('div');
    impactEl.className = 'choice-impact';
    impactEl.textContent = impact;
    infoBtn.onclick = (e) => {
      e.stopPropagation();
      impactEl.classList.toggle('visible');
    };
    card.appendChild(infoBtn);
    wrap.appendChild(card);
    wrap.appendChild(impactEl);
  } else {
    wrap.appendChild(card);
  }

  card.onclick = () => selectOption(label, optText);
  return wrap;
}

function renderOptions(parsed) {
  // parsed is a JSON object: { question, options: [{label, text, impact}] }
  if(!parsed || !parsed.options) return;
  const panel = document.getElementById('question-panel');
  const panelText = document.getElementById('question-panel-text');
  const panelChoices = document.getElementById('question-panel-choices');
  if(!panel || !panelText || !panelChoices) return;

  // Show section badge if present
  let sectionBadge = panel.querySelector('.question-section-badge');
  if(!sectionBadge) {
    sectionBadge = document.createElement('div');
    sectionBadge.className = 'question-section-badge';
    panel.insertBefore(sectionBadge, panel.firstChild);
  }
  const sectionIcons = { Business: '💼', Frontend: '🎨', Backend: '⚙️' };
  if(parsed.section) {
    sectionBadge.textContent = (sectionIcons[parsed.section] || '') + ' ' + parsed.section;
    sectionBadge.style.display = 'inline-block';
  } else {
    sectionBadge.style.display = 'none';
  }

  panelText.textContent = parsed.question || '';
  panelChoices.innerHTML = '';
  parsed.options.forEach(opt => {
    panelChoices.appendChild(_buildChoiceCard(opt.label, opt.text, opt.impact || null));
  });
  panel.style.display = 'flex';

  const chatEl = document.getElementById('chat-messages');
  if(chatEl) chatEl.scrollTop = chatEl.scrollHeight;
}

function renderOptionsLegacy(text) {
  // Fallback for non-JSON AI responses
  const matches = [...text.matchAll(/([A-D])\)\s*(.+?)(?=\n[A-D]\)|$)/gs)];
  if(matches.length === 0) return;
  const panel = document.getElementById('question-panel');
  const panelText = document.getElementById('question-panel-text');
  const panelChoices = document.getElementById('question-panel-choices');
  if(!panel) return;
  panelText.textContent = '';
  panelChoices.innerHTML = '';
  matches.forEach(m => {
    const label = m[1];
    const full = m[2].trim().replace(/\n/g, ' ');
    const parts = full.split(/\s*\|\s*IMPACT:\s*/i);
    panelChoices.appendChild(_buildChoiceCard(label, parts[0].trim(), parts[1] ? parts[1].trim() : null));
  });
  panel.style.display = 'flex';
}

function clearOptions() {
  const panel = document.getElementById('question-panel');
  if(panel) panel.style.display = 'none';
  const panelChoices = document.getElementById('question-panel-choices');
  if(panelChoices) panelChoices.innerHTML = '';
}

async function generateScoring(history) {
  const lvl = t('levels').find(l => l.id === currentLevel);
  const scoringPrompt = `You are a project complexity analyst. Based on this interview about the app "${currentTopic}", generate a project scoring report.

Interview:
${history}

Chosen level: ${lvl ? lvl.name : currentLevel}

Respond ONLY with a JSON object, no markdown:
{
  "overallScore": 72,
  "overallLabel": "Medium-High Complexity",
  "metrics": [
    { "label": "Technical Complexity", "value": 80, "color": "#f2b90d" },
    { "label": "Business Complexity", "value": 60, "color": "#e05a1a" },
    { "label": "Integration Needs", "value": 70, "color": "#c49a0a" },
    { "label": "Scalability Demand", "value": 55, "color": "#7cc42a" }
  ],
  "risks": ["Risk 1 in 10 words max", "Risk 2", "Risk 3"],
  "levelMatch": "ok",
  "levelSuggestion": "Your chosen level matches the project complexity well.",
  "suggestedLevel": "${currentLevel}"
}

levelMatch must be: "ok", "upgrade", or "downgrade".
suggestedLevel must be one of: iskra, plomien, pozar, inferno.
Keep risks under 12 words each. Be specific to this project.
Language: ${lang === 'en' ? 'English' : 'Polish'}`;

  try {
    const raw = await callGemini('You are a project analyst. Return only JSON.', scoringPrompt, '📊 Scoring · Complexity analysis');
    const match = raw.match(/\{[\s\S]*\}/);
    if (!match) return null;
    return JSON.parse(match[0]);
  } catch(e) {
    console.warn('Scoring failed:', e);
    return null;
  }
}

function renderScoring(data) {
  if(!data) return;
  const panel = document.getElementById('scoring-panel');
  panel.style.display = 'block';

  const scoreColor = data.overallScore >= 75 ? 'var(--accent2)' : data.overallScore >= 50 ? '#f59e0b' : 'var(--success)';
  const isWarn = data.levelMatch !== 'ok';
  const suggestedLvl = t('levels').find(l => l.id === data.suggestedLevel);

  const _metricInfo = {
    'Technical Complexity':  { low: '0–40: Simple tech stack, mostly standard tools.', mid: '40–70: Custom logic, APIs or real-time features needed.', high: '70–100: Complex architecture, microservices or AI.' },
    'Business Complexity':   { low: '0–40: Straightforward model, few stakeholders.', mid: '40–70: Multiple user roles or revenue streams.', high: '70–100: Complex ops, compliance or multi-market.' },
    'Integration Needs':     { low: '0–40: Few or no external services required.', mid: '40–70: Several APIs like payments or auth needed.', high: '70–100: Heavy integrations, real-time data sync.' },
    'Scalability Demand':    { low: '0–40: Small user base, no scaling pressure.', mid: '40–70: Growth expected, some infrastructure planning.', high: '70–100: High traffic, distributed systems required.' },
  };
  const metricsHTML = (data.metrics || []).map(m => {
    const info = _metricInfo[m.label] || {};
    const tier = m.value < 40 ? info.low : m.value < 70 ? info.mid : info.high;
    const tipId = 'tip-' + m.label.replace(/\s+/g,'-');
    const infoBtn = tier ? '<button class="metric-info-btn" onclick="document.getElementById(\'' + tipId + '\').classList.toggle(\'visible\')" title="What does this mean?">\u2139\ufe0f</button>' : '';
    const tipDiv = tier ? '<div class="metric-tip" id="' + tipId + '">' + tier + '</div>' : '';
    return '<div class="score-metric">'
      + '<div class="score-metric-label">' + m.label + infoBtn + '</div>'
      + tipDiv
      + '<div class="score-metric-bar"><div class="score-metric-fill" style="width:0%;background:' + m.color + '" data-target="' + m.value + '"></div></div>'
      + '<div class="score-metric-value">' + m.value + '/100</div>'
      + '</div>';
  }).join('');

  const risksHTML = (data.risks || []).map(r => `<div class="risk-item">${r}</div>`).join('');
  const suggestionIcon = data.levelMatch === 'upgrade' ? '⬆' : data.levelMatch === 'downgrade' ? '⬇' : '✓';

  panel.innerHTML = `
    <div class="scoring-header">
      <h3>${lang==='en' ? 'PROJECT SCORING' : 'OCENA PROJEKTU'}</h3>
      <div class="score-badge">
        <div class="score-number" style="color:${scoreColor}">${data.overallScore}</div>
        <div class="score-label"><strong>${data.overallLabel}</strong>${lang==='en'?'out of 100':'na 100'}</div>
      </div>
    </div>
    <div class="scoring-grid">${metricsHTML}</div>
    ${risksHTML ? `<div class="scoring-risks"><h4>${lang==='en'?'⚠ POTENTIAL RISKS':'⚠ POTENCJALNE RYZYKA'}</h4>${risksHTML}</div>` : ''}
    <div class="level-suggestion ${isWarn ? 'warn' : ''}">
      <span class="ls-icon">${suggestionIcon}</span>
      <span>${data.levelSuggestion}${suggestedLvl && isWarn ? ' <strong>→ ' + suggestedLvl.name + '</strong>' : ''}</span>
    </div>
  `;

  // Single-frame rAF to trigger CSS transition after DOM paint
  requestAnimationFrame(() => {
    if(!document.getElementById('screen-results').classList.contains('active')) return;
    panel.querySelectorAll('.score-metric-fill').forEach(bar => {
      setTimeout(() => { bar.style.width = (bar.dataset.target || 0) + '%'; }, 100);
    });
  });
}

async function generateAgents() {
  addTypingIndicator();
  const history = chatHistory.map(m => `${m.role === 'user' ? 'User' : 'AgentSpark'}: ${m.text}`).join('\n');
  const prompt = `Here is the complete interview:\n${history}\n\n[GENERATE]\nGenerate the agent team JSON now based on the interview.`;

  try {
    const levelData = t('levels').find(l => l.id === currentLevel) || t('levels')[0];
    const raw = await callGemini(getSystemPrompt(), prompt, `⚡ Generate Team · ${levelData.agentCount} agents · ${currentLevel}`);
    removeTypingIndicator();

    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if(!jsonMatch) throw new Error('Could not parse agent data');
    const data = JSON.parse(jsonMatch[0]);

    generatedAgents = data.agents || [];
    generatedFiles = {};

    generatedAgents.forEach(a => {
      generatedFiles[`agent-${a.id}.md`] = a.agentMd || `# Agent: ${a.name}\n\n**Role:** ${a.role || ''}\n\n${a.description || ''}`;
      generatedFiles[`skill-${a.id}.md`] = a.skillMd || `# Skill: ${a.name}\n\n## Capabilities\n\n${a.description || ''}`;
    });
    generatedFiles['team-config.md'] = data.teamConfig || `# Team Configuration\n\n**Project:** ${currentTopic}\n\n## Agents\n\n${generatedAgents.map(a => `- **${a.name}** (${a.role || a.id})`).join('\n')}`;
    generatedFiles['README.md'] = generateReadme();

    window._scoringData = undefined;
    const historyForScoring = chatHistory.map(m => `${m.role === 'user' ? 'User' : 'AgentSpark'}: ${m.text}`).join('\n');
    generateScoring(historyForScoring).then(scoreData => {
      window._scoringData = scoreData;
    });

    renderProgressSteps(3);
    addMessage('ai', lang==='en'
      ? `✅ Done! I've designed ${generatedAgents.length} specialized agents for your "${currentTopic}" app. Your files are ready — switching to results view now!`
      : `✅ Gotowe! Zaprojektowałem ${generatedAgents.length} wyspecjalizowanych agentów dla Twojej aplikacji "${currentTopic}". Pliki są gotowe — przechodzę do widoku wyników!`
    );

    setTimeout(() => {
      // Seed v1 "Origin" snapshot
      versionHistory = [];
      versionHistory.push({
        id: Date.now(),
        label: lang === 'en' ? `Original team — ${currentTopic}` : `Oryginalny zespół — ${currentTopic}`,
        ts: new Date(),
        agents: JSON.parse(JSON.stringify(generatedAgents)),
        files: JSON.parse(JSON.stringify(generatedFiles)),
        diff: { added: [], removed: [], changed: [] },
        removedNames: {},
        agentNames: Object.fromEntries(generatedAgents.map(a => [a.id, a.name])),
        vNum: 1,
        isOrigin: true,
      });
      showResults();
    }, 1800);
  } catch(err) {
    removeTypingIndicator();
    addMessage('ai', `Generation error: ${err.message}. Please try again.`);
  }
}

function generateReadme() {
  const technical = generatedAgents.filter(a => a.type === 'technical');
  const business  = generatedAgents.filter(a => a.type !== 'technical');
  const techList = technical.map(a => `- **${a.name}** [TECHNICAL] (${a.role}): ${a.description}`).join('\n');
  const bizList  = business.map(a  => `- **${a.name}** [BUSINESS] (${a.role}): ${a.description}`).join('\n');
  const lvl = t('levels').find(l => l.id === currentLevel);
  return `# AgentSpark — Generated Team\n\n**Project:** ${currentTopic}\n**Level:** ${lvl ? lvl.name : currentLevel}\n**Generated:** ${new Date().toLocaleString()}\n**Language:** ${lang.toUpperCase()}\n\n## ⚙️ Technical Agents\n\n${techList || 'none'}\n\n## 💼 Business Agents\n\n${bizList || 'none'}\n\n## Files\n\n${Object.keys(generatedFiles).filter(f=>f!=='README.md').map(f=>`- \`${f}\``).join('\n')}\n\n## How to use\n\nSee instructions inside the app or visit antigravity.google\n`;
}


// ─── DEPENDENCY GRAPH ────────────────────────────────────
let graphNodes = [];
let graphEdges = [];
let graphAnimFrame = null;

function buildGraphFromAgents() {
  const agents = generatedAgents;
  if(!agents.length) return;

  const canvas = document.getElementById('agent-graph');
  if(!canvas) return;

  // Cancel any running animation before rebuilding
  if(graphAnimFrame) {
    cancelAnimationFrame(graphAnimFrame);
    graphAnimFrame = null;
  }
  const W = canvas.offsetWidth || 800;
  const H = 400;
  canvas.width = W;
  canvas.height = H;

  const cx = W / 2, cy = H / 2;
  const radius = Math.min(W, H) * 0.33;

  const tech = agents.filter(a => a.type === 'technical');
  const biz  = agents.filter(a => a.type !== 'technical');

  graphNodes = [];

  tech.forEach((a, i) => {
    const angle = (Math.PI * 0.8) + (i / Math.max(tech.length - 1, 1)) * Math.PI * 0.8 - Math.PI * 0.4;
    graphNodes.push({
      id: a.id, label: a.name, emoji: a.emoji || '⚙',
      type: 'technical',
      x: cx - radius * 0.6 + Math.cos(angle) * radius * 0.5,
      y: cy + Math.sin(angle) * radius * 0.7,
      vx: 0, vy: 0, r: 28
    });
  });

  biz.forEach((a, i) => {
    const angle = (Math.PI * 0.1) + (i / Math.max(biz.length - 1, 1)) * Math.PI * 0.8 - Math.PI * 0.4;
    graphNodes.push({
      id: a.id, label: a.name, emoji: a.emoji || '💼',
      type: 'business',
      x: cx + radius * 0.6 + Math.cos(angle) * radius * 0.5,
      y: cy + Math.sin(angle) * radius * 0.7,
      vx: 0, vy: 0, r: 28
    });
  });

  graphEdges = [];
  for(let i = 0; i < tech.length - 1; i++) {
    graphEdges.push({ from: tech[i].id, to: tech[i+1].id, label: 'pipeline', style: 'tech' });
  }
  biz.forEach(b => {
    tech.forEach(tn => {
      graphEdges.push({ from: b.id, to: tn.id, label: 'context', style: 'biz' });
    });
  });

  drawGraph();
}

function drawGraph() {
  const canvas = document.getElementById('agent-graph');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  ctx.clearRect(0, 0, W, H);

  ctx.strokeStyle = 'rgba(242,185,13,0.04)';
  ctx.lineWidth = 1;
  for(let x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for(let y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

  graphEdges.forEach(edge => {
    const from = graphNodes.find(n => n.id === edge.from);
    const to   = graphNodes.find(n => n.id === edge.to);
    if(!from || !to) return;

    const isBiz = edge.style === 'biz';
    const color = isBiz ? 'rgba(255,107,53,0.35)' : 'rgba(242,185,13,0.4)';

    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = isBiz ? 1.5 : 2;
    if(isBiz) ctx.setLineDash([4, 4]);
    else ctx.setLineDash([]);

    const mx = (from.x + to.x) / 2;
    const my = (from.y + to.y) / 2 - 30;
    ctx.moveTo(from.x, from.y);
    ctx.quadraticCurveTo(mx, my, to.x, to.y);
    ctx.stroke();
    ctx.setLineDash([]);

    const angle = Math.atan2(to.y - my, to.x - mx);
    const arrowLen = 8;
    ctx.beginPath();
    ctx.fillStyle = color.replace('0.35','0.7').replace('0.4','0.8');
    ctx.moveTo(to.x, to.y);
    ctx.lineTo(to.x - arrowLen * Math.cos(angle - 0.4), to.y - arrowLen * Math.sin(angle - 0.4));
    ctx.lineTo(to.x - arrowLen * Math.cos(angle + 0.4), to.y - arrowLen * Math.sin(angle + 0.4));
    ctx.closePath();
    ctx.fill();
  });

  graphNodes.forEach(node => {
    const isTech = node.type === 'technical';
    const color  = isTech ? '#f2b90d' : '#e05a1a';
    const glow   = isTech ? 'rgba(242,185,13,0.25)' : 'rgba(224,90,26,0.22)';

    ctx.beginPath();
    ctx.arc(node.x, node.y, node.r + 8, 0, Math.PI * 2);
    ctx.fillStyle = glow;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(node.x, node.y, node.r, 0, Math.PI * 2);
    ctx.fillStyle = isTech ? 'rgba(196,147,10,0.2)' : 'rgba(255,107,53,0.15)';
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.font = '16px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(node.emoji, node.x, node.y - 2);

    const maxW = 90;
    const words = node.label.split(' ');
    let line = '', lines = [];
    words.forEach(w => {
      const test = line + (line ? ' ' : '') + w;
      ctx.font = 'bold 10px Manrope, sans-serif';
      if(ctx.measureText(test).width > maxW && line) {
        lines.push(line); line = w;
      } else { line = test; }
    });
    lines.push(line);

    ctx.fillStyle = '#f0ead8';
    ctx.font = 'bold 10px Manrope, sans-serif';
    lines.forEach((l, i) => {
      ctx.fillText(l, node.x, node.y + node.r + 12 + i * 13);
    });
  });

  graphAnimFrame = requestAnimationFrame(drawGraphPulse);
}

let pulseT = 0;
function drawGraphPulse() {
  pulseT += 0.02;
  const canvas = document.getElementById('agent-graph');
  if(!canvas || !document.getElementById('screen-results').classList.contains('active')) return;

  // Full redraw each frame so glows don't accumulate
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  // Background grid
  ctx.strokeStyle = 'rgba(242,185,13,0.04)';
  ctx.lineWidth = 1;
  for(let x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for(let y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

  // Edges
  graphEdges.forEach(edge => {
    const from = graphNodes.find(n => n.id === edge.from);
    const to   = graphNodes.find(n => n.id === edge.to);
    if(!from || !to) return;
    const isBiz = edge.style === 'biz';
    const color = isBiz ? 'rgba(255,107,53,0.35)' : 'rgba(242,185,13,0.4)';
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = isBiz ? 1.5 : 2;
    if(isBiz) ctx.setLineDash([4, 4]);
    else ctx.setLineDash([]);
    const mx = (from.x + to.x) / 2;
    const my = (from.y + to.y) / 2 - 30;
    ctx.moveTo(from.x, from.y);
    ctx.quadraticCurveTo(mx, my, to.x, to.y);
    ctx.stroke();
    ctx.setLineDash([]);
    const angle = Math.atan2(to.y - my, to.x - mx);
    const arrowLen = 8;
    ctx.beginPath();
    ctx.fillStyle = color.replace('0.35','0.7').replace('0.4','0.8');
    ctx.moveTo(to.x, to.y);
    ctx.lineTo(to.x - arrowLen * Math.cos(angle - 0.4), to.y - arrowLen * Math.sin(angle - 0.4));
    ctx.lineTo(to.x - arrowLen * Math.cos(angle + 0.4), to.y - arrowLen * Math.sin(angle + 0.4));
    ctx.closePath();
    ctx.fill();
  });

  // Nodes with pulse
  graphNodes.forEach(node => {
    const isTech = node.type === 'technical';
    const color  = isTech ? '#f2b90d' : '#e05a1a';
    const phase  = pulseT + (isTech ? 0 : Math.PI);
    const pulse  = Math.sin(phase) * 3;
    const glowA  = 0.15 + Math.abs(Math.sin(phase)) * 0.12;
    const glow   = isTech ? `rgba(196,147,10,${glowA})` : `rgba(255,107,53,${glowA * 0.85})`;

    ctx.beginPath();
    ctx.arc(node.x, node.y, node.r + 8 + pulse, 0, Math.PI * 2);
    ctx.fillStyle = glow;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(node.x, node.y, node.r, 0, Math.PI * 2);
    ctx.fillStyle = isTech ? 'rgba(196,147,10,0.2)' : 'rgba(255,107,53,0.15)';
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.font = '16px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(node.emoji, node.x, node.y - 2);

    const maxW = 90;
    const words = node.label.split(' ');
    let line = '', lines = [];
    words.forEach(w => {
      ctx.font = 'bold 10px Manrope, sans-serif';
      const test = line + (line ? ' ' : '') + w;
      if(ctx.measureText(test).width > maxW && line) { lines.push(line); line = w; }
      else { line = test; }
    });
    lines.push(line);
    ctx.fillStyle = '#f0ead8';
    ctx.font = 'bold 10px Manrope, sans-serif';
    lines.forEach((l, i) => ctx.fillText(l, node.x, node.y + node.r + 12 + i * 13));
  });

  graphAnimFrame = requestAnimationFrame(drawGraphPulse);
}


// ─── REFINE MODE ─────────────────────────────────────────────
let refineSnapshots = [];      // legacy — kept for revertLastRefine compat
let versionHistory  = [];      // rich version objects: { id, label, ts, agents, files, diff }
let selectedRefineAction = null;
let versionPanelOpen = false;

// ─── TRACE STATE ──────────────────────────────────────────
let traceSpans = [];           // all recorded API spans
let tracePanelOpen = false;
let traceSessionStart = null;  // epoch ms of first span in current session

function openRefine() {
  const panel = document.getElementById('refine-panel');
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

  document.getElementById('refine-title').textContent = t('refineTitle');
  document.getElementById('refine-sub').textContent = t('refineSub');
  document.getElementById('refine-input').placeholder = t('refinePlaceholder');
  document.getElementById('refine-submit-label').textContent = t('refineApply');

  const chips = document.getElementById('refine-action-chips');
  chips.innerHTML = '';
  t('refineActions').forEach(action => {
    const chip = document.createElement('button');
    chip.className = 'refine-chip' + (selectedRefineAction === action.id ? ' active' : '');
    chip.dataset.id = action.id;
    chip.innerHTML = `<span>${action.emoji}</span><span>${action.label}</span>`;
    chip.title = action.desc;
    chip.onclick = () => {
      selectedRefineAction = action.id;
      chips.querySelectorAll('.refine-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      const ta = document.getElementById('refine-input');
      if(!ta.value.trim()) {
        const hints = {
          improve: lang === 'en' ? 'Improve overall agent descriptions and add more specific skills...' : 'Ulepsz opisy agentów i dodaj bardziej szczegółowe umiejętności...',
          add: lang === 'en' ? 'Add a [type] agent that handles [responsibility]...' : 'Dodaj agenta [typ] który zajmuje się [odpowiedzialność]...',
          remove: lang === 'en' ? 'Remove the [agent name] agent and redistribute its responsibilities...' : 'Usuń agenta [nazwa] i redystrybuuj jego obowiązki...',
          connections: lang === 'en' ? 'Change the connection so that [agent A] sends results directly to [agent B]...' : 'Zmień połączenie tak żeby [agent A] wysyłał wyniki bezpośrednio do [agent B]...',
        };
        ta.value = '';
        ta.placeholder = hints[action.id] || t('refinePlaceholder');
      }
      ta.focus();
    };
    chips.appendChild(chip);
  });

  updateRefineCounter();
}

function closeRefine() {
  document.getElementById('refine-panel').style.display = 'none';
  selectedRefineAction = null;
  // If panel is closed mid-request, unlock state so user can refine again later
  if(isRefining) {
    isRefining = false;
    document.getElementById('refine-submit-btn').disabled = false;
    removeRefineThinking();
  }
}

function updateRefineCounter() {
  const count = refineSnapshots.length;
  const counter = document.getElementById('refine-counter');
  const revertBtn = document.getElementById('refine-revert-btn');
  // ── FIX: was missing quotes around 'ę' causing SyntaxError ──
  if(lang === 'pl') {
    const suffix = count === 1 ? 'ę' : count > 1 && count < 5 ? 'e' : 'i';
    counter.textContent = count > 0 ? `Wykonano ${count} rewizj${suffix}` : '';
  } else {
    counter.textContent = count > 0 ? `${count} revision${count > 1 ? 's' : ''} made` : '';
  }
  revertBtn.style.display = count > 0 ? 'block' : 'none';
}

function addRefineMessage(role, html) {
  const history = document.getElementById('refine-history');
  const div = document.createElement('div');
  div.className = `refine-msg ${role}`;
  div.innerHTML = `
    <div class="refine-msg-sender">${role === 'ai' ? '⚡ AgentSpark' : (lang === 'en' ? 'You' : 'Ty')}</div>
    <div class="refine-bubble">${html}</div>
  `;
  history.appendChild(div);
  history.scrollTop = history.scrollHeight;
}

function addRefineThinking() {
  const history = document.getElementById('refine-history');
  const div = document.createElement('div');
  div.className = 'refine-msg ai';
  div.id = 'refine-thinking-indicator';
  div.innerHTML = `
    <div class="refine-msg-sender">⚡ AgentSpark</div>
    <div class="refine-bubble">
      <div class="refine-thinking">
        <span>${t('refineThinking')}</span>
        <span class="thinking-dots"><span></span><span></span><span></span></span>
      </div>
    </div>
  `;
  history.appendChild(div);
  history.scrollTop = history.scrollHeight;
}

function removeRefineThinking() {
  const el = document.getElementById('refine-thinking-indicator');
  if(el) el.remove();
}

function getRefineSystemPrompt() {
  const lvl = t('levels').find(l => l.id === currentLevel);
  const currentTeamJSON = JSON.stringify(generatedAgents.map(a => ({
    id: a.id, name: a.name, type: a.type, role: a.role, description: a.description
  })), null, 2);

  return `You are AgentSpark, an expert AI system designer in REFINE mode.
Language: ${lang === 'en' ? 'English' : 'Polish'}
App topic: ${currentTopic}
Complexity level: ${lvl ? lvl.name : currentLevel}

CURRENT TEAM:
${currentTeamJSON}

The user wants to modify their agent team. Apply their requested changes and return the complete updated team as JSON.

RESPONSE FORMAT — two parts:
1. A brief human-readable summary of what changed (1-3 sentences), using these tags for changes:
   - New agent: <span class="refine-diff-added">+AgentName</span>
   - Removed: <span class="refine-diff-removed">-AgentName</span>  
   - Modified: <span class="refine-diff-changed">~AgentName</span>

2. Then the full updated JSON (same format as original generation):
[UPDATED_TEAM]
{
  "agents": [...complete updated agents array with all fields: id, name, emoji, type, role, description, agentMd, skillMd...],
  "teamConfig": "...updated team config md..."
}

RULES:
- Always return the COMPLETE agents array, not just changed agents
- Keep unchanged agents exactly as they are
- New agents must follow same structure (id, name, emoji, type, role, description, agentMd, skillMd)
- type must be "technical" or "business"
- agentMd and skillMd must be full detailed markdown, not placeholders
- The [UPDATED_TEAM] marker must appear on its own line`;
}

async function submitRefine() {
  const input = document.getElementById('refine-input');
  const text = input.value.trim();
  if(!text || isRefining) return;

  const actionCtx = selectedRefineAction ? `[Action: ${selectedRefineAction}] ` : '';
  const fullRequest = actionCtx + text;

  input.value = '';
  isRefining = true;
  document.getElementById('refine-submit-btn').disabled = true;

  addRefineMessage('user', text);
  addRefineThinking();

  refineSnapshots.push(JSON.parse(JSON.stringify({ agents: generatedAgents, files: generatedFiles })));

  // Save rich version BEFORE we mutate state
  const preSnap = JSON.parse(JSON.stringify({ agents: generatedAgents, files: generatedFiles }));

  try {
    const history = refineHistory.map(m => `${m.role === 'user' ? 'User' : 'AI'}: ${m.text}`).join('\n');
    const prompt = history
      ? `Previous context:\n${history}\n\nNew request: ${fullRequest}`
      : `Request: ${fullRequest}`;

    const refineActionEmoji = { improve:'⚡', add:'➕', remove:'🗑', connections:'🔗' };
    const refineEmoji = refineActionEmoji[selectedRefineAction] || '✏️';
    const refineVer   = versionHistory.length + 1;
    const raw = await callGemini(getRefineSystemPrompt(), prompt, `${refineEmoji} Refine · v${refineVer}${selectedRefineAction ? ' · ' + selectedRefineAction : ''}`);
    removeRefineThinking();

    const markerIdx = raw.indexOf('[UPDATED_TEAM]');
    let summary = '', jsonPart = '';

    if(markerIdx !== -1) {
      summary = raw.slice(0, markerIdx).trim();
      jsonPart = raw.slice(markerIdx + '[UPDATED_TEAM]'.length).trim();
    } else {
      const jsonMatch = raw.match(/\{[\s\S]*"agents"[\s\S]*\}/);
      if(jsonMatch) {
        jsonPart = jsonMatch[0];
        summary = raw.slice(0, raw.indexOf(jsonMatch[0])).trim() || (lang === 'en' ? 'Team updated.' : 'Zespół zaktualizowany.');
      } else {
        throw new Error(lang === 'en' ? 'Could not parse updated team.' : 'Nie udało się przetworzyć zaktualizowanego zespołu.');
      }
    }

    const jsonMatch = jsonPart.match(/\{[\s\S]*\}/);
    if(!jsonMatch) throw new Error('No JSON in response');
    const data = JSON.parse(jsonMatch[0]);

    if(!data.agents || !Array.isArray(data.agents)) throw new Error('Invalid agents data');

    const prevIds = new Set(generatedAgents.map(a => a.id));
    const newIds  = new Set(data.agents.map(a => a.id));
    const addedIds   = [...newIds].filter(id => !prevIds.has(id));
    const removedIds = [...prevIds].filter(id => !newIds.has(id));
    const changedIds = [...newIds].filter(id => prevIds.has(id) && JSON.stringify(data.agents.find(a=>a.id===id)) !== JSON.stringify(generatedAgents.find(a=>a.id===id)));

    // Capture removed agent names BEFORE overwriting generatedAgents
    const removedNames = Object.fromEntries(
      removedIds.map(id => [id, generatedAgents.find(a => a.id === id)?.name || id])
    );

    generatedAgents = data.agents;

    data.agents.forEach(a => {
      generatedFiles[`agent-${a.id}.md`] = a.agentMd || `# Agent: ${a.name}\n\n**Role:** ${a.role || ''}\n\n${a.description || ''}`;
      generatedFiles[`skill-${a.id}.md`] = a.skillMd || `# Skill: ${a.name}\n\n## Capabilities\n\n${a.description || ''}`;
    });
    removedIds.forEach(id => {
      delete generatedFiles[`agent-${id}.md`];
      delete generatedFiles[`skill-${id}.md`];
    });
    if(data.teamConfig) generatedFiles['team-config.md'] = data.teamConfig;
    generatedFiles['README.md'] = generateReadme();

    refineHistory.push({ role: 'user', text: fullRequest });
    refineHistory.push({ role: 'ai', text: summary });

    // ── Save version snapshot ──────────────────────────────
    const vNum = versionHistory.length + 2; // v1 = origin, v2+ = refines
    versionHistory.push({
      id: Date.now(),
      label: text.length > 60 ? text.slice(0, 57) + '…' : text,
      ts: new Date(),
      agents: JSON.parse(JSON.stringify(generatedAgents)),
      files: JSON.parse(JSON.stringify(generatedFiles)),
      diff: { added: addedIds, removed: removedIds, changed: changedIds },
      removedNames,
      agentNames: Object.fromEntries(data.agents.map(a => [a.id, a.name])),
      vNum,
    });
    renderVersionPanel();

    const diffBadges = [
      ...addedIds.map(id => `<span class="refine-diff-added">+${data.agents.find(a=>a.id===id)?.name || id}</span>`),
      ...removedIds.map(id => `<span class="refine-diff-removed">-${removedNames[id]}</span>`),
      ...changedIds.map(id => `<span class="refine-diff-changed">~${data.agents.find(a=>a.id===id)?.name || id}</span>`),
    ].join(' ');

    addRefineMessage('ai', (summary || '') + (diffBadges ? '<br/><br/>' + diffBadges : ''));

    updateRefineCounter();

    showResults(true);
    scheduleAutoSave(); // auto-save after refine (#1)

    setTimeout(() => {
      addedIds.forEach(id => {
        const card = document.querySelector(`[data-agent-id="${id}"]`);
        if(card) card.classList.add('just-added');
      });
      changedIds.forEach(id => {
        const card = document.querySelector(`[data-agent-id="${id}"]`);
        if(card) card.classList.add('just-updated');
      });
    }, 150);

    setTimeout(() => buildGraphFromAgents(), 300);

    showNotif(lang === 'en' ? '✓ Team updated!' : '✓ Zespół zaktualizowany!');

  } catch(err) {
    removeRefineThinking();
    const snap = refineSnapshots.pop();
    if(snap) { generatedAgents = snap.agents; generatedFiles = snap.files; }
    addRefineMessage('ai', `<span style="color:var(--accent2)">⚠ ${err.message}</span>`);
    showNotif(lang === 'en' ? '⚠ Refine failed, reverted.' : '⚠ Błąd, przywrócono poprzedni stan.', true);
  }

  isRefining = false;
  document.getElementById('refine-submit-btn').disabled = false;
}

function revertLastRefine() {
  if(!refineSnapshots.length) return;
  const snap = refineSnapshots.pop();
  generatedAgents = snap.agents;
  generatedFiles = snap.files;
  refineHistory = refineHistory.slice(0, -2);
  updateRefineCounter();
  showResults(true);
  buildGraphFromAgents();
  addRefineMessage('ai', lang === 'en' ? '↩ Reverted to previous version.' : '↩ Przywrócono poprzednią wersję.');
  showNotif(lang === 'en' ? '↩ Reverted.' : '↩ Przywrócono.');
}

// ─── RESULTS SCREEN ───────────────────────────────────────
function showResults(skipReset = false) {
  showScreen('results');
  _updateContextBar('results');
  // Show skeleton while agents render
  if (!skipReset) _renderSkeletonCards(4);

  document.getElementById('result-badge').textContent = t('resultBadge');
  document.getElementById('result-title').textContent = t('resultTitle');
  document.getElementById('result-sub').textContent = t('resultSub');
  document.getElementById('download-btn').textContent = t('downloadBtn');
  document.getElementById('instr-btn').textContent = t('instrBtn');
  document.getElementById('refine-btn').textContent = t('refineBtn');
  document.getElementById('md-preview-btn').textContent = lang === 'en' ? '📄 Preview Docs' : '📄 Podgląd Docs';
  document.getElementById('fw-export-btn').textContent = lang === 'en' ? '🚀 Export Framework' : '🚀 Eksport Framework';

  renderVersionPanel();
  renderTraceLive();

  if(!skipReset) {
    refineHistory = [];
    isRefining = false;
    refineSnapshots = [];
    selectedRefineAction = null;
    document.getElementById('refine-panel').style.display = 'none';
    document.getElementById('refine-history').innerHTML = '';
  }

  const lvl = t('levels').find(l => l.id === currentLevel);
  if(lvl) {
    document.getElementById('result-badge').textContent = lvl.emoji + ' ' + lvl.name.toUpperCase() + ' — ' + t('resultBadge');
    document.getElementById('result-badge').style.borderColor = lvl.color + '66';
    document.getElementById('result-badge').style.color = lvl.color;
  }

  if(!skipReset) {
    let scoringAttempts = 0;
    const tryRenderScoring = () => {
      scoringAttempts++;
      if(window._scoringData !== undefined) {
        renderScoring(window._scoringData);
      } else if(scoringAttempts < 30) {
        setTimeout(tryRenderScoring, 400);
      }
      // silently give up after 12s — scoring is non-critical
    };
    setTimeout(tryRenderScoring, 300);
  }

  // Always ensure graph section is visible when results are shown
  document.getElementById('graph-title').textContent = lang==='en' ? 'Agent Dependency Graph' : 'Graf Zależności Agentów';
  document.getElementById('graph-section').style.display = 'block';

  // Auto-save hook (#1)
  _onAgentsReady();

  const grid = document.getElementById('agents-grid');
  grid.innerHTML = '';

  const technical = generatedAgents.filter(a => a.type === 'technical');
  const business  = generatedAgents.filter(a => a.type !== 'technical');

  function makeAgentCard(agent) {
    const isTech = agent.type === 'technical';
    const card = document.createElement('div');
    card.className = 'agent-card';
    card.dataset.type = agent.type || 'technical';
    card.dataset.agentId = agent.id;
    card.innerHTML = `
      <div class="agent-card-header">
        <div class="agent-avatar" style="background:${isTech ? 'linear-gradient(145deg,#c49a0a,#f2b90d)' : 'linear-gradient(145deg,#c44010,#e05a1a)'}">${agent.emoji || '🤖'}</div>
        <div class="agent-card-meta">
          <div class="agent-name">${agent.name}</div>
          <div class="agent-role">${agent.role}</div>
          <div class="agent-type-badge ${isTech ? 'badge-tech' : 'badge-biz'}" style="display:inline-block;margin-top:0.4rem;">${isTech ? (lang==='en'?'Technical':'Techniczny') : (lang==='en'?'Business':'Biznesowy')}</div>
        </div>
      </div>
      <div class="agent-card-divider"></div>
      <div class="agent-card-body">
        <div class="agent-desc">${agent.description}</div>
        <div class="file-chips-group">
          <span class="file-chips-label">Files</span>
          <div class="file-chips">
            <div class="file-chip" tabindex="0" role="button" onclick="previewFile('agent-${agent.id}.md')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();previewFile('agent-${agent.id}.md')}">agent-${agent.id}.md</div>
            <div class="file-chip" tabindex="0" role="button" onclick="previewFile('skill-${agent.id}.md')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();previewFile('skill-${agent.id}.md')}">skill-${agent.id}.md</div>
          </div>
        </div>
      </div>
    `;
    card.tabIndex = 0;
    card.setAttribute('role', 'article');
    card.setAttribute('aria-label', `${agent.name} — ${agent.role}`);
    return card;
  }

  function makeSection(title, icon, agents, colorClass) {
    if(agents.length === 0) return;
    const section = document.createElement('div');
    section.className = 'agent-section';
    section.innerHTML = `<div class="agent-section-header ${colorClass}"><span>${icon}</span><span>${title}</span><span class="section-count">${agents.length}</span></div>`;
    const sg = document.createElement('div');
    sg.className = 'agents-grid';
    agents.forEach(a => sg.appendChild(makeAgentCard(a)));
    section.appendChild(sg);
    grid.appendChild(section);
  }

  makeSection(
    lang==='en' ? 'Technical Agents — Build your app' : 'Agenci Techniczni — Budują aplikację',
    '⚙️', technical, 'section-tech'
  );
  makeSection(
    lang==='en' ? 'Business Agents — Shape your vision' : 'Agenci Biznesowi — Nadają kontekst',
    '💼', business, 'section-biz'
  );

  const configWrap = document.createElement('div');
  configWrap.className = 'agent-section';
  configWrap.innerHTML = `<div class="agent-section-header section-config"><span>🔗</span><span>${lang==='en'?'Team Configuration':'Konfiguracja Zespołu'}</span></div>`;
  const configGrid = document.createElement('div');
  configGrid.className = 'agents-grid';
  const configCard = document.createElement('div');
  configCard.className = 'agent-card';
  configCard.innerHTML = `
    <div class="agent-card-header">
      <div class="agent-avatar" style="background:linear-gradient(145deg,#2a2510,#3a3218)">🔗</div>
      <div class="agent-card-meta">
        <div class="agent-name">${lang==='en' ? 'Team Configuration' : 'Konfiguracja Zespołu'}</div>
        <div class="agent-role">Orchestration</div>
      </div>
    </div>
    <div class="agent-card-divider"></div>
    <div class="agent-card-body">
      <div class="agent-desc">${lang==='en' ? 'Defines how all agents connect and collaborate.' : 'Definiuje jak agenci się łączą i współpracują.'}</div>
      <div class="file-chips-group">
        <span class="file-chips-label">Files</span>
        <div class="file-chips">
          <div class="file-chip" onclick="previewFile('team-config.md')">team-config.md</div>
          <div class="file-chip" onclick="previewFile('README.md')">README.md</div>
        </div>
      </div>
    </div>
  `;
  configGrid.appendChild(configCard);
  configWrap.appendChild(configGrid);
  grid.appendChild(configWrap);
  // Sync FAB after agents rendered
  _syncFab();

  setTimeout(() => {
    buildGraphFromAgents();
    const gc = document.querySelector('.graph-container');
    if(gc && !gc.querySelector('.graph-legend')) {
      const leg = document.createElement('div');
      leg.className = 'graph-legend';
      leg.innerHTML = `
        <span><div class="legend-dot" style="background:#f2b90d"></div>${lang==='en'?'Technical agent':'Agent techniczny'}</span>
        <span><div class="legend-dot" style="background:#e05a1a"></div>${lang==='en'?'Business agent':'Agent biznesowy'}</span>
        <span style="font-size:0.65rem;margin-left:auto;color:var(--muted)">— — ${lang==='en'?'context flow':'przepływ kontekstu'} &nbsp;&nbsp;—— ${lang==='en'?'pipeline':'pipeline'}</span>
      `;
      gc.appendChild(leg);
    }
  }, 100);
}

function showInstructions() {
  const section = document.getElementById('instructions-section');
  const isHidden = getComputedStyle(section).display === 'none';
  section.style.display = isHidden ? 'block' : 'none';
  if(isHidden) {
    document.getElementById('instr-title').textContent = t('instrTitle');
    const steps = document.getElementById('instr-steps');
    steps.innerHTML = '';
    t('instrSteps').forEach((step, i) => {
      const div = document.createElement('div');
      div.className = 'instruction-step';
      div.innerHTML = `<div class="num">0${i+1}</div><div class="content"><strong>${step.title}</strong><p>${step.body}</p></div>`;
      steps.appendChild(div);
    });
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

async function downloadZip() {
  if(typeof JSZip === 'undefined') {
    showNotif('JSZip not loaded', true); return;
  }
  const zip = new JSZip();
  Object.entries(generatedFiles).forEach(([name, content]) => {
    zip.file(name, content);
  });
  // Embed project manifest for lossless re-import (#4)
  const manifest = {
    v: 2,
    source: 'agentspark',
    topic: currentTopic,
    level: currentLevel,
    lang,
    agents: generatedAgents,
    files: generatedFiles,
    ts: Date.now(),
  };
  zip.file('agentspark.json', JSON.stringify(manifest, null, 2));
  const blob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `agentspark-${currentTopic.toLowerCase().replace(/\s+/g,'-')}.zip`;
  a.click();
  showNotif(lang==='en' ? '✓ ZIP downloaded successfully!' : '✓ ZIP pobrany pomyślnie!');
}

// ─── MARKDOWN RENDERER ───────────────────────────────────
function renderMarkdown(md) {
  if(!md) return '';

  // Step 1: Extract fenced code blocks and inline code before ANY other processing
  // so that their content is never HTML-escaped or regex-mangled
  const codeBlocks = [];
  const inlineCodes = [];

  let text = md
    // Fenced code blocks: save content raw, replace with placeholder
    .replace(/```([\w]*)\n?([\s\S]*?)```/g, (_, lang, code) => {
      const escaped = code.trim()
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const idx = codeBlocks.length;
      codeBlocks.push(`<pre><code>${escaped}</code></pre>`);
      return `\x02CODE_BLOCK_${idx}\x03`;
    })
    // Inline code: save raw, replace with placeholder
    .replace(/`([^`\n]+)`/g, (_, code) => {
      const escaped = code
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const idx = inlineCodes.length;
      inlineCodes.push(`<code>${escaped}</code>`);
      return `\x02INLINE_CODE_${idx}\x03`;
    });

  // Step 2: Escape remaining HTML in normal text
  text = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Step 3: Apply markdown transformations
  text = text
    // Headings
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    // Horizontal rule
    .replace(/^---$/gm, '<hr>')
    // Bold + italic
    .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
    // Bold
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    // Italic (skip lone asterisks used as list bullets)
    .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
    // Unordered lists
    .replace(/^\s*[-+] (.+)$/gm, '<li>$1</li>')
    // Ordered lists
    .replace(/^\s*\d+\. (.+)$/gm, '<li>$1</li>')
    // Blockquotes
    .replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

  // Step 4: Line-by-line block wrapping — prevents paragraph text from being
  // swallowed into <ul> when it appears in the same \n\n block as list items
  const outLines = [];
  let inList = false;
  let paraAcc = [];

  const flushPara = () => {
    if (paraAcc.length) {
      outLines.push('<p>' + paraAcc.join('<br>') + '</p>');
      paraAcc = [];
    }
  };
  const flushList = () => {
    if (inList) { outLines.push('</ul>'); inList = false; }
  };

  text.split('\n').forEach(rawLine => {
    const line = rawLine.trim();

    if (!line) {
      flushPara();
      flushList();
      return;
    }

    // Block-level tags / placeholders — emit as-is
    if (line.startsWith('<h')      || line.startsWith('<pre')       ||
        line.startsWith('<hr')     || line.startsWith('<blockquote') ||
        line.startsWith('\x02CODE_BLOCK_')) {
      flushPara();
      flushList();
      outLines.push(line);
      return;
    }

    // List item
    if (line.startsWith('<li>')) {
      flushPara();
      if (!inList) { outLines.push('<ul>'); inList = true; }
      outLines.push(line);
      return;
    }

    // Regular text
    flushList();
    paraAcc.push(line);
  });

  flushPara();
  flushList();

  text = outLines.join('\n');

  // Step 5: Restore code placeholders
  codeBlocks.forEach((html, i) => {
    text = text.replace(`\x02CODE_BLOCK_${i}\x03`, html);
  });
  inlineCodes.forEach((html, i) => {
    text = text.replace(`\x02INLINE_CODE_${i}\x03`, html);
  });

  return text;
}

// ─── FILE PREVIEW MODAL ───────────────────────────────────
function previewFile(filename) {
  const content = generatedFiles[filename];
  if(!content) return;

  currentModalFile = filename;
  currentModalTab = 'preview';

  document.getElementById('modal-title').textContent = filename;
  document.getElementById('modal-filesize').textContent =
    `${(new Blob([content]).size / 1024).toFixed(1)} KB`;

  // Render both panes
  document.getElementById('modal-preview-pane').innerHTML = renderMarkdown(content);
  document.getElementById('modal-raw-pane').textContent = content;

  // Show preview by default
  switchModalTab('preview');

  document.getElementById('modal').classList.add('open');
}

function switchModalTab(tab) {
  currentModalTab = tab;
  const previewPane = document.getElementById('modal-preview-pane');
  const rawPane = document.getElementById('modal-raw-pane');
  const tabPreview = document.getElementById('tab-preview');
  const tabRaw = document.getElementById('tab-raw');

  if(tab === 'preview') {
    previewPane.style.display = 'block';
    rawPane.style.display = 'none';
    tabPreview.classList.add('active');
    tabRaw.classList.remove('active');
  } else {
    previewPane.style.display = 'none';
    rawPane.style.display = 'block';
    tabPreview.classList.remove('active');
    tabRaw.classList.add('active');
  }
}

function downloadCurrentFile() {
  if(!currentModalFile || !generatedFiles[currentModalFile]) return;
  const blob = new Blob([generatedFiles[currentModalFile]], { type: 'text/markdown' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = currentModalFile;
  a.click();
  showNotif(`✓ ${currentModalFile} downloaded`);
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

// ─── MARKDOWN BROWSER (all files) ─────────────────────────
function openMarkdownPreview() {
  if(!Object.keys(generatedFiles).length) {
    showNotif(lang==='en' ? '⚠ No files yet — generate a team first' : '⚠ Brak plików — najpierw wygeneruj zespół', true);
    return;
  }
  const modal = document.getElementById('md-browser-modal');
  modal.classList.add('open');

  const mdFiles = Object.keys(generatedFiles).filter(f => f.endsWith('.md'));
  const sidebar = document.getElementById('md-browser-sidebar');
  sidebar.innerHTML = '';

  // File groups
  const groups = [
    { label: lang==='en' ? '📋 Config' : '📋 Konfiguracja', files: mdFiles.filter(f => f === 'README.md' || f === 'team-config.md') },
    { label: lang==='en' ? '⚙️ Agents' : '⚙️ Agenci', files: mdFiles.filter(f => f.startsWith('agent-')) },
    { label: lang==='en' ? '🎯 Skills' : '🎯 Umiejętności', files: mdFiles.filter(f => f.startsWith('skill-')) },
  ];

  groups.forEach(group => {
    if(!group.files.length) return;

    const groupLabel = document.createElement('div');
    groupLabel.style.cssText = 'font-size:0.6rem;font-family:"Space Mono",monospace;color:var(--muted);padding:0.6rem 1rem 0.3rem;letter-spacing:0.1em;text-transform:uppercase;';
    groupLabel.textContent = group.label;
    sidebar.appendChild(groupLabel);

    group.files.forEach(f => {
      const item = document.createElement('button');
      item.style.cssText = `
        display:block;width:100%;text-align:left;
        background:none;border:none;border-left:2px solid transparent;
        color:var(--muted);padding:0.5rem 1rem;
        font-family:'Space Mono',monospace;font-size:0.68rem;
        cursor:pointer;transition:all 0.15s;line-height:1.4;
        word-break:break-all;
      `;
      item.textContent = f;
      item.dataset.file = f;
      item.onmouseenter = () => { if(f !== mdBrowserActiveFile) item.style.color = 'var(--text)'; };
      item.onmouseleave = () => { if(f !== mdBrowserActiveFile) item.style.color = 'var(--muted)'; };
      item.onclick = () => selectMdBrowserFile(f);
      sidebar.appendChild(item);
    });
  });

  // Select first file
  if(mdFiles.length > 0) {
    selectMdBrowserFile('README.md' in generatedFiles ? 'README.md' : mdFiles[0]);
  }
}

function selectMdBrowserFile(filename) {
  mdBrowserActiveFile = filename;
  const content = generatedFiles[filename] || '';

  // Update sidebar active state
  document.querySelectorAll('#md-browser-sidebar button').forEach(btn => {
    const isActive = btn.dataset.file === filename;
    btn.style.borderLeftColor = isActive ? 'var(--accent)' : 'transparent';
    btn.style.color = isActive ? 'var(--accent)' : 'var(--muted)';
    btn.style.background = isActive ? 'rgba(242,185,13,0.06)' : 'none';
  });

  document.getElementById('md-browser-rendered').innerHTML = renderMarkdown(content);
  document.getElementById('md-browser-active-file').textContent =
    `${filename} · ${(new Blob([content]).size / 1024).toFixed(1)} KB`;

  // Scroll content pane to top
  const contentPane = document.getElementById('md-browser-content');
  contentPane.scrollTop = 0;
}

function closeMdBrowser() {
  document.getElementById('md-browser-modal').classList.remove('open');
}

async function downloadAllMd() {
  if(typeof JSZip === 'undefined') {
    showNotif('JSZip not loaded', true); return;
  }
  const zip = new JSZip();
  Object.entries(generatedFiles)
    .filter(([name]) => name.endsWith('.md'))
    .forEach(([name, content]) => zip.file(name, content));

  const blob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `agentspark-docs-${currentTopic.toLowerCase().replace(/\s+/g,'-')}.zip`;
  a.click();
  showNotif(lang === 'en' ? '✓ Docs ZIP downloaded!' : '✓ Docs ZIP pobrany!');
}

// ─── CHAT HELPERS ─────────────────────────────────────────
function addMessage(role, text) {
  const container = document.getElementById('chat-messages');
  const cleanText = text.replace('[INTERVIEW_COMPLETE]', '').trim();
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  const sender = document.createElement('div');
  sender.className = 'msg-sender';
  sender.textContent = role === 'ai' ? '⚡ AgentSpark' : (lang==='en'?'You':'Ty');
  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  // AI messages may have formatting intent — use innerHTML but only with escaped special chars
  // User messages are always plain text
  if(role === 'user') {
    bubble.textContent = cleanText;
  } else {
    // Sanitise AI output: remove dangerous tags and all event handler attributes
    const sanitized = cleanText
      .replace(/<script[\s\S]*?<\/script>/gi, '')
      .replace(/<iframe[\s\S]*?<\/iframe>/gi, '')
      .replace(/<object[\s\S]*?<\/object>/gi, '')
      .replace(/<embed[^>]*>/gi, '')
      .replace(/\s+on\w+\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]*)/gi, '')  // strip onX= attributes
      .replace(/\s+href\s*=\s*(?:"javascript:[^"]*"|'javascript:[^']*')/gi, ''); // strip javascript: hrefs
    bubble.innerHTML = sanitized;
  }
  div.appendChild(sender);
  div.appendChild(bubble);
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function addTypingIndicator() {
  removeTypingIndicator();
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'msg ai';
  div.id = 'typing-indicator';
  div.innerHTML = `
    <div class="msg-sender">⚡ AgentSpark</div>
    <div class="typing-indicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function removeTypingIndicator() {
  const el = document.getElementById('typing-indicator');
  if(el) el.remove();
}

// ─── PROGRESS ─────────────────────────────────────────────
function renderProgressSteps(activeIndex) {
  const container = document.getElementById('progress-steps');
  container.innerHTML = '';
  t('progressSteps').forEach((label, i) => {
    const div = document.createElement('div');
    div.className = `step ${i < activeIndex ? 'done' : i === activeIndex ? 'active' : ''}`;
    div.innerHTML = `<div class="step-num">${i < activeIndex ? '✓' : i+1}</div><span>${label}</span>`;
    container.appendChild(div);
  });
  // iOS progress bar update
  const iosBar = document.getElementById('ios-progress-bar');
  if (iosBar) {
    const steps = t('progressSteps');
    iosBar.innerHTML = steps.map((_, i) =>
      `<div class="ios-progress-segment ${i < activeIndex ? 'done' : i === activeIndex ? 'active' : ''}"></div>`
    ).join('');
  }
  // iOS step counter label
  const stepLabel = document.getElementById('ios-chat-step-label');
  if (stepLabel) stepLabel.textContent = `${activeIndex + 1}/${t('progressSteps').length}`;
}

// ─── AI API (multi-provider + automatic fallback) ─────────

// Fallback chains per provider tag — ordered best→fastest
const FALLBACK_CHAINS = {
  gemini: [
    { provider:'gemini', model:'gemini-3-flash-preview', endpoint:'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}', tag:'gemini', label:'Gemini 3 Flash Preview' },
    { provider:'gemini', model:'gemini-2.0-flash',               endpoint:'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}', tag:'gemini', label:'Gemini 2.0 Flash' },
    { provider:'gemini', model:'gemini-1.5-flash',               endpoint:'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}', tag:'gemini', label:'Gemini 1.5 Flash' },
  ],
  openai: [
    { provider:'openai', model:'gpt-4o',      endpoint:'https://api.openai.com/v1/chat/completions', tag:'openai', label:'GPT-4o' },
    { provider:'openai', model:'gpt-4o-mini', endpoint:'https://api.openai.com/v1/chat/completions', tag:'openai', label:'GPT-4o mini' },
    { provider:'openai', model:'gpt-3.5-turbo', endpoint:'https://api.openai.com/v1/chat/completions', tag:'openai', label:'GPT-3.5 Turbo' },
  ],
  anthropic: [
    { provider:'anthropic', model:'claude-sonnet-4-6', endpoint:'https://api.anthropic.com/v1/messages', tag:'anthropic', label:'Claude Sonnet 4.6' },
    { provider:'anthropic', model:'claude-haiku-4-5-20251001', endpoint:'https://api.anthropic.com/v1/messages', tag:'anthropic', label:'Claude Haiku 4.5' },
  ],
  mistral: [
    { provider:'openai', model:'mistral-large-latest',  endpoint:'https://api.mistral.ai/v1/chat/completions', tag:'mistral', label:'Mistral Large' },
    { provider:'openai', model:'mistral-small-latest',  endpoint:'https://api.mistral.ai/v1/chat/completions', tag:'mistral', label:'Mistral Small' },
    { provider:'openai', model:'open-mistral-nemo',     endpoint:'https://api.mistral.ai/v1/chat/completions', tag:'mistral', label:'Mistral Nemo' },
  ],
  groq: [
    { provider:'openai', model:'llama-3.3-70b-versatile', endpoint:'https://api.groq.com/openai/v1/chat/completions', tag:'groq', label:'Llama 3.3 70B' },
    { provider:'openai', model:'llama-3.1-8b-instant',    endpoint:'https://api.groq.com/openai/v1/chat/completions', tag:'groq', label:'Llama 3.1 8B' },
    { provider:'openai', model:'gemma2-9b-it',            endpoint:'https://api.groq.com/openai/v1/chat/completions', tag:'groq', label:'Gemma2 9B' },
  ],
};

// Errors that justify trying a fallback (rate limit, overload, server error)
function isFallbackable(status, message) {
  if([429, 500, 502, 503, 504, 529].includes(status)) return true;
  const msg = (message || '').toLowerCase();
  return msg.includes('rate limit') || msg.includes('overloaded') ||
         msg.includes('capacity') || msg.includes('timeout') ||
         msg.includes('quota') || msg.includes('unavailable');
}

// Update typing indicator text without replacing the dots
function setTypingStatus(text) {
  const el = document.getElementById('typing-indicator');
  if(!el) return;
  let label = el.querySelector('.typing-status-label');
  if(!label) {
    label = document.createElement('div');
    label.className = 'typing-status-label';
    label.style.cssText = 'font-size:0.68rem;font-family:"Space Mono",monospace;color:var(--muted);margin-top:0.4rem;';
    el.appendChild(label);
  }
  label.textContent = text;
}

// Single model call — throws with {status, message} on failure
async function callSingleModel(m, key, systemInstruction, userMessage, _traceLabel) {
  const { provider, model, endpoint } = m;
  const t0 = Date.now();

  // Register span as pending
  const span = {
    id: traceSpans.length,
    label: _traceLabel || 'API Call',
    model: m.label || model,
    provider,
    startMs: t0,
    endMs: null,
    durationMs: null,
    status: 'pending',   // pending | ok | fallback | error
    isFallback: false,
    tokens: null,
    error: null,
  };
  if(!traceSessionStart) traceSessionStart = t0;
  traceSpans.push(span);
  renderTraceLive();  // show pending bar immediately

  const finalize = (status, tokens, error) => {
    span.endMs = Date.now();
    span.durationMs = span.endMs - span.startMs;
    span.status = status;
    span.tokens = tokens || null;
    span.error = error || null;
    renderTraceLive();
  };

  try {
    let result, tokens = null;

    if(provider === 'gemini') {
      const url = endpoint.replace('{model}', model).replace('{key}', key);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          systemInstruction: { parts: [{ text: systemInstruction }] },
          contents: [{ role: 'user', parts: [{ text: userMessage }] }],
          generationConfig: { temperature: 0.8, maxOutputTokens: 4096 }
        })
      });
      if(!res.ok) {
        const err = await res.json().catch(() => ({}));
        const e = new Error(err.error?.message || `Gemini error ${res.status}`);
        e.status = res.status;
        finalize('error', null, e.message);
        throw e;
      }
      const data = await res.json();
      tokens = data.usageMetadata
        ? (data.usageMetadata.totalTokenCount || null)
        : null;
      result = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    }

    else if(provider === 'openai') {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
        body: JSON.stringify({
          model,
          messages: [{ role:'system', content: systemInstruction }, { role:'user', content: userMessage }],
          temperature: 0.8, max_tokens: 4096
        })
      });
      if(!res.ok) {
        const err = await res.json().catch(() => ({}));
        const e = new Error(err.error?.message || `API error ${res.status}`);
        e.status = res.status;
        finalize('error', null, e.message);
        throw e;
      }
      const data = await res.json();
      tokens = data.usage?.total_tokens || null;
      result = data.choices?.[0]?.message?.content || '';
    }

    else if(provider === 'anthropic') {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': key,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model,
          system: systemInstruction,
          messages: [{ role: 'user', content: userMessage }],
          max_tokens: 4096
        })
      });
      if(!res.ok) {
        const err = await res.json().catch(() => ({}));
        const e = new Error(err.error?.message || `Anthropic error ${res.status}`);
        e.status = res.status;
        finalize('error', null, e.message);
        throw e;
      }
      const data = await res.json();
      tokens = data.usage ? (data.usage.input_tokens + data.usage.output_tokens) : null;
      result = data.content?.[0]?.text || '';
    }

    else {
      const e = new Error(`Unknown provider: ${provider}`);
      finalize('error', null, e.message);
      throw e;
    }

    finalize('ok', tokens, null);
    return result;

  } catch(err) {
    // Only finalize if not already done inside branches
    if(span.status === 'pending') finalize('error', null, err.message);
    throw err;
  }
}

// Main entry — tries selected model, then falls back through chain
async function callGemini(systemInstruction, userMessage, traceLabel) {
  const key = apiKey || document.getElementById('apiKeyInput')?.value?.trim();
  if(!key) throw new Error('No API key — please enter your key');

  // Build attempt list: selected model first, then rest of its chain
  const chain = FALLBACK_CHAINS[selectedModel.tag] || [];
  // Put selected model at front, deduplicate by model name
  const primary = { ...selectedModel };
  const rest = chain.filter(m => m.model !== primary.model);
  const attempts = [primary, ...rest];

  let lastError = null;
  for(let i = 0; i < attempts.length; i++) {
    const m = attempts[i];
    const spanLabel = traceLabel
      ? (i > 0 ? `${traceLabel} (fallback)` : traceLabel)
      : (i > 0 ? `Fallback #${i}` : 'API Call');

    if(i > 0) {
      setTypingStatus(`⚠ ${attempts[i-1].label || attempts[i-1].model} failed — trying ${m.label || m.model}…`);
      await new Promise(r => setTimeout(r, 600)); // brief pause before retry
    }
    try {
      const result = await callSingleModel(m, key, systemInstruction, userMessage, spanLabel);

      // If we used a fallback, mark the span and notify user
      if(i > 0) {
        const span = traceSpans[traceSpans.length - 1];
        if(span) { span.status = 'fallback'; span.isFallback = true; }
        renderTraceLive();
        const modelName = m.label || m.model;
        setTimeout(() => showNotif(
          lang === 'en'
            ? `↩ Fell back to ${modelName}`
            : `↩ Przełączono na ${modelName}`
        ), 300);
        // Update header badge to reflect actual model used
        const badgeEl = document.getElementById('headerModelBadge');
        if(badgeEl) badgeEl.textContent = m.model + ' (fallback)';
      }
      setTypingStatus('');
      return result;
    } catch(err) {
      lastError = err;
      const fallbackable = isFallbackable(err.status, err.message);
      // If not a fallbackable error (e.g. 401 auth), fail immediately
      if(!fallbackable) {
        console.warn(`[AgentSpark] Non-fallbackable error on ${m.model}:`, err.message);
        break;
      }
      console.warn(`[AgentSpark] Fallback triggered (${m.model}): ${err.message}`);
    }
  }

  setTypingStatus('');
  throw lastError || new Error('All models failed');
}

// ─── UTILS ────────────────────────────────────────────────
// ─── COLLAPSIBLE API SETUP ────────────────────────────────
let _apiSetupOpen = true; // open by default until key entered

function toggleApiSetup(forceState) {
  const body = document.getElementById('api-setup-body');
  const chevron = document.getElementById('api-setup-chevron');
  if (!body) return;
  if (forceState !== undefined) {
    _apiSetupOpen = forceState;
  } else {
    _apiSetupOpen = !_apiSetupOpen;
  }
  body.classList.toggle('open', _apiSetupOpen);
  if (chevron) chevron.classList.toggle('open', _apiSetupOpen);
}

function _updateApiKeyDot(status) {
  // status: 'ready' | 'error' | ''
  const dot = document.getElementById('api-key-dot');
  const label = document.getElementById('api-setup-toggle-label');
  if (!dot) return;
  dot.className = 'api-key-dot' + (status ? ' ' + status : '');
  if (status === 'ready' && label) {
    const sel = document.getElementById('modelSelect');
    const modelText = sel ? sel.options[sel.selectedIndex]?.text : 'AI Model';
    label.textContent = modelText + ' · Ready';
    // Auto-collapse when key is valid
    toggleApiSetup(false);
  } else if (label) {
    label.textContent = 'AI Model & API Key';
  }
}

// ─── SKELETON LOADING ─────────────────────────────────────
function _renderSkeletonCards(count = 4) {
  const grid = document.getElementById('agents-grid');
  if (!grid) return;
  grid.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const card = document.createElement('div');
    card.className = 'skeleton-card';
    card.innerHTML = `
      <span class="skeleton skeleton-avatar"></span>
      <span class="skeleton skeleton-line w65"></span>
      <span class="skeleton skeleton-line w40"></span>
      <span class="skeleton skeleton-line w100" style="margin-top:1rem;height:11px;"></span>
      <span class="skeleton skeleton-line w90" style="height:11px;"></span>
      <span class="skeleton skeleton-line w75" style="height:11px;"></span>
      <div class="skeleton-chips">
        <span class="skeleton skeleton-chip"></span>
        <span class="skeleton skeleton-chip" style="width:80px;"></span>
      </div>
    `;
    grid.appendChild(card);
  }
}

function _showGeneratingState(stepIndex) {
  // stepIndex 0=interviewing, 1=generating, 2=writing files, 3=done
  const steps = [
    lang === 'en' ? 'Analyzing your requirements…' : 'Analizuję wymagania…',
    lang === 'en' ? 'Designing agent team…' : 'Projektuję zespół agentów…',
    lang === 'en' ? 'Writing configuration files…' : 'Zapisuję pliki konfiguracyjne…',
    lang === 'en' ? 'Finalizing…' : 'Finalizuję…',
  ];
  const grid = document.getElementById('agents-grid');
  if (!grid) return;
  const overlay = document.createElement('div');
  overlay.className = 'generating-overlay';
  overlay.id = 'generating-overlay';
  const stepsHtml = steps.map((s, i) => `
    <div class="gen-step ${i < stepIndex ? 'done' : i === stepIndex ? 'active' : ''}">
      <span class="gen-step-dot"></span>
      <span>${i < stepIndex ? '✓ ' : ''}${s}</span>
    </div>
  `).join('');
  overlay.innerHTML = `
    <div class="generating-spinner"></div>
    <div class="generating-label">${lang === 'en' ? 'Building your AI team…' : 'Buduję Twój zespół AI…'}</div>
    <div class="generating-steps">${stepsHtml}</div>
  `;
  grid.innerHTML = '';
  grid.appendChild(overlay);
}

// ─── FAB (Floating Action Button) visibility ──────────────
function _syncFab() {
  const fab = document.getElementById('results-fab');
  if (!fab) return;
  const resultsActive = document.getElementById('screen-results')?.classList.contains('active');
  const shouldShow = resultsActive && generatedAgents.length > 0;
  fab.classList.toggle('fab-visible', shouldShow);
}

function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
  syncIosTabBar(name);
  _syncFab();
}

// ── iOS Tab Bar Navigation ──────────────────────────────
function syncIosTabBar(screenName) {
  // Map screens to tabs
  const tabMap = {
    'topic':    'home',
    'projects': 'projects',
    'chat':     'chat',
    'results':  'results',
  };
  const activeTab = tabMap[screenName] || 'home';

  // Show/hide contextual tabs
  const chatTab    = document.getElementById('tab-chat');
  const resultsTab = document.getElementById('tab-results');
  if (chatTab)    chatTab.style.display    = (screenName === 'chat' || screenName === 'results') ? '' : 'none';
  if (resultsTab) resultsTab.style.display = (screenName === 'results') ? '' : 'none';

  // Set active state
  document.querySelectorAll('.ios-tab-btn').forEach(btn => btn.classList.remove('active'));
  const activeBtn = document.getElementById('tab-' + activeTab);
  if (activeBtn) activeBtn.classList.add('active');
}

function iosTabNav(tab) {
  if (tab === 'home')     showScreen('topic');
  else if (tab === 'projects') openProjectsScreen();
  else if (tab === 'chat')    showScreen('chat');
  else if (tab === 'results') showScreen('results');
  else if (tab === 'settings') openSettingsSheet();
}

function openSettingsSheet() {
  // Build settings as iOS action sheet
  let sheet = document.getElementById('ios-settings-sheet');
  if (!sheet) {
    sheet = document.createElement('div');
    sheet.id = 'ios-settings-sheet';
    sheet.className = 'ios-sheet-overlay';
    sheet.innerHTML = `
      <div class="ios-sheet" style="max-height:80vh;">
        <div class="ios-sheet-handle"></div>
        <div class="ios-sheet-header">
          <span class="ios-sheet-title">Settings</span>
          <button class="ios-sheet-close" onclick="document.getElementById('ios-settings-sheet').classList.remove('open')">✕</button>
        </div>
        <div class="ios-sheet-body">
          <div class="ios-section-label" style="margin-bottom:0.5rem;">Appearance</div>
          <div class="ios-list-group">
            <div class="ios-list-item" onclick="_toggleThemeCore()">
              <div class="ios-list-icon" style="background:rgba(242,185,13,0.15);">🌙</div>
              <div style="flex:1"><div class="ios-list-label" id="settings-theme-label">Dark Mode</div></div>
              <span class="ios-list-chevron">›</span>
            </div>
          </div>
          <div class="ios-section-label" style="margin-bottom:0.5rem;">Language</div>
          <div class="ios-list-group">
            <div class="ios-list-item" onclick="setLang('en');document.getElementById('ios-settings-sheet').classList.remove('open')">
              <div class="ios-list-icon" style="background:rgba(242,185,13,0.15);">🇬🇧</div>
              <div style="flex:1"><div class="ios-list-label">English</div></div>
              <span id="settings-lang-en" style="color:var(--accent);font-size:0.9rem;">✓</span>
            </div>
            <div class="ios-list-item" onclick="setLang('pl');document.getElementById('ios-settings-sheet').classList.remove('open')">
              <div class="ios-list-icon" style="background:rgba(242,185,13,0.15);">🇵🇱</div>
              <div style="flex:1"><div class="ios-list-label">Polski</div></div>
              <span id="settings-lang-pl" style="color:var(--accent);font-size:0.9rem;display:none;">✓</span>
            </div>
          </div>
          <div class="ios-section-label" style="margin-bottom:0.5rem;">About</div>
          <div class="ios-list-group">
            <div class="ios-list-item">
              <div class="ios-list-icon" style="background:rgba(242,185,13,0.15);">⚡</div>
              <div style="flex:1">
                <div class="ios-list-label">AgentSpark</div>
                <div class="ios-list-sub">v2.4.0 — AI Agent Team Generator</div>
              </div>
            </div>
            <div class="ios-list-item" onclick="openImportModal();document.getElementById('ios-settings-sheet').classList.remove('open')">
              <div class="ios-list-icon" style="background:rgba(242,185,13,0.15);">📥</div>
              <div style="flex:1"><div class="ios-list-label">Import Project</div></div>
              <span class="ios-list-chevron">›</span>
            </div>
          </div>
        </div>
      </div>
    `;
    sheet.addEventListener('click', e => { if (e.target === sheet) sheet.classList.remove('open'); });
    document.body.appendChild(sheet);
  }
  // Update language indicators
  const isEn = lang === 'en';
  const langEn = document.getElementById('settings-lang-en');
  const langPl = document.getElementById('settings-lang-pl');
  if (langEn) langEn.style.display = isEn ? '' : 'none';
  if (langPl) langPl.style.display = !isEn ? '' : 'none';
  // Update theme label
  const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
  const themeLabel = document.getElementById('settings-theme-label');
  if (themeLabel) themeLabel.textContent = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
  sheet.classList.add('open');
}

// ─── SIDEBAR TOGGLE (#5) ──────────────────────────────────
let _sidebarCollapsed = false;
function toggleChatSidebar() {
  _sidebarCollapsed = !_sidebarCollapsed;
  const layout = document.querySelector('.chat-layout');
  const btn = document.getElementById('sidebar-toggle-btn');
  if (layout) layout.classList.toggle('sidebar-collapsed', _sidebarCollapsed);
  if (btn) btn.textContent = _sidebarCollapsed ? '◀' : '▶';
  localStorage.setItem('agentspark-sidebar-collapsed', _sidebarCollapsed ? '1' : '0');
}
// Restore sidebar state on load
(function() {
  window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('agentspark-sidebar-collapsed') === '1') {
      _sidebarCollapsed = true;
      const layout = document.querySelector('.chat-layout');
      const btn = document.getElementById('sidebar-toggle-btn');
      if (layout) layout.classList.add('sidebar-collapsed');
      if (btn) btn.textContent = '◀';
    }
  });
})();

function renderResults() {
  // Alias used when loading a project — renders the results screen UI
  showResults(false);
}

function restart() {
  // If there's unsaved work and a project in progress, offer to save
  if (generatedAgents.length && _currentProjectId === null) {
    const save = window.confirm(
      lang === 'en'
        ? 'Save current project before starting over?'
        : 'Zapisać bieżący projekt przed rozpoczęciem od nowa?'
    );
    if (save) { saveCurrentProject(false); }
  }
  _currentProjectId = null;
  chatHistory = [];
  generatedAgents = [];
  generatedFiles = {};
  refineHistory = [];
  refineSnapshots = [];
  versionHistory = [];
  versionPanelOpen = false;
  traceSpans = [];
  tracePanelOpen = false;
  traceSessionStart = null;
  isRefining = false;
  selectedRefineAction = null;
  questionCount = 0;
  conversationState = 'interview';
  currentModalFile = '';
  mdBrowserActiveFile = '';
  document.getElementById('chat-messages').innerHTML = '';
  clearOptions();
  if(document.getElementById('refine-history')) document.getElementById('refine-history').innerHTML = '';
  document.getElementById('refine-panel').style.display = 'none';
  document.getElementById('version-panel').style.display = 'none';
  currentLevel = 'iskra';
  MAX_QUESTIONS = 4;
  if(graphAnimFrame) { cancelAnimationFrame(graphAnimFrame); graphAnimFrame = null; }
  graphNodes = []; graphEdges = [];
  document.getElementById('scoring-panel').style.display = 'none';
  document.getElementById('trace-panel').style.display = 'none';
  document.getElementById('graph-section').style.display = 'none';
  const gc = document.querySelector('.graph-container');
  if(gc) { const leg = gc.querySelector('.graph-legend'); if(leg) leg.remove(); }
  document.getElementById('instructions-section').style.display = 'none';
  document.getElementById('apiKeyHeader').style.display = 'none';
  showScreen('topic');
}

let notifTimeout;
function showNotif(msg, isError = false) {
  // Remove any existing toast with fade-out
  const old = document.querySelector('.notif');
  if (old) {
    old.classList.add('hiding');
    setTimeout(() => old.remove(), 260);
  }

  const div = document.createElement('div');
  div.className = 'notif' + (isError ? ' error' : '');

  // Icon prefix for context
  const icon = isError ? '⚠ ' : '';
  div.textContent = icon + msg;

  // Color tint for success vs error
  if (isError) {
    div.style.color = 'var(--accent2)';
  } else if (msg.startsWith('✓') || msg.startsWith('↩')) {
    div.style.color = 'var(--success)';
  } else {
    div.style.color = 'var(--text)';
  }

  document.body.appendChild(div);

  clearTimeout(notifTimeout);
  notifTimeout = setTimeout(() => {
    div.classList.add('hiding');
    setTimeout(() => div.remove(), 260);
  }, 3200);
}

// ─── TRACE VIEWER ─────────────────────────────────────────

function toggleTracePanel() {
  tracePanelOpen = !tracePanelOpen;
  document.getElementById('trace-body').classList.toggle('open', tracePanelOpen);
  document.getElementById('trace-toggle-icon').classList.toggle('open', tracePanelOpen);
}

function renderTraceLive() {
  const panel = document.getElementById('trace-panel');
  if(!panel) return;

  if(!traceSpans.length) { panel.style.display = 'none'; return; }
  panel.style.display = 'block';

  // Count badge
  const doneCount = traceSpans.filter(s => s.status !== 'pending').length;
  document.getElementById('trace-span-count').textContent = traceSpans.length;

  // Summary pills
  const pills = document.getElementById('trace-summary-pills');
  const totalMs = traceSpans.reduce((n, s) => n + (s.durationMs || 0), 0);
  const totalTok = traceSpans.reduce((n, s) => n + (s.tokens || 0), 0);
  const hasFallback = traceSpans.some(s => s.isFallback);
  const hasError    = traceSpans.some(s => s.status === 'error');
  const hasPending  = traceSpans.some(s => s.status === 'pending');
  pills.innerHTML = `
    <span class="trace-pill ${hasError ? 'error' : hasFallback ? 'warn' : 'ok'}">
      ${hasError ? '⚠ error' : hasFallback ? '↩ fallback' : '✓ ok'}
    </span>
    <span class="trace-pill">${(totalMs/1000).toFixed(1)}s total</span>
    ${totalTok ? `<span class="trace-pill">${totalTok.toLocaleString()} tokens</span>` : ''}
    ${hasPending ? `<span class="trace-pill">⏳ running…</span>` : ''}
  `;

  // Span rows
  const spansEl = document.getElementById('trace-spans');

  // Calculate timeline scale
  const sessionStart = traceSessionStart || (traceSpans[0]?.startMs || Date.now());
  const sessionEnd   = Math.max(...traceSpans.map(s => s.endMs || Date.now()));
  const sessionRange = Math.max(sessionEnd - sessionStart, 1);

  spansEl.innerHTML = '';
  traceSpans.forEach(s => {
    const left  = ((s.startMs - sessionStart) / sessionRange) * 100;
    const width = s.durationMs
      ? Math.max((s.durationMs / sessionRange) * 100, 1.5)
      : Math.max(((Date.now() - s.startMs) / sessionRange) * 100, 3);

    const fillClass = s.status === 'ok'       ? 'fill-ok'
      : s.status === 'fallback' ? 'fill-fallback'
      : s.status === 'error'   ? 'fill-error'
      : 'fill-pending';

    const badgeClass = s.status === 'ok'       ? 'badge-ok'
      : s.status === 'fallback' ? 'badge-fallback'
      : s.status === 'error'   ? 'badge-error'
      : 'badge-pending';

    const badgeText = s.status === 'ok'       ? 'OK'
      : s.status === 'fallback' ? '↩ FALLBACK'
      : s.status === 'error'   ? 'ERROR'
      : '…';

    const durText = s.durationMs
      ? s.durationMs >= 1000 ? `${(s.durationMs/1000).toFixed(1)}s` : `${s.durationMs}ms`
      : '…';

    const tokenText = s.tokens ? s.tokens.toLocaleString() : '–';

    // ── Improved label parsing (#9) ───────────────────────
    const rawLabel = s.label || 'API Call';
    let phase = rawLabel, detail = '';
    const dotSep   = rawLabel.indexOf(' · ');
    const colonSep = rawLabel.indexOf(': ');
    if (dotSep !== -1) {
      phase  = rawLabel.slice(0, dotSep);
      detail = rawLabel.slice(dotSep + 3);
    } else if (colonSep !== -1) {
      phase  = rawLabel.slice(0, colonSep);
      detail = rawLabel.slice(colonSep + 2);
    }

    // Shorten model name if too long
    const modelDisplay = s.model || '';
    const modelShort   = modelDisplay.length > 22 ? modelDisplay.slice(0, 20) + '…' : modelDisplay;

    // Relative start time for tooltip
    const relSec  = ((s.startMs - sessionStart) / 1000).toFixed(2);
    const absTime = new Date(s.startMs).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });

    // Tooltip
    const tooltipLines = [
      `Step: ${rawLabel}`,
      `Model: ${modelDisplay}`,
      `Started: ${absTime} (+${relSec}s into session)`,
      s.durationMs ? `Duration: ${durText}` : 'Duration: pending…',
      s.tokens     ? `Tokens: ${s.tokens.toLocaleString()}` : '',
      s.isFallback ? `↩ Fell back from primary model` : '',
      s.error      ? `Error: ${s.error}` : '',
    ].filter(Boolean).join('\n');

    const row = document.createElement('div');
    row.className = 'trace-span';
    row.title     = tooltipLines;
    row.innerHTML = `
      <div class="span-name">
        <div class="span-label" title="${phase}">${phase}</div>
        ${detail ? `<div class="span-detail">${_escHtml(detail)}</div>` : ''}
        <div class="span-model" title="${modelDisplay}">${modelShort}</div>
      </div>
      <div class="span-bar-col">
        <div class="span-bar-track">
          <div class="span-bar-fill ${fillClass}" style="margin-left:${left.toFixed(1)}%;width:${width.toFixed(1)}%"></div>
        </div>
      </div>
      <div class="span-duration">${durText}</div>
      <div class="span-tokens">${tokenText}</div>
      <div class="span-status"><span class="span-badge ${badgeClass}">${badgeText}</span></div>
    `;
    spansEl.appendChild(row);
  });

  // Footer stats — improved (#9)
  const footerEl = document.getElementById('trace-footer');
  const calls     = traceSpans.length;
  const errors    = traceSpans.filter(s => s.status === 'error').length;
  const fallbacks = traceSpans.filter(s => s.isFallback).length;
  const phases    = [...new Set(traceSpans.map(s => {
    const raw = s.label || '';
    const dot = raw.indexOf(' · ');
    return dot !== -1 ? raw.slice(0, dot) : raw.split(':')[0];
  }))];
  const avgDur = calls ? Math.round(totalMs / calls) : 0;
  footerEl.innerHTML = `
    <span><strong>${calls}</strong> ${lang==='en' ? (calls===1 ? 'call' : 'calls') : 'wywołań'}</span>
    <span><strong>${(totalMs/1000).toFixed(1)}s</strong> ${lang==='en'?'total':'łącznie'}</span>
    ${totalTok ? `<span title="${lang==='en'?'Total tokens consumed':'Łączna liczba tokenów'}"><strong>${totalTok.toLocaleString()}</strong> tok</span>` : ''}
    ${calls > 1 ? `<span style="color:var(--muted)">~${avgDur >= 1000 ? (avgDur/1000).toFixed(1)+'s' : avgDur+'ms'} ${lang==='en'?'avg/call':'śr/call'}</span>` : ''}
    ${fallbacks ? `<span title="${lang==='en'?'Model fallbacks used':'Użyte fallbacki modelu'}">↩ <strong>${fallbacks}</strong> ${lang==='en'?'fallback':'fallback'}</span>` : ''}
    ${errors ? `<span style="color:var(--accent2)" title="${lang==='en'?'Failed calls':'Nieudane wywołania'}">⚠ <strong>${errors}</strong> ${lang==='en'?'error':'błąd'}</span>` : ''}
    <span style="margin-left:auto;color:var(--muted);font-size:0.68rem;" title="${lang==='en'?'Session start time':'Czas startu sesji'}">${new Date(sessionStart).toLocaleTimeString()}</span>
  `;
}

// ─── VERSION HISTORY ──────────────────────────────────────

function renderVersionPanel() {
  const panel = document.getElementById('version-panel');
  const timeline = document.getElementById('version-timeline');
  const badge = document.getElementById('version-count-badge');
  const icon = document.getElementById('version-toggle-icon');

  const total = versionHistory.length;
  if(total === 0) { panel.style.display = 'none'; return; }

  panel.style.display = 'block';
  badge.textContent = total;
  icon.className = 'version-toggle-icon' + (versionPanelOpen ? ' open' : '');
  timeline.className = 'version-timeline' + (versionPanelOpen ? ' open' : '');

  timeline.innerHTML = '';

  // Show newest first
  const reversed = [...versionHistory].reverse();

  reversed.forEach((v, ri) => {
    const isCurrentIdx = ri === 0;
    const origIdx = versionHistory.indexOf(v);           // index in versionHistory array

    const entry = document.createElement('div');
    entry.className = 'version-entry' + (isCurrentIdx ? ' current' : '') + (v.isOrigin ? ' origin' : '');

    // Diff tags
    const diffHtml = [
      ...v.diff.added.map(id =>
        `<span class="diff-tag diff-added">+${v.agentNames?.[id] || id}</span>`),
      ...v.diff.removed.map(id =>
        `<span class="diff-tag diff-removed">−${v.removedNames?.[id] || id}</span>`),
      ...v.diff.changed.map(id =>
        `<span class="diff-tag diff-changed">~${v.agentNames?.[id] || id}</span>`),
    ].join('');

    // Agent list preview
    const agentPreview = v.agents.map(a => a.name).join(', ');

    // Time label
    const timeLabel = formatVersionTime(v.ts);

    // Actions: can't restore current, can't diff origin
    const restoreBtn = !isCurrentIdx
      ? `<button class="version-btn restore-btn" onclick="restoreVersion(${origIdx})">↩ ${lang==='en'?'Restore':'Przywróć'}</button>`
      : `<span class="version-current-tag">CURRENT</span>`;

    const diffBtn = origIdx > 0
      ? `<button class="version-btn diff-btn" onclick="showDiffModal(${origIdx})">🔍 ${lang==='en'?'Diff':'Porównaj'}</button>`
      : '';

    const downloadBtn = `<button class="version-btn" onclick="downloadVersionZip(${origIdx})">⬇ ZIP</button>`;

    entry.innerHTML = `
      <div class="version-dot-col">
        <div class="version-dot">${v.isOrigin ? '●' : 'v' + v.vNum}</div>
      </div>
      <div class="version-card">
        <div class="version-card-top">
          <div class="version-label">${escapeHtml(v.label)}</div>
          <div class="version-time">${timeLabel}</div>
        </div>
        ${diffHtml ? `<div class="version-diff">${diffHtml}</div>` : ''}
        <div class="version-agents">⚡ ${agentPreview}</div>
        <div class="version-actions">
          ${restoreBtn}
          ${diffBtn}
          ${downloadBtn}
        </div>
      </div>
    `;
    timeline.appendChild(entry);
  });
}

function toggleVersionPanel() {
  versionPanelOpen = !versionPanelOpen;
  renderVersionPanel();
}

function formatVersionTime(ts) {
  if(!ts) return '';
  const d = ts instanceof Date ? ts : new Date(ts);
  const now = new Date();
  const diffMs = now - d;
  const diffM = Math.floor(diffMs / 60000);
  if(diffM < 1)  return lang==='en' ? 'just now' : 'przed chwilą';
  if(diffM < 60) return `${diffM}m ${lang==='en'?'ago':'temu'}`;
  const diffH = Math.floor(diffM / 60);
  if(diffH < 24) return `${diffH}h ${lang==='en'?'ago':'temu'}`;
  return d.toLocaleDateString();
}

function restoreVersion(idx) {
  if(idx < 0 || idx >= versionHistory.length) return;
  const v = versionHistory[idx];

  // Save current state as new version before restoring
  const alreadySaved = versionHistory[versionHistory.length - 1];
  // Don't double-save if idx is already last
  if(idx !== versionHistory.length - 1) {
    versionHistory.push({
      id: Date.now(),
      label: lang==='en' ? `Restored v${v.vNum}` : `Przywrócono v${v.vNum}`,
      ts: new Date(),
      agents: JSON.parse(JSON.stringify(v.agents)),
      files: JSON.parse(JSON.stringify(v.files)),
      diff: { added: [], removed: [], changed: [] },
      removedNames: {},
      agentNames: Object.fromEntries(v.agents.map(a => [a.id, a.name])),
      vNum: versionHistory.length + 1,
    });
  }

  generatedAgents = JSON.parse(JSON.stringify(v.agents));
  generatedFiles  = JSON.parse(JSON.stringify(v.files));

  showResults(true);
  buildGraphFromAgents();
  renderVersionPanel();

  showNotif(lang==='en'
    ? `↩ Restored to v${v.vNum}: "${v.label}"`
    : `↩ Przywrócono v${v.vNum}: "${v.label}"`);
}

async function downloadVersionZip(idx) {
  if(typeof JSZip === 'undefined') { showNotif('JSZip not loaded', true); return; }
  const v = versionHistory[idx];
  if(!v) return;
  const zip = new JSZip();
  Object.entries(v.files).forEach(([name, content]) => zip.file(name, content));
  const blob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `agentspark-v${v.vNum}-${currentTopic.toLowerCase().replace(/\s+/g,'-')}.zip`;
  a.click();
  showNotif(`✓ v${v.vNum} ZIP downloaded`);
}

function showDiffModal(idx) {
  if(idx < 1 || idx >= versionHistory.length) return;
  const vNew = versionHistory[idx];
  const vOld = versionHistory[idx - 1];

  const modal = document.getElementById('diff-modal');
  const title = document.getElementById('diff-modal-title');
  const body  = document.getElementById('diff-modal-body');

  title.textContent = lang==='en'
    ? `🔍 v${vOld.vNum} → v${vNew.vNum}: "${vNew.label}"`
    : `🔍 v${vOld.vNum} → v${vNew.vNum}: "${vNew.label}"`;

  const { added, removed, changed } = vNew.diff;

  let html = '';

  if(added.length) {
    html += `<div class="diff-section">
      <div class="diff-section-title" style="color:var(--success)">➕ ${lang==='en'?'Added Agents':'Dodani Agenci'} (${added.length})</div>
      ${added.map(id => {
        const a = vNew.agents.find(ag => ag.id === id);
        if(!a) return '';
        return `<div class="diff-agent-row row-added">
          <span class="row-icon">${a.emoji||'🤖'}</span>
          <div><div class="diff-agent-name">${a.name}</div><div class="diff-agent-role">${a.role||''}</div></div>
        </div>`;
      }).join('')}
    </div>`;
  }

  if(removed.length) {
    html += `<div class="diff-section">
      <div class="diff-section-title" style="color:var(--accent2)">🗑 ${lang==='en'?'Removed Agents':'Usunięci Agenci'} (${removed.length})</div>
      ${removed.map(id => {
        const a = vOld.agents.find(ag => ag.id === id);
        if(!a) return '';
        return `<div class="diff-agent-row row-removed">
          <span class="row-icon">${a.emoji||'🤖'}</span>
          <div><div class="diff-agent-name">${a.name}</div><div class="diff-agent-role">${a.role||''}</div></div>
        </div>`;
      }).join('')}
    </div>`;
  }

  if(changed.length) {
    html += `<div class="diff-section">
      <div class="diff-section-title" style="color:#ffd580">✏ ${lang==='en'?'Modified Agents':'Zmodyfikowani Agenci'} (${changed.length})</div>
      ${changed.map(id => {
        const aNew = vNew.agents.find(ag => ag.id === id);
        const aOld = vOld.agents.find(ag => ag.id === id);
        if(!aNew) return '';
        const descChanged = aOld && aOld.description !== aNew.description;
        const roleChanged = aOld && aOld.role !== aNew.role;
        return `<div class="diff-agent-row row-changed">
          <span class="row-icon">${aNew.emoji||'🤖'}</span>
          <div style="flex:1">
            <div class="diff-agent-name">${aNew.name}</div>
            ${roleChanged ? `<div class="diff-agent-role" style="color:#ffd580">Role: ${aOld.role} → ${aNew.role}</div>` : ''}
            ${descChanged ? `<div style="font-size:0.7rem;color:var(--muted);margin-top:0.25rem;line-height:1.4;">${aNew.description.slice(0,120)}${aNew.description.length>120?'…':''}</div>` : ''}
          </div>
        </div>`;
      }).join('')}
    </div>`;
  }

  if(!added.length && !removed.length && !changed.length) {
    html = `<div style="padding:2rem;text-align:center;color:var(--muted);font-family:'Space Mono',monospace;font-size:0.82rem;">
      ${lang==='en'?'No structural changes — metadata or descriptions updated.':'Brak zmian strukturalnych — zaktualizowano metadane lub opisy.'}
    </div>`;
  }

  // Agent count summary
  html = `<div style="display:flex;gap:1.5rem;padding:0 0 1.25rem;font-family:'Space Mono',monospace;font-size:0.72rem;color:var(--muted);border-bottom:1px solid var(--border);margin-bottom:1.25rem;">
    <span>${lang==='en'?'Before':'Przed'}: <strong style="color:var(--text)">${vOld.agents.length} ${lang==='en'?'agents':'agentów'}</strong></span>
    <span>→</span>
    <span>${lang==='en'?'After':'Po'}: <strong style="color:var(--text)">${vNew.agents.length} ${lang==='en'?'agents':'agentów'}</strong></span>
    <span style="margin-left:auto;">${lang==='en'?'Change':'Zmiana'}: ${vNew.agents.length - vOld.agents.length > 0 ? '+' : ''}${vNew.agents.length - vOld.agents.length}</span>
  </div>` + html;

  body.innerHTML = html;
  modal.classList.add('open');
}

function closeDiffModal() {
  document.getElementById('diff-modal').classList.remove('open');
}

// ─── FRAMEWORK EXPORT ─────────────────────────────────────

const FRAMEWORKS = [
  { id: 'crewai',   label: 'CrewAI',    badge: 'Python',   logo: '🤝', pip: 'pip install crewai crewai-tools',
    desc: 'Role-based agents with tasks and tools. Best for sequential and hierarchical workflows.',
    url: 'https://docs.crewai.com' },
  { id: 'langgraph', label: 'LangGraph', badge: 'Python',  logo: '🔗', pip: 'pip install langgraph langchain-openai',
    desc: 'Stateful multi-agent graphs with cycles and branching. Best for complex conditional flows.',
    url: 'https://langchain-ai.github.io/langgraph' },
  { id: 'autogen',  label: 'AutoGen',   badge: 'Python',   logo: '🔄', pip: 'pip install pyautogen',
    desc: 'Conversational multi-agent framework with human-in-the-loop support. Best for agentic chat.',
    url: 'https://microsoft.github.io/autogen' },
  { id: 'swarm',    label: 'Swarm',     badge: 'Python',   logo: '🐝', pip: 'pip install git+https://github.com/openai/swarm.git',
    desc: 'Lightweight OpenAI Swarm with handoffs between agents. Best for simple agent routing.',
    url: 'https://github.com/openai/swarm' },
];

let activeFwTab = 'crewai';

// ═══════════════════════════════════════════════════════════
// ─── IMPORT PROJECT (#4) ─────────────────────────────────
// ═══════════════════════════════════════════════════════════

let _importParsed = null; // holds parsed payload ready to confirm

// ── Open / close ──────────────────────────────────────────
function openImportModal() {
  resetImportModal();
  document.getElementById('import-modal').classList.add('open');
}
function closeImportModal() {
  document.getElementById('import-modal').classList.remove('open');
  _importParsed = null;
}

// ── Drag & drop ───────────────────────────────────────────
function handleImportDrop(e) {
  e.preventDefault();
  document.getElementById('import-dropzone').classList.remove('drag-over');
  const file = e.dataTransfer?.files?.[0];
  if (file) _processImportFile(file);
}
function handleImportFileSelect(input) {
  const file = input.files?.[0];
  if (file) _processImportFile(file);
  input.value = ''; // reset so same file can be re-selected
}

// ── Core parser ───────────────────────────────────────────
async function _processImportFile(file) {
  _clearImportError();
  const ext = file.name.split('.').pop().toLowerCase();

  try {
    if (ext === 'json') {
      const text = await file.text();
      await _parseImportJson(text, file.name);
    } else if (ext === 'zip') {
      await _parseImportZip(file);
    } else {
      _showImportError(`Unsupported file type ".${ext}". Please use .json or .zip`);
    }
  } catch(e) {
    _showImportError('Failed to read file: ' + e.message);
  }
}

async function _parseImportJson(text, filename) {
  let data;
  try { data = JSON.parse(text); }
  catch(e) { _showImportError('Invalid JSON: ' + e.message); return; }

  // Support multiple JSON shapes:
  // 1) AgentSpark share payload  { v, agents, files, topic, level, lang }
  // 2) AgentSpark project record { id, name, agents, files, topic, ... }
  // 3) Raw agents array           [ { id, name, ... }, ... ]
  let payload;
  if (Array.isArray(data) && data[0]?.id && data[0]?.name) {
    // Raw agents array
    payload = { agents: data, topic: 'Imported', level: 'iskra', files: {} };
  } else if (data.agents?.length) {
    payload = data;
  } else {
    _showImportError('No agents found in this JSON file. Make sure it\'s an AgentSpark export.');
    return;
  }
  _importParsed = { ...payload, _sourceFile: filename };
  _showImportPreview(payload, filename);
}

async function _parseImportZip(file) {
  if (typeof JSZip === 'undefined') {
    _showImportError('JSZip library not loaded — cannot read ZIP files.'); return;
  }
  let zip;
  try {
    zip = await JSZip.loadAsync(file);
  } catch(e) {
    _showImportError('Cannot open ZIP: ' + e.message); return;
  }

  // Strategy 1: look for agentspark.json manifest (lossless)
  const manifestFile = zip.file('agentspark.json');
  if (manifestFile) {
    const text = await manifestFile.async('text');
    await _parseImportJson(text, file.name + ' → agentspark.json');
    return;
  }

  // Strategy 2: look for any .json in the zip
  const jsonFiles = Object.keys(zip.files).filter(n => n.endsWith('.json') && !zip.files[n].dir);
  for (const jf of jsonFiles) {
    const text = await zip.file(jf).async('text');
    try {
      const data = JSON.parse(text);
      if (data.agents?.length) {
        _importParsed = { ...data, _sourceFile: file.name };
        _showImportPreview(data, file.name);
        return;
      }
    } catch(e) { /* try next */ }
  }

  // Strategy 3: reconstruct from .md files (generic zip without manifest)
  const mdFiles = {};
  const mdNames = Object.keys(zip.files).filter(n => n.endsWith('.md') && !zip.files[n].dir);
  for (const mf of mdNames) {
    mdFiles[mf] = await zip.file(mf).async('text');
  }
  if (!mdNames.length) {
    _showImportError('No recognizable AgentSpark files found in this ZIP.'); return;
  }
  const reconstructed = _reconstructFromMdFiles(mdFiles, file.name);
  if (!reconstructed.agents.length) {
    _showImportError('Could not reconstruct agents from .md files in this ZIP.'); return;
  }
  _importParsed = { ...reconstructed, _sourceFile: file.name };
  _showImportPreview(reconstructed, file.name);
}

// Reconstruct minimal agent list from agent-*.md files
function _reconstructFromMdFiles(mdFiles, zipName) {
  const agents = [];
  const files  = { ...mdFiles };
  let topic = 'Imported from ZIP';

  // Try to get topic from README.md
  if (mdFiles['README.md']) {
    const m = mdFiles['README.md'].match(/\*\*Project:\*\*\s*(.+)/);
    if (m) topic = m[1].trim();
  }

  // Parse agent-*.md files
  Object.entries(mdFiles).forEach(([name, content]) => {
    if (!name.startsWith('agent-') || !name.endsWith('.md')) return;
    const idSlug = name.replace(/^agent-/, '').replace(/\.md$/, '');
    const nameMatch    = content.match(/^#\s+Agent:\s+(.+)/m);
    const roleMatch    = content.match(/\*\*Role:\*\*\s*(.+)/m);
    const emojiMatch   = content.match(/^##\s+Identity[\s\S]*?([^\w\s])/m);
    const descMatch    = content.match(/^##\s+Goal\s*\n+([\s\S]+?)(?:\n##|$)/m);
    agents.push({
      id:          idSlug,
      name:        nameMatch?.[1]?.trim()  || idSlug,
      emoji:       emojiMatch?.[1]         || '🤖',
      type:        'technical',
      role:        roleMatch?.[1]?.trim()  || 'Agent',
      description: descMatch?.[1]?.trim().slice(0, 200) || '',
      agentMd:     content,
      skillMd:     mdFiles[`skill-${idSlug}.md`] || '',
    });
  });

  return { agents, files, topic, level: 'iskra', lang: 'en' };
}

// ── Preview ───────────────────────────────────────────────
function _showImportPreview(payload, filename) {
  const agents = payload.agents || [];
  const tech   = agents.filter(a => a.type === 'technical');
  const biz    = agents.filter(a => a.type !== 'technical');
  const fileCount = Object.keys(payload.files || {}).length;

  const preview = document.getElementById('import-preview');
  const content = document.getElementById('import-preview-content');
  const dropzone = document.getElementById('import-dropzone');

  content.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 1.5rem;margin-bottom:0.75rem;">
      <div><span style="color:var(--muted);font-size:0.72rem;">FILE</span><br/><strong style="font-size:0.85rem;">${_escHtml(filename)}</strong></div>
      <div><span style="color:var(--muted);font-size:0.72rem;">TOPIC</span><br/><strong style="font-size:0.85rem;">${_escHtml(payload.topic || '—')}</strong></div>
      <div><span style="color:var(--muted);font-size:0.72rem;">LEVEL</span><br/><strong style="font-size:0.85rem;">${payload.level || '—'}</strong></div>
      <div><span style="color:var(--muted);font-size:0.72rem;">FILES</span><br/><strong style="font-size:0.85rem;">${fileCount} .md files</strong></div>
    </div>
    <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.4rem;">AGENTS (${agents.length})</div>
    <div style="display:flex;flex-wrap:wrap;gap:0.4rem;">
      ${agents.map(a => `<span style="font-size:0.75rem;padding:0.2rem 0.55rem;border-radius:5px;
        background:${a.type==='technical'?'rgba(124,58,255,0.12)':'rgba(255,107,53,0.12)'};
        border:1px solid ${a.type==='technical'?'rgba(196,147,10,0.3)':'rgba(255,107,53,0.3)'};
        color:${a.type==='technical'?'var(--accent3)':'var(--accent2)'}">${a.emoji||'🤖'} ${_escHtml(a.name)}</span>`).join('')}
    </div>
    ${!agents.length ? '<div style="color:var(--accent2);">⚠ No agents detected</div>' : ''}
  `;

  preview.style.display = 'block';
  dropzone.style.opacity = '0.5';
  dropzone.style.pointerEvents = 'none';
}

// ── Confirm import ────────────────────────────────────────
async function confirmImport() {
  if (!_importParsed) return;
  const p = _importParsed;
  const saveToDb = document.getElementById('import-save-checkbox')?.checked !== false;

  // Restore state — same pattern as loadProject / share restore
  currentTopic    = p.topic   || 'Imported Project';
  currentLevel    = p.level   || 'iskra';
  if (p.lang) { lang = p.lang; setLang(lang); }
  generatedAgents = JSON.parse(JSON.stringify(p.agents || []));
  generatedFiles  = JSON.parse(JSON.stringify(p.files  || {}));

  // Regenerate missing files
  if (!generatedFiles['README.md'] && generatedAgents.length) {
    generatedFiles['README.md'] = generateReadme();
  }
  generatedAgents.forEach(a => {
    if (!generatedFiles[`agent-${a.id}.md`] && a.agentMd)
      generatedFiles[`agent-${a.id}.md`] = a.agentMd;
    if (!generatedFiles[`skill-${a.id}.md`] && a.skillMd)
      generatedFiles[`skill-${a.id}.md`] = a.skillMd;
  });

  // Bootstrap version history
  versionHistory = [{
    id: Date.now(),
    label: lang==='en' ? `Imported: ${currentTopic}` : `Zaimportowany: ${currentTopic}`,
    ts: new Date(),
    agents: JSON.parse(JSON.stringify(generatedAgents)),
    files:  JSON.parse(JSON.stringify(generatedFiles)),
    diff: { added: [], removed: [], changed: [] },
    removedNames: {},
    agentNames: Object.fromEntries(generatedAgents.map(a => [a.id, a.name])),
    vNum: 1,
    isOrigin: true,
  }];

  // Reset project ID — will be assigned fresh by save
  _currentProjectId = null;

  closeImportModal();
  showScreen('results');
  document.getElementById('apiKeyHeader').style.display = 'flex';
  showResults(false);

  // Save to IndexedDB if requested
  if (saveToDb) {
    await saveCurrentProject(true);
  }

  showNotif(lang==='en'
    ? `✓ Imported "${currentTopic}" — ${generatedAgents.length} agents`
    : `✓ Zaimportowano "${currentTopic}" — ${generatedAgents.length} agentów`
  );
}

// ── Reset modal ───────────────────────────────────────────
function resetImportModal() {
  _importParsed = null;
  const preview  = document.getElementById('import-preview');
  const error    = document.getElementById('import-error');
  const dropzone = document.getElementById('import-dropzone');
  if (preview)  preview.style.display  = 'none';
  if (error)    error.style.display    = 'none';
  if (dropzone) { dropzone.style.opacity = ''; dropzone.style.pointerEvents = ''; }
}

function _showImportError(msg) {
  const el = document.getElementById('import-error');
  if (!el) return;
  el.textContent = '⚠ ' + msg;
  el.style.display = 'block';
}
function _clearImportError() {
  const el = document.getElementById('import-error');
  if (el) el.style.display = 'none';
}

// ─── PROMPT EXPORT (#7) ──────────────────────────────────
let _activePromptTab = 'interview';

const PROMPT_TAB_DESCS = {
  interview: 'System prompt used during the AI interview phase — guides question format, depth calibration, and IMPACT notes.',
  generate:  'System prompt used to generate your agent team JSON from interview answers.',
  refine:    'System prompt used when refining / editing an existing team.'
};

function openPromptExport() {
  _activePromptTab = 'interview';
  _renderPromptTab('interview');
  document.getElementById('prompt-export-modal').classList.add('open');
}

function closePromptExport() {
  document.getElementById('prompt-export-modal').classList.remove('open');
}

function switchPromptTab(tab) {
  _activePromptTab = tab;
  document.querySelectorAll('.prompt-tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('ptab-' + tab).classList.add('active');
  _renderPromptTab(tab);
}

function _getPromptForTab(tab) {
  if (tab === 'interview') return getSystemPrompt();
  if (tab === 'generate')  return getSystemPrompt() + '\n\n--- GENERATION PHASE TRIGGER ---\nWhen user sends [GENERATE], respond with the JSON agent team.';
  if (tab === 'refine')    return getRefineSystemPrompt();
  return '';
}

function _renderPromptTab(tab) {
  const ta = document.getElementById('prompt-export-textarea');
  const desc = document.getElementById('prompt-tab-desc');
  if (ta) ta.value = _getPromptForTab(tab);
  if (desc) desc.textContent = PROMPT_TAB_DESCS[tab] || '';
  // reset copy feedback
  const fb = document.getElementById('copy-prompt-feedback');
  if (fb) { fb.textContent = ''; fb.style.opacity = '0'; }
}

async function copyPromptToClipboard() {
  const ta = document.getElementById('prompt-export-textarea');
  const fb = document.getElementById('copy-prompt-feedback');
  const btn = document.getElementById('copy-prompt-btn');
  if (!ta) return;
  try {
    await navigator.clipboard.writeText(ta.value);
    if (fb) { fb.textContent = '✓ Copied!'; fb.style.opacity = '1'; setTimeout(() => { fb.style.opacity = '0'; }, 2000); }
    if (btn) { const orig = btn.textContent; btn.textContent = '✓ Copied!'; setTimeout(() => { btn.textContent = orig; }, 1500); }
  } catch(e) {
    ta.select();
    document.execCommand('copy');
    if (fb) { fb.textContent = '✓ Copied!'; fb.style.opacity = '1'; setTimeout(() => { fb.style.opacity = '0'; }, 2000); }
  }
}

function downloadPromptTxt() {
  const content = _getPromptForTab(_activePromptTab);
  const topicSlug = (currentTopic || 'agentspark').toLowerCase().replace(/\s+/g, '-');
  const filename = `prompt-${_activePromptTab}-${topicSlug}.txt`;
  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function openFrameworkExport() {
  if(!generatedAgents.length) {
    showNotif(lang==='en' ? '⚠ Generate a team first' : '⚠ Najpierw wygeneruj zespół', true);
    return;
  }
  renderFwModal();
  document.getElementById('fw-modal').classList.add('open');
}

function closeFwModal() {
  document.getElementById('fw-modal').classList.remove('open');
}

function renderFwModal() {
  const tabsEl = document.getElementById('fw-tabs');
  const bodyEl = document.getElementById('fw-body');
  tabsEl.innerHTML = '';
  bodyEl.innerHTML = '';

  FRAMEWORKS.forEach(fw => {
    // Tab
    const tab = document.createElement('button');
    tab.className = 'fw-tab' + (activeFwTab === fw.id ? ' active' : '');
    tab.innerHTML = `${fw.logo} ${fw.label} <span class="fw-badge">${fw.badge}</span>`;
    tab.onclick = () => { activeFwTab = fw.id; renderFwModal(); };
    tabsEl.appendChild(tab);

    // Pane
    const pane = document.createElement('div');
    pane.className = 'fw-pane' + (activeFwTab === fw.id ? ' active' : '');

    const code = generateFrameworkCode(fw.id);
    pane.innerHTML = `
      <div class="fw-info">
        <div class="fw-info-text">
          <div class="fw-info-title">${fw.logo} ${fw.label}</div>
          <div class="fw-info-desc">${fw.desc} <a href="${fw.url}" target="_blank" style="color:var(--accent);text-decoration:none;">Docs ↗</a></div>
        </div>
      </div>
      <div class="fw-code-wrap">
        <pre id="fw-code-${fw.id}">${escapeHtml(code)}</pre>
      </div>
      <div class="fw-footer-row">
        <div class="fw-pip">$ ${fw.pip}</div>
        <button class="modal-download-btn" onclick="copyFwCode('${fw.id}')">📋 ${lang==='en'?'Copy':'Kopiuj'}</button>
        <button class="modal-download-btn" onclick="downloadFwCode('${fw.id}')">⬇ ${lang==='en'?'Download .py':'Pobierz .py'}</button>
      </div>
    `;
    bodyEl.appendChild(pane);
  });
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function copyFwCode(fwId) {
  const code = generateFrameworkCode(fwId);
  navigator.clipboard.writeText(code).then(() => {
    showNotif(lang==='en' ? '✓ Code copied to clipboard!' : '✓ Kod skopiowany!');
  }).catch(() => {
    showNotif(lang==='en' ? '⚠ Copy failed — select manually' : '⚠ Kopiowanie nieudane', true);
  });
}

function downloadFwCode(fwId) {
  const code = generateFrameworkCode(fwId);
  const slug = currentTopic.toLowerCase().replace(/\s+/g, '_');
  const filename = `${fwId}_${slug}.py`;
  const blob = new Blob([code], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  showNotif(`✓ ${filename} downloaded`);
}

// ── Code generators ────────────────────────────────────────

function generateFrameworkCode(fwId) {
  switch(fwId) {
    case 'crewai':   return genCrewAI();
    case 'langgraph': return genLangGraph();
    case 'autogen':  return genAutoGen();
    case 'swarm':    return genSwarm();
    default:         return '# Unknown framework';
  }
}

function agentVarName(agent) {
  return agent.id.replace(/-/g, '_') + '_agent';
}
function taskVarName(agent) {
  return agent.id.replace(/-/g, '_') + '_task';
}

function genCrewAI() {
  const topic = currentTopic;
  const agents = generatedAgents;
  const agentDefs = agents.map(a => `
${agentVarName(a)} = Agent(
    role="${a.role || a.name}",
    goal="${a.description.split('.')[0]}.",
    backstory="""${a.description}""",
    verbose=True,
    allow_delegation=${a.type === 'technical' ? 'False' : 'True'},
    tools=[],  # Add your tools here
)`).join('\n');

  const taskDefs = agents.map((a, i) => {
    const next = agents[i + 1];
    return `
${taskVarName(a)} = Task(
    description="""
    Topic: ${topic}
    Agent: ${a.name} — ${a.role || ''}
    ${a.description}
    """,
    expected_output="Detailed output from ${a.name} covering its responsibilities.",
    agent=${agentVarName(a)},${next ? `\n    context=[],  # Will receive output from previous tasks` : ''}
)`;
  }).join('\n');

  const agentList = agents.map(a => `    ${agentVarName(a)},`).join('\n');
  const taskList  = agents.map(a => `    ${taskVarName(a)},`).join('\n');

  return `"""
AgentSpark → CrewAI Export
Topic: ${topic}
Generated: ${new Date().toISOString().slice(0,10)}
Docs: https://docs.crewai.com
"""

from crewai import Agent, Task, Crew, Process
# from crewai_tools import SerperDevTool, FileReadTool  # uncomment to add tools

# ── Agents ────────────────────────────────────────────────
${agentDefs}

# ── Tasks ─────────────────────────────────────────────────
${taskDefs}

# ── Crew ──────────────────────────────────────────────────
crew = Crew(
    agents=[
${agentList}
    ],
    tasks=[
${taskList}
    ],
    process=Process.sequential,  # or Process.hierarchical
    verbose=True,
)

# ── Run ───────────────────────────────────────────────────
if __name__ == "__main__":
    result = crew.kickoff()
    print("\\n=== CREW RESULT ===")
    print(result)
`;
}

function genLangGraph() {
  const topic = currentTopic;
  const agents = generatedAgents;

  const stateFields = agents.map(a =>
    `    ${a.id.replace(/-/g,'_')}_output: str`
  ).join('\n');

  const nodeDefs = agents.map(a => {
    const varName = a.id.replace(/-/g,'_');
    return `
def ${varName}_node(state: AgentState) -> AgentState:
    """${a.name}: ${a.description.split('.')[0]}."""
    response = llm.invoke([
        SystemMessage(content="""You are ${a.name}, ${a.role || a.description.split('.')[0]}.
Topic: ${topic}
Task: ${a.description}"""),
        HumanMessage(content=state.get("user_input", "Start the workflow.")),
    ])
    state["${varName}_output"] = response.content
    state["messages"].append(AIMessage(content=f"[${a.name}] " + response.content))
    return state`;
  }).join('\n');

  const addNodes = agents.map(a =>
    `workflow.add_node("${a.id}", ${a.id.replace(/-/g,'_')}_node)`
  ).join('\n');

  const addEdges = agents.map((a, i) => {
    if(i === 0) return `workflow.set_entry_point("${a.id}")`;
    return `workflow.add_edge("${agents[i-1].id}", "${a.id}")`;
  }).join('\n');

  const lastId = agents[agents.length-1]?.id || 'end';

  return `"""
AgentSpark → LangGraph Export
Topic: ${topic}
Generated: ${new Date().toISOString().slice(0,10)}
Docs: https://langchain-ai.github.io/langgraph
"""

from typing import TypedDict, Annotated
from langgraph.graph import StateGraph, END
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage
import operator

# ── State ─────────────────────────────────────────────────
class AgentState(TypedDict):
    messages: Annotated[list, operator.add]
    user_input: str
${stateFields}

# ── LLM ───────────────────────────────────────────────────
llm = ChatOpenAI(model="gpt-4o", temperature=0.7)

# ── Agent Nodes ───────────────────────────────────────────
${nodeDefs}

# ── Graph ─────────────────────────────────────────────────
workflow = StateGraph(AgentState)

${addNodes}

${addEdges}
workflow.add_edge("${lastId}", END)

app = workflow.compile()

# ── Run ───────────────────────────────────────────────────
if __name__ == "__main__":
    result = app.invoke({
        "messages": [],
        "user_input": "Build the ${topic} application.",
${agents.map(a => `        "${a.id.replace(/-/g,'_')}_output": ""`).join(',\n')}
    })
    print("\\n=== FINAL STATE ===")
    for key, val in result.items():
        if val and key != "messages":
            print(f"\\n[{key}]\\n{val}")
`;
}

function genAutoGen() {
  const topic = currentTopic;
  const agents = generatedAgents;

  const agentDefs = agents.map(a => `
${a.id.replace(/-/g,'_')} = AssistantAgent(
    name="${a.name.replace(/\s+/g,'_')}",
    system_message="""You are ${a.name}.
Role: ${a.role || a.name}
Responsibilities: ${a.description}
Topic: ${topic}

When you complete your part, summarize your output clearly and pass to the next agent.""",
    llm_config=llm_config,
)`).join('\n');

  const groupChatAgents = agents.map(a => `    ${a.id.replace(/-/g,'_')},`).join('\n');

  return `"""
AgentSpark → AutoGen Export
Topic: ${topic}
Generated: ${new Date().toISOString().slice(0,10)}
Docs: https://microsoft.github.io/autogen
"""

import autogen

# ── LLM Config ────────────────────────────────────────────
llm_config = {
    "config_list": [{"model": "gpt-4o", "api_key": "YOUR_OPENAI_API_KEY"}],
    "temperature": 0.7,
    "timeout": 120,
}

# ── Human Proxy ───────────────────────────────────────────
user_proxy = autogen.UserProxyAgent(
    name="UserProxy",
    human_input_mode="NEVER",  # Set to "ALWAYS" for interactive mode
    max_consecutive_auto_reply=10,
    is_termination_msg=lambda x: "TASK_COMPLETE" in x.get("content", ""),
    code_execution_config={"work_dir": "workspace", "use_docker": False},
)

# ── Agents ────────────────────────────────────────────────
${agentDefs}

# ── Group Chat ────────────────────────────────────────────
groupchat = autogen.GroupChat(
    agents=[
        user_proxy,
${groupChatAgents}
    ],
    messages=[],
    max_round=20,
    speaker_selection_method="round_robin",  # or "auto"
)

manager = autogen.GroupChatManager(
    groupchat=groupchat,
    llm_config=llm_config,
)

# ── Run ───────────────────────────────────────────────────
if __name__ == "__main__":
    user_proxy.initiate_chat(
        manager,
        message=f"""
        Build the ${topic} application.
        Each agent should complete their responsibilities and hand off to the next.
        Finish with TASK_COMPLETE when all work is done.
        """,
    )
`;
}

function genSwarm() {
  const topic = currentTopic;
  const agents = generatedAgents;

  const agentDefs = agents.map((a, i) => {
    const nextAgent = agents[i + 1];
    const handoff = nextAgent
      ? `\n    handoff_to_${nextAgent.id.replace(/-/g,'_')} = transfer_to_${nextAgent.id.replace(/-/g,'_')}()`
      : '';
    return `
def ${a.id.replace(/-/g,'_')}_instructions(context_variables):
    return f"""You are ${a.name}.
Role: ${a.role || a.name}
Topic: ${topic}
Task: ${a.description}
${nextAgent ? `When done, call transfer_to_${nextAgent.id.replace(/-/g,'_')} to pass to the next agent.` : 'This is the final step. Summarize all work done.'}"""

${a.id.replace(/-/g,'_')} = Agent(
    name="${a.name}",
    instructions=${a.id.replace(/-/g,'_')}_instructions,
    functions=[${nextAgent ? `transfer_to_${nextAgent.id.replace(/-/g,'_')}` : ''}],
)`;
  }).join('\n');

  const transferFns = agents.slice(0, -1).map((a, i) => {
    const next = agents[i + 1];
    return `
def transfer_to_${next.id.replace(/-/g,'_')}():
    """Transfer to ${next.name} — ${next.description.split('.')[0]}."""
    return ${next.id.replace(/-/g,'_')}`;
  }).join('\n');

  const firstAgent = agents[0]?.id.replace(/-/g,'_') || 'agent';

  return `"""
AgentSpark → OpenAI Swarm Export
Topic: ${topic}
Generated: ${new Date().toISOString().slice(0,10)}
Docs: https://github.com/openai/swarm
Install: pip install git+https://github.com/openai/swarm.git
"""

from swarm import Swarm, Agent

client = Swarm()

# ── Transfer Functions (forward declarations) ──────────────
${agents.slice(1).map(a => `${a.id.replace(/-/g,'_')} = None  # defined below`).join('\n')}

# ── Agents ────────────────────────────────────────────────
${agentDefs}

# ── Handoff Functions ─────────────────────────────────────
${transferFns}

# ── Fix forward references ────────────────────────────────
${agents.slice(0,-1).map((a,i) => {
    const next = agents[i+1];
    return `${a.id.replace(/-/g,'_')}.functions = [transfer_to_${next.id.replace(/-/g,'_')}]`;
  }).join('\n')}

# ── Run ───────────────────────────────────────────────────
if __name__ == "__main__":
    response = client.run(
        agent=${firstAgent},
        messages=[{"role": "user", "content": "Build the ${topic} application. Complete all steps."}],
        context_variables={"topic": "${topic}"},
        debug=False,
    )
    print("\\n=== SWARM RESULT ===")
    print(response.messages[-1]["content"])
`;
}

document.getElementById('fw-modal').addEventListener('click', function(e) {
  if(e.target === this) closeFwModal();
});
document.getElementById('diff-modal').addEventListener('click', function(e) {
  if(e.target === this) closeDiffModal();
});
document.getElementById('prompt-export-modal').addEventListener('click', function(e) {
  if(e.target === this) closePromptExport();
});
document.getElementById('import-modal').addEventListener('click', function(e) {
  if(e.target === this) closeImportModal();
});

// ─── SHARING VIA URL ──────────────────────────────────────

// Compress string → Uint8Array (gzip via CompressionStream)
async function compress(str) {
  const stream = new CompressionStream('gzip');
  const writer = stream.writable.getWriter();
  const enc = new TextEncoder();
  writer.write(enc.encode(str));
  writer.close();
  const chunks = [];
  const reader = stream.readable.getReader();
  while(true) {
    const { done, value } = await reader.read();
    if(done) break;
    chunks.push(value);
  }
  const total = chunks.reduce((n, c) => n + c.length, 0);
  const out = new Uint8Array(total);
  let offset = 0;
  for(const c of chunks) { out.set(c, offset); offset += c.length; }
  return out;
}

// Decompress Uint8Array → string
async function decompress(bytes) {
  const stream = new DecompressionStream('gzip');
  const writer = stream.writable.getWriter();
  writer.write(bytes);
  writer.close();
  const chunks = [];
  const reader = stream.readable.getReader();
  while(true) {
    const { done, value } = await reader.read();
    if(done) break;
    chunks.push(value);
  }
  const total = chunks.reduce((n, c) => n + c.length, 0);
  const out = new Uint8Array(total);
  let offset = 0;
  for(const c of chunks) { out.set(c, offset); offset += c.length; }
  return new TextDecoder().decode(out);
}

// Uint8Array → URL-safe base64
function uint8ToBase64url(bytes) {
  let bin = '';
  for(let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

// URL-safe base64 → Uint8Array
function base64urlToUint8(str) {
  const b64 = str.replace(/-/g, '+').replace(/_/g, '/');
  const bin = atob(b64);
  const out = new Uint8Array(bin.length);
  for(let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
  return out;
}

// Simple XOR kept ONLY for backward-compat reading of v:2 links
function xorObfuscate(str, password) {
  const key = password.split('').map(c => c.charCodeAt(0));
  return str.split('').map((c, i) =>
    String.fromCharCode(c.charCodeAt(0) ^ key[i % key.length])
  ).join('');
}

// ── AES-256-GCM helpers (#3) ──────────────────────────────
// Derive a 256-bit key from a password using PBKDF2 + a fixed app salt
async function _aesKeyFromPassword(password, saltBytes) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']
  );
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: saltBytes, iterations: 200_000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function aesGcmEncrypt(plaintext, password) {
  const enc      = new TextEncoder();
  const iv       = crypto.getRandomValues(new Uint8Array(12));  // 96-bit IV
  const salt     = crypto.getRandomValues(new Uint8Array(16));  // 128-bit PBKDF2 salt
  const key      = await _aesKeyFromPassword(password, salt);
  const ctBuf    = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv },
    key,
    enc.encode(plaintext)
  );
  // Pack: [salt 16B][iv 12B][ciphertext …]
  const ct = new Uint8Array(ctBuf);
  const packed = new Uint8Array(salt.length + iv.length + ct.length);
  packed.set(salt, 0);
  packed.set(iv,   salt.length);
  packed.set(ct,   salt.length + iv.length);
  return packed;
}

async function aesGcmDecrypt(packedBytes, password) {
  const salt = packedBytes.slice(0, 16);
  const iv   = packedBytes.slice(16, 28);
  const ct   = packedBytes.slice(28);
  const key  = await _aesKeyFromPassword(password, salt);
  const ptBuf = await crypto.subtle.decrypt(
    { name: 'AES-GCM', iv },
    key,
    ct
  );
  return new TextDecoder().decode(ptBuf);
}

// ── Password unlock modal promise ─────────────────────────
let _unlockResolve = null;
let _unlockRejectCb = null;

function _unlockReject() {
  document.getElementById('unlock-modal').classList.remove('open');
  if (_unlockRejectCb) { _unlockRejectCb(new Error('cancelled')); _unlockRejectCb = null; }
}

function _promptPassword(descText) {
  return new Promise((resolve, reject) => {
    _unlockResolve  = resolve;
    _unlockRejectCb = reject;
    const descEl = document.getElementById('unlock-modal-desc');
    if (descEl && descText) descEl.textContent = descText;
    const input = document.getElementById('unlock-password-input');
    if (input) input.value = '';
    const errEl = document.getElementById('unlock-error');
    if (errEl) errEl.style.display = 'none';
    document.getElementById('unlock-modal').classList.add('open');
    setTimeout(() => input?.focus(), 80);
  });
}

function _unlockConfirm() {
  const pw = document.getElementById('unlock-password-input')?.value || '';
  if (!pw) return;
  document.getElementById('unlock-modal').classList.remove('open');
  if (_unlockResolve) { _unlockResolve(pw); _unlockResolve = null; }
}

function _unlockShowError() {
  const errEl = document.getElementById('unlock-error');
  if (errEl) errEl.style.display = 'block';
  const input = document.getElementById('unlock-password-input');
  if (input) { input.value = ''; input.focus(); }
  document.getElementById('unlock-modal').classList.add('open');
}

let _shareUrl  = '';
let _shareMode = 'open';

async function generateShareUrl() {
  const password    = document.getElementById('share-password-input')?.value?.trim() || '';
  const usePassword = _shareMode === 'password' && password.length > 0;

  // Build state payload
  const payload = {
    v:      3,             // v3 = AES-GCM encrypted (v2 = legacy XOR)
    topic:  currentTopic,
    level:  currentLevel,
    lang,
    agents: generatedAgents,
    files:  generatedFiles,
    ts:     Date.now(),
    pw:     usePassword,
  };

  try {
    const jsonStr = JSON.stringify(payload);
    let dataToCompress;

    if (usePassword) {
      // Encrypt with AES-256-GCM, then compress the packed binary
      const encrypted = await aesGcmEncrypt(jsonStr, password);
      dataToCompress  = encrypted;                       // Uint8Array
      const compressed = await _compressBytes(dataToCompress);
      const encoded    = uint8ToBase64url(compressed);
      const base       = window.location.href.split('#')[0];
      _shareUrl        = `${base}#share=${encoded}`;
    } else {
      const compressed = await compress(jsonStr);
      const encoded    = uint8ToBase64url(compressed);
      const base       = window.location.href.split('#')[0];
      _shareUrl        = `${base}#share=${encoded}`;
    }

    const displayEl = document.getElementById('share-url-display');
    if (displayEl) displayEl.value = _shareUrl;

    const kb     = (_shareUrl.length / 1024).toFixed(1);
    const sizeEl = document.getElementById('share-size-label');
    if (sizeEl) {
      sizeEl.textContent = `${kb} KB`;
      sizeEl.className   = parseFloat(kb) > 100 ? 'share-size-warn' : '';
    }
    const agentEl = document.getElementById('share-agent-count');
    if (agentEl) agentEl.textContent = `${generatedAgents.length} agents`;
    const verEl   = document.getElementById('share-version-label');
    if (verEl)    verEl.textContent = `v${versionHistory.length || 1} (latest)`;

  } catch(e) {
    const displayEl = document.getElementById('share-url-display');
    if (displayEl) displayEl.value = 'Error generating link: ' + e.message;
  }
}

// Compress raw Uint8Array (for encrypted binary blobs)
async function _compressBytes(bytes) {
  const stream = new CompressionStream('gzip');
  const writer = stream.writable.getWriter();
  writer.write(bytes);
  writer.close();
  const chunks = [];
  const reader = stream.readable.getReader();
  while(true) {
    const { done, value } = await reader.read();
    if(done) break;
    chunks.push(value);
  }
  const total = chunks.reduce((n,c) => n + c.length, 0);
  const out   = new Uint8Array(total);
  let offset  = 0;
  for(const c of chunks) { out.set(c, offset); offset += c.length; }
  return out;
}

async function _decompressBytes(bytes) {
  const stream = new DecompressionStream('gzip');
  const writer = stream.writable.getWriter();
  writer.write(bytes);
  writer.close();
  const chunks = [];
  const reader = stream.readable.getReader();
  while(true) {
    const { done, value } = await reader.read();
    if(done) break;
    chunks.push(value);
  }
  const total = chunks.reduce((n,c) => n + c.length, 0);
  const out   = new Uint8Array(total);
  let offset  = 0;
  for(const c of chunks) { out.set(c, offset); offset += c.length; }
  return out;
}

function onShareModeChange() {
  const val = document.querySelector('input[name="share-mode"]:checked')?.value || 'open';
  _shareMode = val;

  document.getElementById('share-opt-open').classList.toggle('active', val === 'open');
  document.getElementById('share-opt-password').classList.toggle('active', val === 'password');

  const pwRow = document.getElementById('share-password-row');
  if(pwRow) pwRow.style.display = val === 'password' ? 'flex' : 'none';

  generateShareUrl();
}

function openShareModal() {
  if(!generatedAgents.length) {
    showNotif(lang==='en' ? '⚠ Generate a team first' : '⚠ Najpierw wygeneruj zespół', true);
    return;
  }
  _shareMode = 'open';
  // Reset UI
  const openOpt = document.querySelector('input[name="share-mode"][value="open"]');
  if(openOpt) openOpt.checked = true;
  document.getElementById('share-opt-open').classList.add('active');
  document.getElementById('share-opt-password').classList.remove('active');
  document.getElementById('share-password-row').style.display = 'none';
  const pwInput = document.getElementById('share-password-input');
  if(pwInput) pwInput.value = '';

  const copyBtn = document.getElementById('share-copy-btn');
  if(copyBtn) { copyBtn.textContent = '📋 Copy'; copyBtn.classList.remove('copied'); }

  document.getElementById('share-modal').classList.add('open');
  generateShareUrl();
}

function closeShareModal() {
  document.getElementById('share-modal').classList.remove('open');
}

async function copyShareUrl() {
  if(!_shareUrl) return;
  try {
    await navigator.clipboard.writeText(_shareUrl);
    const btn = document.getElementById('share-copy-btn');
    btn.textContent = '✓ Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = '📋 Copy'; btn.classList.remove('copied'); }, 2500);
    showNotif(lang==='en' ? '✓ Share link copied!' : '✓ Link skopiowany!');
  } catch(e) {
    showNotif(lang==='en' ? '⚠ Copy failed' : '⚠ Kopiowanie nieudane', true);
  }
}

// ── Load from URL hash on startup ──────────────────────────
async function loadFromHash() {
  const hash = window.location.hash;
  if(!hash.startsWith('#share=')) return false;

  const encoded = hash.slice('#share='.length);
  if(!encoded) return false;

  try {
    const bytes = base64urlToUint8(encoded);

    // Try 1: decompress as plain text (unencrypted, v1 or v2 open link)
    let payload = null;
    let jsonStr = null;
    try {
      jsonStr = await decompress(bytes);
      payload = JSON.parse(jsonStr);
    } catch(e) {
      // Not valid plain JSON after decompress — could be:
      // (a) v3 AES-GCM encrypted binary, or
      // (b) v2 XOR-obfuscated (legacy)
      // In both cases, decompress gave us bytes or garbled text.
      // We'll re-decompress the raw bytes and attempt AES-GCM first.
    }

    // If payload has pw:true it was flagged as password-protected
    if (payload && payload.pw) {
      // v2 legacy XOR path
      let pw;
      try {
        pw = await _promptPassword(
          lang === 'en'
            ? '🔒 This team is password protected. Enter the password to unlock it.'
            : '🔒 Ten zespół jest chroniony hasłem. Podaj hasło, aby go odblokować.'
        );
      } catch(e) { return false; } // user cancelled

      while (true) {
        const decrypted = xorObfuscate(jsonStr, pw);
        try {
          payload = JSON.parse(decrypted);
          break; // success
        } catch(e2) {
          _unlockShowError();
          try {
            pw = await _promptPassword();
          } catch(e3) { return false; }
        }
      }
    }

    // If no valid plain payload yet → treat as v3 AES-GCM encrypted binary
    if (!payload) {
      let decompressedBytes;
      try {
        decompressedBytes = await _decompressBytes(bytes);
      } catch(e) {
        decompressedBytes = bytes; // maybe not compressed
      }

      let pw;
      try {
        pw = await _promptPassword(
          lang === 'en'
            ? '🔒 This team is password protected (AES-256-GCM). Enter the password to unlock it.'
            : '🔒 Ten zespół jest zaszyfrowany (AES-256-GCM). Podaj hasło, aby go odblokować.'
        );
      } catch(e) { return false; }

      while (true) {
        try {
          const decrypted = await aesGcmDecrypt(decompressedBytes, pw);
          payload = JSON.parse(decrypted);
          break; // success
        } catch(e) {
          _unlockShowError();
          try {
            pw = await _promptPassword();
          } catch(e2) { return false; }
        }
      }
    }

    if(!payload?.agents?.length) return false;

    // Restore state
    currentTopic = payload.topic || 'Shared Team';
    currentLevel = payload.level || 'iskra';
    if(payload.lang) lang = payload.lang;
    generatedAgents = payload.agents;
    generatedFiles  = payload.files || {};
    versionHistory  = [{
      id: Date.now(),
      label: lang==='en' ? `Shared: ${currentTopic}` : `Udostępniony: ${currentTopic}`,
      ts: new Date(payload.ts || Date.now()),
      agents: JSON.parse(JSON.stringify(generatedAgents)),
      files:  JSON.parse(JSON.stringify(generatedFiles)),
      diff: { added: [], removed: [], changed: [] },
      removedNames: {},
      agentNames: Object.fromEntries(generatedAgents.map(a => [a.id, a.name])),
      vNum: 1,
      isOrigin: true,
    }];

    // Show results
    showResults();

    // Show shared banner
    const banner = document.getElementById('shared-banner');
    const bannerTitle = document.getElementById('shared-banner-title');
    const bannerSub   = document.getElementById('shared-banner-sub');
    if(banner) {
      bannerTitle.textContent = lang==='en'
        ? `🔗 Shared team: "${currentTopic}"`
        : `🔗 Udostępniony zespół: "${currentTopic}"`;
      bannerSub.textContent = lang==='en'
        ? `${generatedAgents.length} agents · Read-only view · Start Over to create your own`
        : `${generatedAgents.length} agentów · Widok tylko do odczytu · Zacznij od nowa, by stworzyć własny`;
      banner.style.display = 'flex';
    }

    // Clean hash from URL (so refresh doesn't re-load)
    history.replaceState(null, '', window.location.pathname + window.location.search);

    return true;
  } catch(e) {
    console.warn('[AgentSpark] Failed to load shared URL:', e);
    return false;
  }
}

document.getElementById('share-modal').addEventListener('click', function(e) {
  if(e.target === this) closeShareModal();
});
document.getElementById('unlock-modal').addEventListener('click', function(e) {
  if(e.target === this) _unlockReject();
});

// ─── THEME ────────────────────────────────────────────────
function _toggleThemeCore() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') !== 'light';
  const next = isDark ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('agentspark-theme', next);
  document.getElementById('theme-toggle-btn').textContent = next === 'light' ? '☀️' : '🌙';
  // Sync PWA theme-color meta
  const metaTC = document.getElementById('meta-theme-color');
  if(metaTC) metaTC.content = next === 'light' ? '#faf7ee' : '#1a170d';
}

// Global wrapper called by onclick="toggleTheme()"
// Short click = toggle + save manual preference
// Long press (600ms) = reset to OS auto-detect
let _themeHoldTimer = null;
function toggleTheme() {
  if (_themeHoldTimer === null) return; // longpress already fired
  clearTimeout(_themeHoldTimer);
  _themeHoldTimer = null;
  _toggleThemeCore();
}
function _themeHoldStart() {
  _themeHoldTimer = setTimeout(() => {
    _themeHoldTimer = null;
    localStorage.removeItem('agentspark-theme');
    const next = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    const btn = document.getElementById('theme-toggle-btn');
    if (btn) btn.textContent = next === 'light' ? '☀️' : '🌙';
    const metaTC = document.getElementById('meta-theme-color');
    if (metaTC) metaTC.content = next === 'light' ? '#faf7ee' : '#1a170d';
    showNotif(lang === 'en' ? '🎨 Theme: following OS preference' : '🎨 Motyw: podąża za ustawieniami systemu');
  }, 600);
}

// Init theme from localStorage or auto-detect from OS
(function() {
  const saved = localStorage.getItem('agentspark-theme');
  // If user never manually picked → follow OS preference
  const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = saved || (systemPrefersDark ? 'dark' : 'light');
  document.documentElement.setAttribute('data-theme', theme);
  // Set correct icon after DOM ready
  window.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('theme-toggle-btn');
    if (btn) btn.textContent = theme === 'light' ? '☀️' : '🌙';
  });
  // Listen for OS-level theme changes — only apply if user hasn't manually overridden
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    if (localStorage.getItem('agentspark-theme')) return; // user has manual pref — respect it
    const next = e.matches ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    const btn = document.getElementById('theme-toggle-btn');
    if (btn) btn.textContent = next === 'light' ? '☀️' : '🌙';
    const metaTC = document.getElementById('meta-theme-color');
    if (metaTC) metaTC.content = next === 'light' ? '#faf7ee' : '#1a170d';
  });
})();

// ─── INIT ─────────────────────────────────────────────────
(async () => {
  const loaded = await loadFromHash();
  if(!loaded) renderTopicScreen();
})();

// ─── PWA ──────────────────────────────────────────────────

(function initPWA() {

  // ── 1. Inline Manifest ────────────────────────────────
  const manifest = {
    name: 'AgentSpark',
    short_name: 'AgentSpark',
    description: 'Build your AI agent team in minutes',
    start_url: './',
    display: 'standalone',
    background_color: '#1a170d',
    theme_color: '#1a170d',
    orientation: 'any',
    categories: ['productivity', 'developer', 'utilities'],
    icons: [
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%231a170d'/%3E%3Crect width='192' height='192' rx='40' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='192' y2='192' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23f2b90d' stop-opacity='.3'/%3E%3Cstop offset='1' stop-color='%23c49a0a' stop-opacity='.3'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='96' y='128' font-size='96' text-anchor='middle' fill='%23f2b90d'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E",
        sizes: '192x192', type: 'image/svg+xml', purpose: 'any maskable'
      },
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%231a170d'/%3E%3Crect width='512' height='512' rx='100' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='512' y2='512' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23f2b90d' stop-opacity='.3'/%3E%3Cstop offset='1' stop-color='%23c49a0a' stop-opacity='.3'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='256' y='340' font-size='256' text-anchor='middle' fill='%23f2b90d'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E",
        sizes: '512x512', type: 'image/svg+xml', purpose: 'any maskable'
      }
    ],
    screenshots: [],
    shortcuts: [
      {
        name: 'New Team',
        short_name: 'New',
        description: 'Start building a new AI agent team',
        url: './',
        icons: [{ src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 96 96'%3E%3Ctext y='80' font-size='80'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E", sizes: '96x96' }]
      }
    ]
  };

  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
  const manifestURL  = URL.createObjectURL(manifestBlob);
  const manifestLink = document.getElementById('pwa-manifest');
  if(manifestLink) manifestLink.href = manifestURL;

  // ── 2. Service Worker (inline as Blob) ────────────────
  const CACHE_NAME = 'agentspark-v1';

  const swCode = `
const CACHE = '${CACHE_NAME}';
const FONTS = [
  'https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap',
  'https://fonts.gstatic.com'
];

self.addEventListener('install', e => {
  self.skipWaiting();
  e.waitUntil(
    caches.open(CACHE).then(c => {
      // Cache the app shell itself (the HTML)
      return c.addAll(['./']).catch(() => {});
    })
  );
});

self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys().then(keys =>
      Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
    ).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', e => {
  const url = new URL(e.request.url);

  // Network-first for API calls (never cache)
  if(url.hostname.includes('googleapis.com') && url.pathname.includes('generateContent')) {
    e.respondWith(fetch(e.request));
    return;
  }
  if(url.hostname.includes('openai.com') ||
     url.hostname.includes('anthropic.com') ||
     url.hostname.includes('mistral.ai') ||
     url.hostname.includes('groq.com')) {
    e.respondWith(fetch(e.request));
    return;
  }

  // Cache-first for fonts and static assets
  if(url.hostname.includes('fonts.g') || e.request.destination === 'font') {
    e.respondWith(
      caches.match(e.request).then(cached => cached || fetch(e.request).then(res => {
        const clone = res.clone();
        caches.open(CACHE).then(c => c.put(e.request, clone));
        return res;
      }))
    );
    return;
  }

  // Stale-while-revalidate for the app shell
  e.respondWith(
    caches.open(CACHE).then(cache =>
      cache.match(e.request).then(cached => {
        const fetchPromise = fetch(e.request).then(res => {
          if(res.ok) cache.put(e.request, res.clone());
          return res;
        }).catch(() => cached);
        return cached || fetchPromise;
      })
    )
  );
});

// Listen for skip-waiting message from update toast
self.addEventListener('message', e => {
  if(e.data === 'skipWaiting') self.skipWaiting();
});
`;

  let swRegistration = null;
  let newWorker = null;

  if('serviceWorker' in navigator) {
    const swBlob = new Blob([swCode], { type: 'text/javascript' });
    const swURL  = URL.createObjectURL(swBlob);

    navigator.serviceWorker.register(swURL)
      .then(reg => {
        swRegistration = reg;

        // Detect update (new SW waiting)
        reg.addEventListener('updatefound', () => {
          newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if(newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdateToast();
            }
          });
        });

        // Check for update on focus
        window.addEventListener('focus', () => reg.update());
      })
      .catch(err => console.warn('[AgentSpark SW]', err));

    // Reload page when new SW takes control
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }

  // ── 3. Offline / Online detection ────────────────────
  const offlineBar = document.getElementById('offline-bar');

  function updateOnlineStatus() {
    if(!offlineBar) return;
    offlineBar.classList.toggle('visible', !navigator.onLine);
  }

  window.addEventListener('online',  updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus(); // initial check

  // ── 4. Install prompt (A2HS) ─────────────────────────
  let deferredPrompt = null;
  const DISMISSED_KEY = 'agentspark-pwa-dismissed';

  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;

    // Don't show if previously dismissed (within 7 days)
    const dismissed = localStorage.getItem(DISMISSED_KEY);
    if(dismissed && Date.now() - Number(dismissed) < 7 * 86400000) return;

    // Show install banner after a brief delay
    setTimeout(showInstallBanner, 3000);
  });

  window.addEventListener('appinstalled', () => {
    hideInstallBanner();
    if(typeof showNotif === 'function') {
      showNotif('✓ AgentSpark installed!');
    }
    deferredPrompt = null;
  });

  function showInstallBanner() {
    if(document.getElementById('pwa-install-banner')) return;

    const banner = document.createElement('div');
    banner.id = 'pwa-install-banner';
    banner.className = 'pwa-install-banner';
    banner.innerHTML = `
      <div class="pwa-install-icon">⚡</div>
      <div class="pwa-install-text">
        <div class="pwa-install-title">Install AgentSpark</div>
        <div class="pwa-install-sub">Add to home screen — works offline</div>
      </div>
      <div class="pwa-install-actions">
        <button class="pwa-install-btn" onclick="window._pwaInstall()">Install</button>
        <button class="pwa-dismiss-btn" onclick="window._pwaDismiss()">✕</button>
      </div>
    `;
    document.body.appendChild(banner);
  }

  function hideInstallBanner() {
    const b = document.getElementById('pwa-install-banner');
    if(b) {
      b.style.animation = 'none';
      b.style.opacity = '0';
      b.style.transform = 'translateY(20px)';
      b.style.transition = 'all 0.3s ease';
      setTimeout(() => b.remove(), 300);
    }
  }

  window._pwaInstall = async () => {
    if(!deferredPrompt) return;
    hideInstallBanner();
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    if(outcome === 'dismissed') {
      localStorage.setItem(DISMISSED_KEY, Date.now());
    }
  };

  window._pwaDismiss = () => {
    hideInstallBanner();
    localStorage.setItem(DISMISSED_KEY, Date.now());
  };

  // ── 5. Update toast ───────────────────────────────────
  function showUpdateToast() {
    if(document.getElementById('pwa-update-toast')) return;
    const toast = document.createElement('div');
    toast.id = 'pwa-update-toast';
    toast.className = 'pwa-update-toast pwa-bottom-sheet';
    toast.innerHTML = `
      <span>🔄 New version available</span>
      <button class="pwa-update-btn" onclick="window._pwaUpdate()">Update</button>
      <button class="pwa-dismiss-btn" onclick="this.parentElement.remove()" style="font-size:0.7rem;padding:0.25rem 0.5rem;">✕</button>
    `;
    document.body.appendChild(toast);
    // Auto-hide after 15s
    setTimeout(() => toast.remove(), 15000);
  }

  window._pwaUpdate = () => {
    document.getElementById('pwa-update-toast')?.remove();
    if(newWorker) newWorker.postMessage('skipWaiting');
    else if(swRegistration?.waiting) swRegistration.waiting.postMessage('skipWaiting');
  };

  // ── 6. Theme-color sync with dark/light toggle ────────
  // Handled directly inside toggleTheme() / _toggleThemeCore()

  // Initial sync of meta theme-color on PWA startup
  (function() {
    const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
    const metaTC = document.getElementById('meta-theme-color');
    if(metaTC) metaTC.content = isDark ? '#1a170d' : '#faf7ee';
  })();

})();

document.getElementById('modal').addEventListener('click', function(e) {
  if(e.target === this) closeModal();
});
document.getElementById('md-browser-modal').addEventListener('click', function(e) {
  if(e.target === this) closeMdBrowser();
});

// ── iOS: tap backdrop to dismiss ALL modal-overlays ────────
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', function(e) {
    if (e.target === this) {
      // Find and trigger the close button
      const closeBtn = this.querySelector('.modal-close');
      if (closeBtn) closeBtn.click();
      else this.classList.remove('open');
    }
  });
});


// ═══════════════════════════════════════════════════════════
//  v6 — Drawer · Context bar · Back-to-top · Home panels ·
//       Swipe gestures · Accordion · showInstructions v2
// ═══════════════════════════════════════════════════════════

// ── DRAWER ─────────────────────────────────────────────────
let _drawerOpen = false;
function toggleDrawer() { _drawerOpen ? closeDrawer() : openDrawer(); }

function openDrawer() {
  _drawerOpen = true;
  document.getElementById('nav-drawer').classList.add('open');
  document.getElementById('nav-drawer-overlay').classList.add('open');
  const btn = document.getElementById('burger-btn');
  if (btn) { btn.classList.add('open'); btn.setAttribute('aria-expanded', 'true'); }
  document.body.style.overflow = 'hidden';
  updateDrawerActive();
}

function closeDrawer() {
  _drawerOpen = false;
  document.getElementById('nav-drawer').classList.remove('open');
  const overlay = document.getElementById('nav-drawer-overlay');
  overlay.style.opacity = '0';
  setTimeout(() => { overlay.classList.remove('open'); overlay.style.opacity = ''; }, 280);
  const btn = document.getElementById('burger-btn');
  if (btn) { btn.classList.remove('open'); btn.setAttribute('aria-expanded', 'false'); }
  document.body.style.overflow = '';
}

function updateDrawerActive() {
  const screens = ['home','projects','chat','results'];
  let active = 'home';
  screens.forEach(s => {
    const screen = document.getElementById('screen-' + (s === 'home' ? 'topic' : s));
    if (screen && screen.classList.contains('active')) active = s;
  });
  document.querySelectorAll('.drawer-nav-item').forEach(el => el.classList.remove('active'));
  const activeEl = document.getElementById('dnav-' + active);
  if (activeEl) activeEl.classList.add('active');
  // Badge
  const tabBadge = document.getElementById('tab-badge');
  const dnavBadge = document.getElementById('dnav-badge');
  if (dnavBadge && tabBadge) {
    dnavBadge.textContent = tabBadge.textContent;
    dnavBadge.style.display = tabBadge.style.display;
  }
  // Theme icon
  const themeIcon = document.getElementById('dnav-theme-icon');
  const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
  if (themeIcon) themeIcon.textContent = isDark ? '🌙' : '☀️';
}

// Close drawer on Escape
document.addEventListener('keydown', e => { if (e.key === 'Escape' && _drawerOpen) closeDrawer(); });

// ── BACK TO TOP ────────────────────────────────────────────
function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

let _bttVisible = false;
function _syncBackToTop() {
  const visible = window.scrollY > 320;
  if (visible !== _bttVisible) {
    _bttVisible = visible;
    const btn = document.getElementById('back-to-top');
    if (btn) btn.classList.toggle('visible', visible);
  }
}
window.addEventListener('scroll', _syncBackToTop, { passive: true });

// ── CONTEXT BAR ────────────────────────────────────────────
const _ctxBarConfigs = {
  topic:    { btns: [
    { label: '⚡ Generate', cls: 'primary', fn: 'startWithTopic()' }
  ]},
  chat:     { btns: [
    { label: '↩ Cancel', cls: '', fn: 'restart()' },
  ]},
  results:  { btns: [
    { label: '↩ Start Over', cls: '', fn: 'restart()' }
  ]},
  projects: { btns: [
    { label: '+ New Project', cls: 'primary', fn: "showScreen('topic')" }
  ]},
};

function _updateContextBar(screenName) {
  const bar = document.getElementById('sticky-context-bar');
  if (!bar) return;
  const cfg = _ctxBarConfigs[screenName];
  if (!cfg) { bar.classList.remove('visible'); return; }
  bar.innerHTML = cfg.btns.map(b =>
    `<button class="ctx-btn ${b.cls}" onclick="${b.fn}">${b.label}</button>`
  ).join('');
  // small delay so spring animation triggers after paint
  requestAnimationFrame(() => requestAnimationFrame(() => bar.classList.add('visible')));
}

// ── HOME SEGMENTED NAVIGATION ──────────────────────────────
let _activeHomePanel = 'topics';

function switchHomePanel(panel) {
  _activeHomePanel = panel;
  ['topics','projects','custom'].forEach(p => {
    document.getElementById('hpanel-' + p)?.classList.toggle('active', p === panel);
    const btn = document.getElementById('hseg-' + p);
    if (btn) {
      btn.classList.toggle('active', p === panel);
      btn.setAttribute('aria-selected', p === panel ? 'true' : 'false');
    }
  });
  if (panel === 'projects') renderHomeProjectsList();
}

async function renderHomeProjectsList() {
  const list  = document.getElementById('home-projects-list');
  const empty = document.getElementById('home-projects-empty');
  const search = (document.getElementById('home-projects-search')?.value || '').toLowerCase();
  if (!list) return;
  let projects = [];
  try { projects = await dbGetAll(); } catch(e) {}
  const filtered = search
    ? projects.filter(p => p.name.toLowerCase().includes(search) || (p.topic||'').toLowerCase().includes(search))
    : projects;
  if (!filtered.length) {
    list.innerHTML = '';
    list.style.display = 'none';
    if (empty) empty.style.display = 'block';
    return;
  }
  list.style.display = 'grid';
  if (empty) empty.style.display = 'none';
  list.innerHTML = filtered.map(p => `
    <div class="project-card" tabindex="0" role="button" aria-label="${_escHtml(p.name)}"
      onclick="loadProject('${p.id}')"
      onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();loadProject('${p.id}')}">
      <div class="project-card-name">${_escHtml(p.name)}</div>
      <div class="project-card-topic">📌 ${_escHtml(p.topic||'No topic')}</div>
      <div class="project-card-meta">
        ${(p.agents||[]).length ? `<span class="project-card-tag">👥 ${(p.agents||[]).length}</span>` : ''}
        ${p.level ? `<span class="project-card-tag">${p.level}</span>` : ''}
      </div>
      <div class="project-card-date">Updated ${_formatDate(p.updatedAt)}</div>
    </div>
  `).join('');
}

// ── SWIPE GESTURES ON PROJECT CARDS ───────────────────────
function _initSwipeGestures() {
  const list = document.getElementById('projects-list');
  if (!list || window.innerWidth > 768) return;

  let startX = 0, startY = 0, currentWrap = null, currentCard = null;
  const SWIPE_THRESHOLD = 60;
  const MAX_SWIPE = 216; // 3 × 72px

  list.addEventListener('touchstart', e => {
    const wrap = e.target.closest('.project-card-wrap');
    if (!wrap) return;
    currentWrap = wrap;
    currentCard = wrap.querySelector('.project-card');
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    if (currentCard) currentCard.style.transition = 'none';
  }, { passive: true });

  list.addEventListener('touchmove', e => {
    if (!currentCard) return;
    const dx = e.touches[0].clientX - startX;
    const dy = Math.abs(e.touches[0].clientY - startY);
    if (dy > 12) { currentCard = null; return; } // vertical scroll wins
    if (dx >= 0) { // only left swipe
      currentCard.style.transform = 'translateX(0)';
      return;
    }
    const travel = Math.min(Math.abs(dx), MAX_SWIPE);
    currentCard.style.transform = `translateX(-${travel}px)`;
  }, { passive: true });

  list.addEventListener('touchend', e => {
    if (!currentCard) return;
    const dx = e.changedTouches[0].clientX - startX;
    currentCard.style.transition = '';
    if (dx < -SWIPE_THRESHOLD) {
      currentCard.style.transform = `translateX(-${MAX_SWIPE}px)`;
    } else {
      currentCard.style.transform = 'translateX(0)';
    }
    currentCard = null;
    currentWrap = null;
  }, { passive: true });

  // Tap elsewhere closes open swipes
  document.addEventListener('touchstart', e => {
    if (!e.target.closest('.project-card-wrap')) {
      list.querySelectorAll('.project-card').forEach(c => {
        c.style.transition = '';
        c.style.transform = 'translateX(0)';
      });
    }
  }, { passive: true });
}

// ── ACCORDION INSTRUCTIONS ─────────────────────────────────
function _renderAccordionInstructions(steps) {
  const container = document.getElementById('instr-steps');
  if (!container) return;
  container.innerHTML = '';
  steps.forEach((step, i) => {
    const item = document.createElement('div');
    item.className = 'accordion-item';
    item.innerHTML = `
      <div class="accordion-header" onclick="_toggleAccordion(this.parentElement)" role="button" tabindex="0"
           onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();_toggleAccordion(this.parentElement)}">
        <div class="accordion-num">0${i+1}</div>
        <div class="accordion-title">${step.title}</div>
        <span class="accordion-chevron">▾</span>
      </div>
      <div class="accordion-body">
        <div class="accordion-content">${step.body}</div>
      </div>
    `;
    container.appendChild(item);
  });
  // Open first by default
  if (container.firstElementChild) {
    _toggleAccordion(container.firstElementChild);
  }
}

function _toggleAccordion(item) {
  const isOpen = item.classList.contains('open');
  // Close all siblings
  item.parentElement.querySelectorAll('.accordion-item.open').forEach(el => {
    el.classList.remove('open');
  });
  if (!isOpen) item.classList.add('open');
}

// ── PATCH showInstructions to use accordion ────────────────
const _origShowInstructions = window.showInstructions;
window.showInstructions = function() {
  const section = document.getElementById('instructions-section');
  const isHidden = getComputedStyle(section).display === 'none';
  section.style.display = isHidden ? 'block' : 'none';
  if (isHidden) {
    document.getElementById('instr-title').textContent = t('instrTitle');
    _renderAccordionInstructions(t('instrSteps'));
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
};

// ── PATCH showScreen to update context bar + drawer ────────
const _origShowScreen = window.showScreen;
window.showScreen = function(name) {
  _origShowScreen(name);
  _updateContextBar(name);
  updateDrawerActive();
  _syncBackToTop();
  // Re-init swipe gestures after projects screen loads
  if (name === 'projects') setTimeout(_initSwipeGestures, 200);
};

// ── INIT ───────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  _syncFab();
  _updateContextBar('topic');
  updateDrawerActive();
  // Keyboard shortcut: Cmd/Ctrl+K opens drawer on desktop
  document.addEventListener('keydown', e => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      toggleDrawer();
    }
  });
});

// ── iOS: swipe-down to dismiss sheets ─────────────────────
(function() {
  let startY = 0, startScrollTop = 0, sheetEl = null, overlayEl = null;
  let isDragging = false;

  document.addEventListener('touchstart', function(e) {
    const overlay = e.target.closest('.modal-overlay.open, .ios-sheet-overlay.open');
    if (!overlay) return;
    const sheet = overlay.querySelector('.modal, .share-modal, .fw-modal, .ios-sheet');
    if (!sheet) return;
    // Only start if touch begins on the handle area (top 40px of sheet) or not in scrollable content
    const touch = e.touches[0];
    const sheetRect = sheet.getBoundingClientRect();
    const touchRelY = touch.clientY - sheetRect.top;
    const scrollable = e.target.closest('.modal-body, .ios-sheet-body, .fw-body');
    if (scrollable && scrollable.scrollTop > 0) return; // don't drag if scrolled
    if (touchRelY > 80 && !e.target.closest('.modal::before')) {
      // Only drag from top 80px
      if (touchRelY > 80 && scrollable) return;
    }
    startY = touch.clientY;
    sheetEl = sheet;
    overlayEl = overlay;
    isDragging = true;
  }, { passive: true });

  document.addEventListener('touchmove', function(e) {
    if (!isDragging || !sheetEl) return;
    const delta = e.touches[0].clientY - startY;
    if (delta > 0) {
      sheetEl.style.transform = `translateY(${Math.pow(delta, 0.8)}px)`;
      sheetEl.style.transition = 'none';
      overlayEl.style.background = `rgba(0,0,0,${Math.max(0, 0.55 - delta/400)})`;
    }
  }, { passive: true });

  document.addEventListener('touchend', function(e) {
    if (!isDragging || !sheetEl) return;
    const delta = e.changedTouches[0].clientY - startY;
    sheetEl.style.transition = '';
    overlayEl.style.background = '';
    if (delta > 80) {
      // Snap closed
      sheetEl.style.transform = 'translateY(100%)';
      setTimeout(() => {
        const closeBtn = overlayEl.querySelector('.modal-close');
        if (closeBtn) closeBtn.click();
        else overlayEl.classList.remove('open');
        if (sheetEl) sheetEl.style.transform = '';
      }, 280);
    } else {
      sheetEl.style.transform = '';
    }
    isDragging = false; sheetEl = null; overlayEl = null;
  }, { passive: true });
})();

// ── iOS: spring on tab icons via JS for better feel ───────
document.querySelectorAll('.ios-tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    this.querySelectorAll('.tab-icon').forEach(icon => {
      icon.style.transition = 'none';
      icon.style.transform = 'scale(0.78)';
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          icon.style.transition = 'transform 0.4s cubic-bezier(0.34,1.56,0.64,1)';
          icon.style.transform = '';
        });
      });
    });
  });
});

// ── SW / Warning corner toast helper ──────────────────────
function showSwToast(msg, isError = true) {
  const old = document.querySelector('.sw-toast');
  if (old) old.remove();
  const el = document.createElement('div');
  el.className = 'sw-toast';
  el.innerHTML = `
    <span class="sw-toast-icon">${isError ? '⚠' : 'ℹ'}</span>
    <span>${msg}</span>
    <button class="sw-toast-close" onclick="this.parentElement.remove()">✕</button>
  `;
  document.body.appendChild(el);
  setTimeout(() => { el.style.transition='opacity 0.3s'; el.style.opacity='0'; setTimeout(()=>el.remove(),320); }, 6000);
}


// ── Bottom nav hide-on-scroll-down (mobile only) ──────────
(function() {
  let _lastScroll = 0;
  let _tabHidden = false;
  const THRESHOLD = 6;        // px delta to trigger
  const SHOW_ZONE = 80;       // px from bottom always shows

  function _onScroll() {
    if (window.innerWidth > 768) return;  // desktop: never hide
    const now = window.scrollY;
    const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
    const nearBottom = maxScroll - now < SHOW_ZONE;
    const delta = now - _lastScroll;
    _lastScroll = now;

    const tabBar = document.getElementById('ios-tab-bar');
    const ctxBar = document.getElementById('sticky-context-bar');
    if (!tabBar) return;

    if (nearBottom || now < 60) {
      // Always show near top or bottom
      if (_tabHidden) {
        _tabHidden = false;
        tabBar.classList.remove('hidden-by-scroll');
        ctxBar?.classList.remove('tab-hidden');
      }
    } else if (delta > THRESHOLD && !_tabHidden) {
      // Scrolling down → hide
      _tabHidden = true;
      tabBar.classList.add('hidden-by-scroll');
      ctxBar?.classList.add('tab-hidden');
    } else if (delta < -THRESHOLD && _tabHidden) {
      // Scrolling up → show
      _tabHidden = false;
      tabBar.classList.remove('hidden-by-scroll');
      ctxBar?.classList.remove('tab-hidden');
    }
  }

  window.addEventListener('scroll', _onScroll, { passive: true });

  // Reset on screen change
  const _origShowScreenP7 = window.showScreen;
  window.showScreen = function(name) {
    _origShowScreenP7(name);
    _tabHidden = false;
    document.getElementById('ios-tab-bar')?.classList.remove('hidden-by-scroll');
    document.getElementById('sticky-context-bar')?.classList.remove('tab-hidden');
    _lastScroll = 0;
  };
})();

</script>

<!-- ── STICKY CONTEXT BAR (mobile) ── -->
<div id="sticky-context-bar">
  <!-- populated dynamically by updateContextBar() -->
</div>

<!-- ── BACK TO TOP ── -->
<button id="back-to-top" onclick="scrollToTop()" aria-label="Back to top" title="Back to top">↑</button>

</body>
</html>
